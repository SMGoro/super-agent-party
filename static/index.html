<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Agent party</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/transition.css">
  <!-- GitHub Markdown CSS for styling -->
  <link rel="stylesheet" href="css/github-markdown.min.css">
  <!-- Highlight.js CSS for code highlighting -->
  <link rel="stylesheet" href="css/github.min.css">
  <script src="libs/clipboard.min.js"></script>
  <!--引入html2canvas-->
  <script src="libs/html2canvas.min.js"></script>
  <!-- 引入Element Plus样式 -->
  <link rel="stylesheet" href="libs/element-plus.css">
  <link rel="stylesheet" href="fontawesome/css/all.min.css">
  <link rel="icon" href="source/icon.png" type="image/png">
  <!-- Voice Activation Detection -->
  <script src="libs/ort.js"></script>
  <script src="libs/bundle.min.js"></script>
  <script src="libs/qrcode.min.js"></script>
  <script src="libs/driver.js"></script>
  <link rel="stylesheet" href="libs/driver.css">
  <script src="libs/exceljs.min.js"></script>
  <script>
    console.log(`
     _       ____   _____   _   _   _____ 
    / \\     / ___| | ____| | \\ | | |_   _|
   / _ \\   | |  _  |  _|   |  \\| |   | |  
  / ___ \\  | |_| | | |___  | |\\  |   | |  
 /_/   \\_\\  \\____| |_____| |_| \\_|   |_|  
                                          
  ____       _      ____    _____  __   __
 |  _ \\     / \\    |  _ \\  |_   _| \\ \\ / /
 | |_) |   / _ \\   | |_) |   | |    \\ V / 
 |  __/   / ___ \\  |  _ <    | |     | |  
 |_|     /_/   \\_\\ |_| \\_\\   |_|     |_|  
       
 github repo: https://github.com/heshengtao/super-agent-party
`);
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}
// 2. 注册 Vue 自定义指令 (在您的 app.mount 之前或者组件 mixin 中)
// 如果您用的是 Options API，可以直接放在 directives: { ... } 里，或者全局注册
const StreamDirective = {
  mounted(el, binding) {
    el._markdownContent = '';
    updateElement(el, binding.value, binding.arg); // binding.arg 可以传 formatMessage 函数
  },
  updated(el, binding) {
    if (binding.value !== el._markdownContent) {
      updateElement(el, binding.value, binding.arg);
    }
  }
};

// 核心渲染逻辑
function updateElement(el, rawMarkdown, formatFn) {
  el._markdownContent = rawMarkdown; // 缓存内容

  // A. 表格补全逻辑 (防止解析抖动)
  let contentToRender = rawMarkdown || '';
  const lines = contentToRender.split('\n');
  const lastLine = lines[lines.length - 1].trim();
  // 如果最后一行看起来是未闭合的表格行，手动补全竖线
  if (lastLine.startsWith('|') && !lastLine.endsWith('|') && !/^[|\s-:]+$/.test(lastLine)) {
    contentToRender += ' |';
  }

  // B. 生成 HTML 字符串 (调用您原有的 formatMessage)
  // 注意：这里假设 formatFn 是您组件里的 formatMessage 方法
  // 如果 formatFn 不存在，退化为简单的 md.render
  let newHtml = '';
  if (typeof formatFn === 'function') {
    newHtml = formatFn(contentToRender); 
  } else if (window.md) {
    newHtml = window.md.render(contentToRender);
  }

  // C. 构造新 DOM 树容器
  const wrapper = document.createElement('div');
  wrapper.innerHTML = newHtml;
  
  // D. 使用 morphdom 进行增量更新
  // 这就是"丝滑"的关键：它只修改变动的部分，保留旧 DOM 的动画状态
  morphdom(el, wrapper, {
    childrenOnly: true, // 仅更新子节点
    
    // 性能优化：跳过不需要更新的节点
    onBeforeElUpdated: (fromEl, toEl) => {
      // 1. 保护 MathJax 公式不被重绘 (防止公式闪烁)
      if (fromEl.classList.contains('MathJax') || fromEl.tagName === 'MJX-CONTAINER') {
        return false; 
      }
      // 2. 保护代码块，如果内容没变就不动 (防止高亮丢失)
      if (fromEl.tagName === 'PRE' && fromEl.isEqualNode(toEl)) {
        return false;
      }
      return true;
    },
    
    // 节点添加后的回调
    onNodeAdded: (node) => {
      // 可以在这里触发 highlight.js 或 mathjax 对新节点的渲染
      if (node.tagName === 'PRE' && window.hljs) {
         // hljs.highlightElement(node); // 如果 formatMessage 里没做，可以在这做
      }
    }
  });

  // E. 触发 MathJax 渲染 (Debounced)
  // 建议在组件 methods 里定义一个防抖的 queueMathJax，这里简单模拟
  if (window.MathJax) {
    // 使用 Promise 队列防止冲突，这里简化处理
    setTimeout(() => {
      window.MathJax.typesetPromise([el]).catch(()=>{});
    }, 50);
  }
}
  </script>
  <!-- Include markdown-it and highlight.js scripts -->
  <script src="libs/markdown-it.min.js"></script>
  <script src="libs/markdown-it-task-lists.min.js"></script>
  <script src="libs/markdown-it-footnote.min.js"></script>
  <script src="libs/markdown-it-container.min.js"></script>
  <script src="libs/morphdom-umd.min.js"></script>
  <script src="libs/highlight.min.js"></script>
  <script src="js/locales.js"></script>
  <script src="libs/mermaid.min.js"></script>
  <script src="libs/uuid.min.js"></script>
  <script>
    mermaid.initialize({ 
      startOnLoad: false,
      securityLevel: 'loose',
      theme: 'default',
    });
  </script>
  <!--  MathJax 配置  -->
  <script>
    window.MathJax = {
      options: {
        ignoreHtmlClass: 'user-message-content'  // 匹配用户消息容器类名
      },
      tex: {
        inlineMath: [
          ['$', '$']       // 常见的行内公式定界符
        ],
        displayMath: [
          ['$$', '$$']     // 常见的行间公式定界符
        ],
      },
      svg: {
        fontCache: 'global' // 使用全局字体缓存
      },
      startup: {
        pageReady: () => {
          // 可选：页面加载完成后执行一些操作
          console.log("MathJax is ready!");
        }
      }
    };
  </script>
  <script id="MathJax-script" async src="libs/tex-svg.js"></script>
</head>
<body>
  <div id="app">
    <!-- 顶部栏 -->
    <el-header v-if="isElectron || isMobile" class="top-bar" height="30px">

      <!-- ★ 新增：集成式浏览器顶栏 -->
      <!-- style="margin-left: 78px" 实现了左侧留白，且该区域可拖拽 -->
      <div 
        v-if="activeMenu === 'ai-browser' && !isMobile" 
        class="integrated-browser-bar"
        :style="{ 'margin-left': isCollapse ? '50px':'186px'}" 
      >
        
        <!-- 2. 标签栏 (边缘滚动容器) -->
        <div 
            class="integrated-tabs-container" 
            ref="tabsContainerRef"
            @mousemove="handleTabsMouseMove"
            @mouseleave="stopEdgeScroll"
        >
            <div class="tabs-scroll-wrapper" ref="tabsWrapperRef">
                <!-- 现有的标签页循环 -->
                <div 
                    v-for="tab in browserTabs" 
                    :key="tab.id"
                    class="ib-tab"
                    :class="{ 'active': currentTabId === tab.id }"
                    @click="switchTab(tab.id)"
                    @mousedown.middle="closeTab(tab.id, $event)"
                >
                    <div class="ib-tab-content">
                        <span class="ib-icon" v-if="tab.isLoading"><i class="fa-solid fa-spinner fa-spin"></i></span>
                        <span class="ib-icon" v-else-if="tab.favicon"><img :src="tab.favicon" /></span>
                        <span class="ib-icon" v-else><i class="fa-regular fa-compass"></i></span>
                        <span class="ib-title">{{ tab.title || t('newTab') }}</span>
                    </div>
                    <span class="ib-close" @click.stop="closeTab(tab.id, $event)">
                        <i class="fa-solid fa-xmark"></i>
                    </span>
                </div>

                <!-- ★★★ 修改点：将新建按钮移到这里 ★★★ -->
                <button class="new-tab-inline" @click="addNewTab" :title="t('newTab')">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>
        <!-- 1. 地址栏 (现在排在最左边) -->
        <div class="integrated-address-bar">
             <el-input 
                v-model="urlInput" 
                class="ib-input" 
                :placeholder="t('searchOrUrl')"
                @keyup.enter="handleUrlEnter"
                @focus="$event.target.select()"
            >
                <template #prefix>
                    <i class="fa-solid fa-lock" v-if="currentTab?.url.startsWith('https')" style="font-size: 10px;"></i>
                    <i class="fa-solid fa-globe" v-else style="font-size: 10px;"></i>
                </template>
            </el-input>
        </div>
        <!-- 3. 右侧控制组：新建标签 + 导航按钮 -->
        <!-- 放在一起 -->
        <div class="browser-controls-group">
            <button 
                class="ib-btn" 
                :class="{ 'is-favorite': isCurrentTabFavorite }"
                @click="toggleFavorite(currentTab)" 
                :title="isCurrentTabFavorite ? t('removeFavorite') : t('addFavorite')"
                :disabled="!currentTab?.url"
            >
                <i :class="isCurrentTabFavorite ? 'fa-solid fa-star' : 'fa-regular fa-star'"></i>
            </button>

            <!-- 下载管理按钮 & 下拉框 -->
            <div 
                class="download-manager-wrapper"
                @mouseenter="handleDropdownEnter" 
                @mouseleave="handleDropdownLeave"
            >
                <!-- 触发按钮 -->
                <button class="ib-btn" :class="{ 'active': showDownloadDropdown }" :title="t('downloads')">
                    <i class="fa-solid fa-cloud-arrow-down"></i>
                    <!-- 进度小红点/进度条 (可选) -->
                    <span v-if="activeDownloadCount > 0" class="download-badge"></span>
                </button>

                <!-- iOS 风格下拉框 -->
                <transition name="dropdown-fade">
                    <div class="ios-dropdown-panel" v-show="showDownloadDropdown">
                        <div class="dropdown-header">
                            <span>{{ t('downloads') || 'Downloads' }}</span>
                            <span class="clear-btn" @click="clearFinishedDownloads" v-if="downloads.length > 0">{{ t('clear') || 'Clear' }}</span>
                        </div>

                        <!-- 空状态 -->
                        <div v-if="downloads.length === 0" class="empty-state">
                            <i class="fa-solid fa-box-open"></i>
                            <p>{{ t('noDownloads') || 'No recent downloads' }}</p>
                        </div>

                        <!-- 下载列表 -->
                        <div v-else class="download-list">
                            <div v-for="item in downloads" :key="item.id" class="download-item">
                                
                                <!-- 图标 -->
                                <div class="file-icon">
                                    <i class="fa-solid fa-file"></i>
                                </div>

                                <!-- 信息区 -->
                                <div class="file-info">
                                    <div class="file-name" :title="item.filename">{{ item.filename }}</div>
                                    
                                    <!-- 进度条 (仅在下载中显示) -->
                                    <div class="progress-bar-bg" v-if="item.state === 'progressing' || item.state === 'paused'">
                                        <div class="progress-bar-fill" :style="{ width: (item.progress * 100) + '%' }"></div>
                                    </div>

                                    <!-- 状态文本 -->
                                    <div class="file-meta">
                                        <span v-if="item.state === 'completed'" class="success-text">{{ t('completed') || 'Done' }}</span>
                                        <span v-else-if="item.state === 'cancelled'" class="error-text">{{ t('cancelled') || 'Cancelled' }}</span>
                                        <span v-else-if="item.state === 'interrupted'" class="error-text">{{ t('failed') || 'Failed' }}</span>
                                        <span v-else>
                                            {{ formatBytes(item.receivedBytes) }} / {{ formatBytes(item.totalBytes) }}
                                            <span v-if="item.state === 'paused'">({{ t('paused') || 'Paused' }})</span>
                                        </span>
                                    </div>
                                </div>

                                <!-- 操作按钮区 -->
                                <div class="item-actions">
                                    <!-- 完成后：打开文件夹 -->
                                    <button v-if="item.state === 'completed'" class="action-btn folder" @click="openFileFolder(item.path)" :title="t('openFolder')">
                                        <i class="fa-regular fa-folder-open"></i>
                                    </button>
                                    
                                    <!-- 下载中：暂停/开始 -->
                                    <button v-if="item.state === 'progressing'" class="action-btn" @click="controlDownload(item.id, 'pause')" :title="t('pause')">
                                        <i class="fa-solid fa-pause"></i>
                                    </button>
                                    <button v-if="item.state === 'paused'" class="action-btn" @click="controlDownload(item.id, 'resume')" :title="t('resume')">
                                        <i class="fa-solid fa-play"></i>
                                    </button>

                                    <!-- 下载中：取消 / 完成后：移除记录 -->
                                    <button class="action-btn delete" @click="handleStopOrRemove(item)" :title="t('cancel')">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>

            <!-- 导航按钮 -->
            <button class="ib-btn" @click="browserGoBack" :disabled="!currentTab?.canGoBack" :title="t('back')">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <button class="ib-btn" @click="browserGoForward" :disabled="!currentTab?.canGoForward" :title="t('forward')">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
            <button class="ib-btn" @click="browserReload" :title="t('reload')">
                <i :class="currentTab?.isLoading ? 'fa-solid fa-xmark' : 'fa-solid fa-rotate-right'"></i>
            </button>
            <button class="ib-btn" @click="goHome" :title="t('home')">
                <i class="fa-solid fa-house"></i>
            </button>
        </div>

      </div>

      <div class="window-controls">
        <div v-show="!isAssistantMode&&!isMobile&&settings?.model!==''" class="model-info" @click="showModelDialog = true" >
          <el-tooltip :content="t('clickToSwitchModel')">
            <el-alert type="primary" :closable="false" style="max-height: 32px;">
              <span>{{t("model") +": "+settings.model}}</span>  
            </el-alert>
          </el-tooltip>
        </div>
        <div v-show="!isAssistantMode&&!isMobile" class="model-info" @click="openExtensionsDialog" >
          <el-tooltip :content="t('clickToSwitchExtensions')">
            <el-alert type="primary" :closable="false" style="max-height: 32px;">
              <span>{{t("extension") +": "+currentViewName}}</span>  
            </el-alert>
          </el-tooltip>
        </div>
        <el-button 
          v-if="updateAvailable&&!isAssistantMode&&!isMobile"
          @click="handleUpdateAction" 
          class="top-bar-btn update-btn"
          :class="{ 'installed': updateDownloaded }"
          text>
          <el-icon>
            <i :class="updateIcon"></i>
          </el-icon>
          {{ updateButtonText }}
          <span v-if="downloadProgress > 0 && !updateDownloaded" class="progress-text">
            ({{ downloadProgress }}%)
          </span>
        </el-button>
        <el-button  v-if="!isAssistantMode&&!isMobile" @click="restartDriverGuide" class="top-bar-btn" text id="driver-guide-btn" :title=" t('tutorial')">
          <el-icon>
            <i class="fa-solid fa-school"></i>
          </el-icon>
        </el-button>
      <!-- 添加移动端菜单按钮 -->
      <el-button 
      class="top-bar-btn"
       v-if="!isAssistantMode&&isMobile" 
       @click="isCollapse = sidebarVisible;sidebarVisible = !sidebarVisible"
       text
       :title="isCollapse ? t('expandAside') : t('collapseAside')">
          <el-icon>
            <i :class="!sidebarVisible ? 'fa-solid fa-bars' : 'fa-solid fa-bars-staggered'"></i>
          </el-icon>
      </el-button>
        <el-button 
          v-if="!isAssistantMode&&!isMobile"
          @click="openLogDialog"
          class="top-bar-btn"
          text
          :title="t('serverLogs') || 'Server Logs'">
          <el-icon>
            <i class="fa-solid fa-terminal"></i>
          </el-icon>
        </el-button>
        <!-- 新增展开/收起按钮 -->
        <el-button 
          v-if="!isAssistantMode&&!isMobile"
          @click="isCollapse = !isCollapse"
          class="top-bar-btn"
          text
          :title="isCollapse ? t('expandAside') : t('collapseAside')">
          <el-icon>
            <i :class="isCollapse ? 'fa-solid fa-bars' : 'fa-solid fa-bars-staggered'"></i>
          </el-icon>
        </el-button>
        <el-button 
          @click="fixedWindow"
          v-if="isAssistantMode"
          class="top-bar-btn"
          text
          :title="isFixedWindow ? t('unfixedWindow'):t('fixedWindow')">
          <el-icon>
            <i :class="isFixedWindow ? 'fa-solid fa-thumbtack-slash':'fa-solid fa-thumbtack'"></i>
          </el-icon>
        </el-button>
        <el-button 
          @click="toggleCapsuleMode"
          v-if="!isCapsuleMode&&!isAssistantMode&&!isMobile"
          class="top-bar-btn"
          text
          :title="t('CapsuleMode')">
          <el-icon>
            <i class="fa-solid fa-capsules"></i>
          </el-icon>
        </el-button>
        <el-button 
          @click="toggleAssistantMode"
          class="top-bar-btn"
          text
          :title="isAssistantMode ?  t('maximize'):t('assistantMode')">
          <el-icon>
            <i :class="isAssistantMode ?  'fa-solid fa-expand' : 'fa-solid fa-wand-magic-sparkles'"></i>
          </el-icon>
        </el-button>
        <el-button v-if="!isMac&&!isMobile" @click="minimizeWindow" class="top-bar-btn" text :title="t('minimize')">
          <el-icon>
            <i class="fa-solid fa-minus"></i>
          </el-icon>
        </el-button>
        <el-button v-if="!isMac&&!isMobile" @click="toggleIcon" class="top-bar-btn" text :title="t('maximize')">
          <el-icon>
            <i :class="iconClass"></i>
          </el-icon>
        </el-button>
        <el-button v-if="!isMac&&!isMobile" @click="closeWindow" class="top-bar-btn" text :title="t('close')">
          <el-icon>
            <i class="fa-solid fa-xmark"></i>
          </el-icon>
        </el-button>
      </div>
    </el-header>

    <!-- 主容器 -->
    <el-container class="main-container">
      <!-- 侧边栏 -->
      <el-aside 
        :width="sidebarStyle.width"
        class="sidebar"
        :class="{ 'mobile-sidebar': isMobile }"
        @dblclick="isCollapse = !isCollapse"
        v-show="!isMobile || sidebarVisible">
        <el-menu
          :collapse="isCollapse"
          :default-active="activeMenu"
          class="el-menu-vertical"
          @select="handleSelect">
          <el-menu-item index="home">
            <el-icon>
              <i class="fa-solid fa-comment"></i>
            </el-icon>
            <template #title>{{ t('chat') }}</template>
          </el-menu-item>
          <el-menu-item index="model-config" id="model-config">
            <el-icon>
              <i class="fa-solid fa-hexagon-nodes"></i>
            </el-icon>
            <template #title>{{ t('modelConfig') }}</template>
          </el-menu-item>
          <el-menu-item index="toolkit">
            <el-icon>
              <i class="fa-solid fa-toolbox"></i>
            </el-icon>
            <template #title>{{ t('toolkit') }}</template>
          </el-menu-item>
          <el-menu-item index="role">
            <el-icon>
              <i class="fa-solid fa-masks-theater"></i>
            </el-icon>
            <template #title>{{ t('role') }}</template>
          </el-menu-item>
          <el-menu-item index="deploy-bot">
              <el-icon>
                  <i class="fa-solid fa-robot"></i>
              </el-icon>
              <template #title>{{ t('deployBot') }}</template>
          </el-menu-item>
          <el-menu-item index="ai-browser" v-if="isElectron">
            <el-icon>
              <i class="fa-solid fa-compass"></i>
            </el-icon>
            <template #title>{{ t('aiBrowser') }}</template>
          </el-menu-item>
          <el-menu-item index="api-group">
            <el-icon>
              <i class="fa-solid fa-plug"></i>
            </el-icon>
            <template #title>{{ t('apiGroup') }}</template>
          </el-menu-item>
          <el-menu-item index="storage">
            <el-icon>
              <i class="fa-solid fa-box-archive"></i>
            </el-icon>
            <template #title>{{ t('storage') }}</template>
          </el-menu-item>
          <el-menu-item index="system">
            <el-icon>
              <i class="fa-solid fa-gear"></i>
            </el-icon>
            <template #title>{{ t('systemSettings') }}</template>
          </el-menu-item>
          <el-menu-item 
            index="logo"
            class="sidebar-logo">
            <el-icon class="logo-icon"><img src="./source/icon.png" /></el-icon>
            <template #title>{{ t('aboutUs') }}</template>
          </el-menu-item>
        </el-menu>
      </el-aside>
      <div 
        class="sidebar-mask"
        v-show="isMobile && sidebarVisible"
        @click="sidebarVisible = false"></div>

    <!-- 后端日志弹窗 -->
    <el-dialog
      v-model="showLogDialog"
      :title="t('serverLogs') || 'Backend Logs'"
      width="70%"
      top="5vh"
      class="log-dialog"
      :append-to-body="true"
    >
      <div class="log-container" ref="logContainer">
        <pre>{{ logContent }}</pre>
      </div>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="fetchLogs">
            <el-icon><i class="fa-solid fa-rotate-right"></i></el-icon> {{ t('refresh') || 'Refresh' }}
          </el-button>
          <el-button type="primary" @click="showLogDialog = false">{{ t('confirm') || 'OK' }}</el-button>
        </span>
      </template>
    </el-dialog>

      <el-dialog
        v-model="showModelDialog"
        :title="t('mainModel')"
        width="600px">
        <div class="knowledge-dialog-content">
          <!-- 服务器列表 -->
          <div
            v-for="provider in modelProviders"
            :key="provider.id"
            class="knowledge-item"
            :class="{ active: settings.selectedProvider === provider.id }"
            @click="
              settings.selectedProvider = provider.id;
              selectMainProvider(provider.id);
              showModelDialog = false;
            "
          >
            <img
              :src="getVendorLogo(provider.vendor)"
              class="mini-vendor-logo"
            />
            <span>{{ provider.modelId }}</span>
          </div>
          <div v-if="Object.keys(modelProviders).length === 0" class="empty-tip">
              {{ t('firstTimeUse') }}
              <el-link
                type="primary"
                :underline="false"
                class="font-medium"
                @click="switchToApiBox"
              >
                <el-icon class="mr-1">
                  <i class="fa-solid fa-key"></i>
                </el-icon>{{ t('keyBoxInterface') }}
              </el-link>
              {{ t('addProviderReturnSelect') }}
              {{ t('mainmodelnotice') }}
          </div>
        </div>
      </el-dialog>  
      <!-- 扩展选择对话框 -->
      <el-dialog
        :title="t('switchExtension')"
        v-model="showExtensionsDialog"
        width="60%"
        :close-on-click-modal="false">
        <div class="extensions-list" :style="{ 'overflow-x': 'hidden'}">
          <!-- 默认视图选项 -->
          <el-card 
            class="extension-card default-view-card"
            :class="{ active: currentExtension === null }"
            @click="resetToDefaultView()">
            <div class="extension-info">
              <h3>{{ t('defaultView') }}</h3>
              <p>{{ t('defaultViewDescription') }}</p>
            </div>
          </el-card>
          
          <!-- 分隔线 -->
          <div class="extensions-divider" v-if="extensions.length > 0">
            <span>
              {{ t('availableExtensions') }}
              <el-link
                type="primary"
                :underline="false"
                href="#" 
                @click.stop.prevent="switchToExtensionPage();showExtensionsDialog = false" 
              >
                <el-icon class="mr-1">
                  <i class="fa-solid fa-puzzle-piece"></i>
                </el-icon>{{ t('goToExtensionPage') }}
              </el-link>
            </span>
          </div>
          <!-- 扩展列表 -->
          <el-empty v-if="extensions.length === 0" :description="t('noExtensionsFound')" ></el-empty>
            <el-card
              v-for="ext in extensions"
              :key="ext.id"
              class="extension-card"
              :class="{ active: currentExtension && currentExtension.id === ext.id }"
              @click="switchExtension(ext)">
              
              <!-- 右上角按钮组 -->
              <div class="btn-top-right">
                <el-tooltip :content="t('openExtensionInBrowser')" placement="top">
                  <!-- 浏览器打开按钮 -->
                  <el-button
                    type="default"
                    circle
                    size="small"
                    @click.stop="openExtension(ext)">
                    <i class="fa-solid fa-external-link"></i>
                  </el-button>
                </el-tooltip>
                <el-tooltip :content="t('openExtensionInWindow')" placement="top">
                  <!-- 独立窗口打开按钮（仅在Electron环境下显示） -->
                  <el-button
                    v-if="isElectron"
                    type="primary"
                    circle
                    size="small"
                    @click.stop="openExtensionInWindow(ext)"
                    style="margin-left: 8px;">
                    <i class="fa-solid fa-window-restore"></i>
                  </el-button>
                </el-tooltip>
              </div>

              <div class="extension-info">
                <h3>{{ ext.name }}</h3>
                <p>{{ ext.description }}</p>
                <div class="extension-meta">
                  <span>v{{ ext.version }}</span>
                  <span>{{ ext.author }}</span>
                </div>
              </div>
            </el-card>
        </div>
        <template #footer>
          <div class="dialog-footer">
            <el-button @click="showExtensionsDialog = false">{{ t('cancel') }}</el-button>
          </div>
        </template>
      </el-dialog>
      <!-- 内容区 -->
      <el-main class="content">
        <!-- 聊天界面保持不变 -->
        <div v-show="activeMenu === 'home'" class="page chat-container">
        <!-- 最外层 wrapper，负责整体左右布局 -->
        <div class="chat-wrapper" 
            ref="chatWrapperRef"
            :class="{ 
              'collapsed-right': !sidePanelOpen, 
              'collapsed-left': !chatAreaOpen,
              'resizing': isResizing
            }">
          
          <!-- 添加拖拽遮罩层 -->
          <div v-if="isResizing" class="resize-overlay"></div>
            <!-- 聊天消息列表 -->
            <div class="chat-area" 
                ref="chatAreaRef"
                :class="{ collapsed: !chatAreaOpen }" 
                v-show="chatAreaOpen">
              <div class="messages-container" ref="messagesContainer" v-if="!isCapsuleMode" @click.capture="handleMessageLinkClick">
                <!-- 添加 is-group-mode 类 -->
                <div v-for="(message, index) in messages" :key="index" class="message" :class="[message.role, { 'is-group-mode': isGroupMode }]">
                  
                  <!-- 群聊模式 - AI 头像 (左侧) -->
                  <div v-if="isGroupMode && message.role === 'assistant' && message.agentName" class="im-avatar left">
                    <img :src="getRoleAvatar(message.agentName)" draggable="false" />
                  </div>

                  <!-- 内容包裹层：负责纵向排列 名字、气泡、按钮 -->
                  <div class="im-content-wrapper">
                    
                    <!-- AI 名字 (仅群聊显示) -->
                    <div v-if="(isGroupMode && message.agentName) && message.role === 'assistant'" class="im-name-tag">
                        {{ message.agentName }}
                    </div>

                    <!-- TTS 控制区 -->
                    <div v-if="(ttsSettings.enabled || settings.enableOmniTTS) && message.role === 'assistant'" class="tts-controls">
                      <el-tooltip :content="message.isPlaying ? t('pause') : t('play')">
                        <el-button @click="toggleTTS(message)" circle size="small">
                          <i :class="message.isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play'"></i>
                        </el-button>
                      </el-tooltip>
                      <template v-if="!message.isOmni">
                        <el-button @click="backwardTTS(message)" circle size="small"><i class="fa-solid fa-backward"></i></el-button>
                        <el-button @click="forwardTTS(message)" circle size="small"><i class="fa-solid fa-forward"></i></el-button>
                        <span class="tts-status" v-if="message.ttsChunks">
                          {{ (message.currentChunk || 0) + 1 }}/{{ message.ttsChunks.length }}
                        </span>
                      </template>
                      <template v-else>
                        <div class="omni-progress-wrapper" style="margin-left: 20px;">
                          <el-slider 
                            v-model="message.omniCurrentTime" 
                            :max="message.omniDuration > 0 ? message.omniDuration : 0.1" 
                            :step="0.01"
                            :show-tooltip="false"
                            @change="(val) => seekOmniTTS(message, val)"
                          />
                          <span class="tts-status-time">
                            {{ (message.omniCurrentTime || 0).toFixed(1) }}s / {{ (message.omniDuration || 0).toFixed(1) }}s
                          </span>
                        </div>
                      </template>
                      <span class="tts-status" v-if="message.role === 'assistant' && !isMobile && !message.isOmni">
                        {{ t('first_sentence_latency')+': '+(message?.first_sentence_latency ?? 0) +'ms' }}
                      </span>
                    </div>

                    <!-- 消息气泡主体 -->
                    <div class="message-content" v-if="!allBriefly||message.role !== 'system'||index === 0" :class="{ typing: message.role === 'assistant' && isTyping && index === messages.length - 1 }">
                      
                      <!-- User -->
                      <div v-if="message.role === 'user'" class="user-content" data-mjx-disabled="true">
                        <div v-html="message.content" class = "user-msg"></div>
                        <div v-if="message.fileLinks?.length" class="file-links">
                          <a v-for="(link, linkIndex) in message.fileLinks" :key="linkIndex" :href="formatFileUrl(link.path)" target="_blank" class="file-link">@{{ link.name }}</a>
                        </div>
                        <div v-if="message.imageLinks?.length" class="image-links">
                          <img v-for="(link, linkIndex) in message.imageLinks" :key="linkIndex" :src="formatFileUrl(link.path)" class="image-link"/>
                        </div>
                      </div>
                      
                      <!-- Assistant -->
                      <div v-else-if="message.role === 'assistant'" class="markdown-body">
                          <div v-if="message.briefly" v-html="formatMessage(message.pure_content??message.content, index)"></div>
                          <div v-else>
                              <template v-for="(segment, segIndex) in splitMessageContent(message.content)" :key="segIndex">
                                  <div v-if="segment.type === 'text'" class="stream-content" :class="{ 'streaming': isTyping && index === messages.length - 1 && segIndex === splitMessageContent(message.content).length - 1 }" v-morph:format="segment.content" style="display: inline-block; width: 100%;"></div>
                                  <a2-u-i-renderer v-else-if="segment.type === 'ui'" :config="segment.content" @action="handleA2UIAction"></a2-u-i-renderer>
                              </template>
                              <div v-if="isTyping && index === messages.length - 1 && !message.content"><i class="fa-solid fa-spinner fa-spin"></i></div>
                          </div>
                      </div>
                      
                      <!-- System -->
                      <div v-else class="system-content" data-mjx-disabled="true">
                        <div v-html="index===0 ? (t('system_prompt') + message.content):message.content" class="scroll-on-hover" @click="openEditDialog(message.role, message.content,index)" :style="{ 'max-height': index===0 ? '200px' : 'none', 'overflow-y': index===0 ? 'auto' : 'hidden' }"></div>
                      </div>

                    </div>

                    <!-- 操作按钮区 -->
                    <div class="message-actions" v-if="!allBriefly||message.role !== 'system'||index === 0">
                      <el-tooltip v-if="mainAgent === 'super-model' || message.role !== 'system'" :content="t('edit')" placement="bottom">
                        <el-button @click="openEditDialog(message.role, message.content,index)" circle size="small"><i class="fa-solid fa-pen-to-square"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="message.role === 'assistant'" :content="t('briefly')" placement="bottom">
                        <el-button class="briefly-btn" @click="toggleBriefly(index)" circle size="small"><i class="fa-solid fa-asterisk"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="message.role === 'assistant'" :content="t('rewrite')" placement="bottom">
                        <el-button class="rewrite-btn" @click="rewrite(index)" circle size="small"><i class="fa-solid fa-rotate"></i></el-button>
                      </el-tooltip>
                      <el-tooltip :content="t('copy')" placement="bottom">
                        <el-button class="copy-btn" @click="copyMessageContent(message)" circle size="small"><i class="fa-solid fa-copy"></i></el-button>
                      </el-tooltip>
                      <el-tooltip :content="t('translateAndMark')" placement="bottom">
                        <el-button @click="translateMessage(index)" circle size="small"><i class="fa-solid fa-language"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="index !== 0" :content="t('delete')" placement="bottom">
                        <el-button @click="deleteMessage(index)" circle size="small"><i class="fa-solid fa-trash-can"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="index == 0" :content="t('reset')" placement="bottom">
                        <el-button @click="resetMessage(index)" circle size="small"><i class="fa-solid fa-rotate"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="message.role === 'system'&&index == 0" :content="t('oneClickExpand')" placement="bottom">
                        <el-button class="Gen-btn" @click="toggleQuickGen(index)" :disabled="isQuickGenerating" circle size="small"><i class="fa-solid fa-wand-magic-sparkles"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="message.role === 'system'&&index == 0" :content="t('save')" placement="bottom">
                        <el-button class="Gen-btn" @click="saveSystemPrompt(index)" :disabled="isQuickGenerating" circle size="small"><i class="fa-solid fa-floppy-disk"></i></el-button>
                      </el-tooltip>
                      <span class="msg-status" v-if="message.role === 'assistant' && !isMobile">
                          {{ t('total_tokens')+': '+ (message?.total_tokens ?? 0) +',    '+ t('first_token_latency')+': '+(message?.first_token_latency ?? 0) +'ms,    '+ t('elapsedTime')+': '+(message?.elapsedTime ?? 0) + 's'}}
                      </span>
                    </div>

                  </div>

                  <!-- 群聊模式 - 用户头像 (右侧) -->
                  <div v-if="isGroupMode && message.role === 'user'" class="im-avatar right">
                    <img src="source/providers/logo.png" draggable="false" />
                  </div>

                </div>
              </div>
              
              <div class="button-group">

                <el-tooltip :content="ASRrunning?t('listening'):isTyping?t('typing'):TTSrunning?t('speaking'):t('idle')" placement="top">
                  <el-button
                    v-if="isCapsuleMode"
                    class="icon-btn status-btn"
                    :type="ASRrunning||TTSrunning||isTyping ?  'primary':'default' "
                    circle>
                    <i v-if="ASRrunning" class="fa-solid fa-ear-listen"></i>
                    <i v-else-if="isTyping" class="fa-solid fa-feather-pointed"></i>
                    <i v-else-if="TTSrunning" class="fa-solid fa-head-side-cough"></i>
                    <i v-else class="fa-solid fa-heart"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('clearChat')" placement="top">
                  <el-button
                    v-if="!isCapsuleMode"
                    @click="clearMessages"
                    class="icon-btn clear-btn"
                    type="danger"
                    circle>
                    <i class="fa-solid fa-trash"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('mainModel')" placement="top">
                  <el-button
                    v-if="!isCapsuleMode"
                    plain
                    circle
                    class="icon-btn model-btn"
                    @click="showModelDialog = true"
                  >
                    <template #icon>
                      <img
                        :src="getVendorLogo(selectedVendor?.vendor || 'unknown')"
                        class="model-vendor-logo"
                        draggable="false"
                      />
                    </template>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('chatHistory')" placement="top">
                  <el-button
                    v-if="!isCapsuleMode"
                    @click="showHistoryDialog = true"
                    class="icon-btn history-btn"
                    :type="conversations.length === 0 ? 'default' : 'primary'"
                    circle>
                    <i class="fa-solid fa-clock-rotate-left"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('extension')" placement="top">
                  <el-button
                    v-if="!isMobile"
                    @click="openExtensionsDialog"
                    class="icon-btn history-btn"
                    :type="!sidePanelURL ? 'default' : 'primary'"
                    circle>
                    <i class="fa-solid fa-puzzle-piece"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="allBriefly ? t('allNoBriefly'):t('allBriefly')" placement="top">
                  <el-button
                    @click="handleAllBriefly"
                    class="icon-btn history-btn"
                    v-if="MoreButtonDict.find(b => b.name === 'brieflyButton')?.enabled&&!isCapsuleMode"
                    :type="allBriefly ? 'primary' : 'default'"
                    circle>
                    <i class="fa-solid fa-asterisk"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="isInputExpanded ? t('collapseInput') : t('expandInput')" placement="top">
                    <el-button 
                        @click="toggleInputExpand"
                        class="icon-btn expand-btn"
                        v-if="MoreButtonDict.find(b => b.name === 'expandButton')?.enabled&&!isCapsuleMode"
                        :type="isInputExpanded ? 'primary' : 'default'"
                        circle>
                        <i :class="isInputExpanded ? 'fa-solid fa-down-left-and-up-right-to-center' : 'fa-solid fa-up-right-and-down-left-from-center'"></i>
                    </el-button>
                </el-tooltip>

                <el-tooltip :content="t('uploadFile')" placement="top">
                  <el-button
                    @click="sendFiles"
                    class="icon-btn file-btn"
                    :type="hasFiles ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'fileButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-paperclip"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('uploadImage')" placement="top">
                  <el-button
                    @click="sendImages"
                    class="icon-btn image-btn"
                    :type="hasImages ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'imageButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-image"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('deepThinking')" placement="top">
                  <el-button
                    @click="reasonerSettings.enabled = !reasonerSettings.enabled; autoSaveSettings()"
                    class="icon-btn deep-think-btn"
                    :type="reasonerSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'reasonerButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-atom"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('deepResearch')" placement="top">
                  <el-button
                    @click="toolsSettings.deepsearch.enabled = !toolsSettings.deepsearch.enabled; autoSaveSettings()"
                    class="icon-btn deep-search-btn"
                    :type="toolsSettings.deepsearch.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'deepSearchButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-flask"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('vision')" placement="top">
                  <el-button
                    @click="visionSettings.enabled = !visionSettings.enabled; autoSaveSettings()"
                    class="icon-btn vision-btn"
                    :type="visionSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'visionButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-camera"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('desktopVisionButton')" placement="top">
                  <el-button
                    @click="visionSettings.desktopVision = !visionSettings.desktopVision; autoSaveSettings()"
                    class="icon-btn vision-btn"
                    :type="visionSettings.desktopVision ? 'primary' : 'default'"
                    v-if="isElectron&&(MoreButtonDict.find(b => b.name === 'desktopVisionButton')?.enabled||isCapsuleMode)"
                    circle>
                    <i class="fa-solid fa-eye"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('screenshot')" placement="top">
                  <el-button
                    @click="toggleScreenshot(true)"
                    class="icon-btn vision-btn"
                    type="default"
                    v-if="isElectron&&(MoreButtonDict.find(b => b.name === 'screenshotButton')?.enabled||isCapsuleMode)"
                    circle>
                    <i class="fa-solid fa-scissors"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('imgGen')" placement="top">
                  <el-button
                    @click="text2imgSettings.enabled = !text2imgSettings.enabled; autoSaveSettings()"
                    class="icon-btn text2img-btn"
                    :type="text2imgSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'text2imgButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-pencil"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('asr')" placement="top">
                  <el-button
                    @click="toggleASR"
                    class="icon-btn asr-btn"
                    :type="asrSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'asrButton')?.enabled||isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-microphone"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('tts')" placement="top">
                  <el-button
                    @click="ttsSettings.enabled=!ttsSettings.enabled;changeTTSstatus();"
                    class="icon-btn asr-btn"
                    :type="ttsSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'ttsButton')?.enabled||isCapsuleMode"
                    circle>
                    <i v-if="ttsSettings.enabled" class="fa-solid fa-volume-high"></i>
                    <i v-else class="fa-solid fa-volume-xmark"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('knowledgeBase')" placement="top">
                  <el-button
                    @click="showKnowledgeDialog = true"
                    class="icon-btn knowledge-base-btn"
                    :type="hasEnabledKnowledgeBases ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'knowledgeBaseButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-book"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('webSearch')" placement="top">
                  <el-button
                    @click="webSearchSettings.enabled = !webSearchSettings.enabled; autoSaveSettings()"
                    class="icon-btn web-search-btn"
                    :type="webSearchSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'webSearchButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-globe"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('memory')" placement="top">
                  <el-button
                    @click="showMemoryDialog = true"
                    class="icon-btn web-search-btn"
                    :type="memorySettings.is_memory ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'memoryButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-brain"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('a2ui')" placement="top">
                  <el-button
                    @click="toolsSettings.a2ui.enabled = !toolsSettings.a2ui.enabled; autoSaveSettings()"
                    class="icon-btn ui-btn"
                    :type="toolsSettings.a2ui.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'uiButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-icons"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('interpreter')" placement="top">
                  <el-button
                    @click="codeSettings.enabled = !codeSettings.enabled; autoSaveSettings()"
                    class="icon-btn web-search-btn"
                    :type="codeSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'codeButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-code"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('CLItool')" placement="top">
                  <el-button
                    :disabled="!isElectron"
                    @click="CLISettings.enabled = !CLISettings.enabled; autoSaveSettings()"
                    class="icon-btn web-search-btn"
                    :type="CLISettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'CLIButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-terminal"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('sticker')" placement="top">
                  <el-button
                    @click="showStickerPacksDialog = true"
                    class="icon-btn sticker-btn"
                    :type="hasEnabledStickerPacks ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'stickerButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-face-smile"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('homeAssistant')" placement="top">
                  <el-button
                    @click="HASettings.enabled = !HASettings.enabled; changeHAEnabled();"
                    class="icon-btn homeAssistant-btn"
                    :type="HASettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'haButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-house"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('browserControl')" placement="top">
                  <el-button
                    @click="chromeMCPSettings.enabled = !chromeMCPSettings.enabled; changeChromeMCPEnabled();"
                    class="icon-btn browserControl-btn"
                    :type="chromeMCPSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'chromeButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-compass"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('sqlControl')" placement="top">
                  <el-button
                    @click="sqlSettings.enabled = !sqlSettings.enabled; changeSqlEnabled();"
                    class="icon-btn sqlControl-btn"
                    :type="sqlSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'sqlButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-database"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('agentSnapshot')" placement="top">
                  <el-button
                    @click="showAgentDialog = true"
                    class="icon-btn agent-btn"
                    :type="hasAgentChanges ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'agentButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-robot"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('llmTools')" placement="top">
                  <el-button
                    @click="showLLMToolsDialog = true"
                    class="icon-btn llm-tool-btn"
                    :type="hasEnabledLLMTools ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'llmButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-cube"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('mcpServers')" placement="top">
                  <el-button
                    @click="showMCPServerDialog = true"
                    class="icon-btn mcp-btn"
                    :type="hasEnabledMCPServers ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'mcpButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-server"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('a2aServers')" placement="top">
                  <el-button
                    @click="this.showA2AServerDialog = true"
                    class="icon-btn a2a-btn"
                    :type="hasEnabledA2AServers ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'a2aButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-network-wired"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('customHttpTool')" placement="top">
                  <el-button
                    @click="this.showHttpToolDialog = true"
                    class="icon-btn http-btn"
                    :type="hasEnabledHttpTools ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'httpButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-wifi"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('ComfyUI')" placement="top">
                  <el-button
                    @click="this.showComfyUIDialog = true"
                    class="icon-btn comfyui-btn"
                    :type="hasEnabledComfyUI ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'comfyuiButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-palette"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('tablePet')" placement="top">
                  <el-button
                    @click="startVRM"
                    class="icon-btn vrm-btn"
                    :type="'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'vrmButton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i :class='isVRMStarting? "fa-solid fa-spinner fa-spin" : "fa-solid fa-user-ninja"'></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="t('enableAutoBehavior')" placement="top">
                  <el-button
                    @click="behaviorSettings.enabled=!behaviorSettings.enabled; autoSaveSettings();"
                    class="icon-btn behavior-btn"
                    :type="behaviorSettings.enabled ? 'primary' : 'default'"
                    v-if="MoreButtonDict.find(b => b.name === 'behaviorBotton')?.enabled&&!isCapsuleMode"
                    circle>
                    <i class="fa-solid fa-person-running"></i>
                  </el-button>
                </el-tooltip>

                <!-- 1. 群聊模式开关 -->
                <el-tooltip :content="t('groupChatSettings')" placement="top">
                  <el-button 
                    v-if="MoreButtonDict.find(b => b.name === 'groupChatBotton')?.enabled && !isCapsuleMode"
                    @click="showGroupSettingsDialog = true"
                    class="icon-btn group-chat-btn"
                    :type="isGroupMode ? 'primary' : 'default'"
                    circle>
                    <i class="fa-solid fa-users"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip :content="isSending ? t('stopGenerating') : t('sendMessage')" placement="top">
                  <el-button
                    v-if="!isCapsuleMode"
                    @click="isSending ? stopGenerate() : sendMessage()"
                    :type="isSending ? 'danger' : 'primary'"
                    class="icon-btn send-btn"
                    circle>
                    <i :class="isSending ? 'fa-solid fa-stop' : 'fa-solid fa-paper-plane'" aria-hidden="true"></i>
                  </el-button>
                </el-tooltip>
                <!--展开收起按钮-->
                <el-tooltip :content="t('moreButton')" placement="top">
                  <el-button v-if="!isCapsuleMode" @click="showMoreButtonDialog = true" class="icon-btn collapse-btn" circle>
                    <i class="fa-solid fa-ellipsis"></i>
                  </el-button>
                </el-tooltip>
              </div>
              <div class="input-container" v-if="!isCapsuleMode">
                
                <!-- ✨✨✨ 新增：统一的外层包裹器 ✨✨✨ -->
                <!-- tabindex="-1" 是为了让 focus-within 生效更稳定 -->
                <div class="unified-input-wrapper">
                  
                  <!-- 1. 附件预览区域 -->
                  <div class="attachment-preview-list" v-show="allItems.length > 0">
                    <div v-for="(item, index) in allItems" :key="index" class="attachment-item">
                      
                      <!-- 图片类型 -->
                      <div v-if="item.type === 'image'" class="preview-image-box">
                        <img :src="item.path" alt="preview" />
                        <div class="overlay">
                          <el-button 
                            type="danger" 
                            circle 
                            size="small" 
                            @click.stop="removeItem(index, item.type)"
                          >
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </div>
                      </div>

                      <!-- 文件类型 -->
                      <div v-else class="file-card-box">
                        <div class="file-icon">
                          <i class="fa-solid fa-file-lines"></i>
                        </div>
                        <div class="file-info">
                          <span class="file-name" :title="item.name">{{ item.name }}</span>
                        </div>
                        <div class="remove-btn" @click.stop="removeItem(index, item.type)">
                          <i class="fa-solid fa-xmark"></i>
                        </div>
                      </div>

                    </div>
                  </div>

                  <!-- 2. 输入框 -->
                  <!-- 注意：这里的 class 是 input-box-transparent -->
                  <el-input
                    v-model="userInput"
                    type="textarea"
                    :rows="isMobile?(isInputExpanded ? 8 : 3):(isInputExpanded ? 16 : 4)"
                    :placeholder="t('inputMessage')"
                    resize="none"
                    @keydown="isInputting=true;handleKeyDown($event)" 
                    @keyup="isInputting=false"
                    @paste.native="handleInputPaste"
                    class="input-box-transparent">
                  </el-input>
                  
                </div> <!-- 结束 unified-input-wrapper -->
              </div>
            </div>
            <!-- 可拖拽的分割条 -->
            <div
              v-if="!isCapsuleMode && !isAssistantMode && !isMobile"
              class="resizer"
              ref="resizerRef"
              :class="{ 
                'resizer-collapsed-right': !sidePanelOpen,
                'resizer-collapsed-left': !chatAreaOpen
              }"
              @mousedown="startResize"
              @click="handleResizerClick"
            >
              <div class="resizer-handle">
                <div class="resizer-dots" v-if="chatAreaOpen && sidePanelOpen">
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                </div>

                <div 
                    v-if="!chatAreaOpen"
                    class="browser-toggle-handle--left"
                    @click.stop="expandChatArea"
                >
                    <!-- 图标逻辑：面板打开时显示向右箭头(收起)，关闭时显示向左箭头(展开) -->
                    <i class='fa-solid fa-chevron-right'></i>
                </div>

                <div 
                    v-if="!sidePanelOpen"
                    class="browser-toggle-handle"
                    @click.stop="expandSidePanel"
                >
                    <!-- 图标逻辑：面板打开时显示向右箭头(收起)，关闭时显示向左箭头(展开) -->
                    <i class='fa-solid fa-chevron-left'></i>
                </div>
              </div>
            </div>

            <!-- 侧边栏区域 -->
            <div class="side-panel" 
                ref="sidePanelRef"
                :class="{ collapsed: !sidePanelOpen }" 
                v-show="sidePanelOpen">
              <div class="side-panel-scroll" ref="messagesPanel" :style="{ overflow: 'hidden' }">
                <iframe class="side-panel-iframe" 
                        v-if="sidePanelURL" 
                        :src="sidePanelURL" 
                        frameborder="0" 
                        allowfullscreen 
                        style="width: 100%; height: 100%;">
                </iframe>
                <div v-else-if="currentExtension" class="loading-container">
                  <div class="loading-content">
                    <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
                    <p class="loading-text">{{t('waitForLoadingExt')}}</p>
                  </div>
                </div>
                <div v-else class="extensions-list" style="margin: 10px;height: 100%;">
                  <!-- 默认视图选项 -->
                  <el-card 
                    class="extension-card default-view-card"
                    :class="{ active: currentExtension === null }"
                    @click="resetToDefaultView()">
                    <div class="extension-info">
                      <h3>{{ t('defaultView') }}</h3>
                      <p>{{ t('defaultViewDescription') }}</p>
                    </div>
                  </el-card>
                  
                  <!-- 分隔线 -->
                  <div class="extensions-divider" v-if="extensions.length > 0">
                    <span>
                      {{ t('availableExtensions') }}
                      <el-link
                        type="primary"
                        :underline="false"
                        href="#" 
                        @click.stop.prevent="switchToExtensionPage" 
                      >
                        <el-icon class="mr-1">
                          <i class="fa-solid fa-puzzle-piece"></i>
                        </el-icon>{{ t('goToExtensionPage') }}
                      </el-link>
                    </span>
                  </div>
                  <!-- 扩展列表 -->
                  <el-empty v-if="extensions.length === 0" :description="t('noExtensionsFound')" ></el-empty>
                    <el-card
                      v-for="ext in extensions"
                      :key="ext.id"
                      class="extension-card"
                      :class="{ active: currentExtension && currentExtension.id === ext.id }"
                      @click="switchExtension(ext)">
                      
                      <!-- 右上角图标 -->
                      <div class="btn-top-right">
                        <el-tooltip :content="t('openExtensionInBrowser')" placement="top">
                          <!-- 浏览器打开按钮 -->
                          <el-button
                            type="default"
                            circle
                            size="small"
                            @click.stop="openExtension(ext)">
                            <i class="fa-solid fa-external-link"></i>
                          </el-button>
                        </el-tooltip>
                        <el-tooltip :content="t('openExtensionInWindow')" placement="top">
                          <!-- 独立窗口打开按钮（仅在Electron环境下显示） -->
                          <el-button
                            v-if="isElectron"
                            type="primary"
                            circle
                            size="small"
                            @click.stop="openExtensionInWindow(ext)"
                            style="margin-left: 8px;">
                            <i class="fa-solid fa-window-restore"></i>
                          </el-button>
                        </el-tooltip>
                      </div>

                      <div class="extension-info">
                        <h3>{{ ext.name }}</h3>
                        <p>{{ ext.description }}</p>
                        <div class="extension-meta">
                          <span>v{{ ext.version }}</span>
                          <span>{{ ext.author }}</span>
                        </div>
                      </div>
                    </el-card>
                </div>
              </div>
            </div>
          </div>
          <!-- 群聊设置弹窗 -->
          <el-dialog
            v-model="showGroupSettingsDialog"
            :title="t('groupChatSettings')"
            width="500px">
            <div class="knowledge-dialog-content">
              
              <!-- 1. 开启/关闭群聊模式 -->
              <el-form-item :label="t('enableGroupChat')" class="form-item-align" label-position="left">
                <el-switch
                  v-model="isGroupMode"
                  @change="autoSaveSettings"
                ></el-switch>
              </el-form-item>

              <!-- 2. 选择群聊成员 -->
              <div class="group-settings-area" style="margin-top: 20px;">
                <div style="margin-bottom: 10px; font-weight: bold;">{{ t('selectGroupAgents') }}</div>
                
                <el-select 
                    v-model="selectedGroupAgents" 
                    multiple 
                    placeholder="Select"
                    style="width: 100%;">
                    
                    <!-- 第一组：角色记忆 (Memories) -->
                    <el-option-group :label="t('characterRoles')">
                        <el-option
                            v-for="m in memories"
                            :key="'mem_' + m.id"
                            :label="m.name"
                            :value="'memory/' + m.id + '/super-model'">
                            <span style="float: left">
                                <i class="fa-solid fa-brain" style="margin-right: 8px;"></i>{{ m.name }}
                            </span>
                        </el-option>
                    </el-option-group>

                    <!-- 第二组：智能体 (Agents) -->
                    <el-option-group :label="t('agents')">
                        <el-option :label="t('defaultAgent')" value="super-model">
                            <span style="float: left">
                                <i class="fa-solid fa-robot" style="margin-right: 8px;"></i>{{ t('defaultAgent') }}
                            </span>
                        </el-option>
                        <el-option
                            v-for="(agent, id) in agents"
                            :key="id"
                            :label="agent.name"
                            :value="id">
                            <span style="float: left">
                                <i class="fa-solid fa-microchip" style="margin-right: 8px;"></i>{{ agent.name }}
                            </span>
                        </el-option>
                    </el-option-group>
                </el-select>
                
                <div class="tip-text" style="margin-top: 10px; color: #909399; font-size: 12px;">
                    <i class="fa-solid fa-circle-info"></i> {{ t('groupChatTip') || 'Selected agents will respond based on context.' }}
                </div>
              </div>
            </div>
          </el-dialog>
          <el-dialog
            v-model="showEditDialog"
            :title="editType === 'system' ? t('editSystemPrompt') : t('editMessage')"
            width="600px">
            <el-form-item v-if="editType === 'system'" :label="t('selectSystemPrompt')" class="form-item-align" label-position="left">
              <el-select 
                v-model="selectSystemPromptId" 
                :placeholder="t('selectSystemPromptPlaceholder')"
                class="full-width-input"
                @change="changeSystemPrompt"
                >
                <el-option
                  v-for="prompt in SystemPromptsList"
                  :key="prompt.id"
                  :label="prompt.name"
                  :value="prompt.id"
                />
              </el-select>
            </el-form-item>
            <el-input
              v-model="editContent"
              type="textarea"
              :rows="18"
              :placeholder="t('enterContent')"
            ></el-input>
            <template #footer>
              <el-button @click="showEditDialog = false">{{ t('cancel') }}</el-button>
              <el-button @click="switchToSystemPrompts" v-if="editType === 'system'">{{ t('addSystemPrompt') }}</el-button>
              <el-button type="primary" @click="saveEdit">{{ editType === 'user' ? t('modifyAndSend'):t('save') }}</el-button>
            </template>
          </el-dialog>
            <!-- 文件上传对话框 -->
            <el-dialog
              v-model="showUploadDialog"
              :title="currentUploadType==='file' ? t('uploadFile') : t('uploadImage')"
              width="600px"
              :before-close="() => showUploadDialog = false">

              <div class="upload-container">
                <!-- 可点击的拖拽区域 -->
                <div
                  class="drop-zone"
                  @dragover.prevent
                  @drop.prevent="handleDrop"
                  @click="browseFiles"
                >
                  <el-icon :size="50"><upload /></el-icon>
                  <p>{{ t('clickOrDrop') }}</p>
                </div>
              </div>
            </el-dialog>
            <el-dialog
              v-model="showKnowledgeDialog"
              :title="t('knowledgeBaseSelection')"
              width="600px">
              <div class="knowledge-dialog-content">
                <div v-for="kb in knowledgeBases" :key="kb.id" class="knowledge-item">
                  <el-switch v-model="kb.enabled" @change="autoSaveSettings"></el-switch>
                  <div class="knowledge-info">
                    <div class="knowledge-name">{{ kb.name }}</div>
                    <div class="knowledge-desc">{{ kb.introduction || t('noDescription') }}</div>
                  </div>
                </div>
                <div v-if="knowledgeBases.length === 0" class="empty-tip">
                  {{ t('noKnowledgeBase') }}
                  <a href="#" @click.stop.prevent="switchToKnowledgePage">{{ t('goToKnowledgeBase') }}</a>
                  {{ t('add') }}
                </div>
              </div>
            </el-dialog>
          <el-dialog
            v-model="showMemoryDialog"
            :title="t('memory')"
            width="600px">
            <div class="knowledge-dialog-content">
              <el-form-item :label="t('memoryEnable')" class="form-item-align" label-position="left">
                <el-switch
                  v-model="memorySettings.is_memory"
                  @change="changeMemory"
                ></el-switch>
              </el-form-item>
              <el-form-item :label="t('resultCount')" class="form-item-align">
                <el-slider
                  v-model="memorySettings.memoryLimit"
                  :min="1"
                  :max="20"
                  :step="1"
                  show-input
                  @input="autoSaveSettings"
                />
              </el-form-item>
              <el-form-item :label="t('selectMemory')">
                <el-select 
                  v-model="memorySettings.selectedMemory" 
                  :placeholder="t('selectMemoryPlaceholder')"
                  class="full-width-input"
                  @change="changeMemory"
                  >
                  <el-option
                    v-for="memory in memories"
                    :key="memory.id"
                    :label="memory.name"
                    :value="memory.id"
                  />
                </el-select>
              </el-form-item>
              <el-form-item v-if="ttsSettings.newtts.length > 0 " :label="t('availableVoice')"></el-form-item>
              <div class="knowledge-dialog-content">
                <div v-for="(config, name) in ttsSettings.newtts" :key="name" class="knowledge-item">
                  <el-switch v-model="config.enabled" @change="autoSaveSettings"></el-switch>
                  <div class="knowledge-info">
                    <div class="knowledge-name">{{ name }}</div>
                  </div>
                </div>
              </div>
            </div>
          </el-dialog>
          <el-dialog
            v-model="showAgentDialog"
            :title="t('agentSettings')"
            width="600px">
            <div class="agent-dialog-content">
              <!-- 主智能体选择 -->
              <div class="agent-section">
                <h3>{{ t('mainAgent') }}</h3>
                <el-select 
                  v-model="mainAgent"
                  @change="changeMainAgent">
                  <el-option
                    :label="t('defaultAgent')"
                    value="super-model"
                  >
                  </el-option>
                  <el-option
                    v-for="(agent, id) in agents"
                    :key="id"
                    :label="agent.name"
                    :value="id"
                  >
                  </el-option>
                </el-select>
              </div>
              <!-- 工具智能体选择 -->
              <div class="agent-section">
                <h3>{{ t('toolAgents') }}</h3>
                <div 
                  v-for="(agent, id) in agents" 
                  :key="id"
                  class="knowledge-item">
                  <el-switch 
                    v-model="agent.enabled"
                    @change="autoSaveSettings">
                  </el-switch>
                  <div class="knowledge-info">
                    <div class="knowledge-name">{{ agent.name }}</div>
                  </div>
                </div>
                <div v-if="Object.keys(agents).length === 0" class="empty-tip">
                  {{ t('noagents') }}
                  <a href="#" @click.stop.prevent="switchToagents">{{ t('goToagents') }}</a>
                  {{ t('add') }}
                </div>
              </div>
            </div>
          </el-dialog>
          <el-dialog
            v-model="showMCPServerDialog"
            :title="t('mcpServersManagement')"
            width="600px">
            <div class="knowledge-dialog-content">
              <!-- 服务器列表 -->
              <div v-for="(server, name) in mcpServers" :key="name" class="knowledge-item">
                <el-switch 
                  :active-value="false"  
                  :inactive-value="true" 
                  v-model="server.disabled" 
                  :disabled="server.processingStatus === 'server_error'"
                  @change="autoSaveSettings">
                </el-switch>
                <div class="knowledge-info">
                  <div class="knowledge-name">{{ name }}</div>
                </div>
              </div>
              <div v-if="Object.keys(mcpServers).length === 0" class="empty-tip">
                {{ t('nomcpServers') }}
                <a href="#" @click.stop.prevent="switchTomcpServers">{{ t('goTomcpServers') }}</a>
                {{ t('add') }}
              </div>
            </div>
          </el-dialog>
          <el-dialog
            v-model="showA2AServerDialog"
            :title="t('a2aServersManagement')"
            width="600px">
            <div class="knowledge-dialog-content">
              <div v-for="(server, url) in a2aServers" :key="url" class="knowledge-item">
                <el-switch v-model="server.enabled" @change="autoSaveSettings"></el-switch>
                <div class="knowledge-info">
                  <div class="knowledge-name">{{ server.name }}</div>
                  <div class="knowledge-desc">{{ server.description }}</div>
                </div>
              </div>
              <div v-if="Object.keys(a2aServers).length === 0" class="empty-tip">
                {{ t('noA2AServers') }}
                <a href="#" @click.stop.prevent="switchToa2aServers">{{ t('addA2AServer') }}</a>
                {{ t('add') }}
              </div>
            </div>
          </el-dialog>
          <el-dialog
            v-model="showLLMToolsDialog"
            :title="t('llmToolsManagement')"
            width="600px">
            <div class="knowledge-dialog-content">
              <div v-for="(tool, index) in llmTools" :key="index" class="knowledge-item">
                <el-switch v-model="tool.enabled" @change="autoSaveSettings"></el-switch>
                <div class="knowledge-info">
                  <div class="knowledge-name">{{ tool.name }}</div>
                  <div class="knowledge-desc">{{ tool.description || t('noDescription') }}</div>
                </div>
                <el-button 
                  @click="removeLLMTool(index)" 
                  type="danger" 
                  circle 
                  size="small">
                  <i class="fa-solid fa-trash"></i>
                </el-button>
              </div>
              <div v-if="llmTools.length === 0" class="empty-tip">
                {{ t('noLLMTools') }}
                <a href="#" @click.stop.prevent="switchTollmTools">{{ t('gollmTools') }}</a>
                {{ t('add') }}
              </div>
            </div>
          </el-dialog>
          <el-dialog
            v-model="showComfyUIDialog"
            :title="t('ComfyUIManagement')"
            width="600px">
            <div class="knowledge-dialog-content">
              <div v-for="(tool, index) in workflows" :key="index" class="knowledge-item">
                <el-switch v-model="tool.enabled" @change="autoSaveSettings"></el-switch>
                <div class="knowledge-info">
                  <div class="knowledge-name">{{ tool.original_filename }}</div>
                  <div class="knowledge-desc">{{ tool.description || t('noDescription') }}</div>
                </div>
                <el-button 
                  @click="deleteWorkflow(tool.unique_filename)" 
                  type="danger" 
                  circle 
                  size="small">
                  <i class="fa-solid fa-trash"></i>
                </el-button>
              </div>
              <div v-if="workflows.length === 0" class="empty-tip">
                {{ t('noWorkflows') }}
                <a href="#" @click.stop.prevent="switchToComfyui">{{ t('goComfyui') }}</a>
                {{ t('add') }}
              </div>
            </div>
          </el-dialog>
          <el-dialog
            v-model="showStickerPacksDialog"
            :title="t('StickerPackManagement')"
            width="600px">
            <div class="knowledge-dialog-content">
              <div v-for="(pack, index) in stickerPacks" :key="index" class="knowledge-item">
                <el-switch v-model="pack.enabled" @change="autoSaveSettings"></el-switch>
                <div class="knowledge-info">
                  <div class="knowledge-name">{{ pack.name }}</div>
                </div>
                <el-button 
                  @click="deleteStickerPack(pack)" 
                  type="danger" 
                  circle 
                  size="small">
                  <i class="fa-solid fa-trash"></i>
                </el-button>
              </div>
              <div v-if="stickerPacks.length === 0" class="empty-tip">
                {{ t('noStickerPack') }}
                <a href="#" @click.stop.prevent="switchToStickerPacks">{{ t('goStickerPack') }}</a>
                {{ t('add') }}
              </div>
            </div>
          </el-dialog>
          <el-dialog
            v-model="showMoreButtonDialog"
            :title="t('showMoreButton')"
            width="600px">
            <div class="knowledge-dialog-content">
              <div v-for="(config, index) in MoreButtonDict" :key="index" class="knowledge-item">
                <el-switch v-model="config.enabled" @change="autoSaveSettings"></el-switch>
                <div class="knowledge-info">
                  <div class="knowledge-name">{{ t(config.name) }}</div>
                </div>
              </div>
            </div>
          </el-dialog>
        </div>

        <el-dialog
          v-model="showHistoryDialog"
          :title="t('chatHistory')"
          width="600px">
          <div class="knowledge-dialog-content">
            <!-- 搜索框与操作按钮行 -->
            <div class="search-action-row">
              <el-input
                v-model="searchKeyword"
                :placeholder="t('searchChatHistoryPlaceholder')"
                clearable
                class="search-input"
                style="flex:1">
                <template #prefix>
                  <el-icon><i class="fa-solid fa-magnifying-glass"></i></el-icon>
                </template>
              </el-input>

              <div class="action-buttons">
                <el-tooltip 
                  :content="t('keepLastWeek')" 
                  placement="top"
                  :disabled="conversations.length === 0">
                  <el-button 
                    type="info"
                    circle 
                    size="small"
                    @click="keepLastWeek"
                    :disabled="conversations.length === 0">
                    <i class="fa-solid fa-calendar-week"></i>
                  </el-button>
                </el-tooltip>

                <el-tooltip 
                  :content="t('clearAllHistory')" 
                  placement="top"
                  :disabled="conversations.length === 0">
                  <el-button 
                    type="danger"
                    circle 
                    size="small"
                    @click="confirmClearAll"
                    :disabled="conversations.length === 0">
                    <i class="fa-solid fa-trash-can"></i>
                  </el-button>
                </el-tooltip>
              </div>
            </div>

            <!-- 对话记录列表 -->
            <div v-for="conv in filteredConversations" 
                :key="conv.id" 
                class="knowledge-item"
                @click="loadConversation(conv.id)">
              <el-button 
                @click.stop="confirmDeleteConversation(conv.id)"
                type="danger" 
                circle 
                size="small">
                <i class="fa-solid fa-trash"></i>
              </el-button>
              <div class="knowledge-info">
                <h3 class="knowledge-name">{{ conv.title || t('untitled') }}</h3>
                <div class="knowledge-desc">
                  <el-icon class="meta-icon"><i class="fa-solid fa-message"></i></el-icon>
                  <span>{{ conv.messages?.length || 0 }} {{ t('messages') }}</span><br>
                  <el-icon class="meta-icon"><i class="fa-solid fa-clock"></i></el-icon>
                  <span>{{ formatDate(conv.timestamp) }}</span>
                </div>
              </div>
            </div>

            <!-- 空状态提示 -->
            <div v-if="filteredConversations.length === 0" class="empty-tip">
              {{ searchKeyword ? t('noResults') : t('noChatHistory') }}
            </div>
          </div>
        </el-dialog>

        <div v-show="activeMenu === 'role'" class="page agent-suite-container">
          <div class="suite-layout">
            <!-- 左侧二级导航 -->
            <div class="suite-sidebar">
              <div class="tile-nav">
                <div 
                  v-for="tile in roleTiles" 
                  :key="tile.id"
                  class="nav-item"
                  :class="{ active: subMenu === tile.id }"
                  @click="subMenu = tile.id">
                  <el-icon class="nav-icon"><i :class="tile.icon"></i></el-icon>
                  <span class="nav-text">{{ t(tile.title) }}</span>
                </div>
              </div>
            </div>
            <!-- 右侧内容区 -->
            <div class="suite-content">
              <!-- 角色卡 -->
              <div v-show="subMenu === 'memory'" class="page">
                <el-tabs v-model="activeMemoryTab">
                  <!-- 记忆配置标签页 -->
                  <el-tab-pane :label="t('memoryConfig')" name="config">
                    <el-form :model="memorySettings" class="settings-form"  label-position="top">
                      <div class="tool-item">
                        <div class="tool-header">
                          <div class="header-left">
                            <span>
                              <el-icon>
                                <i class="fa-solid fa-brain"></i>
                              </el-icon>
                              {{ t('memory') }}
                              <el-link
                                type="primary"
                                :underline="false"
                                href="https://github.com/SillyTavern/SillyTavern" 
                                target="_blank"
                              >
                                <el-icon class="mr-1">
                                  <i class="fa-solid fa-key"></i>
                                </el-icon>{{ t('gotoGithub') }}
                              </el-link>
                            </span>
                          </div>
                          <el-switch v-model="memorySettings.is_memory" @click.stop @change="changeMemory"/>
                        </div>
                        <div class="tool-content">
                          <el-form-item :label="t('memoryResultCount')" class="form-item-align">
                            <el-slider
                              v-model="memorySettings.memoryLimit"
                              :min="1"
                              :max="20"
                              :step="1"
                              show-input
                              @input="autoSaveSettings"
                            />
                          </el-form-item>
                          <el-alert type="info" :closable="false" class="mb-2">
                            <template #default>
                              <div class="alert-content">
                                {{ t('longTermMemoryNote') }}
                              </div>
                            </template>
                          </el-alert>
                          <el-form-item :label="t('selectMemory')">
                            <el-select 
                              v-model="memorySettings.selectedMemory" 
                              :placeholder="t('selectMemoryPlaceholder')"
                              class="full-width-input"
                              @change ="changeMemory"
                              >
                              <el-option
                                v-for="memory in memories"
                                :key="memory.id"
                                :label="memory.name"
                                :value="memory.id"
                              />
                            </el-select>
                          </el-form-item>
                          <el-form-item :label="t('userName')" class="form-item-align">
                            <el-input
                              v-model="memorySettings.userName"
                              :placeholder="t('userNamePlaceholder')"
                              @input="autoSaveSettings"
                              class="full-width-input"
                            />
                          </el-form-item>
                          <el-form-item :label="t('genericSystemPrompt')" class="form-item-align">
                            <el-input
                              v-model="memorySettings.genericSystemPrompt"
                              :placeholder="t('genericSystemPromptPlaceholder')"
                              type="textarea"
                              :rows="3"
                              @input="autoSaveSettings"
                              class="full-width-input"
                            />
                          </el-form-item>
                        </div>
                      </div>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('minilmNotice3') }}
                          </div>
                        </template>
                      </el-alert>
                      <!-- Minilm ONNX 卡片 -->
                      <el-card
                        shadow="hover"
                        class="sherpa-card"
                      >
                        <!-- 卡片头部：标题 + 安装状态 -->
                        <div class="card-header d-flex justify-content-between align-items-center">
                          <!-- 左侧标题 -->
                          <span><strong>Paraphrase Multilingual MiniLM L12 v2</strong></span>

                          <!-- 右侧 tag 组 -->
                          <div class="d-flex gap-2">
                            <el-tag type="info" effect="dark">
                              224MB
                            </el-tag>

                            <el-tag
                              :type="minilmModelExists ? 'success' : 'info'"
                              effect="dark"
                            >
                              {{ minilmModelExists ? t('installed') : t('notInstalled') }}
                            </el-tag>
                          </div>
                        </div>


                        <!-- 操作按钮区 -->
                        <div class="card-actions">
                          <!-- 左侧：两个下载按钮 -->
                          <div class="left-actions">
                            <el-button
                              type="primary"
                              :disabled="minilmModelExists || minilmDownloading"
                              :loading="minilmDownloading && source==='modelscope'"
                              @click="minilmDownload('modelscope')"
                            >
                              {{ t('downloadFromModelScope') }}
                            </el-button>

                            <el-button
                              type="primary"
                              :style="{ margin: '0' }"
                              :disabled="minilmModelExists || minilmDownloading"
                              :loading="minilmDownloading && source==='huggingface'"
                              @click="minilmDownload('huggingface')"
                            >
                              {{ t('downloadFromHuggingFace') }}
                            </el-button>
                          </div>

                          <!-- 右侧：删除按钮 -->
                          <el-button
                            v-if="minilmModelExists"
                            type="danger"
                            @click="minilmRemove"
                          >
                            {{ t('deleteModel') }}
                          </el-button>
                        </div>


                        <!-- 进度条（固定在底部） -->
                        <el-progress
                          v-if="minilmDownloading"
                          :percentage="minilmPercent"
                          style="margin-top: 16px;"
                          :stroke-width="10"
                        ></el-progress>
                      </el-card>
                    </el-form>
                  </el-tab-pane>
                  <!-- 添加新记忆标签页 -->
                  <el-tab-pane :label="t('addNewMemory')" name="add">
                    <!-- 向量库交互 Dialog -->
                    <el-dialog
                      v-model="vectorDialogVisible"
                      :title="t('vectorInteractTitle') + ' —— ' + vectorDialogMemoryName"
                      width="80%"
                    >
                      <div v-loading="vectorLoading">
                        <el-table :data="vectorTable" stripe height="400">
                          <el-table-column prop="idx" label="#" width="60" ></el-table-column>
                          <el-table-column prop="text" :label="t('memoryText')"></el-table-column>
                          <el-table-column prop="created_at" :label="t('createTime')"width="160"></el-table-column>
                          <el-table-column prop="timetamp" :label="t('lastTime')" width="160" ></el-table-column>
                          <el-table-column width="100">
                            <template #default="{ $index }">
                              <el-button circle @click="startEditRow($index)">
                                <i class="fa-solid fa-pen"></i>
                              </el-button>
                              <el-button circle type="danger" @click="deleteVectorRow(vectorTable[$index].idx)">
                                <i class="fa-solid fa-trash"></i>
                              </el-button>
                            </template>
                          </el-table-column>
                        </el-table>
                      </div>

                      <!-- 底部统一关闭 -->
                      <template #footer>
                        <el-button @click="vectorDialogVisible = false">{{ t('close') }}</el-button>
                      </template>
                    </el-dialog>

                    <!-- 单行编辑小弹窗 -->
                    <el-dialog
                      v-model="editRowVisible"
                      width="40%"
                      :title="t('editText')"
                    >
                      <el-input v-model="editRowText" type="textarea" :rows="4" ></el-input>
                      <template #footer>
                        <el-button @click="editRowVisible = false">{{ t('cancel') }}</el-button>
                        <el-button type="primary" @click="submitEditRow">{{ t('confirm') }}</el-button>
                      </template>
                    </el-dialog>

                    <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px;">
                      <!-- 大输入框：限制最大宽度，让出空间给按钮 -->
                      <el-input
                        v-model="quickCreatePrompt"
                        type="textarea"
                        :rows="4"
                        :placeholder="t('quickGenPlaceholder')"
                      >
                      </el-input>
                      <!-- 生成按钮 -->
                      <el-tooltip :content="t('oneClickGenCard')" placement="top">
                        <el-button
                          type="primary"
                          size="large"
                          circle
                          style="margin: 0;"
                          :disabled="!quickCreatePrompt.trim()||isGenerating"
                          @click="handleQuickGen"
                        >
                          <i v-if="!isGenerating" class="fa-solid fa-wand-magic-sparkles"></i>
                          <i v-else class="fa-solid fa-spinner fa-spin"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip :content="t('stopGenCard')" placement="top">
                        <!-- 停止生成按钮 -->
                        <el-button
                          type="danger"
                          size="large"
                          circle
                          style="margin: 0;"
                          :disabled="!isGenerating"
                          @click="stopQuickGen"
                        >
                          <i class="fa-solid fa-stop"></i>
                        </el-button>
                      </el-tooltip>
                    </div>
                    <div class="provider-grid">
                      <!-- 已有记忆磁贴 -->
                      <div class="provider-card knowledge-card" v-for="memory in memories" :key="memory.id">
                        <div class="card-header">
                          <img 
                            :src="memory.avatar? memory.avatar : 'source/Avatar.png'" 
                            class="mini-vendor-logo"
                          />
                          <div class="card-actions">
                            <el-tooltip :content="t('vectorInteract')" placement="top">
                              <el-button
                                type="warning"
                                circle
                                size="small"
                                @click="openVectorDialog(memory.id)"
                                v-if="memory.providerId"
                              >
                                <i class="fa-solid fa-brain"></i>
                              </el-button>
                            </el-tooltip>
                            <el-tooltip :content="t('downloadMemory')" placement="top">
                              <el-button
                                @click="downloadMemory(memory)"
                                type="primary"
                                circle
                                size="small"
                              >
                                <i class="fa-solid fa-download"></i>
                              </el-button>
                            </el-tooltip>
                            <el-tooltip :content="t('editMemory')" placement="top">
                              <el-button
                                @click="editMemory(memory.id)"
                                :disabled="isGenerating"
                                type="default"
                                circle
                                size="small"
                              >
                                <i class="fa-solid fa-pen-to-square"></i>
                              </el-button>
                            </el-tooltip>
                            <el-tooltip :content="t('removeMemory')" placement="top">
                              <el-button
                                @click="removeMemory(memory.id)"
                                type="danger"
                                circle
                                size="small"
                              >
                                <i class="fa-solid fa-trash"></i>
                              </el-button>
                            </el-tooltip>
                          </div>
                        </div>
                        <div class="kb-content">
                          <h3 class="kb-title">{{memory.name }}</h3>
                          <div class="kb-meta">
                            <div class="kb-meta-item">
                              <el-icon class="kb-icon">
                                <i class="fa-solid fa-brain"></i>
                              </el-icon>
                              <span>{{ getVendorName(memory.providerId) }}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- 添加新记忆磁贴 -->
                      <div class="provider-card add-tile" @click="handleShowAddMemoryDialog">
                        <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                        <div style="color: #606266; margin-top: 10px;">{{ t('addNewMemory') }}</div>
                      </div>
                    </div>
                    <!-- 添加记忆对话框 -->
                    <el-dialog v-model="showAddMemoryDialog" :title="t('memoryConfig')" width="80%">
                      <el-form label-position="top">
                        <el-form-item :label="t('memoryName')" required>
                          <el-input v-model="newMemory.name" />
                        </el-form-item>

                        <el-form-item :label="t('avatar')">
                          <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                            <!-- 头像预览 (如果有值显示图片，没值显示图标) -->
                            <div style="flex-shrink: 0;">
                                <img 
                                  :src="newMemory.avatar? newMemory.avatar : 'source/Avatar.png'"  
                                  style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #dcdfe6;"
                                />
                            </div>

                            <!-- URL 输入框 (保留手动输入功能) -->
                            <el-input 
                              v-model="newMemory.avatar" 
                              :placeholder="t('avatarPlaceholder')"
                              style="flex: 1; min-width: 0;"
                            ></el-input>

                            <!-- 上传按钮 -->
                            <el-tooltip :content="t('uploadImage')" placement="top">
                              <el-button @click="triggerAvatarUpload" type="primary" circle>
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                              </el-button>
                            </el-tooltip>

                            <!-- 隐藏的文件输入控件 -->
                            <input
                              type="file"
                              ref="avatarInput"
                              accept="image/*"
                              style="display: none"
                              @change="handleAvatarUpload"
                            ></input>
                          </div>
                        </el-form-item>

                        <!-- 新增已有记忆选择框 -->
                        <el-form-item :label="t('selectExistingMemory')">
                          <el-select 
                            v-model="selectedExistingMemoryId" 
                            :placeholder="t('selectExistingMemoryPlaceholder')"
                            @change="copyExistingMemoryData"
                            class="full-width-input">
                            <!-- 添加“无”选项，默认选中 -->
                            <el-option
                              :key="'none'"
                              :label="t('none')"
                              :value="null">
                            </el-option>
                            
                            <el-option
                              v-for="memory in memories"
                              :key="memory.id"
                              :label="memory.name"
                              :value="memory.id">
                            </el-option>
                          </el-select>
                        </el-form-item>
                        <div class="upload-container">
                          <div
                            class="drop-zone"
                            @dragover.prevent
                            @drop.prevent="handleJsonDrop"
                            @click="browseJsonFile"
                          >
                            <el-icon :size="50"><i class="fa-solid fa-cloud-arrow-up"></i></el-icon>
                            <p>{{ t('clickOrDropCharacterCards') }}</p>
                          </div>
                        </div>
                        <el-tabs type="border-card" v-model="activeMemoryTabName">

                          <!-- 自动更新设定（供应商） -->
                          <el-tab-pane name="autoUpdateSetting">
                            <template #label>
                              <span>{{ t('autoUpdateSetting') }}</span>
                            </template>
                            <el-form-item :label="t('embeddingProvider')">
                              <el-select
                                v-model="newMemory.providerId"
                                :placeholder="t('selectProvider')"
                                clearable
                                class="full-width-input"
                              >
                                <!-- 添加“无”选项，默认选中 -->
                                <el-option
                                  :key="'none'"
                                  :label="t('none')"
                                  :value="null"
                                >
                                  <div class="provider-option">
                                    <img 
                                      src="source/providers/logo.png" 
                                      class="mini-vendor-logo"
                                    />
                                    <span class="model-id">{{ t("NoLongTermMemory") }}</span>
                                  </div>
                                </el-option>
                                <el-option
                                  key='paraphrase-multilingual-MiniLM-L12-v2'
                                  :label="t('localVendor') + ' - ' + 'paraphrase-multilingual-MiniLM-L12-v2'"
                                  value='paraphrase-multilingual-MiniLM-L12-v2'
                                >
                                  <div class="provider-option">
                                    <img 
                                      :src="getVendorLogo('Local')" 
                                      class="mini-vendor-logo"
                                    />
                                    <span class="model-id">paraphrase-multilingual-MiniLM-L12-v2</span>
                                  </div>
                                </el-option>
                                <el-option
                                  v-for="p in modelProviders"
                                  :key="p.id"
                                  :label="p.vendor + ' - ' + p.modelId"
                                  :value="p.id"
                                >
                                  <div class="provider-option">
                                    <img :src="getVendorLogo(p.vendor)" class="mini-vendor-logo" />
                                    <span class="model-id">{{ p.modelId }}</span>
                                  </div>
                                </el-option>
                              </el-select>
                            </el-form-item>
                            <el-alert type="info" :closable="false" class="mb-2">
                              <template #default>
                                <div class="alert-content">
                                  {{ t('minilmNotice4') }}
                                  <el-link
                                    type="primary"
                                    :underline="false"
                                    class="font-medium"
                                    @click="switchToMemoryConfig"
                                  >
                                    <el-icon class="mr-1">
                                      <i class="fa-solid fa-key"></i>
                                    </el-icon>{{ t('goToMemory') }}
                                  </el-link><br>
                                  {{ t('firstTimeUse') }}
                                  <el-link
                                    type="primary"
                                    :underline="false"
                                    class="font-medium"
                                    @click="switchToApiBox"
                                  >
                                    <el-icon class="mr-1">
                                      <i class="fa-solid fa-key"></i>
                                    </el-icon>{{ t('keyBoxInterface') }}
                                  </el-link>
                                  {{ t('addProviderReturnSelect') }}
                                  {{ t('addemdNotice') }}
                                  {{ t('autoUpdateSettingNote') }}
                                </div>
                              </template>
                            </el-alert>
                          </el-tab-pane>

                          <!-- 角色描述 -->
                          <el-tab-pane name="description" :label="t('characterDescription')">
                            <el-form-item>
                              <el-input
                                v-model="newMemory.description"
                                type="textarea"
                                :rows="8"
                                :placeholder="t('characterDescriptionPlaceholder')"
                              />
                            </el-form-item>
                          </el-tab-pane>

                          <!-- 性格 -->
                          <el-tab-pane name="personality" :label="t('personality')">
                            <el-form-item>
                              <el-input
                                v-model="newMemory.personality"
                                type="textarea"
                                :rows="8"
                                :placeholder="t('personalityPlaceholder')"
                              />
                            </el-form-item>
                          </el-tab-pane>

                          <!-- 对话示例（一问一答） -->
                          <el-tab-pane name="mesExample" :label="t('mesExample')">
                            <el-form-item>
                              <el-input
                                v-model="newMemory.mesExample"
                                type="textarea"
                                :rows="8"
                                :placeholder="t('mesExamplePlaceholder')"
                              />
                            </el-form-item>
                          </el-tab-pane>

                          <!-- 系统提示 -->
                          <el-tab-pane name="systemPrompt" :label="t('systemPrompt')">
                            <el-form-item>
                              <el-input
                                v-model="newMemory.systemPrompt"
                                type="textarea"
                                :rows="8"
                                :placeholder="t('systemPromptPlaceholder')"
                              />
                            </el-form-item>
                          </el-tab-pane>

                          <el-tab-pane name="characterBook" :label="t('characterBook')">
                            <div
                              v-for="(item, idx) in newMemory.characterBook"
                              :key="idx"
                              style="margin-bottom:12px;border:1px solid;border-radius:4px;padding:8px"
                            >
                              <el-form-item :label="t('keys')">
                                <el-input
                                  v-model="item.keysRaw"
                                  type="textarea"
                                  :rows="3"
                                  :placeholder="t('keysPlaceholder')"
                                />
                              </el-form-item>
                              <el-form-item :label="t('content')">
                                <el-input
                                  v-model="item.content"
                                  type="textarea"
                                  :rows="4"
                                  :placeholder="t('contentPlaceholder')"
                                />
                              </el-form-item>
                              <div style="text-align:right">
                                <el-button circle size="small" type="default" @click="clearBook(idx)">
                                  <i class="fa-solid fa-eraser"></i>
                                </el-button>
                                <el-button
                                  v-if="newMemory.characterBook.length>1"
                                  circle
                                  size="small"
                                  type="danger"
                                  @click="removeBook(idx)"
                                >
                                  <i class="fa-solid fa-trash"></i>
                                </el-button>
                                <el-button circle size="small" type="primary" @click="addBook">
                                  <i class="fa-solid fa-plus"></i>
                                </el-button>
                              </div>
                            </div>
                          </el-tab-pane>

                          <el-tab-pane name="firstGreeting" :label="t('firstGreeting')">
                            <div
                              class="param-row"
                              style="margin-bottom:12px;border:1px solid;border-radius:4px;padding:8px"
                            >
                              <el-form-item>
                                <el-input
                                  v-model="newMemory.firstMes"
                                  type="textarea"
                                  :rows="3"
                                  :placeholder="t('firstMes')"
                                  
                                />
                              </el-form-item>
                              <div style="text-align:right">
                                <el-button
                                  @click="clearFirstMes"
                                  type="default"
                                  size="small"
                                  circle
                                >
                                  <i class="fa-solid fa-eraser"></i>
                                </el-button>
                                <el-button
                                  @click="addGreeting"
                                  type="primary"
                                  circle
                                  size="small"
                                  class="header-add-btn"
                                >
                                  <i class="fa-solid fa-plus"></i>
                                </el-button>
                              </div>
                            </div>
                            <div
                              v-for="(g, idx) in newMemory.alternateGreetings"
                              :key="idx"
                              class="param-row"
                              style="margin-bottom:12px;border:1px solid #dcdfe6;border-radius:4px;padding:8px"
                            >
                              <el-form-item>
                                <el-input
                                  v-model="newMemory.alternateGreetings[idx]"
                                  type="textarea"
                                  :rows="3"
                                  :placeholder="t('alternateGreeting') + ' ' + (idx + 1)"
                                  
                                />
                              </el-form-item>
                              <div style="text-align:right">
                                <el-button
                                  @click="clearGreeting(idx)"
                                  type="default"
                                  size="small"
                                  circle
                                >
                                  <i class="fa-solid fa-eraser"></i>
                                </el-button>
                                <el-button
                                  @click="removeGreeting(idx)"
                                  type="danger"
                                  size="small"
                                  circle
                                >
                                  <i class="fa-solid fa-trash"></i>
                                </el-button>
                                <el-button
                                  @click="addGreeting"
                                  type="primary"
                                  circle
                                  size="small"
                                  class="header-add-btn"
                                >
                                  <i class="fa-solid fa-plus"></i>
                                </el-button>
                              </div>
                            </div>
                          </el-tab-pane>
                        </el-tabs>
                      </el-form>

                      <template #footer>
                        <el-button @click="showAddMemoryDialog = false">{{ t('cancel') }}</el-button>
                        <el-button 
                          type="primary" 
                          @click="addMemory"
                          :disabled="!newMemory.name">
                          {{ t('confirmAdd') }}
                        </el-button>
                      </template>
                    </el-dialog>
                  </el-tab-pane>
                  <!-- 系统提示词标签页 -->
                  <el-tab-pane :label="t('addSystemPrompt')" name="prompts">
                    <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px;">
                      <!-- 大输入框：限制最大宽度，让出空间给按钮 -->
                      <el-input
                        v-model="quickCreateSystemPrompt"
                        type="textarea"
                        :rows="4"
                        :placeholder="t('quickGenSystemPromptPlaceholder')"
                      >
                      </el-input>
                      <!-- 生成按钮 -->
                      <el-tooltip :content="t('oneClickGenCard')" placement="top">
                        <el-button
                          type="primary"
                          size="large"
                          circle
                          style="margin: 0;"
                          :disabled="!quickCreateSystemPrompt.trim()||isSystemPromptGenerating"
                          @click="handleSystemPromptQuickGen"
                        >
                          <i v-if="!isSystemPromptGenerating" class="fa-solid fa-wand-magic-sparkles"></i>
                          <i v-else class="fa-solid fa-spinner fa-spin"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip :content="t('stopGenCard')" placement="top">
                        <!-- 停止生成按钮 -->
                        <el-button
                          type="danger"
                          size="large"
                          circle
                          style="margin: 0;"
                          :disabled="!isSystemPromptGenerating"
                          @click="stopSystemPromptQuickGen"
                        >
                          <i class="fa-solid fa-stop"></i>
                        </el-button>
                      </el-tooltip>
                    </div>
                    <div class="provider-grid">
                      <!-- 已有提示词磁贴 -->
                      <div
                        class="provider-card knowledge-card"
                        v-for="(prompt, idx) in SystemPromptsList"
                        :key="prompt.id || idx"
                      >
                        <div class="card-header">
                          <el-tooltip :content="t('usePrompt')" placement="top">
                            <el-button 
                              type="primary" 
                              @click="usePrompt(prompt.content)"
                              circle
                            >
                              <i class="fa-solid fa-play"></i>
                            </el-button>
                          </el-tooltip>
                          <div class="card-actions">
                            <el-button
                              @click="editPrompt(prompt)"
                              type="default"
                              circle
                              size="small"
                              :title="t('edit')"
                            >
                              <i class="fa-solid fa-pen-to-square"></i>
                            </el-button>
                            <el-button
                              @click="removePrompt(prompt.id)"
                              type="danger"
                              circle
                              size="small"
                              :title="t('delete')"
                            >
                              <i class="fa-solid fa-trash"></i>
                            </el-button>
                          </div>
                        </div>
                        <h3>{{ prompt.name }}</h3>
                        <span>{{ (prompt.content || '').substring(0, 50) }}...</span>
                      </div>

                      <!-- 新增磁贴 -->
                      <div class="provider-card add-tile" @click="addPrompt">
                        <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                        <div style="color: #606266; margin-top: 10px;">{{ t('addSystemPrompt') }}</div>
                      </div>
                    </div>

                    <!-- 编辑/新增对话框 -->
                    <el-dialog
                      v-model="showPromptDialog"
                      :title="t('editSystemPrompt')"
                      width="60%"
                    >
                      <el-form label-position="top">
                        <el-form-item :label="t('promptName')" required>
                          <el-input v-model="promptForm.name" />
                        </el-form-item>
                        <el-form-item :label="t('promptContent')" required>
                          <el-input
                            v-model="promptForm.content"
                            type="textarea"
                            :rows="8"
                            :placeholder="t('systemPromptPlaceholder')"
                          />
                        </el-form-item>
                      </el-form>
                      <template #footer>
                        <el-button @click="showPromptDialog = false">{{ t('cancel') }}</el-button>
                        <el-button type="primary" @click="savePrompt" :disable="!promptForm.name || !promptForm.content">{{ t('confirm') }}</el-button>
                      </template>
                    </el-dialog>
                  </el-tab-pane>
                </el-tabs>
              </div>
              <!-- 脑区模型页面 -->
              <div v-show="subMenu === 'mind'" class="page mind-page">
                <div class="mind-container">
                  
                  <!-- 背景装饰网格 -->
                  <div class="mind-grid-bg"></div>

                  <!-- 核心大脑容器 -->
                  <div class="brain-wrapper" :class="{'full-power-mode': isAllBrainsActive}">
                    
                    <!-- SVG 抽象大脑线框图 -->
                    <svg class="brain-svg" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
                      <defs>
                        <!-- 定义发光滤镜 -->
                        <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                          <feGaussianBlur stdDeviation="4" result="blur" />
                          <feComposite in="SourceGraphic" in2="blur" operator="over" />
                        </filter>
                      </defs>
                      
                      <!-- 大脑轮廓 (科技感线条) -->
                      <g class="brain-lines" filter="url(#glow)">
                        <!-- 前额叶区域 -->
                        <path d="M60,120 Q60,80 100,50 T180,40" class="brain-path prefrontal-line" />
                        <!-- 理性脑区域 (皮层) -->
                        <path d="M180,40 Q260,40 320,90 T340,180" class="brain-path rational-line" />
                        <!-- 生理脑区域 (脑干/小脑) -->
                        <path d="M340,180 Q320,240 250,250 T180,260 L180,290" class="brain-path physio-line" />
                        <!-- 感性脑区域 (边缘系统/中心) -->
                        <path d="M140,140 Q200,120 240,160 T200,210 Q160,220 120,190" class="brain-path emotional-line" />
                        <!-- 连接线 -->
                        <path d="M100,50 L140,140" class="connector-line" />
                        <path d="M320,90 L240,160" class="connector-line" />
                      </g>
                      
                      <!-- 脉冲节点动画 -->
                      <circle cx="100" cy="50" r="4" class="pulse-dot" />
                      <circle cx="320" cy="90" r="4" class="pulse-dot" style="animation-delay: 0.5s" />
                      <circle cx="200" cy="180" r="4" class="pulse-dot" style="animation-delay: 1s" />
                    </svg>

                    <!-- 四个功能区卡片 (添加了 @click 事件) -->
                    
                    <!-- 1. 前额叶 -->
                    <!-- 增加 :class="{ 'enabled': prefrontalCortexSettings.enabled }" -->
                    <div class="mind-card prefrontal-card" 
                         :class="{ 'enabled': prefrontalCortexSettings.enabled }"
                         @click="openBrainEdit('prefrontalCortex')">
                      <div class="card-glow"></div>
                      <div class="mind-icon"><i class="fa-solid fa-chess-king"></i></div>
                      <div class="mind-content">
                        <h3>{{ t('prefrontalCortex')}}</h3>
                        <p>{{t('prefrontalCortexNotice')}}</p>
                        <el-tag size="small" :type="prefrontalCortexSettings.enabled ? 'success' : 'info'">
                          {{ prefrontalCortexSettings.enabled ? t('enabled') : t('disabled') }}
                        </el-tag>
                      </div>
                    </div>

                    <!-- 2. 理性脑 -->
                    <!-- 增加 :class="{ 'enabled': NeocortexSettings.enabled }" -->
                    <div class="mind-card rational-card" 
                         :class="{ 'enabled': NeocortexSettings.enabled }"
                         @click="openBrainEdit('Neocortex')">
                      <div class="card-glow"></div>
                      <div class="mind-icon"><i class="fa-solid fa-microchip"></i></div>
                      <div class="mind-content">
                        <h3>{{ t('Neocortex') }}</h3>
                        <p>{{t('NeocortexNotice')}}</p>
                        <el-tag size="small" :type="NeocortexSettings.enabled ? 'success' : 'info'">
                          {{ NeocortexSettings.enabled ? t('enabled') : t('disabled') }}
                        </el-tag>
                      </div>
                    </div>

                    <!-- 3. 感性脑 -->
                    <!-- 增加 :class="{ 'enabled': LimbicSystemSettings.enabled }" -->
                    <div class="mind-card emotional-card" 
                         :class="{ 'enabled': LimbicSystemSettings.enabled }"
                         @click="openBrainEdit('LimbicSystem')">
                      <div class="card-glow"></div>
                      <div class="mind-icon"><i class="fa-solid fa-heart-pulse"></i></div>
                      <div class="mind-content">
                        <h3>{{ t('LimbicSystem') }}</h3>
                        <p>{{t('LimbicSystemNotice')}}</p>
                        <el-tag size="small" :type="LimbicSystemSettings.enabled ? 'success' : 'info'">
                          {{ LimbicSystemSettings.enabled ? t('enabled') : t('disabled') }}
                        </el-tag>
                      </div>
                    </div>

                    <!-- 4. 生理脑 -->
                    <!-- 增加 :class="{ 'enabled': ReptilianBrainSettings.enabled }" -->
                    <div class="mind-card physio-card" 
                         :class="{ 'enabled': ReptilianBrainSettings.enabled }"
                         @click="openBrainEdit('ReptilianBrain')">
                      <div class="card-glow"></div>
                      <div class="mind-icon"><i class="fa-solid fa-dna"></i></div>
                      <div class="mind-content">
                        <h3>{{ t('ReptilianBrain')}}</h3>
                        <p>{{t('ReptilianBrainNotice')}}</p>
                        <el-tag size="small" :type="ReptilianBrainSettings.enabled ? 'success' : 'info'">
                          {{ ReptilianBrainSettings.enabled ? t('enabled') : t('disabled') }}
                        </el-tag>
                      </div>
                    </div>

                  </div>
                </div>

                <!-- 新增：右下角极简控制面板 -->
                <div class="mind-quick-panel">
                  <!-- 头部 -->
                  <div class="panel-header">
                    <span class="panel-title">
                      <i class="fa-solid fa-sliders"></i> {{ t('neuralControl') || 'Neural Control' }}
                    </span>
                    <!-- 状态指示灯 -->
                    <div class="system-status" :class="{'active': isAllBrainsActive}">
                      <div class="status-pulse"></div>
                    </div>
                  </div>

                  <!-- 分割线 -->
                  <div class="panel-divider"></div>

                  <!-- 列表控制 -->
                  <div class="panel-rows">
                    <!-- 前额叶 -->
                    <div class="control-row">
                      <span class="label">{{ t('prefrontalCortex') }}</span>
                      <el-switch v-model="prefrontalCortexSettings.enabled" size="small" @change="autoSaveSettings" />
                    </div>
                    <!-- 理性脑 -->
                    <div class="control-row">
                      <span class="label">{{ t('Neocortex') }}</span>
                      <el-switch v-model="NeocortexSettings.enabled" size="small" @change="autoSaveSettings" />
                    </div>
                    <!-- 感性脑 -->
                    <div class="control-row">
                      <span class="label">{{ t('LimbicSystem') }}</span>
                      <el-switch v-model="LimbicSystemSettings.enabled" size="small" @change="autoSaveSettings" />
                    </div>
                    <!-- 生理脑 -->
                    <div class="control-row">
                      <span class="label">{{ t('ReptilianBrain') }}</span>
                      <el-switch v-model="ReptilianBrainSettings.enabled" size="small" @change="autoSaveSettings" />
                    </div>
                  </div>
                </div>


                <!-- 通用脑区设置模态框 -->
                <el-dialog
                  v-model="showBrainEditDialog"
                  :title="currentBrainTitle"
                  width="50%"
                  align-center
                >
                  <!-- 只有当 currentBrainSettings 存在时才渲染表单，防止报错 -->
                  <el-form label-position="top">
                    
                    <!-- 1. 启用/禁用开关 -->
                    <el-form-item :label="t('enableFunction')" class="form-item-align"  label-position="left">
                        <el-switch 
                          v-model="currentBrainSettings.enabled" 
                        />
                    </el-form-item>
                    <!-- 2. 模型供应商选择 -->
                    <el-form-item :label="t('provider')" required>
                      <el-select
                        v-model="currentBrainSettings.selectedProvider"
                        :placeholder="t('selectProvider')"
                        filterable
                        class="full-width-input"
                        @change="selectBrainProvider"
                        @visible-change="handleBrainProviderVisibleChange"
                      >
                        <el-option
                          v-for="provider in modelProviders"
                          :key="provider.id"
                          :label="provider.vendor+' - '+provider.modelId"
                          :value="provider.id"
                        >
                          <div class="provider-option">
                            <img 
                              :src="getVendorLogo(provider.vendor)" 
                              class="mini-vendor-logo"
                            />
                            <span class="model-id">{{ provider.modelId }}</span>
                          </div>
                        </el-option>
                      </el-select>
                    </el-form-item>

                  </el-form>

                  <template #footer>
                    <el-button @click="showBrainEditDialog = false">{{ t('close') }}</el-button>
                    <!-- 如果需要手动保存按钮，可以使用下面的，但在 switch/select 上加 @change 自动保存通常体验更好 -->
                    <el-button type="primary" @click="showBrainEditDialog = false;autoSaveSettings()">{{ t('confirm') }}</el-button> 
                  </template>
                </el-dialog>
              </div>
              <!-- 角色语音 -->
              <div v-show="subMenu === 'voice'" class="page">
                <div class="provider-grid">
                  <!-- 已有 TTS 配置磁贴 -->
                  <div v-for="(config, name) in ttsSettings.newtts" :key="name" class="provider-card knowledge-card">
                    <div class="card-header">
                      <el-switch v-model="config.enabled" @change="autoSaveSettings"></el-switch>
                      <div class="card-actions">
                        <el-button @click="ClickToListen(config.SampleText,name)" type="primary" circle size="small">
                          <i class="fa-solid fa-headphones"></i>
                        </el-button>
                        <el-button @click="editTTS(name)" type="primary" circle size="small">
                          <i class="fa-solid fa-pen-to-square"></i>
                        </el-button>
                        <el-button @click="deleteTTS(name)" type="danger" circle size="small">
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="kb-content">
                      <h3 class="kb-title">{{ name }}</h3>
                      <div class="kb-meta">
                        <div class="kb-meta-item">
                          <el-icon class="kb-icon">
                            <i class="fa-solid fa-volume-high"></i>
                          </el-icon>
                          <span>{{ config.engine }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- 添加新 TTS 磁贴 -->
                  <div class="provider-card add-tile" @click="openAddTTSDialog">
                    <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addNewTTS') }}</div>
                  </div>
                </div>

                <!-- 新增 TTS 配置对话框 -->
                <el-dialog v-model="showAddTTSDialog" :title="t('addNewTTS')" width="80%">
                  <el-form ref="form" :model="newTTSConfig" label-position="top">
                    <!-- 名称输入 -->
                    <el-form-item :label="t('ttsName')" required>
                      <el-select 
                        v-model="newTTSConfig.name" 
                        filterable
                        allow-create
                      class="full-width-input">
                        <el-option :label="t('Narrator')" :value="t('Narrator')"></el-option>
                        <el-option
                          v-for="memory in memories"
                          :key="memory.id"
                          :label="memory.name"
                          :value="memory.name"
                        ></el-option>
                      </el-select>
                    </el-form-item>

                    <!-- 引擎选择 -->
                    <el-form-item :label="t('ttsEngine')" class="form-item-align">
                      <el-select 
                        v-model="newTTSConfig.engine" 
                        class="full-width-input"
                        @change="fetchTetosNewVoices(newTTSConfig.engine)"
                      >
                        <el-option :label="t('edgetts')" value="edgetts"></el-option>
                        <el-option :label="t('systemtts')" value="systemtts" ></el-option>
                        <el-option label="GPT Sovits" value="GSV"></el-option>
                        <el-option :label="t('openaiLikeTTS')" value="openai"></el-option>
                        <el-option :label="t('customTTS')" value="customTTS"></el-option>
                        <el-option label="Azure TTS" value="azure"></el-option>
                        <el-option label="Volcengine (火山)" value="volcengine"></el-option>
                        <el-option label="Google TTS" value="google"></el-option>
                        <el-option label="Baidu TTS (百度)" value="baidu"></el-option>
                        <el-option label="Minimax" value="minimax"></el-option>
                        <el-option label="Xunfei (讯飞)" value="xunfei"></el-option>
                        <el-option label="Fish Audio" value="fish"></el-option>
                      </el-select>
                    </el-form-item>

                    <el-form-item :label="t('SampleText')" class="server-item">
                      <el-input 
                        v-model="newTTSConfig.SampleText" 
                        :placeholder="t('SampleTextPlaceholder')"
                        class="full-width-input"
                        style="margin-right: 10px;"
                        @change="autoSaveSettings"
                      >
                      </el-input>
                      <el-tooltip :content="t('ClickToListen')" placement="top">
                        <el-button 
                          type="primary" 
                          @click="ClickToListen(newTTSConfig.SampleText)" 
                          circle
                        >
                          <i class="fa-solid fa-headphones"></i>
                        </el-button>
                      </el-tooltip>
                    </el-form-item>

                    <!-- ================= Azure TTS ================= -->
                    <div class="tool-item" v-show="newTTSConfig.engine === 'azure'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span><i class="fa-brands fa-microsoft"></i> 
                            Azure TTS
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://portal.azure.com/#create/Microsoft.CognitiveServicesSpeechServices" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('getAPIkey') }}
                            </el-link>
                          </span>
                        </div>
                        <div class="header-right">
                          <el-button circle type="primary" @click="fetchTetosVoices('azure')">
                            <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': newTTSConfig.isFetchingVoices }"></i>
                          </el-button>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item label="Speech Key" class="form-item-align">
                          <el-input v-model="newTTSConfig.azureSpeechKey" placeholder="Azure Key" type="password" show-password @change="autoSaveSettings"/>
                        </el-form-item>
                        <el-form-item label="Region" class="form-item-align">
                          <el-input v-model="newTTSConfig.azureRegion" placeholder="e.g. eastus" @change="autoSaveSettings"/>
                        </el-form-item>
                        <el-form-item label="Voice" class="form-item-align">
                          <el-select v-model="newTTSConfig.azureVoice" filterable allow-create placeholder="Select Voice" class="full-width-input" @change="autoSaveSettings">
                            <el-option 
                              v-for="(v, index) in newTTSConfig.tetosVoices" 
                              :key="index" 
                              :label="getVoiceLabel(v)" 
                              :value="getVoiceValue(v)"
                            >
                              <span style="float: left">{{ getVoiceLabel(v) }}</span>
                              <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                            </el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                    </div>
                  <!-- ================= Volcengine TTS (火山引擎) ================= -->
                  <div class="tool-item" v-show="newTTSConfig.engine === 'volcengine'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon><i class="fa-solid fa-fire"></i></el-icon> 
                          {{ t('volcengineTTS') || 'Volcengine TTS' }}
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://console.volcengine.com/speech/service/10035" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('getAPIkey') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item label="App ID" class="form-item-align">
                        <el-input v-model="newTTSConfig.volcAppId" placeholder="e.g. 1234567890" @change="autoSaveSettings"/>
                      </el-form-item>
                      
                      <el-form-item label="Access Token" class="form-item-align">
                        <el-input v-model="newTTSConfig.volcAccessKey" type="password" show-password placeholder="Bearer Token / Access Key" @change="autoSaveSettings"/>
                      </el-form-item>

                      <el-form-item label="Resource ID" class="form-item-align">
                        <el-select
                          v-model="newTTSConfig.volcResourceId"
                          filterable
                          allow-create
                          default-first-option
                          placeholder="选择或输入 Resource ID"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="item in volcResourceOptions"
                            :key="item.value"
                            :label="item.value"
                            :value="item.value"
                          >
                            <span style="float: left">{{ item.value }}</span>
                            <span style="float: right; color: #8492a6; font-size: 12px; margin-left: 10px;">{{ item.label }}</span>
                          </el-option>
                        </el-select>
                      </el-form-item>
                      
                      <el-form-item :label="t('Voice') || 'Voice'" class="form-item-align">
                         <!-- 这里使用输入框，也可以改成 select 如果你有列表 -->
                        <el-input v-model="newTTSConfig.volcVoice" placeholder="e.g. zh_female_vv_uranus_bigtts" @change="autoSaveSettings">
                        </el-input>
                      </el-form-item>

                      <el-form-item :label="t('TTSRate')" class="form-item-align">
                        <el-slider
                          v-model="newTTSConfig.volcRate"
                          :min="0.5"
                          :max="2.0"
                          :step="0.1"
                          show-input
                          @change="autoSaveSettings">
                        </el-slider>
                      </el-form-item>
                    </div>
                  </div>
                    <!-- ================= Google TTS ================= -->
                    <div class="tool-item" v-show="newTTSConfig.engine === 'google'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span><i class="fa-brands fa-google"></i> 
                            Google TTS
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('getAPIkey') }}
                            </el-link>
                          </span>
                        </div>
                        <div class="header-right">
                          <el-button circle type="primary" @click="fetchTetosVoices('google')">
                            <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': newTTSConfig.isFetchingVoices }"></i>
                          </el-button>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item label="Service Account JSON" class="form-item-align">
                          <el-input v-model="newTTSConfig.googleServiceAccount" type="textarea" :rows="3" placeholder='Paste JSON content here: {"type": "service_account", ...}' @change="autoSaveSettings"/>
                        </el-form-item>
                        <el-form-item label="Voice" class="form-item-align">
                          <el-select v-model="newTTSConfig.googleVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                            <el-option 
                              v-for="(v, index) in newTTSConfig.tetosVoices" 
                              :key="index" 
                              :label="getVoiceLabel(v)" 
                              :value="getVoiceValue(v)"
                            >
                              <span style="float: left">{{ getVoiceLabel(v) }}</span>
                              <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                            </el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                    </div>

                    <!-- ================= Baidu TTS ================= -->
                    <div class="tool-item" v-show="newTTSConfig.engine === 'baidu'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span><i class="fa-solid fa-paw"></i> 
                            Baidu TTS
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://console.bce.baidu.com/ai/#/ai/speech/app/list" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('getAPIkey') }}
                            </el-link>
                          </span>
                        </div>
                        <div class="header-right">
                          <el-button circle type="primary" @click="fetchTetosVoices('baidu')">
                            <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': newTTSConfig.isFetchingVoices }"></i>
                          </el-button>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item label="API Key" class="form-item-align"><el-input v-model="newTTSConfig.baiduApiKey" @change="autoSaveSettings"/></el-form-item>
                        <el-form-item label="Secret Key" class="form-item-align"><el-input v-model="newTTSConfig.baiduSecretKey" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                        <el-form-item label="Voice" class="form-item-align">
                          <el-select v-model="newTTSConfig.baiduVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                            <el-option 
                              v-for="(v, index) in newTTSConfig.tetosVoices" 
                              :key="index" 
                              :label="getVoiceLabel(v)" 
                              :value="getVoiceValue(v)"
                            >
                              <span style="float: left">{{ getVoiceLabel(v) }}</span>
                              <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                            </el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                    </div>

                    <!-- ================= Minimax ================= -->
                    <div class="tool-item" v-show="newTTSConfig.engine === 'minimax'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>Minimax
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://platform.minimaxi.com/user-center/basic-information" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('getAPIkey') }}
                            </el-link>
                          </span>
                        </div>
                        <div class="header-right">
                          <el-button circle type="primary" @click="fetchTetosVoices('minimax')">
                            <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': newTTSConfig.isFetchingVoices }"></i>
                          </el-button>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item label="API Key" class="form-item-align"><el-input v-model="newTTSConfig.minimaxApiKey" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                        <el-form-item label="Group ID" class="form-item-align"><el-input v-model="newTTSConfig.minimaxGroupId" @change="autoSaveSettings"/></el-form-item>
                        <el-form-item label="Voice" class="form-item-align">
                          <el-select v-model="newTTSConfig.minimaxVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                            <el-option 
                              v-for="(v, index) in newTTSConfig.tetosVoices" 
                              :key="index" 
                              :label="getVoiceLabel(v)" 
                              :value="getVoiceValue(v)"
                            >
                              <span style="float: left">{{ getVoiceLabel(v) }}</span>
                              <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                            </el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                    </div>

                    <!-- ================= Xunfei (讯飞) ================= -->
                    <div class="tool-item" v-show="newTTSConfig.engine === 'xunfei'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>Xunfei
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://console.xfyun.cn/services/tts" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('getAPIkey') }}
                            </el-link>
                          </span>
                        </div>
                        <div class="header-right">
                          <el-button circle type="primary" @click="fetchTetosVoices('xunfei')">
                            <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': newTTSConfig.isFetchingVoices }"></i>
                          </el-button>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item label="App ID" class="form-item-align"><el-input v-model="newTTSConfig.xunfeiAppId" @change="autoSaveSettings"/></el-form-item>
                        <el-form-item label="API Key" class="form-item-align"><el-input v-model="newTTSConfig.xunfeiApiKey" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                        <el-form-item label="API Secret" class="form-item-align"><el-input v-model="newTTSConfig.xunfeiApiSecret" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                        <el-form-item label="Voice" class="form-item-align">
                          <el-select v-model="newTTSConfig.xunfeiVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                            <el-option 
                              v-for="(v, index) in newTTSConfig.tetosVoices" 
                              :key="index" 
                              :label="getVoiceLabel(v)" 
                              :value="getVoiceValue(v)"
                            >
                              <span style="float: left">{{ getVoiceLabel(v) }}</span>
                              <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                            </el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                    </div>

                    <!-- ================= Fish Audio ================= -->
                    <div class="tool-item" v-show="newTTSConfig.engine === 'fish'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span><i class="fa-solid fa-fish"></i> 
                            Fish Audio
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://fish.audio/go-api" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('getAPIkey') }}
                            </el-link>
                          </span>
                        </div>
                        <div class="header-right">
                          <el-button circle type="primary" @click="fetchTetosVoices('fish')">
                            <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': newTTSConfig.isFetchingVoices }"></i>
                          </el-button>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item label="API Key" class="form-item-align"><el-input v-model="newTTSConfig.fishApiKey" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                        <el-form-item label="Voice" class="form-item-align">
                          <el-select v-model="newTTSConfig.fishVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                            <el-option 
                              v-for="(v, index) in newTTSConfig.tetosVoices" 
                              :key="index" 
                              :label="getVoiceLabel(v)" 
                              :value="getVoiceValue(v)"
                            >
                              <span style="float: left">{{ getVoiceLabel(v) }}</span>
                              <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                            </el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                    </div>

                    <!-- ================= System TTS ================= -->
                    <div class="tool-item" v-show="newTTSConfig.engine === 'systemtts'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon><i class="fa-solid fa-laptop-code"></i></el-icon>
                            {{ t('sysTTS') }}
                          </span>
                        </div>
                        <div class="header-right">
                          <el-button circle type="primary" @click="fetchSystemVoices">
                            <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': isLoadingSystemVoices }"></i>
                          </el-button>
                        </div>
                      </div>

                      <div class="tool-content">
                        <el-form-item :label="t('TTSRate')" class="form-item-align">
                          <el-slider
                            v-model="newTTSConfig.systemRate"
                            :min="50"
                            :max="400"
                            :step="10"
                            show-input
                            @change="autoSaveSettings">
                          </el-slider>
                        </el-form-item>

                        <el-form-item :label="t('Timbre')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.systemVoiceName"
                            class="full-width-input"
                            filterable
                            :loading="isLoadingSystemVoices"
                            @change="autoSaveSettings"
                          >
                            <el-option
                              v-for="voice in systemVoices"
                              :key="voice.id"
                              :label="voice.name"
                              :value="voice.id"
                            >
                              <span style="float: left">{{ voice.name }}</span>
                              <span
                                style="
                                  float: right;
                                  color: var(--el-text-color-secondary);
                                  font-size: 13px;
                                "
                              >
                                {{ voice.lang }}
                              </span>
                            </el-option>
                          </el-select>
                        </el-form-item>

                        <div v-if="systemVoices.length === 0 && !isLoadingSystemVoices" style="color: #e6a23c; font-size: 12px; margin-top: 5px;">
                          <i class="fa-solid fa-triangle-exclamation"></i> {{ t('noSystemVoiceDetected') }}
                        </div>
                      </div>
                    </div>

                    <div class="tool-item" v-show="newTTSConfig.engine === 'openai'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon>
                              <i class="fa-solid fa-microphone"></i>
                            </el-icon>
                            {{t('openaiLike')}}
                          </span>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item :label="t('TTSModelProvider')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.selectedProvider"
                            :placeholder="t('selectProvider')"
                            filterable
                            @change="selectTTSProvider"
                            @visible-change="handleTTSProviderVisibleChange"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="provider in modelProviders"
                              :key="provider.id"
                              :label="provider.vendor+' - '+provider.modelId"
                              :value="provider.id"
                            >
                              <div class="provider-option">
                                <img 
                                  :src="getVendorLogo(provider.vendor)" 
                                  class="mini-vendor-logo"
                                />
                                <span class="model-id">{{ provider.modelId }}</span>
                              </div>
                            </el-option>
                          </el-select>
                        </el-form-item>
                        <el-form-item :label="t('openaiStream')" class="form-item-align" label-position="left">
                          <el-switch 
                            v-model="newTTSConfig.openaiStream" 
                            @change="autoSaveSettings"
                          ></el-switch>
                        </el-form-item>
                        <el-form-item :label="t('TTSVoice')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.openaiVoice"
                            :placeholder="t('selectVoice')"
                            filterable
                            allow-create
                            @change="autoSaveSettings"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="voice in openaiVoices"
                              :key="voice"
                              :label="voice"
                              :value="voice"
                            ></el-option>
                          </el-select>
                        </el-form-item>
                        <!-- 提示音频选择框 -->
                        <el-form-item :label="t('promptAudio')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.gsvRefAudioPath"
                            @change="handleRefAudioPathChange"
                            class="full-width-input"
                          >
                            <el-option :key="null" :value="null" :label="t('noRefAudio')"></el-option>
                            <el-option
                              v-for="audio in ttsSettings.gsvAudioOptions"
                              :key="audio.path"
                              :label="audio.name"
                              :value="audio.path"
                            >
                              <div class="model-option-item">
                                <span>{{ audio.name }}</span>
                                <i 
                                  class="fa-solid fa-trash-can"
                                  style="color: #ff0000"
                                  @click.stop="deleteAudioOption(audio.path)"
                                ></i>
                              </div>
                            </el-option>
                            
                          </el-select>
                        </el-form-item>
                        <!-- 语速滑动条 -->
                        <el-form-item :label="t('TTSRate')" class="form-item-align">
                          <el-slider
                            v-model="newTTSConfig.openaiSpeed"
                            :min="0.1"
                            :max="2"
                            :step="0.1"
                            show-input
                            @change="autoSaveSettings">
                        </el-form-item>
                      </div>
                      <el-button 
                        @click="showGsvRefAudioPathDialog = true;currentUploadType='audio'"
                        type="primary" 
                        class="add-server-btn">
                        <i class="fa-solid fa-plus"></i> {{ t('addRefAudio') }}
                      </el-button>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('firstTimeUse') }}
                            <el-link
                              type="primary"
                              :underline="false"
                              class="font-medium"
                              @click="switchToApiBox"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('keyBoxInterface') }}
                            </el-link>
                            {{ t('addProviderReturnSelect') }}
                            {{ t('addTTSNotice') }}
                          </div>
                        </template>
                      </el-alert>
                    </div>

                    <div class="tool-item" v-show="newTTSConfig.engine === 'customTTS'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon>
                              <i class="fa-solid fa-volume-high"></i>
                            </el-icon>
                            {{t('customTTS')}}
                          </span>
                        </div>
                      </div>
                      <div class="tool-content">
                          <el-form-item :label="t('customTTSserver')" class="form-item-align">
                            <el-input
                              v-model="newTTSConfig.customTTSserver"
                              :placeholder="t('customTTSServerPlaceholder')"
                              @input="autoSaveSettings"
                              type="textarea"
                            />
                          </el-form-item>
                          <el-form-item :label="t('customStream')" class="form-item-align" label-position="left">
                            <el-switch 
                              v-model="newTTSConfig.customStream" 
                              @change="autoSaveSettings"
                            ></el-switch>
                          </el-form-item>
                          
                          <el-form-item :label="t('customTTSspeaker')" class="form-item-align">
                              <el-input
                                  v-model="newTTSConfig.customTTSspeaker"
                                  :placeholder="t('customTTSspeakerPlaceholder')"
                                  @input="autoSaveSettings"
                                  class="full-width-input"
                              />
                          </el-form-item>
                          <el-form-item :label="t('customTTSspeed')" class="form-item-align">
                              <el-slider
                                  v-model="newTTSConfig.customTTSspeed"
                                  :min="0.1"
                                  :max="2"
                                  :step="0.1"
                                  show-input
                                  @change="autoSaveSettings">
                              </el-slider>
                          </el-form-item>

                          <hr> <div class="advanced-key-config">
                              <div class="tool-header" style="margin-bottom: 10px;">
                                  <div class="header-left">
                                      <span>{{t('customTTSKeyMapping')}}</span>
                                  </div>
                              </div>

                              <el-form-item :label="t('key_text')" class="form-item-align">
                                  <el-input
                                      v-model="newTTSConfig.customTTSKeyText"
                                      placeholder="text"
                                      @input="autoSaveSettings"
                                      class="full-width-input"
                                  />
                              </el-form-item>

                              <el-form-item :label="t('key_speaker')" class="form-item-align">
                                  <el-input
                                      v-model="newTTSConfig.customTTSKeySpeaker"
                                      placeholder="speaker"
                                      @input="autoSaveSettings"
                                      class="full-width-input"
                                  />
                              </el-form-item>

                              <el-form-item :label="t('key_speed')" class="form-item-align">
                                  <el-input
                                      v-model="newTTSConfig.customTTSKeySpeed"
                                      placeholder="speed"
                                      @input="autoSaveSettings"
                                      class="full-width-input"
                                  />
                              </el-form-item>
                          </div>
                      </div>
                    </div>

                    <div class="tool-item" v-show="newTTSConfig.engine === 'edgetts'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon>
                              <i class="fa-solid fa-volume-high"></i>
                            </el-icon>
                            Edge TTS
                          </span>
                        </div>
                      </div>
                      <div class="tool-content">
                        <!-- 语速滑动条 -->
                        <el-form-item :label="t('edgettsRate')" class="form-item-align">
                          <el-slider
                            v-model="newTTSConfig.edgettsRate"
                            :min="0.1"
                            :max="2"
                            :step="0.1"
                            show-input
                            @change="autoSaveSettings">
                        </el-form-item>
                        <!-- 语言选择框 -->
                        <el-form-item :label="t('edgettsLanguage')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.edgettsLanguage"
                            @change="updateNewLanguages"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="language in uniqueNewLanguages"
                              :key="language"
                              :label="language"
                              :value="language"
                            ></el-option>
                          </el-select>
                        </el-form-item>

                        <!-- 性别选择框 -->
                        <el-form-item :label="t('edgettsGender')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.edgettsGender"
                            @change="updateNewGenders"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="gender in uniqueNewGenders"
                              :key="gender"
                              :label="t(gender)"
                              :value="gender"
                            ></el-option>
                          </el-select>
                        </el-form-item>

                        <!-- 语音选择框 -->
                        <el-form-item :label="t('edgettsVoice')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.edgettsVoice"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="voice in filteredNewVoices"
                              :key="voice.name"
                              :label="voice.name"
                              :value="voice.name"
                            ></el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                    </div>
                    <div class="tool-item" v-show="newTTSConfig.engine === 'GSV'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon>
                              <i class="fa-solid fa-volume-high"></i>
                            </el-icon>
                            GPT Sovits
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://github.com/RVC-Boss/GPT-SoVITS" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('gotoGithub') }}
                            </el-link>
                          </span>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item :label="t('gsvServer')" class="form-item-align">
                          <el-input
                            v-model="newTTSConfig.gsvServer"
                            :placeholder="t('gsvServerPlaceholder')"
                            @input="autoSaveSettings"
                            type="textarea"
                          />
                        </el-form-item>

                        <!-- 语速滑动条 -->
                        <el-form-item :label="t('gsvRate')" class="form-item-align">
                          <el-slider
                            v-model="newTTSConfig.gsvRate"
                            :min="0.1"
                            :max="2"
                            :step="0.1"
                            show-input
                            @change="autoSaveSettings">
                        </el-form-item>

                        <el-form-item :label="t('gsvSample_steps')" class="form-item-align">
                          <el-slider
                            v-model="newTTSConfig.gsvSample_steps"
                            :min="1"
                            :max="16"
                            :step="1"
                            show-input
                            @change="autoSaveSettings">
                        </el-form-item>                       

                        <!-- 语言选择框 -->
                        <el-form-item :label="t('gsvTextLang')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.gsvTextLang"
                            @change="autoSaveSettings"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="language in gsvTextLangs"
                              :key="language"
                              :label="t(language)"
                              :value="language"
                            ></el-option>
                          </el-select>
                        </el-form-item>

                        <!-- 提示语言选择框 -->
                        <el-form-item :label="t('gsvPromptLang')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.gsvPromptLang"
                            @change="autoSaveSettings"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="language in gsvTextLangs"
                              :key="language"
                              :label="t(language)"
                              :value="language"
                            ></el-option>
                          </el-select>
                        </el-form-item>

                        <!-- 提示音频选择框 -->
                        <el-form-item :label="t('gsvPromptAudio')" class="form-item-align">
                          <el-select
                            v-model="newTTSConfig.gsvRefAudioPath"
                            @change="handleRefAudioPathChange"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="audio in ttsSettings.gsvAudioOptions"
                              :key="audio.path"
                              :label="audio.name"
                               :value="audio.path"
                            >
                              <div class="model-option-item">
                                <span>{{ audio.name }}</span>
                                <i 
                                  class="fa-solid fa-trash-can"
                                  style="color: #ff0000"
                                  @click.stop="deleteAudioOption(audio.path)"
                                ></i>
                              </div>
                            </el-option>
                          </el-select>
                        </el-form-item>

                        <el-button 
                          @click="showGsvRefAudioPathDialog = true;currentUploadType='audio'"
                          type="primary" 
                          class="add-server-btn">
                          <i class="fa-solid fa-plus"></i> {{ t('addRefAudio') }}
                        </el-button>

                        <el-alert
                          type="info"
                          :closable="false"
                          class="mb-2"
                        >
                          <template #default>
                            <div class="alert-content">
                              {{ t('gsvNotice1') }}<br>
                              {{ t('gsvNotice2') }}
                            </div>
                          </template>
                        </el-alert>
                      </div>
                    </div>

                  </el-form>

                  <template #footer>
                    <el-button @click="showAddTTSDialog = false">{{ t('cancel') }}</el-button>
                    <el-button type="primary" @click="saveNewTTSConfig" :disabled="!newTTSConfig.name">
                      {{ t('confirmAdd') }}
                    </el-button>
                  </template>
                </el-dialog>
              </div>
              <!-- 角色形象 -->
              <div v-show="subMenu === 'appearance'" class="page">
                <div class="provider-grid">
                  <!-- 已有 形象 配置磁贴 -->
                  <div v-for="(config, name) in VRMConfig.newVRM" :key="name" class="provider-card knowledge-card">
                    <div class="card-header">
                      <!-- 启动按钮 -->
                      <el-tooltip :content="t('start_table_pet')" placement="top">
                        <el-button 
                          type="primary" 
                          @click="startNewVRM(name)" 
                          circle
                        >
                          <template v-if="isVRMStarting">
                            <i class="fa-solid fa-spinner fa-spin"></i>
                          </template>
                          <template v-else>
                            <i class="fa-solid fa-play"></i>
                          </template>
                        </el-button>
                      </el-tooltip>
                      <div class="card-actions">
                        <el-button @click="editAppearance(name)" type="primary" circle size="small">
                          <i class="fa-solid fa-pen-to-square"></i>
                        </el-button>
                        <el-button @click="deleteAppearance(name)" type="danger" circle size="small">
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="kb-content">
                      <h3 class="kb-title">{{ t(name) }}</h3>
                    </div>
                  </div>

                  <!-- 添加新 形象 磁贴 -->
                  <div class="provider-card add-tile" @click="openAddAppearanceDialog()">
                    <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addNewAppearance') }}</div>
                  </div>
                <!-- 新增 形象 配置对话框 -->
                <el-dialog v-model="showAddAppearanceDialog" :title="t('addNewAppearance')" width="80%">
                  <div class="tool-content">
                    <!-- 名称输入 -->
                    <el-form-item :label="t('AppearanceName')" required label-position="top">
                      <el-select 
                        v-model="newAppearanceConfig.name" 
                        filterable
                        allow-create
                      class="full-width-input">
                        <el-option :label="t('Narrator')" value='Narrator'></el-option>
                        <el-option
                          v-for="memory in memories"
                          :key="memory.id"
                          :label="memory.name"
                          :value="memory.name"
                        ></el-option>
                      </el-select>
                    </el-form-item>
                      <el-form-item :label="t('windowWidth')" class="form-item-align">
                        <el-slider
                          v-model="newAppearanceConfig.windowWidth"
                          :min="300"
                          :max="2560"
                          :step="10"
                          show-input
                          @change="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('windowHeight')" class="form-item-align">
                        <el-slider
                          v-model="newAppearanceConfig.windowHeight"
                          :min="450"
                          :max="2560"
                          :step="10"
                          show-input
                          @change="autoSaveSettings"
                        />
                      </el-form-item>

                      <!-- VRM模型选择框 -->
                      <el-form-item :label="t('selectVrmModel')" label-position="top">
                        <el-select
                          v-model="newAppearanceConfig.selectedModelId"
                          @change="handleModelChange"
                          class="full-width-input"
                        >
                          <!-- 默认模型分组 -->
                          <el-option-group :label="t('defaultModels')">
                            <el-option
                              v-for="model in VRMConfig.defaultModels"
                              :key="model.id"
                              :label="model.name"
                              :value="model.id"
                            >
                              <div class="model-option-item">
                                <!-- 图标在最前 -->
                                <i class="fa-solid fa-star" style="color: #f39c12; margin-right: 6px;"></i>
                                <span>{{ model.name }}</span>
                              </div>
                            </el-option>
                          </el-option-group>

                          <!-- 用户上传模型分组 -->
                          <el-option-group :label="t('userModels')" v-if="VRMConfig.userModels.length > 0">
                            <el-option
                              v-for="model in VRMConfig.userModels"
                              :key="model.id"
                              :label="model.name"
                              :value="model.id"
                            >
                              <div class="model-option-item">
                                <!-- 图标在最前 -->
                                <i
                                  class="fa-solid fa-trash-can"
                                  style="color: #ff0000; margin-right: 6px;"
                                  @click.stop="deleteModelOption(model.id)"
                                ></i>
                                <span>{{ model.name }}</span>
                              </div>
                            </el-option>
                          </el-option-group>
                        </el-select>

                        <!-- 模型上传按钮 -->
                        <el-button
                          @click="showVrmModelDialog = true"
                          type="primary"
                          class="add-server-btn"
                        >
                          <i class="fa-solid fa-plus"></i> {{ t('addVrmModel') }}
                        </el-button>
                      </el-form-item>

                      <!-- VRMA动作选择框（已统一） -->
                      <el-form-item :label="t('selectVrmaMotions')" label-position="top">
                        <el-select
                          v-model="newAppearanceConfig.selectedMotionIds"
                          @change="handleMotionChange"
                          class="full-width-input"
                          multiple
                        >
                          <!-- 默认动作分组 -->
                          <el-option-group :label="t('defaultMotions')">
                            <el-option
                              v-for="motion in VRMConfig.defaultMotions"
                              :key="motion.id"
                              :label="motion.name"
                              :value="motion.id"
                            >
                              <div class="motion-option-item">
                                <i class="fa-solid fa-star" style="color: #f39c12; margin-right: 6px;"></i>
                                <span>{{ motion.name }}</span>
                              </div>
                            </el-option>
                          </el-option-group>

                          <!-- 用户上传动作分组 -->
                          <el-option-group :label="t('userMotions')" v-if="VRMConfig.userMotions.length > 0">
                            <el-option
                              v-for="motion in VRMConfig.userMotions"
                              :key="motion.id"
                              :label="motion.name"
                              :value="motion.id"
                            >
                              <div class="motion-option-item">
                                <i
                                  class="fa-solid fa-trash-can"
                                  style="color: #ff0000; margin-right: 6px;"
                                  @click.stop="deleteMotionOption(motion.id)"
                                ></i>
                                <span>{{ motion.name }}</span>
                              </div>
                            </el-option>
                          </el-option-group>
                        </el-select>

                        <!-- 动作上传按钮 -->
                        <el-button
                          @click="showVrmaMotionDialog = true"
                          type="success"
                          class="add-server-btn"
                        >
                          <i class="fa-solid fa-plus"></i> {{ t('addVrmaMotion') }}
                        </el-button>
                      </el-form-item>
                      
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('vrmNotice1') }}<br>
                            {{ t('vrmNotice2') }}<br>
                            {{ t('vrmNotice3') }}
                          </div>
                        </template>
                      </el-alert>
                  </div>

                  <!-- VRM模型上传对话框 -->
                  <el-dialog
                    v-model="showVrmModelDialog"
                    :title="t('uploadVrmModel')"
                    width="600px"
                  >
                    <div class="upload-container">
                      <div
                        class="drop-zone"
                        @dragover.prevent
                        @drop.prevent="handleVrmModelDrop"
                        @click="browseVrmModelFile"
                      >
                        <el-icon :size="50"><i class="fa-solid fa-cloud-arrow-up"></i></el-icon>
                        <p>{{ t('clickOrDropVrm') }}</p>
                      </div>
                      
                      <!-- 文件列表 -->
                      <div class="compact-file-list" v-if="newVrmModel.name">
                        <div class="compact-file-item">
                          <span class="file-name">{{ newVrmModel.name }}</span>
                          <el-button
                            @click.stop="removeNewVrmModel"
                            class="delete-icon"
                            circle
                          >
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </div>
                      </div>

                      <el-input
                        v-model="newVrmModel.displayName"
                        :label="t('modelDisplayName')"
                        :placeholder="t('modelDisplayNamePlaceholder')"
                        required
                      />
                    </div>
                    <template #footer>
                      <el-button @click="cancelVrmModelUpload">{{ t('cancel') }}</el-button>
                      <el-button type="primary" @click="uploadVrmModel" :disabled="!newVrmModel.name">
                        {{ t('createImmediately') }}
                      </el-button>
                    </template>
                  </el-dialog>

                  <!-- VRMA动作上传对话框 -->
                  <el-dialog
                    v-model="showVrmaMotionDialog"
                    :title="t('uploadVrmaMotion')"
                    width="600px"
                  >
                    <div class="upload-container">
                      <div
                        class="drop-zone"
                        @dragover.prevent
                        @drop.prevent="handleVrmaMotionDrop"
                        @click="browseVrmaMotionFile"
                      >
                        <el-icon :size="50"><i class="fa-solid fa-cloud-arrow-up"></i></el-icon>
                        <p>{{ t('clickOrDropVrma') }}</p>
                      </div>
                      
                      <!-- 文件列表 -->
                      <div class="compact-file-list" v-if="newVrmaMotion.name">
                        <div class="compact-file-item">
                          <span class="file-name">{{ newVrmaMotion.name }}</span>
                          <el-button
                            @click.stop="removeNewVrmaMotion"
                            class="delete-icon"
                            circle
                          >
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </div>
                      </div>

                      <el-input
                        v-model="newVrmaMotion.displayName"
                        :label="t('motionDisplayName')"
                        :placeholder="t('motionDisplayNamePlaceholder')"
                        required
                      />
                    </div>
                    <template #footer>
                      <el-button @click="cancelVrmaMotionUpload">{{ t('cancel') }}</el-button>
                      <el-button type="primary" @click="uploadVrmaMotion" :disabled="!newVrmaMotion.name">
                        {{ t('createImmediately') }}
                      </el-button>
                    </template>
                  </el-dialog>
                  <template #footer>
                    <el-button @click="showAddAppearanceDialog = false">{{ t('cancel') }}</el-button>
                    <el-button type="primary" @click="saveNewAppearanceConfig" :disabled="!newAppearanceConfig.name">
                      {{ t('confirmAdd') }}
                    </el-button>
                  </template>
                </el-dialog>
                </div>
              </div>
              <!-- 角色行为页面 -->
              <div v-show="subMenu === 'behavior'" class="page mcp-container">
                
                <!-- 顶部全局设置区域 (保留原有逻辑，但样式优化) -->
                <div class="market-link-banner behavior-banner">
                  <div class="banner-accent-bar">{{ t('AutoBehavior') }}</div>
                  <div class="banner-main" style="justify-content: space-between; padding: 0 20px;">
                    
                    <!-- 左侧：图标和说明 -->
                    <div style="display: flex; align-items: center; gap: 15px;">
                      <div class="banner-icon-box">
                        <i class="fa-solid fa-person-running"></i>
                      </div>
                      <div class="banner-text">
                        <h3>{{ t('AutoBehavior') || 'Behavior Settings' }}</h3>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 12px;">
                          {{ t('autoBehaviorNotice') }}
                        </p>
                      </div>
                    </div>

                    <!-- 右侧：全局开关 -->
                    <div style="display: flex; flex-direction: column; gap: 10px; align-items: flex-end;">
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: bold;">{{ t('enable') }}</span>
                        <el-switch 
                          v-model="behaviorSettings.enabled" 
                          @change="resetCycleTimers();autoSaveSettings()"
                          style="--el-switch-on-color: #13ce66;"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 行为卡片网格 -->
                <div class="provider-grid">
                  <div class="provider-card knowledge-card" v-for="(b, idx) in behaviorSettings.behaviorList" :key="idx">
                    <div class="card-header">
                      <!-- 单个行为开关 -->
                      <el-switch
                        v-model="b.enabled"
                        @change="resetCycleTimers();autoSaveSettings()"
                        class="kb-switch"
                      ></el-switch>
                      
                      <div class="card-actions">
                        <!-- 编辑按钮 -->
                        <el-button
                          @click="openBehaviorDialog(idx)"
                          type="primary"
                          circle
                          size="small"
                        >
                          <i class="fa-solid fa-pen-to-square"></i>
                        </el-button>
                        <!-- 删除按钮 -->
                        <el-button
                          @click="confirmRemoveBehavior(idx)"
                          type="danger"
                          circle
                          size="small"
                        >
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>

                    <div class="kb-content" @click="openBehaviorDialog(idx)" style="cursor: pointer;">
                      <div class="kb-header">
                        <!-- 标题：触发类型 -->
                        <h3 class="kb-title">
                          <i :class="getTriggerIcon(b.trigger.type)" style="margin-right: 8px;"></i>
                          {{ t(behaviorNameDict[b.trigger.type]) }}
                        </h3>
                        
                        <!-- 标签：动作类型 -->
                        <el-tag size="small">
                          {{ t(b.action.type) }}
                        </el-tag>
                      </div>

                      <div class="kb-meta">
                        <!-- 描述信息概览 -->
                        <div class="kb-meta-item">
                          <span style="font-size: 12px; color: #909399; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            {{ getBehaviorSummary(b) }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- 添加新行为卡片 -->
                  <div class="provider-card add-tile" @click="openBehaviorDialog(-1)">
                    <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addBehavior') }}</div>
                  </div>
                </div>

                <!-- 添加/编辑 行为对话框 -->
                <el-dialog
                  v-model="showBehaviorDialog"
                  :title="isEditingBehavior ? t('editBehavior') : t('addBehavior')"
                  width="600px"
                  :close-on-click-modal="false"
                  class="mcp-dialog"
                  @closed="resetBehaviorDialogState"
                >
                  <div v-if="tempBehavior" class="behavior-dialog-content">
                    <el-form :model="tempBehavior" label-position="top">
                      
                      <!-- 触发条件配置 -->
                      <h2>{{ t('triggerSettings') }}</h2>
                      
                      <el-form-item :label="t('triggerType')">
                        <el-select v-model="tempBehavior.trigger.type" class="full-width-input">
                          <el-option :label="t('timeName')"   value="time"></el-option>
                          <el-option :label="t('noInputName')" value="noInput"></el-option>
                          <el-option :label="t('cycleName')" value="cycle"></el-option>
                        </el-select>
                      </el-form-item>

                      <!-- 时间触发详情 -->
                      <div v-if="tempBehavior.trigger.type === 'time'" class="sub-config-box">
                        <el-row :gutter="12">
                          <el-col :span="24">
                            <el-form-item :label="t('time')">
                              <el-time-picker
                                v-model="tempBehavior.trigger.time.timeValue"
                                value-format="HH:mm:ss"
                                format="HH:mm:ss"
                                :placeholder="t('selectTime')"
                                style="width: 100%"
                              />
                            </el-form-item>
                          </el-col>
                        </el-row>
                        <el-form-item :label="t('repeatDays')">
                          <el-select v-model="tempBehavior.trigger.time.days" multiple style="width: 100%">
                            <el-option :label="t('monday')"    :value="1"></el-option>
                            <el-option :label="t('tuesday')"   :value="2"></el-option>
                            <el-option :label="t('wednesday')" :value="3"></el-option>
                            <el-option :label="t('thursday')"  :value="4"></el-option>
                            <el-option :label="t('friday')"    :value="5"></el-option>
                            <el-option :label="t('saturday')"  :value="6"></el-option>
                            <el-option :label="t('sunday')"    :value="0"></el-option>
                          </el-select>
                        </el-form-item>
                      </div>

                      <!-- 无输入触发详情 -->
                      <div v-if="tempBehavior.trigger.type === 'noInput'" class="sub-config-box">
                        <el-form-item :label="t('noInputLatency') + ' (s)'">
                          <el-slider
                            v-model="tempBehavior.trigger.noInput.latency"
                            :min="10"
                            :max="600"
                            :step="5"
                            show-input>
                          </el-slider>
                        </el-form-item>
                      </div>

                      <!-- 周期触发详情 -->
                      <div v-if="tempBehavior.trigger.type === 'cycle'" class="sub-config-box">
                        <el-row :gutter="12">
                          <el-col :span="24">
                            <el-form-item :label="t('cycleValue')">
                              <el-time-picker
                                v-model="tempBehavior.trigger.cycle.cycleValue"
                                value-format="HH:mm:ss"
                                format="HH:mm:ss"
                                :placeholder="t('selectTime')"
                                style="width: 100%"
                              />
                            </el-form-item>
                          </el-col>
                        </el-row>
                        <el-form-item :label="t('repeatNumber')">
                          <el-slider
                            v-model="tempBehavior.trigger.cycle.repeatNumber"
                            :min="1"
                            :max="100"
                            :step="1"
                            show-input>
                          </el-slider>
                        </el-form-item>
                        <el-form-item :label="t('isInfiniteLoop')">
                          <el-switch v-model="tempBehavior.trigger.cycle.isInfiniteLoop"></el-switch>
                        </el-form-item>
                      </div>
                      <el-divider></el-divider>
                      <!-- 执行动作配置 -->
                      <h2>{{ t('actionSettings') }}</h2>

                      <el-form-item :label="t('actionType')">
                        <el-select v-model="tempBehavior.action.type" class="full-width-input">
                          <el-option :label="t('prompt')" value="prompt"></el-option>
                          <el-option :label="t('randomEvent')" value="random"></el-option>
                          <el-option :label="t('randomTopic')" value="topic"></el-option>
                        </el-select>
                      </el-form-item>

                      <!-- Prompt 动作 -->
                      <div v-if="tempBehavior.action.type === 'prompt'" class="sub-config-box">
                        <el-form-item :label="t('promptAction')">
                          <el-input
                            type="textarea"
                            v-model="tempBehavior.action.prompt"
                            :rows="4"
                            :placeholder="t('promptPlaceholder')"
                          />
                        </el-form-item>
                      </div>

                      <!-- Random 动作配置区 -->
                      <div v-if="tempBehavior.action.type === 'random'" class="sub-config-box">
                        
                        <!-- 类型选择 -->
                        <el-form-item :label="t('eventType')">
                          <el-select v-model="tempBehavior.action.random.type" class="full-width-input">
                            <el-option :label="t('random')" value="random"></el-option>
                            <el-option :label="t('order')" value="order"></el-option>
                          </el-select>
                        </el-form-item>

                        <!-- 事件列表 -->
                        <div class="events-management-list">
                          <label class="sub-label">{{ t('eventList') }}</label>
                          
                          <!-- 每一行：输入框 + 删除按钮 -->
                          <div v-for="(event, eIdx) in tempBehavior.action.random.events" :key="eIdx" class="event-row-item">
                            <!-- 左侧输入框 -->
                            <div class="input-col">
                              <el-input
                                type="textarea"
                                v-model="tempBehavior.action.random.events[eIdx]"
                                :rows="2"
                                :placeholder="t('promptPlaceholder')"
                              />
                            </div>
                            
                            <!-- 右侧删除按钮：紧贴输入框右侧 -->
                            <div class="action-col">
                              <el-button @click="removeTempEvent(eIdx)" type="danger" circle :disabled="tempBehavior.action.random.events.length <= 1">
                                <i class="fa-solid fa-trash"></i>
                              </el-button>
                            </div>
                          </div>

                          <!-- 底部添加按钮 -->
                          <el-button 
                            type="primary" 
                            class="add-server-btn"
                            @click="addTempEvent"
                          >
                            <i class="fa-solid fa-plus"></i> {{ t('addEvent') }}
                          </el-button>
                        </div>
                      </div>

                      <!-- Topic 动作 -->
                      <div v-if="tempBehavior.action.type === 'topic'" class="sub-config-box">
                        <el-form-item :label="t('baseURL')">
                          <el-input
                            v-model="toolsSettings.randomTopic.baseURL"
                            :placeholder="t('randomTopicPlaceholder')"
                          ></el-input>
                        </el-form-item>
                        <el-form-item :label="t('topicLimit')">
                          <el-slider
                              v-model="tempBehavior.action.topicLimit"
                              :min="1"
                              :max="5"
                              :step="1"
                              show-input
                          ></el-slider>
                        </el-form-item>
                        <el-alert type="info" :closable="false" show-icon>
                          <template #default>
                            <el-link type="primary" href="https://github.com/heshengtao/topics-after-party" target="_blank">
                              {{ t('gotoGithub') }}
                            </el-link>
                          </template>
                        </el-alert>
                      </div>

                      <!-- 推送平台 -->
                      <div class="sub-config-box">
                        <el-form-item :label="t('behaviorPlatform')">
                          <el-select v-model="tempBehavior.platform" class="full-width-input">
                            <el-option :label="t('chatInterface')" value="chat"></el-option>
                            <el-option :label="t('feishuBot')" value="feishu"></el-option>
                            <el-option :label="t('dingtalkBot')" value="dingtalk"></el-option>
                            <el-option :label="t('telegramBot')" value="telegram"></el-option>
                            <el-option :label="t('discordBot')" value="discord"></el-option>
                            <el-option :label="t('slackBot')" value="slack"></el-option>
                          </el-select>
                        </el-form-item>
                      </div>

                    </el-form>
                  </div>

                  <template #footer>
                    <span class="dialog-footer">
                      <el-button @click="showBehaviorDialog = false">{{ t('cancel') }}</el-button>
                      <el-button type="primary" @click="saveBehavior">{{ t('confirmSave') }}</el-button>
                    </span>
                  </template>
                </el-dialog>
              </div>
            </div>
          </div>
        </div>

        <!-- 音频上传对话框 -->
        <el-dialog
          v-model="showGsvRefAudioPathDialog"
          :title="t('uploadGsvRefAudio')"
          width="600px"
        >
          <div class="upload-container">
            <div
              class="drop-zone"
              @dragover.prevent
              @drop.prevent="handleGsvRefAudioDrop"
              @click="browseGsvRefAudioFile"
            >
              <el-icon :size="50"><i class="fa-solid fa-cloud-arrow-up"></i></el-icon>
              <p>{{ t('clickOrDrop') }}</p>
            </div>
            
            <!-- 文件列表 -->
            <div class="compact-file-list" v-if="newGsvAudio.file">
              <div class="compact-file-item">
                <span class="file-name">@{{ newGsvAudio.name }}</span>
                <el-button
                  @click.stop="removeNewGsvAudio"
                  class="delete-icon"
                  circle
                >
                  <i class="fa-solid fa-trash"></i>
                </el-button>
              </div>
            </div>
          </div>
          <el-form-item :label="t('gsvGsvAudioPath')" class="form-item-align" v-if="!newGsvAudio.file">
            <el-input
              v-model="newGsvAudio.path"
              :placeholder="t('gsvGsvAudioPathPlaceholder')"
              @input="changeGsvAudioPath"
            ></el-input>
          </el-form-item>
          <el-form-item :label="t('gsvPromptText')" class="form-item-align">
            <el-input
              v-model="newGsvAudio.text"
              :placeholder="t('gsvPromptTextPlaceholder')"
            ></el-input>
          </el-form-item>
          <template #footer>
            <el-button @click="cancelGsvAudioUpload">{{ t('cancel') }}</el-button>
            <el-button type="primary" @click="uploadGsvAudio" :disabled="!newGsvAudio.name||!newGsvAudio.text">
              {{ t('createImmediately') }}
            </el-button>
          </template>
        </el-dialog>

        <div v-show="activeMenu === 'model-config'" class="page agent-suite-container">
          <div class="suite-layout">
            <!-- 左侧二级导航 -->
            <div class="suite-sidebar">
              <div class="tile-nav">
                <div 
                  v-for="tile in modelTiles" 
                  :key="tile.id"
                  class="nav-item"
                  :class="{ active: subMenu === tile.id }"
                  @click="subMenu = tile.id">
                  <el-icon class="nav-icon"><i :class="tile.icon"></i></el-icon>
                  <span class="nav-text">{{ t(tile.title) }}</span>
                </div>
              </div>
            </div>
            <!-- 右侧内容区 -->
            <div class="suite-content">
              <!-- 模型服务界面 -->
              <div v-show="subMenu === 'service'" class="page">
                <!-- 顶部全局设置区域 (模型配置样式优化) -->
                <div class="market-link-banner model-config-banner">
                  <!-- 左侧装饰条：显示“MODELS”或类似文字 -->
                  <div class="banner-accent-bar">{{ t('modelConfig') || 'MODELS' }}</div>
                  
                  <div class="banner-main" style="justify-content: space-between; padding: 0 20px;">
                    
                    <!-- 左侧：图标和说明文案 -->
                    <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                      <div class="banner-icon-box">
                        <i class="fa-solid fa-robot"></i> <!-- 改为机器人图标更贴合模型配置 -->
                      </div>
                      <div class="banner-text">
                        <h3 style="margin: 0">{{ t('modelConfigDescription') }}</h3>
                        <!-- 多行说明文字 -->
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 12px; line-height: 1.5; color: white;">
                          1. {{ t('localConfigNotice') }}<br>
                          2. {{ t('localConfigNotice02') }}<br>
                          3. {{ t('localConfigNotice03') }}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- 磁贴网格 -->
                <div class="provider-grid">
                  <!-- 已有供应商磁贴 -->
                  <div class="provider-card" v-for="(provider, index) in modelProviders" :key="provider.id">
                    <div class="card-header">
                      <img 
                        :src="getVendorLogo(provider.vendor)" 
                        class="mini-vendor-logo"
                      />
                      <div class="card-actions">
                        <el-tooltip :content="t('copyProvider')" placement="top">
                          <el-button
                            @click="copyProvider(provider,index)"
                            type="default"
                            circle
                            size="small"
                          >
                          <i class="fa-solid fa-copy"></i>
                          </el-button>
                        </el-tooltip>
                        <el-tooltip :content="t('getAPIkey')" placement="top">
                          <el-button
                            @click="goToURL(provider)"
                            type="info"
                            circle
                            size="small"
                            id="get-API-key"
                          >
                          <i class="fa-solid fa-key"></i>
                          </el-button>
                        </el-tooltip>
                        <el-tooltip :content="t('getModelsList')" placement="top">
                          <el-button
                            @click="fetchModelsForProvider(provider)"
                            type="primary"
                            circle
                            size="small"
                            id="get-Models-List"
                          >
                          <i class="fa-solid fa-magnifying-glass"></i>
                          </el-button>
                        </el-tooltip>
                        <el-tooltip :content="t('delete')" placement="top">
                          <el-button
                            @click="removeProvider(index)"
                            type="danger"
                            circle
                            size="small"
                          >
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </el-tooltip>
                      </div>
                    </div>

                    <div class="input-group">
                      <!-- 添加输入框标签 -->
                      <div class="input-item">
                        <label>
                          {{ t('apiAddress') }}
                          <el-tooltip :content="t('copy')" placement="top">
                            <el-button
                              @click="copyApiKey(provider.url)"
                              type="default"
                              circle
                              size="small"
                              style="margin-bottom: 2px;"
                            >
                              <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </el-tooltip>
                        </label>
                        <el-input
                          v-model="provider.url"
                          :placeholder="t('apiAddressPlaceholder')"
                          @change="autoSaveSettings"
                        />
                      </div>

                      <div class="input-item">
                        <label>
                          {{ t('apiKey') }}
                          <el-tooltip :content="t('copy')" placement="top">
                            <el-button
                              @click="copyApiKey(provider.apiKey)"
                              type="default"
                              circle
                              size="small"
                              style="margin-bottom: 2px;"
                            >
                              <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </el-tooltip>
                        </label>

                        <el-input
                          v-model="provider.apiKey"
                          :placeholder="t('apiKeyPlaceholder')"
                          show-password
                          @change="autoSaveSettings"
                          id="input-api-Key"
                        />
                      </div>

                      <div class="input-item" id="model-Id">
                        <label>
                          {{ t('modelId') }}
                          <el-tooltip :content="t('copy')" placement="top">
                            <el-button
                              @click="copyApiKey(provider.modelId)"
                              type="default"
                              circle
                              size="small"
                              style="margin-bottom: 2px;"
                            >
                              <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </el-tooltip>
                        </label>
                        <el-select
                          v-model="provider.modelId"
                          filterable
                          allow-create
                          :placeholder="provider.models?.length ? t('selectOrTypeModel') : t('modelIdPlaceholder')"
                          class="model-select"
                          @change="autoSaveSettings"
                        >
                          <el-option
                            v-for="model in provider.models"
                            :key="model"
                            :label="model"
                            :value="model"
                          />
                        </el-select>
                      </div>
                    </div>
                  </div>
                  <!-- 添加新磁贴 -->
                  <div id="add-provider-card" class="provider-card add-tile" @click="showAddDialog = true">
                    <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addNewProvider') }}</div>
                  </div>
                </div>

                <!-- 添加供应商对话框 -->
                <el-dialog
                  v-model="showAddDialog"
                  id="show-Add-Dialog"
                  :title="t('addNewProvider')"
                  width="90%"
                  @closed="newProviderTemp = { vendor: '', url: '' }"
                >
                  <!-- 供应商选择区域 -->
                  <el-form-item :label="t('provider')" required label-position="top">
                    <div class="vendor-grid">
                      <div 
                        v-for="item in vendorOptions" 
                        :key="item.value"
                        class="vendor-card"
                        :class="{ 'selected': newProviderTemp.vendor === item.value }"
                        @click="handleSelectVendor(item.value)"
                        id="vendor-Option"
                      >
                        <img 
                          :src="getVendorLogo(item.value)" 
                          :alt="item.label"
                          class="vendor-logo"
                        />
                        <div class="vendor-name">{{ t(item.label) }}</div>
                      </div>
                    </div>
                  </el-form-item>


                    <el-form-item
                      v-if="newProviderTemp.vendor === 'custom'"
                      :label="t('customURL')"
                      required
                    >
                      <el-input
                        v-model="newProviderTemp.url"
                        placeholder="https://api.example.com/v1"
                      />
                    </el-form-item>

                    <div v-if="newProviderTemp.vendor && newProviderTemp.vendor !== 'custom'">
                      <el-alert
                        :title="t('defaultConfigInfo')"
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        1. {{ t('autoFilledDefaultAPI') }} {{ newProviderTemp.vendor }} URL<br>2. 
                          <el-link
                            type="primary"
                            :underline="false"
                            :href="vendorAPIpage[newProviderTemp.vendor]" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link><br>
                        3. {{ t('enterApiKeyThenClick') }}<br>
                        4. {{ t('localConfigNotice') }}
                      </el-alert>
                    </div>
                  </el-form>

                  <template #footer>
                    <el-button @click="showAddDialog = false">{{ t('cancel') }}</el-button>
                    <el-button
                      type="primary"
                      id = "confirm-Add-Provider-Button"
                      @click="confirmAddProvider"
                      :disabled="!validProvider"
                    >
                      {{ t('confirmAdd') }}
                    </el-button>
                  </template>
                </el-dialog>
              </div>
              <!-- 主模型界面 -->
              <div v-show="subMenu === 'main'" class="page">
                <el-form :model="settings" class="settings-form" label-position="top">
                  <div class="tool-item">
                    <!-- 基础配置（仅供应商） -->
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-microchip"></i>
                          </el-icon>
                          {{ t('basicConfiguration') }}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('provider')" class="form-item-align">
                        <el-select
                          v-model="settings.selectedProvider"
                          :placeholder="t('selectProvider')"
                          filterable
                          @change="selectMainProvider"
                          @visible-change="handleMainProviderVisibleChange"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="provider in modelProviders"
                            :key="provider.id"
                            :label="provider.vendor+' - '+provider.modelId"
                            :value="provider.id"
                          >
                            <div class="provider-option">
                              <img 
                                :src="getVendorLogo(provider.vendor)" 
                                class="mini-vendor-logo"
                              />
                              <span class="model-id">{{ provider.modelId }}</span>
                            </div>
                          </el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('enableOmniTTS')" class="form-item-align" label-position="left">
                        <el-switch 
                          v-model="settings.enableOmniTTS" 
                          @change="autoSaveSettings"
                        ></el-switch>
                      </el-form-item>
                      <el-form-item v-if="settings.enableOmniTTS" :label="t('enabledInterruption')" class="form-item-align" label-position="left">
                        <el-switch 
                          v-model="ttsSettings.enabledInterruption" 
                          @change="autoSaveSettings"
                        ></el-switch>
                      </el-form-item>
                      <el-form-item v-if="settings.enableOmniTTS" :label="t('omniVoice')" class="form-item-align" label-position="left">
                        <el-input
                          v-model="settings.omniVoice"
                          :placeholder="t('omniVoicePlaceholder')"
                        ></el-input>
                      </el-form-item>
                    </div>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('firstTimeUse') }}
                            <el-link
                              type="primary"
                              :underline="false"
                              class="font-medium"
                              @click="switchToApiBox"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('keyBoxInterface') }}
                            </el-link>
                            {{ t('addProviderReturnSelect') }}
                            {{ t('mainmodelnotice') }}
                          </div>
                        </template>
                      </el-alert>
                  </div>
                  <!-- 新增高级配置 -->
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-chevron-right"></i>
                          </el-icon>
                          {{ t('advancedConfiguration') }}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('temperature')" class="form-item-align">
                        <el-slider
                          v-model="settings.temperature"
                          :min="0"
                          :max="1"
                          :step="0.1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="'top_p'" class="form-item-align">
                        <el-slider
                          v-model="settings.top_p"
                          :min="0"
                          :max="1"
                          :step="0.1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('outputLength')" class="form-item-align">
                        <el-slider
                          v-model="settings.max_tokens"
                          :min="0"
                          :max="128000"
                          :step="1024"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('conversationRounds')" class="form-item-align">
                        <el-slider
                          v-model="settings.max_rounds"
                          :min="0"
                          :max="1000"
                          :step="2"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('reasoningEffort')" class="form-item-align">
                        <el-select
                          v-model="settings.reasoning_effort"
                          :placeholder="t('reasoningEffort')"
                          @change="autoSaveSettings"
                          class="reasoning-effort-select"
                        >
                          <el-option
                            v-for="effort in reasoningEfforts"
                            :key="effort.value"
                            :label="t(effort.label)"
                            :value="effort.value"
                          ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item v-if="isElectron" :label="t('desktopVision')" class="form-item-align" label-position="left">
                        <el-switch 
                          v-model="visionSettings.desktopVision" 
                          @change="autoSaveSettings"
                        ></el-switch>
                      </el-form-item>
                      <el-form-item v-if="isElectron" :label="t('enableDesktopVisionWakeWord')" class="form-item-align" label-position="left">
                        <el-switch 
                          v-model="visionSettings.enableWakeWord" 
                          @change="autoSaveSettings"
                        ></el-switch>
                      </el-form-item>
                      <el-form-item v-if="isElectron" :label="t('desktopVisionWakeWord')" class="form-item-align">
                        <el-input
                          v-model="visionSettings.wakeWord"
                          :placeholder="t('desktopVisionWakeWordPlaceholder')"
                          @input="autoSaveSettings"
                          type="textarea"
                          :rows="3"
                        />
                      </el-form-item>
                      <div class="param-header">
                        <span>{{ t('extraParams') }}</span>
                        <el-button 
                          @click="addParam"
                          type="primary"
                          circle
                          size="small"
                          class="header-add-btn"
                        >
                          <i class="fa-solid fa-plus"></i>
                        </el-button>
                      </div>
                      <div class="extra-params">
                        <div
                          v-for="(param, index) in settings.extra_params"
                          :key="index"
                          class="param-row"
                        >
                          <el-input
                            v-model="param.name"
                            :placeholder="t('paramName')"
                            class="param-input"
                            @input="autoSaveSettings"
                          ></el-input>
                      
                          <el-select
                            v-model="param.type"
                            :placeholder="t('paramType')"
                            @change="updateParamType(index)"
                            class="type-select"
                          >
                            <el-option
                              v-for="type in paramTypes"
                              :key="type.value"
                              :label="t(type.label)"
                              :value="type.value"
                            ></el-option>
                          </el-select>
                      
                          <!-- 动态输入组件 -->
                          <div class="value-input">
                            <el-input
                              v-if="param.type === 'string'"
                              v-model="param.value"
                              :placeholder="t('paramValue')"
                              @input="autoSaveSettings"
                            ></el-input>
                          
                            <el-input-number
                              v-if="param.type === 'integer'"
                              v-model="param.value"
                              :step="1"         
                              :precision="0"   
                              @input="autoSaveSettings"
                            ></el-input-number>
                          
                            <el-input-number
                              v-if="param.type === 'float'"
                              v-model="param.value"
                              :step="0.5"      
                              :precision="2"    
                              @input="autoSaveSettings"
                            ></el-input-number>
      
                            <el-switch 
                              v-if="param.type === 'boolean'" 
                              v-model="param.value" 
                              @change="autoSaveSettings"
                            ></el-switch>
                          </div>
                      
                          <el-button
                            @click="removeParam(index)"
                            type="danger"
                            circle
                            size="small"
                            class="remove-btn"
                          >
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </div>
                      </div>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('extraParamsNotice') }}
                          </div>
                        </template>
                      </el-alert>
                    </div>
                  </div>
                </el-form>
              </div>
              <!-- 推理模型界面 -->
              <div v-show="subMenu === 'reasoner'" class="page">
                <el-form :model="settings" class="settings-form" label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-atom"></i>
                          </el-icon>
                          {{ t('reasonerConfig') }}
                        </span>
                      </div>
                      <el-switch v-model="reasonerSettings.enabled" @click.stop @change="autoSaveSettings"/>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('reasoningProvider')" class="form-item-align">
                        <el-select
                          v-model="reasonerSettings.selectedProvider"
                          :placeholder="t('selectProvider')"
                          filterable
                          @change="selectReasonerProvider"
                          @visible-change="handleReasonerProviderVisibleChange"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="provider in modelProviders"
                            :key="provider.id"
                            :label="provider.vendor+' - '+provider.modelId"
                            :value="provider.id"
                          >
                            <div class="provider-option">
                              <img 
                                :src="getVendorLogo(provider.vendor)" 
                                class="mini-vendor-logo"
                              />
                              <span class="model-id">{{ provider.modelId }}</span>
                            </div>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                    <el-alert
                    type="info"
                    :closable="false"
                    class="mb-2"
                  >
                    <template #default>
                      <div class="alert-content">
                        {{ t('firstTimeUse') }}
                        <el-link
                          type="primary"
                          :underline="false"
                          class="font-medium"
                          @click="switchToApiBox"
                        >
                          <el-icon class="mr-1">
                            <i class="fa-solid fa-key"></i>
                          </el-icon>{{ t('keyBoxInterface') }}
                        </el-link>
                        {{ t('addProviderReturnSelect') }}
                        {{ t('addresonerNotice') }}
                      </div>
                    </template>
                  </el-alert>
                  </div>
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-chevron-right"></i>
                          </el-icon>
                          {{ t('advancedConfiguration') }}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('temperature')" class="form-item-align">
                        <el-slider
                          v-model="reasonerSettings.temperature"
                          :min="0"
                          :max="1"
                          :step="0.1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('outputLength')" class="form-item-align">
                        <el-slider
                          v-model="reasonerSettings.max_tokens"
                          :min="0"
                          :max="128000"
                          :step="1024"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('stopWords')">
                        <el-select
                          v-model="reasonerSettings.stop_words"
                          multiple
                          filterable
                          allow-create
                          :placeholder="t('stopWordsPlaceholder')"
                          class="full-width-input"
                          @change="autoSaveSettings"
                        >
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('reasoningEffort')" class="form-item-align">
                        <el-select
                          v-model="reasonerSettings.reasoning_effort"
                          :placeholder="t('reasoningEffort')"
                          @change="autoSaveSettings"
                          class="reasoning-effort-select"
                        >
                          <el-option
                            v-for="effort in reasoningEfforts"
                            :key="effort.value"
                            :label="t(effort.label)"
                            :value="effort.value"
                          ></el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>
                </el-form>
              </div>
              <div v-show="subMenu === 'vision'" class="page">
                <el-form :model="settings" class="settings-form" label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon><i class="fa-solid fa-camera"></i></el-icon>
                          {{ t('visionSettings') }}
                        </span>
                      </div>
                      <el-switch v-model="visionSettings.enabled" @click.stop @change="autoSaveSettings"/>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('visionProvider')" class="form-item-align">
                        <el-select
                          v-model="visionSettings.selectedProvider"
                          :placeholder="t('selectProvider')"
                          filterable
                          @change="selectVisionProvider"
                          @visible-change="handleVisionProviderVisibleChange"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="provider in modelProviders"
                            :key="provider.id"
                            :label="provider.vendor+' - '+provider.modelId"
                            :value="provider.id"
                          >
                            <div class="provider-option">
                              <img 
                                :src="getVendorLogo(provider.vendor)" 
                                class="mini-vendor-logo"
                              />
                              <span class="model-id">{{ provider.modelId }}</span>
                            </div>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                    <el-alert
                    type="info"
                    :closable="false"
                    class="mb-2"
                  >
                    <template #default>
                      <div class="alert-content">
                        {{ t('firstTimeUse') }}
                        <el-link
                          type="primary"
                          :underline="false"
                          class="font-medium"
                          @click="switchToApiBox"
                        >
                          <el-icon class="mr-1">
                            <i class="fa-solid fa-key"></i>
                          </el-icon>{{ t('keyBoxInterface') }}
                        </el-link>
                        {{ t('addProviderReturnSelect') }}
                        {{ t('addVisionNotice') }}
                      </div>
                    </template>
                  </el-alert>
                  </div>
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-chevron-right"></i>
                          </el-icon>
                          {{ t('advancedConfiguration') }}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('temperature')" class="form-item-align">
                        <el-slider
                          v-model="visionSettings.temperature"
                          :min="0"
                          :max="1"
                          :step="0.1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item v-if="isElectron" :label="t('desktopVision')" class="form-item-align" label-position="left">
                        <el-switch 
                          v-model="visionSettings.desktopVision" 
                          @change="autoSaveSettings"
                        ></el-switch>
                      </el-form-item>
                      <el-form-item v-if="isElectron" :label="t('enableDesktopVisionWakeWord')" class="form-item-align" label-position="left">
                        <el-switch 
                          v-model="visionSettings.enableWakeWord" 
                          @change="autoSaveSettings"
                        ></el-switch>
                      </el-form-item>
                      <el-form-item v-if="isElectron" :label="t('desktopVisionWakeWord')" class="form-item-align">
                        <el-input
                          v-model="visionSettings.wakeWord"
                          :placeholder="t('desktopVisionWakeWordPlaceholder')"
                          @input="autoSaveSettings"
                          type="textarea"
                          :rows="3"
                        />
                      </el-form-item>
                    </div>
                  </div>
                </el-form>
              </div>
             <!-- 图像生成界面 -->
              <div v-show="subMenu === 'text2img'" class="page">
                <el-form :model="text2imgSettings" class="settings-form"  label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-pencil"></i>
                          </el-icon>
                          {{ t('imgModel') }}
                        </span>
                      </div>
                      <el-switch v-model="text2imgSettings.enabled" @click.stop @change="autoSaveSettings"/>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('imgEngine')" class="form-item-align">
                        <el-select
                          v-model="text2imgSettings.engine"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option :label="t('pollinations')" value="pollinations" ></el-option>
                          <el-option :label="t('openaiImageLike')" value="openai" ></el-option>
                          <el-option :label="t('openaiChatLike')" value="openaiChat" ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            1. {{ t('text2imgNotice') }}<br>
                            2. {{ t('gotoComfyui') }}
                            <el-link
                              type="primary"
                              :underline="false"
                              class="font-medium"
                              @click="switchToComfyui"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('ComfyuiInterface') }}
                            </el-link>
                          </div>
                        </template>
                      </el-alert>
                    </div>
                  </div>
                  <div class="tool-item" v-show="text2imgSettings.engine === 'pollinations'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-pencil"></i>
                          </el-icon>
                          Pollinations
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('model')" class="form-item-align">
                        <el-select
                          v-model="text2imgSettings.pollinations_model"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option label="Flux" value="flux" ></el-option>
                          <el-option label="Flux-turbo" value="turbo" ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('width')" class="form-item-align">
                        <el-slider
                          v-model="text2imgSettings.pollinations_width"
                          :min="128"
                          :max="4096"
                          :step="64"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('height')" class="form-item-align">
                        <el-slider
                          v-model="text2imgSettings.pollinations_height"
                          :min="128"
                          :max="4096"
                          :step="64"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="text2imgSettings.engine === 'openai'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-pencil"></i>
                          </el-icon>
                          {{t('openaiImageLike')}}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('text2imgModelProvider')" class="form-item-align">
                        <el-select
                          v-model="text2imgSettings.selectedProvider"
                          :placeholder="t('selectProvider')"
                          filterable
                          @change="selectText2imgProvider"
                          @visible-change="handleText2imgProviderVisibleChange"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="provider in modelProviders"
                            :key="provider.id"
                            :label="provider.vendor+' - '+provider.modelId"
                            :value="provider.id"
                          >
                            <div class="provider-option">
                              <img 
                                :src="getVendorLogo(provider.vendor)" 
                                class="mini-vendor-logo"
                              />
                              <span class="model-id">{{ provider.modelId }}</span>
                            </div>
                          </el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('sizeAllowCreate')" class="form-item-align">
                        <el-select
                          filterable
                          allow-create
                          v-model="text2imgSettings.size"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option label="1024x1024" value="1024x1024" ></el-option>
                          <el-option label="1536x1024" value="1536x1024" ></el-option>
                          <el-option label="1024x1536" value="1024x1536" ></el-option>
                          <el-option label="256x256" value="256x256" ></el-option>
                          <el-option label="512x512" value="512x512" ></el-option>
                          <el-option label="1792x1024" value="1792x1024" ></el-option>
                          <el-option label="1024x1792" value="1024x1792" ></el-option>                          
                        </el-select>                        
                      </el-form-item>
                    </div>
                    <el-alert
                      type="info"
                      :closable="false"
                      class="mb-2"
                    >
                      <template #default>
                        <div class="alert-content">
                          {{ t('firstTimeUse') }}
                          <el-link
                            type="primary"
                            :underline="false"
                            class="font-medium"
                            @click="switchToApiBox"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('keyBoxInterface') }}
                          </el-link>
                          {{ t('addProviderReturnSelect') }}
                          {{ t('addText2imgNotice') }}
                        </div>
                      </template>
                    </el-alert>
                  </div>
                  <div class="tool-item" v-show="text2imgSettings.engine === 'openaiChat'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-pencil"></i>
                          </el-icon>
                          {{t('openaiChatLike')}}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('imgModelProvider')" class="form-item-align">
                        <el-select
                          v-model="text2imgSettings.selectedProvider"
                          :placeholder="t('selectProvider')"
                          filterable
                          @change="selectText2imgProvider"
                          @visible-change="handleText2imgProviderVisibleChange"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="provider in modelProviders"
                            :key="provider.id"
                            :label="provider.vendor+' - '+provider.modelId"
                            :value="provider.id"
                          >
                            <div class="provider-option">
                              <img 
                                :src="getVendorLogo(provider.vendor)" 
                                class="mini-vendor-logo"
                              />
                              <span class="model-id">{{ provider.modelId }}</span>
                            </div>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                    <el-alert
                      type="info"
                      :closable="false"
                      class="mb-2"
                    >
                      <template #default>
                        <div class="alert-content">
                          {{ t('firstTimeUse') }}
                          <el-link
                            type="primary"
                            :underline="false"
                            class="font-medium"
                            @click="switchToApiBox"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('keyBoxInterface') }}
                          </el-link>
                          {{ t('addProviderReturnSelect') }}
                          {{ t('addimgNotice') }}
                        </div>
                      </template>
                    </el-alert>
                  </div>
                </el-form>
              </div>
             <!-- 语音识别界面 -->
              <div v-show="subMenu === 'asr'" class="page">
                <el-form :model="asrSettings" class="settings-form"  label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-microphone"></i>
                          </el-icon>
                          {{ t('asrModel') }}
                        </span>
                      </div>
                      <el-switch v-model="asrSettings.enabled" @click.stop @change="handleASRchange"/>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('asrEngine')" class="form-item-align">
                        <el-select
                          v-model="asrSettings.engine"
                          @change="autoSaveSettings();handleASRchange();"
                          class="full-width-input"
                        >
                          <el-option :label="t('sherpa-onnx-sense-voice')" value="sherpa" ></el-option>
                          <el-option :label="t('webSpeech')" value="webSpeech" ></el-option>
                          <el-option label="FunASR" value="funasr" ></el-option>
                          <el-option :label="t('openaiLike')" value="openai" ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('interactionMethod')" class="form-item-align">
                        <el-select
                          v-model="asrSettings.interactionMethod"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option :label="t('auto')" value="auto" ></el-option>
                          <el-option :label="t('manual')" value="manual" ></el-option>
                          <el-option :label="t('wakeWord')" value="wakeWord" ></el-option>
                          <el-option :label="t('wakeWordAndEndWord')" value="wakeWordAndEndWord" ></el-option>
                          <el-option :label="t('keyTriggered')" value="keyTriggered" ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item v-if="asrSettings.interactionMethod === 'keyTriggered'" :label="t('hotkey')" class="form-item-align">
                        <el-select
                          v-model="asrSettings.hotkey"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option label="Alt" value="Alt" ></el-option>
                          <el-option :label="t('Space')" value=" " ></el-option>
                          <el-option label="Ctrl" value="Control" ></el-option>
                          <el-option label="Shift" value="Shift" ></el-option>
                          <el-option label="CapsLock" value="CapsLock" ></el-option>
                          <el-option label="Tab" value="Tab" ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item v-if="asrSettings.interactionMethod === 'wakeWord'||asrSettings.interactionMethod === 'wakeWordAndEndWord'"  :label="t('wakeWordMode')" class="form-item-align">
                        <el-input
                          v-model="asrSettings.wakeWord"
                          :placeholder="t('wakeWordPlaceholder')"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                      <el-form-item v-if="asrSettings.interactionMethod === 'wakeWordAndEndWord'" :label="t('endWordMode')" class="form-item-align">
                        <el-input
                          v-model="asrSettings.endWord"
                          :placeholder="t('endWordPlaceholder')"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>
                  <!-- Sherpa ONNX Sense Voice 卡片 -->
                  <el-card
                    v-show="asrSettings.engine === 'sherpa'"
                    shadow="hover"
                    class="sherpa-card"
                  >
                    <!-- 卡片头部：标题 + 安装状态 -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <!-- 左侧标题 -->
                      <span><strong>Sherpa ONNX Sense Voice</strong></span>

                      <!-- 右侧 tag 组 -->
                      <div class="d-flex gap-2">
                        <el-tag type="info" effect="dark">
                          239MB
                        </el-tag>

                        <el-tag
                          :type="sherpaModelExists ? 'success' : 'info'"
                          effect="dark"
                        >
                          {{ sherpaModelExists ? t('installed') : t('notInstalled') }}
                        </el-tag>
                      </div>
                    </div>


                    <!-- 操作按钮区 -->
                    <div class="card-actions">
                      <!-- 左侧：两个下载按钮 -->
                      <div class="left-actions">
                        <el-button
                          type="primary"
                          :disabled="sherpaModelExists || sherpaDownloading"
                          :loading="sherpaDownloading && source==='modelscope'"
                          @click="sherpaDownload('modelscope')"
                        >
                          {{ t('downloadFromModelScope') }}
                        </el-button>

                        <el-button
                          type="primary"
                          :style="{ margin: '0' }"
                          :disabled="sherpaModelExists || sherpaDownloading"
                          :loading="sherpaDownloading && source==='huggingface'"
                          @click="sherpaDownload('huggingface')"
                        >
                          {{ t('downloadFromHuggingFace') }}
                        </el-button>
                      </div>

                      <!-- 右侧：删除按钮 -->
                      <el-button
                        v-if="sherpaModelExists"
                        type="danger"
                        @click="sherpaRemove"
                      >
                        {{ t('deleteModel') }}
                      </el-button>
                    </div>


                    <!-- 进度条（固定在底部） -->
                    <el-progress
                      v-if="sherpaDownloading"
                      :percentage="sherpaPercent"
                      style="margin-top: 16px;"
                      :stroke-width="10"
                    ></el-progress>
                  </el-card>


                  <div class="tool-item" v-show="asrSettings.engine === 'webSpeech'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-microphone"></i>
                          </el-icon>
                          {{t('webSpeechAPI')}}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('language')" class="form-item-align">
                        <el-select
                          v-model="asrSettings.webSpeechLanguage"
                          :placeholder="t('selectProvider')"
                          filterable
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option key="auto" :label="t('auto')" value="auto"></el-option>
                          <el-option
                            v-for="language in supportedLanguages"
                            :key="language.code"
                            :label="language.name"
                            :value="language.code"
                          >
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                    <el-alert
                      type="info"
                      :closable="false"
                      class="mb-2"
                    >
                      <template #default>
                        <div class="alert-content">
                          {{ t('webSpeechNotice1') }}
                        </div>
                      </template>
                    </el-alert>
                  </div>
                  <div class="tool-item" v-show="asrSettings.engine === 'openai'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-microphone"></i>
                          </el-icon>
                          {{t('openaiLike')}}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('asrModelProvider')" class="form-item-align">
                        <el-select
                          v-model="asrSettings.selectedProvider"
                          :placeholder="t('selectProvider')"
                          filterable
                          @change="selectAsrProvider"
                          @visible-change="handleAsrProviderVisibleChange"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="provider in modelProviders"
                            :key="provider.id"
                            :label="provider.vendor+' - '+provider.modelId"
                            :value="provider.id"
                          >
                            <div class="provider-option">
                              <img 
                                :src="getVendorLogo(provider.vendor)" 
                                class="mini-vendor-logo"
                              />
                              <span class="model-id">{{ provider.modelId }}</span>
                            </div>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                    <el-alert
                      type="info"
                      :closable="false"
                      class="mb-2"
                    >
                      <template #default>
                        <div class="alert-content">
                          {{ t('firstTimeUse') }}
                          <el-link
                            type="primary"
                            :underline="false"
                            class="font-medium"
                            @click="switchToApiBox"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('keyBoxInterface') }}
                          </el-link>
                          {{ t('addProviderReturnSelect') }}
                          {{ t('addAsrNotice') }}
                        </div>
                      </template>
                    </el-alert>
                  </div>
                  <div class="tool-item" v-show="asrSettings.engine === 'funasr'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-microphone"></i>
                          </el-icon>
                          FunASR
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://github.com/modelscope/FunASR" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoGithub') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('funasrURL')" class="form-item-align">
                        <el-input
                          v-model="asrSettings.funasr_ws_url"
                          :placeholder="t('funasrURLPlaceholder')"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                      <el-form-item :label="t('mode')" class="form-item-align">
                        <el-select
                          v-model="asrSettings.funasr_mode"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option :label="t('online')" value="2pass" ></el-option>
                          <el-option :label="t('offline')" value="offline" ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('hotwords')" class="form-item-align">
                        <el-input
                          v-model="asrSettings.hotwords"
                          :placeholder="t('hotwordsPlaceholder')"
                          @input="autoSaveSettings"
                          type="textarea"
                          :rows="2"
                        />
                      </el-form-item>
                    </div>
                    <el-alert
                      type="info"
                      :closable="false"
                      class="mb-2"
                    >
                      <template #default>
                        <div class="alert-content">
                          {{ t('funasrNotice1') }}<br>
                          {{ t('funasrNotice2') }}
                        </div>
                      </template>
                    </el-alert>
                  </div>
                </el-form>
              </div>

              <!-- 语音合成界面 -->
              <div v-show="subMenu === 'tts'" class="page">
                <el-form :model="ttsSettings" class="settings-form"  label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-volume-high"></i>
                          </el-icon>
                          {{ t('ttsModel') }}
                        </span>
                      </div>
                      <el-switch v-model="ttsSettings.enabled" @click.stop @change="changeTTSstatus" />
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('ttsEngine')" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.engine"
                          @change="autoSaveSettings();fetchTetosVoices(ttsSettings.engine)"
                          class="full-width-input"
                        >
                          <el-option :label="t('edgetts')" value="edgetts" ></el-option>
                          <el-option :label="t('systemtts')" value="systemtts" ></el-option>
                          <el-option label="GPT Sovits" value="GSV" ></el-option>
                          <el-option :label="t('openaiLikeTTS')" value="openai" ></el-option>
                          <el-option :label="t('customTTS')" value="customTTS" ></el-option>
                          <el-option label="Azure TTS" value="azure"></el-option>
                          <el-option label="Volcengine (火山)" value="volcengine"></el-option>
                          <el-option label="Google TTS" value="google"></el-option>
                          <el-option label="Baidu TTS (百度)" value="baidu"></el-option>
                          <el-option label="Minimax" value="minimax"></el-option>
                          <el-option label="Xunfei (讯飞)" value="xunfei"></el-option>
                          <el-option label="Fish Audio" value="fish"></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('separators')">
                        <el-select
                          v-model="ttsSettings.separators"
                          multiple
                          filterable
                          allow-create
                          @keyup.enter.native="handleEnter"
                          @create="handleCreateSeparator"
                          @change="autoSaveSettings"
                        >
                          <el-option
                            v-for="sep in filteredSeparators"
                            :key="sep.value"
                            :label="sep.label"
                            :value="sep.value"
                          />
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('enabledInterruption')" class="form-item-align" label-position="left">
                        <el-switch 
                          v-model="ttsSettings.enabledInterruption" 
                          @change="autoSaveSettings"
                        ></el-switch>
                      </el-form-item>
                    <el-form-item :label="t('maxConcurrency')" class="form-item-align">
                      <el-slider
                        v-model="ttsSettings.maxConcurrency"
                        :min="1"
                        :max="16"
                        :step="1"
                        show-input
                        @change="autoSaveSettings">
                    </el-form-item>
                    <el-form-item :label="t('bufferWord')">
                      <el-select
                        v-model="ttsSettings.bufferWordList"
                        multiple
                        filterable
                        allow-create
                        :placeholder="t('bufferWordPlaceholder')"
                        class="full-width-input"
                        @change="autoSaveSettings"
                      >
                      </el-select>
                    </el-form-item>
                    <el-form-item :label="t('SampleText')" class="server-item">
                      <el-input 
                        v-model="ttsSettings.SampleText" 
                        :placeholder="t('SampleTextPlaceholder')"
                        class="full-width-input"
                        style="margin-right: 10px;"
                        @change="autoSaveSettings"
                      >
                      </el-input>
                      <el-tooltip :content="t('ClickToListen')" placement="top">
                        <el-button 
                          type="primary" 
                          @click="ClickToListen(ttsSettings.SampleText)" 
                          circle
                        >
                          <i class="fa-solid fa-headphones"></i>
                        </el-button>
                      </el-tooltip>
                    </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="ttsSettings.engine === 'systemtts'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon><i class="fa-solid fa-laptop-code"></i></el-icon>
                          {{ t('sysTTS') }}
                        </span>
                      </div>
                      <div class="header-right">
                        <el-button circle type="primary" @click="fetchSystemVoices">
                          <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': isLoadingSystemVoices }"></i>
                        </el-button>
                      </div>
                    </div>

                    <div class="tool-content">
                      <el-form-item :label="t('TTSRate')" class="form-item-align">
                        <el-slider
                          v-model="ttsSettings.systemRate"
                          :min="50"
                          :max="400"
                          :step="10"
                          show-input
                          @change="autoSaveSettings">
                        </el-slider>
                      </el-form-item>

                      <el-form-item :label="t('Timbre')" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.systemVoiceName"
                          class="full-width-input"
                          :loading="isLoadingSystemVoices"
                          filterable
                          @change="autoSaveSettings"
                        >
                          <el-option
                            v-for="voice in systemVoices"
                            :key="voice.id"
                            :label="voice.name"
                            :value="voice.id"
                          >
                            <span style="float: left">{{ voice.name }}</span>
                            <span
                              style="
                                float: right;
                                color: var(--el-text-color-secondary);
                                font-size: 13px;
                              "
                            >
                              {{ voice.lang }}
                            </span>
                          </el-option>
                        </el-select>
                      </el-form-item>

                      <div v-if="systemVoices.length === 0 && !isLoadingSystemVoices" style="color: #e6a23c; font-size: 12px; margin-top: 5px;">
                        <i class="fa-solid fa-triangle-exclamation"></i> {{ t('noSystemVoiceDetected') }}
                      </div>
                    </div>
                  </div>

                  <div class="tool-item" v-show="ttsSettings.engine === 'openai'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-microphone"></i>
                          </el-icon>
                          {{t('openaiLike')}}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('TTSModelProvider')" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.selectedProvider"
                          :placeholder="t('selectProvider')"
                          filterable
                          @change="selectTTSProvider"
                          @visible-change="handleTTSProviderVisibleChange"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="provider in modelProviders"
                            :key="provider.id"
                            :label="provider.vendor+' - '+provider.modelId"
                            :value="provider.id"
                          >
                            <div class="provider-option">
                              <img 
                                :src="getVendorLogo(provider.vendor)" 
                                class="mini-vendor-logo"
                              />
                              <span class="model-id">{{ provider.modelId }}</span>
                            </div>
                          </el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('openaiStream')" class="form-item-align" label-position="left">
                        <el-switch 
                          v-model="ttsSettings.openaiStream" 
                          @change="autoSaveSettings"
                        ></el-switch>
                      </el-form-item>
                      <el-form-item :label="t('TTSVoice')" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.openaiVoice"
                          :placeholder="t('selectVoice')"
                          filterable
                          allow-create
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="voice in openaiVoices"
                            :key="voice"
                            :label="voice"
                            :value="voice"
                          ></el-option>
                        </el-select>
                      </el-form-item>
                      <!-- 提示音频选择框 -->
                      <el-form-item :label="t('promptAudio')" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.gsvRefAudioPath"
                          @change="handleRefAudioPathChange"
                          class="full-width-input"
                        >
                          <el-option :key="null" :value="null" :label="t('noRefAudio')"></el-option>
                          <el-option
                            v-for="audio in ttsSettings.gsvAudioOptions"
                            :key="audio.path"
                            :label="audio.name"
                            :value="audio.path"
                          >
                            <div class="model-option-item">
                              <span>{{ audio.name }}</span>
                              <i 
                                class="fa-solid fa-trash-can"
                                style="color: #ff0000"
                                @click.stop="deleteAudioOption(audio.path)"
                              ></i>
                            </div>
                          </el-option>
                          
                        </el-select>
                      </el-form-item>
                      <!-- 语速滑动条 -->
                      <el-form-item :label="t('TTSRate')" class="form-item-align">
                        <el-slider
                          v-model="ttsSettings.openaiSpeed"
                          :min="0.1"
                          :max="2"
                          :step="0.1"
                          show-input
                          @change="autoSaveSettings">
                      </el-form-item>
                    </div>
                    <el-button 
                      @click="showGsvRefAudioPathDialog = true;currentUploadType='audio'"
                      type="primary" 
                      class="add-server-btn">
                      <i class="fa-solid fa-plus"></i> {{ t('addRefAudio') }}
                    </el-button>
                    <el-alert
                      type="info"
                      :closable="false"
                      class="mb-2"
                    >
                      <template #default>
                        <div class="alert-content">
                          {{ t('firstTimeUse') }}
                          <el-link
                            type="primary"
                            :underline="false"
                            class="font-medium"
                            @click="switchToApiBox"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('keyBoxInterface') }}
                          </el-link>
                          {{ t('addProviderReturnSelect') }}
                          {{ t('addTTSNotice') }}
                        </div>
                      </template>
                    </el-alert>
                  </div>


                  <!-- ================= Azure TTS ================= -->
                  <div class="tool-item" v-show="ttsSettings.engine === 'azure'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span><i class="fa-brands fa-microsoft"></i> 
                          Azure TTS
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://portal.azure.com/#create/Microsoft.CognitiveServicesSpeechServices" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('getAPIkey') }}
                          </el-link>
                        </span>
                      </div>
                      <div class="header-right">
                        <el-button circle type="primary" @click="fetchTetosVoices('azure')">
                          <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': ttsSettings.isFetchingVoices }"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item label="Speech Key" class="form-item-align">
                        <el-input v-model="ttsSettings.azureSpeechKey" placeholder="Azure Key" @change="autoSaveSettings" type="password" show-password/>
                      </el-form-item>
                      <el-form-item label="Region" class="form-item-align">
                        <el-input v-model="ttsSettings.azureRegion" placeholder="e.g. eastus" @change="autoSaveSettings"/>
                      </el-form-item>
                      <el-form-item label="Voice" class="form-item-align">
                        <el-select v-model="ttsSettings.azureVoice" filterable allow-create placeholder="Select Voice" @change="autoSaveSettings" class="full-width-input">
                          <el-option 
                            v-for="(v, index) in ttsSettings.tetosVoices" 
                            :key="index" 
                            :label="getVoiceLabel(v)" 
                            :value="getVoiceValue(v)"
                          >
                            <span style="float: left">{{ getVoiceLabel(v) }}</span>
                            <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>

                  <!-- ================= Volcengine TTS (火山引擎) ================= -->
                  <div class="tool-item" v-show="ttsSettings.engine === 'volcengine'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon><i class="fa-solid fa-fire"></i></el-icon> 
                          {{ t('volcengineTTS') || 'Volcengine TTS' }}
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://console.volcengine.com/speech/service/10035" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('getAPIkey') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item label="App ID" class="form-item-align">
                        <el-input v-model="ttsSettings.volcAppId" placeholder="e.g. 1234567890" @change="autoSaveSettings"/>
                      </el-form-item>
                      
                      <el-form-item label="Access Token" class="form-item-align">
                        <el-input v-model="ttsSettings.volcAccessKey" type="password" show-password placeholder="Bearer Token / Access Key" @change="autoSaveSettings"/>
                      </el-form-item>

                      <el-form-item label="Resource ID" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.volcResourceId"
                          filterable
                          allow-create
                          default-first-option
                          placeholder="选择或输入 Resource ID"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="item in volcResourceOptions"
                            :key="item.value"
                            :label="item.value"
                            :value="item.value"
                          >
                            <span style="float: left">{{ item.value }}</span>
                            <span style="float: right; color: #8492a6; font-size: 12px; margin-left: 10px;">{{ item.label }}</span>
                          </el-option>
                        </el-select>
                      </el-form-item>
                      
                      <el-form-item :label="t('Voice') || 'Voice'" class="form-item-align">
                         <!-- 这里使用输入框，也可以改成 select 如果你有列表 -->
                        <el-input v-model="ttsSettings.volcVoice" placeholder="e.g. zh_female_vv_uranus_bigtts" @change="autoSaveSettings">
                        </el-input>
                      </el-form-item>

                      <el-form-item :label="t('TTSRate')" class="form-item-align">
                        <el-slider
                          v-model="ttsSettings.volcRate"
                          :min="0.5"
                          :max="2.0"
                          :step="0.1"
                          show-input
                          @change="autoSaveSettings">
                        </el-slider>
                      </el-form-item>
                    </div>
                  </div>

                  <!-- ================= Google TTS ================= -->
                  <div class="tool-item" v-show="ttsSettings.engine === 'google'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span><i class="fa-brands fa-google"></i> 
                          Google TTS
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('getAPIkey') }}
                          </el-link>
                        </span>
                      </div>
                      <div class="header-right">
                        <el-button circle type="primary" @click="fetchTetosVoices('google')">
                          <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': ttsSettings.isFetchingVoices }"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item label="Service Account JSON" class="form-item-align">
                        <el-input v-model="ttsSettings.googleServiceAccount" type="textarea" :rows="3" placeholder='Paste JSON content here: {"type": "service_account", ...}' @change="autoSaveSettings"/>
                      </el-form-item>
                      <el-form-item label="Voice" class="form-item-align">
                        <el-select v-model="ttsSettings.googleVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                          <el-option 
                            v-for="(v, index) in ttsSettings.tetosVoices" 
                            :key="index" 
                            :label="getVoiceLabel(v)" 
                            :value="getVoiceValue(v)"
                          >
                            <span style="float: left">{{ getVoiceLabel(v) }}</span>
                            <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>

                  <!-- ================= Baidu TTS ================= -->
                  <div class="tool-item" v-show="ttsSettings.engine === 'baidu'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span><i class="fa-solid fa-paw"></i> 
                          Baidu TTS
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://console.bce.baidu.com/ai/#/ai/speech/app/list" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('getAPIkey') }}
                          </el-link>
                        </span>
                      </div>
                      <div class="header-right">
                        <el-button circle type="primary" @click="fetchTetosVoices('baidu')">
                          <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': ttsSettings.isFetchingVoices }"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item label="API Key" class="form-item-align"><el-input v-model="ttsSettings.baiduApiKey" @change="autoSaveSettings"/></el-form-item>
                      <el-form-item label="Secret Key" class="form-item-align"><el-input v-model="ttsSettings.baiduSecretKey" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                      <el-form-item label="Voice" class="form-item-align">
                        <el-select v-model="ttsSettings.baiduVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                          <el-option 
                            v-for="(v, index) in ttsSettings.tetosVoices" 
                            :key="index" 
                            :label="getVoiceLabel(v)" 
                            :value="getVoiceValue(v)"
                          >
                            <span style="float: left">{{ getVoiceLabel(v) }}</span>
                            <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>

                  <!-- ================= Minimax ================= -->
                  <div class="tool-item" v-show="ttsSettings.engine === 'minimax'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>Minimax
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://platform.minimaxi.com/user-center/basic-information" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('getAPIkey') }}
                          </el-link>
                        </span>
                      </div>
                      <div class="header-right">
                        <el-button circle type="primary" @click="fetchTetosVoices('minimax')">
                          <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': ttsSettings.isFetchingVoices }"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item label="API Key" class="form-item-align"><el-input v-model="ttsSettings.minimaxApiKey" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                      <el-form-item label="Group ID" class="form-item-align"><el-input v-model="ttsSettings.minimaxGroupId" @change="autoSaveSettings"/></el-form-item>
                      <el-form-item label="Voice" class="form-item-align">
                        <el-select v-model="ttsSettings.minimaxVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                          <el-option 
                            v-for="(v, index) in ttsSettings.tetosVoices" 
                            :key="index" 
                            :label="getVoiceLabel(v)" 
                            :value="getVoiceValue(v)"
                          >
                            <span style="float: left">{{ getVoiceLabel(v) }}</span>
                            <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>

                  <!-- ================= Xunfei (讯飞) ================= -->
                  <div class="tool-item" v-show="ttsSettings.engine === 'xunfei'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>Xunfei
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://console.xfyun.cn/services/tts" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('getAPIkey') }}
                          </el-link>
                        </span>
                      </div>
                      <div class="header-right">
                        <el-button circle type="primary" @click="fetchTetosVoices('xunfei')">
                          <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': ttsSettings.isFetchingVoices }"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item label="App ID" class="form-item-align"><el-input v-model="ttsSettings.xunfeiAppId" @change="autoSaveSettings"/></el-form-item>
                      <el-form-item label="API Key" class="form-item-align"><el-input v-model="ttsSettings.xunfeiApiKey" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                      <el-form-item label="API Secret" class="form-item-align"><el-input v-model="ttsSettings.xunfeiApiSecret" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                      <el-form-item label="Voice" class="form-item-align">
                        <el-select v-model="ttsSettings.xunfeiVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                          <el-option 
                            v-for="(v, index) in ttsSettings.tetosVoices" 
                            :key="index" 
                            :label="getVoiceLabel(v)" 
                            :value="getVoiceValue(v)"
                          >
                            <span style="float: left">{{ getVoiceLabel(v) }}</span>
                            <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>

                  <!-- ================= Fish Audio ================= -->
                  <div class="tool-item" v-show="ttsSettings.engine === 'fish'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span><i class="fa-solid fa-fish"></i> 
                          Fish Audio
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://fish.audio/go-api" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('getAPIkey') }}
                          </el-link>
                        </span>
                      </div>
                      <div class="header-right">
                        <el-button circle type="primary" @click="fetchTetosVoices('fish')">
                          <i class="fa-solid fa-rotate-right" :class="{ 'fa-spin': ttsSettings.isFetchingVoices }"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item label="API Key" class="form-item-align"><el-input v-model="ttsSettings.fishApiKey" type="password" show-password @change="autoSaveSettings"/></el-form-item>
                      <el-form-item :label="t('fishVoice')" class="form-item-align">
                        <el-select v-model="ttsSettings.fishVoice" filterable allow-create class="full-width-input" @change="autoSaveSettings">
                          <el-option 
                            v-for="(v, index) in ttsSettings.tetosVoices" 
                            :key="index" 
                            :label="getVoiceLabel(v)" 
                            :value="getVoiceValue(v)"
                          >
                            <span style="float: left">{{ getVoiceLabel(v) }}</span>
                            <span style="float: right; color: #8492a6; font-size: 13px">{{ getVoiceDesc(v) }}</span>
                          </el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>

                  <div class="tool-item" v-show="ttsSettings.engine === 'customTTS'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-volume-high"></i>
                          </el-icon>
                          {{t('customTTS')}}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                        <el-form-item :label="t('customTTSserver')" class="form-item-align">
                          <el-input
                            v-model="ttsSettings.customTTSserver"
                            :placeholder="t('customTTSServerPlaceholder')"
                            @input="autoSaveSettings"
                            type="textarea"
                          />
                        </el-form-item>
                        <el-form-item :label="t('customStream')" class="form-item-align" label-position="left">
                          <el-switch 
                            v-model="ttsSettings.customStream" 
                            @change="autoSaveSettings"
                          ></el-switch>
                        </el-form-item>
                        
                        <el-form-item :label="t('customTTSspeaker')" class="form-item-align">
                            <el-input
                                v-model="ttsSettings.customTTSspeaker"
                                :placeholder="t('customTTSspeakerPlaceholder')"
                                @input="autoSaveSettings"
                                class="full-width-input"
                            />
                        </el-form-item>
                        <el-form-item :label="t('customTTSspeed')" class="form-item-align">
                            <el-slider
                                v-model="ttsSettings.customTTSspeed"
                                :min="0.1"
                                :max="2"
                                :step="0.1"
                                show-input
                                @change="autoSaveSettings">
                            </el-slider>
                        </el-form-item>

                        <hr> <div class="advanced-key-config">
                            <div class="tool-header" style="margin-bottom: 10px;">
                                <div class="header-left">
                                    <span>{{t('customTTSKeyMapping')}}</span>
                                </div>
                            </div>

                            <el-form-item :label="t('key_text')" class="form-item-align">
                                <el-input
                                    v-model="ttsSettings.customTTSKeyText"
                                    placeholder="text"
                                    @input="autoSaveSettings"
                                    class="full-width-input"
                                />
                            </el-form-item>

                            <el-form-item :label="t('key_speaker')" class="form-item-align">
                                <el-input
                                    v-model="ttsSettings.customTTSKeySpeaker"
                                    placeholder="speaker"
                                    @input="autoSaveSettings"
                                    class="full-width-input"
                                />
                            </el-form-item>

                            <el-form-item :label="t('key_speed')" class="form-item-align">
                                <el-input
                                    v-model="ttsSettings.customTTSKeySpeed"
                                    placeholder="speed"
                                    @input="autoSaveSettings"
                                    class="full-width-input"
                                />
                            </el-form-item>
                        </div>
                    </div>
                  </div>

                  <div class="tool-item" v-show="ttsSettings.engine === 'edgetts'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-volume-high"></i>
                          </el-icon>
                          Edge TTS
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <!-- 语速滑动条 -->
                      <el-form-item :label="t('edgettsRate')" class="form-item-align">
                        <el-slider
                          v-model="ttsSettings.edgettsRate"
                          :min="0.1"
                          :max="2"
                          :step="0.1"
                          show-input
                          @change="autoSaveSettings">
                      </el-form-item>
                      <!-- 语言选择框 -->
                      <el-form-item :label="t('edgettsLanguage')" class="form-item-align">
                        <el-select
                          v-model="edgettsLanguage"
                          @change="updateLanguages"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="language in uniqueLanguages"
                            :key="language"
                            :label="language"
                            :value="language"
                          ></el-option>
                        </el-select>
                      </el-form-item>

                      <!-- 性别选择框 -->
                      <el-form-item :label="t('edgettsGender')" class="form-item-align">
                        <el-select
                          v-model="edgettsGender"
                          @change="updateGenders"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="gender in uniqueGenders"
                            :key="gender"
                            :label="t(gender)"
                            :value="gender"
                          ></el-option>
                        </el-select>
                      </el-form-item>

                      <!-- 语音选择框 -->
                      <el-form-item :label="t('edgettsVoice')" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.edgettsVoice"
                          class="full-width-input"
                          @change="updateVoices"
                        >
                          <el-option
                            v-for="voice in filteredVoices"
                            :key="voice.name"
                            :label="voice.name"
                            :value="voice.name"
                          ></el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="ttsSettings.engine === 'GSV'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-volume-high"></i>
                          </el-icon>
                          GPT Sovits
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://github.com/RVC-Boss/GPT-SoVITS" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoGithub') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('gsvServer')" class="form-item-align">
                        <el-input
                          v-model="ttsSettings.gsvServer"
                          :placeholder="t('gsvServerPlaceholder')"
                          @input="autoSaveSettings"
                          type="textarea"
                        />
                      </el-form-item>

                      <!-- 语速滑动条 -->
                      <el-form-item :label="t('gsvRate')" class="form-item-align">
                        <el-slider
                          v-model="ttsSettings.gsvRate"
                          :min="0.1"
                          :max="2"
                          :step="0.1"
                          show-input
                          @change="autoSaveSettings">
                      </el-form-item>

                        <el-form-item :label="t('gsvSample_steps')" class="form-item-align">
                          <el-slider
                            v-model="ttsSettings.gsvSample_steps"
                            :min="1"
                            :max="16"
                            :step="1"
                            show-input
                            @change="autoSaveSettings">
                        </el-form-item>   

                      <!-- 语言选择框 -->
                      <el-form-item :label="t('gsvTextLang')" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.gsvTextLang"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="language in gsvTextLangs"
                            :key="language"
                            :label="t(language)"
                            :value="language"
                          ></el-option>
                        </el-select>
                      </el-form-item>

                      <!-- 提示语言选择框 -->
                      <el-form-item :label="t('gsvPromptLang')" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.gsvPromptLang"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="language in gsvTextLangs"
                            :key="language"
                            :label="t(language)"
                            :value="language"
                          ></el-option>
                        </el-select>
                      </el-form-item>

                      <!-- 提示音频选择框 -->
                      <el-form-item :label="t('gsvPromptAudio')" class="form-item-align">
                        <el-select
                          v-model="ttsSettings.gsvRefAudioPath"
                          @change="handleRefAudioPathChange"
                          class="full-width-input"
                        >
                          <el-option
                            v-for="audio in ttsSettings.gsvAudioOptions"
                            :key="audio.path"
                            :label="audio.name"
                            :value="audio.path"
                          >
                            <div class="model-option-item">
                              <span>{{ audio.name }}</span>
                              <i 
                                class="fa-solid fa-trash-can"
                                style="color: #ff0000"
                                @click.stop="deleteAudioOption(audio.path)"
                              ></i>
                            </div>
                          </el-option>
                        </el-select>
                      </el-form-item>

                      <el-button 
                        @click="showGsvRefAudioPathDialog = true;currentUploadType='audio'"
                        type="primary" 
                        class="add-server-btn">
                        <i class="fa-solid fa-plus"></i> {{ t('addRefAudio') }}
                      </el-button>

                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('gsvNotice1') }}<br>
                            {{ t('gsvNotice2') }}
                          </div>
                        </template>
                      </el-alert>
                    </div>
                  </div>
                </el-form>
              </div>
            </div>
          </div>
        </div>

        <div v-show="activeMenu === 'toolkit'" class="page agent-suite-container">
          <div class="suite-layout">
            <!-- 左侧导航 -->
            <div class="suite-sidebar">
              <div class="tile-nav">
                <div 
                  v-for="tile in toolkitTiles" 
                  :key="tile.id"
                  class="nav-item"
                  :class="{ active: subMenu === tile.id }"
                  @click="subMenu = tile.id">
                  <el-icon class="nav-icon"><i :class="tile.icon"></i></el-icon>
                  <span class="nav-text">{{ t(tile.title) }}</span>
                </div>
              </div>
            </div>
            <!-- 右侧内容 -->
            <div class="suite-content">
              <!-- 工具界面 -->
              <div v-show="subMenu === 'tools'" class="page">
                <div class="provider-grid">

                  <!-- 当前时间工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch 
                        v-model="toolsSettings.time.enabled" 
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">{{ t('currentTime') }}</h3>
                    </div>
                    <el-form-item :label="t('triggerMode')">
                      <el-select
                        v-model="toolsSettings.time.triggerMode"
                        @change="autoSaveSettings"
                      >
                          <el-option :label="t('beforeThinking')" value="beforeThinking" ></el-option>
                          <el-option :label="t('afterThinking')" value="afterThinking" ></el-option>
                      </el-select>
                    </el-form-item>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('currentTimeNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- 当前天气工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch 
                        v-model="toolsSettings.weather.enabled" 
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">
                        {{ t('openMeteoWeather') }}
                      </h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('weatherNotice') }}
                      </div>
                    </el-alert>
                  </div>
        
                  <!-- 语言语调工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch
                        v-model="toolsSettings.language.enabled"
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">{{ t('languageTone') }}</h3>
                    </div>
                    <el-form-item :label="t('assistantLanguage')">
                      <el-input
                        v-model="toolsSettings.language.language"
                        @change="autoSaveSettings"
                        class="mini-input"
                        :placeholder="t('languagePlaceholder')"
                      ></el-input>
                    </el-form-item>
                    
                    <el-form-item :label="t('assistantTone')">
                      <el-input
                        v-model="toolsSettings.language.tone"
                        @change="autoSaveSettings"
                        class="mini-input"
                        :placeholder="t('tonePlaceholder')"
                      ></el-input>
                    </el-form-item>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('languageNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- 维基百科工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch 
                        v-model="toolsSettings.wikipedia.enabled" 
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">
                        {{ t('wikipedia') }}
                      </h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('wikipediaNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- arxiv工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch 
                        v-model="toolsSettings.arxiv.enabled" 
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">
                        {{ t('arxiv') }}
                      </h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('arxivNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- LaTeX增强工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch
                        v-model="toolsSettings.formula.enabled"
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div  class="tool-card-title">
                      <h3 class="kb-title">{{ t('latexRenderingEnhancement') }}</h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('latexRenderingEnhancementNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- 工具结果备忘录 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch 
                        v-model="toolsSettings.hideToolResults.enabled" 
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">
                        {{ t('hideToolResults') }}
                      </h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('hideToolResultsNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- 存储空间文件查询工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch 
                        v-model="toolsSettings.getFile.enabled" 
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">{{ t('fileGet') }}</h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('fileGetNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- 深度研究工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch
                        v-model="toolsSettings.deepsearch.enabled"
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">{{ t('deepResearch') }}</h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('deepResearchNotice') }}
                      </div>
                    </el-alert>
                  </div>
        
                  <!-- 推理工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch
                        v-model="toolsSettings.inference.enabled"
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">{{ t('fakeInference') }}</h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('fakeInferenceNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- 异步工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch 
                        v-model="toolsSettings.asyncTools.enabled" 
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">{{ t('asyncTools') }}</h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('asyncToolsNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- A2UI工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch 
                        v-model="toolsSettings.a2ui.enabled" 
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">{{ t('a2uiTools') }}</h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('a2uiToolsNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- 自主行为工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch 
                        v-model="toolsSettings.autoBehavior.enabled" 
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">{{ t('autoBehaviorTool') }}</h3>
                    </div>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('autoBehaviorToolNotice') }}
                      </div>
                    </el-alert>
                  </div>

                  <!-- 随机话题工具 -->
                  <div class="provider-card tool-card">
                    <div class="card-header">
                      <el-switch
                        v-model="toolsSettings.randomTopic.enabled"
                        @change="autoSaveSettings"
                        class="tool-switch"
                      ></el-switch>
                    </div>
                    <div class="tool-card-title">
                      <h3 class="kb-title">{{ t('randomTopicTool') }}</h3>
                      <el-link
                        type="primary"
                        :underline="false"
                        href="https://github.com/heshengtao/topics-after-party" 
                        target="_blank"
                      >
                        <el-icon class="mr-1">
                          <i class="fa-solid fa-key"></i>
                        </el-icon>{{ t('gotoGithub') }}
                      </el-link>
                    </div>
                    <el-form-item :label="t('baseURL')">
                      <el-input
                        v-model="toolsSettings.randomTopic.baseURL"
                        @change="autoSaveSettings"
                        class="mini-input"
                        :placeholder="t('randomTopicPlaceholder')"
                      ></el-input>
                    </el-form-item>
                    <el-alert type="info" :closable="false" class="mb-2">
                      <div class="alert-content">
                        {{ t('randomTopicNotice') }}
                      </div>
                    </el-alert>
                  </div>


                </div>
              </div>

              <!-- HA界面 -->
              <div v-show="subMenu === 'HA'" class="page">
                <el-form :model="HASettings" class="settings-form"  label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-house"></i>
                          </el-icon>
                          {{ t('homeAssistant') }}
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://www.home-assistant.io/" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                      <el-switch v-model="HASettings.enabled" @click.stop @change="changeHAEnabled"/>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('baseURL')" class="form-item-align">
                        <el-input
                          v-model="HASettings.url"
                          :placeholder="t('urlPlaceholder')"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="HASettings.api_key"
                          :placeholder="t('apiKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                      <el-alert type="info" :closable="false" class="mb-2">
                        <div class="alert-content">
                          {{ t('HANotice1') }}<br>
                          {{ t('HANotice2') }}<br>
                          {{ t('HANotice3') }}<br>
                          {{ t('HANotice4') }}
                        </div>
                      </el-alert>
                    </div>
                  </div>
                </el-form> 
              </div>

              <!-- 浏览器控制界面 -->
              <div v-show="subMenu === 'chromeMCP'" class="page">
               <!-- 顶部说明条 -->
                <div v-if="isElectron" class="toolbar">
                    <el-alert
                      :title="t('chromeMCPDescription')"
                      type="info"
                      :closable="false"
                      class="mb-2"
                    >
                      1. {{ t('chromeMCPNotice') }}<br>
                      2. {{ t('chromeMCPNotice2') }}<br>
                      3. {{ t('chromeMCPNotice3') }}
                    </el-alert>
                </div>
                <el-form v-if="isElectron" :model="chromeMCPSettings" class="settings-form"  label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-compass"></i>
                          </el-icon>
                          {{ t('browserControl') }}
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://browsermcp.io/install" 
                            target="_blank"
                            v-if="chromeMCPSettings.type=='external' && chromeMCPSettings.mcpName=='browser-mcp'"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoBrowserExtension') }}
                          </el-link>
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://nodejs.org/en/download" 
                            target="_blank"
                            v-if="chromeMCPSettings.type=='external'"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('downloadNodeJS') }}
                          </el-link>
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://github.com/heshengtao/browser-for-sap/releases" 
                            target="_blank"
                            v-if="chromeMCPSettings.type=='external'"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoPartyExtension') }}
                          </el-link>
                        </span>
                      </div>
                      <el-switch v-model="chromeMCPSettings.enabled" @click.stop @change="changeChromeMCPEnabled"/>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('browserType')"  v-if="isElectron">
                        <el-select
                          v-model="chromeMCPSettings.type"
                          @change="autoSaveSettings"
                          class="full-width-input"
                          :disabled="chromeMCPSettings.enabled"
                        >
                          <el-option :label="t('internalBrowser')" value="internal" ></el-option>
                          <el-option :label="t('externalBrowser')" value="external" ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('mcpName')"  v-if="chromeMCPSettings.type=='external'">
                        <el-select
                          v-model="chromeMCPSettings.mcpName"
                          @change="autoSaveSettings"
                          class="full-width-input"
                          :disabled="chromeMCPSettings.enabled"
                        >
                          <el-option :label="t('browser-mcp')" value="browser-mcp" ></el-option>
                          <el-option :label="t('playwright-mcp')" value="playwright-mcp" ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-alert type="info" :closable="false" class="mb-2" v-if="chromeMCPSettings.type=='external' && chromeMCPSettings.mcpName=='playwright-mcp'">
                        <div class="alert-content">
                          {{ t('browserNotice5') }}
                        </div>
                      </el-alert>
                      <el-alert type="info" :closable="false" class="mb-2" v-if="chromeMCPSettings.type=='external' && chromeMCPSettings.mcpName=='browser-mcp'">
                        <div class="alert-content">
                          {{ t('browserNotice1') }}<br>
                          {{ t('browserNotice2') }}<br>
                          {{ t('browserNotice3') }}
                        </div>
                      </el-alert>
                      <el-alert type="info" :closable="false" class="mb-2" v-if="chromeMCPSettings.type=='internal'">
                        <div class="alert-content">
                          {{ t('browserNotice4') }}
                        </div>
                      </el-alert>
                      <el-alert type="info" :closable="false" class="mb-2" v-if="chromeMCPSettings.type=='external'">
                        <div class="alert-content">
                          {{ t('browserNotice6') }}
                        </div>
                      </el-alert>
                    </div>
                  </div>
                  <!-- Node.js 卡片：已安装 & 未安装 双状态 -->
                  <el-card shadow="hover" class="sherpa-card">
                    <!-- 头部：标题 + 状态标签 -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <span><strong>Node.js</strong></span>

                      <div class="d-flex gap-2">
                        <el-button
                          v-if="!nodeInstalled"
                          type="primary"
                          :loading="nodeInstalling"
                          @click="installNode"
                        >
                          <i class="fa-solid fa-download"></i>
                          {{ t('installNode') }}
                        </el-button>
                        <el-tag v-else type="success" effect="dark" size="large">  
                          <i class="fa-solid fa-circle-check"></i>
                          {{ t('installed') }}
                        </el-tag>
                      </div>
                    </div>

                    <!-- 进度条 -->
                    <el-progress
                      v-if="nodeInstalling && nodeProgress > 0"
                      :percentage="nodeProgress"
                      :status="nodeProgress === 100 ? 'success' : null"
                      style="margin-top: 16px;"
                      :stroke-width="10"
                    />
                  </el-card>
                </el-form> 
                <!-- Web端提示 -->
                <div v-else >
                  <el-empty :description="t('webNotSupported')" />
                </div>
              </div>
              
              <!-- SQL控制界面 -->
              <div v-show="subMenu === 'sql'" class="page">
                <el-form :model="sqlSettings" class="settings-form"  label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-database"></i>
                          </el-icon>
                          {{ t('sqlControl') }}
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://docs.astral.sh/uv/getting-started/installation/" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('downloadUV') }}
                          </el-link>
                        </span>
                      </div>
                      <el-switch v-model="sqlSettings.enabled" @click.stop @change="changeSqlEnabled"/>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('sqlEngine')" class="form-item-align">
                        <el-select
                          v-model="sqlSettings.engine"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option label="SQLite" value="sqlite" ></el-option>
                          <el-option label="PostgreSQL" value="postgres" ></el-option>
                          <el-option label="MySQL/MariaDB" value="mysql" ></el-option>
                          <el-option label="Microsoft SQL Server" value="mssql" ></el-option>
                          <el-option label="Oracle" value="oracle" ></el-option>
                        </el-select>
                      </el-form-item> 
                      <el-form-item v-if="sqlSettings.engine!='sqlite'" :label="t('user')" class="form-item-align">
                        <el-input
                          v-model="sqlSettings.user"
                          @input="autoSaveSettings"
                          placeholder="root"
                        />
                      </el-form-item>
                      <el-form-item v-if="sqlSettings.engine!='sqlite'" :label="t('password')" class="form-item-align">
                        <el-input
                          v-model="sqlSettings.password"
                          show-password
                          placeholder="password"
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item v-if="sqlSettings.engine!='sqlite'" :label="t('host')" class="form-item-align" style="width: 100%">
                        <div style="display: flex; gap: 10px; width: 100%;">
                          <el-input
                            v-model="sqlSettings.host"
                            placeholder="localhost"
                            @input="autoSaveSettings"
                            style="flex: 1 1 0; min-width: 0;"
                          ></el-input>
                          <el-input-number
                            v-model="sqlSettings.port"
                            :step="1"
                            :min="0"
                            :max="65535"
                            @input="autoSaveSettings"
                            style="flex: 0 0 150px;"
                          ></el-input-number>
                        </div>
                      </el-form-item>
                      <el-form-item v-if="sqlSettings.engine!='sqlite'" :label="t('dbname')" class="form-item-align">
                        <el-input
                          v-model="sqlSettings.dbname"
                          placeholder="dbname"
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item v-if="sqlSettings.engine =='sqlite'" :label="t('dbpath')" class="form-item-align">
                        <el-input
                          v-model="sqlSettings.dbpath"
                          placeholder="/absolute/path/to/database.db"
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-alert type="info" :closable="false" class="mb-2">
                        <div class="alert-content">
                          {{ t('sqlNotice1') }}<br>
                          {{ t('sqlNotice2') }}
                        </div>
                      </el-alert>
                    </div>                   
                  </div>
                  <!-- uv 卡片：已安装 & 未安装 双状态 -->
                  <el-card shadow="hover" class="sherpa-card">
                    <!-- 头部：标题 + 状态标签 -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <span><strong>UV</strong></span>

                      <div class="d-flex gap-2">
                        <el-button
                          v-if="!uvInstalled"
                          type="primary"
                          :loading="uvInstalling"
                          @click="installUv"
                        >
                          <i class="fa-solid fa-download"></i>
                          {{ t('installUv') }}
                        </el-button>
                        <el-tag v-else type="success" effect="dark" size="large">
                          <i class="fa-solid fa-circle-check"></i>
                          {{ t('installed') }}
                        </el-tag>
                      </div>
                    </div>

                    <!-- 进度条 -->
                    <el-progress
                      v-if="uvInstalling && uvProgress > 0"
                      :percentage="uvProgress"
                      :status="uvProgress === 100 ? 'success' : null"
                      style="margin-top: 16px;"
                      :stroke-width="10"
                    />
                  </el-card>
                </el-form> 
              </div>

              <!-- 代码解释器界面 -->
              <div v-show="subMenu === 'interpreter'" class="page">
                <el-form :model="codeSettings" class="settings-form"  label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-code"></i>
                          </el-icon>
                          {{ t('interpreter') }}
                        </span>
                      </div>
                      <el-switch v-model="codeSettings.enabled" @click.stop @change="autoSaveSettings"/>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('codeEngine')" class="form-item-align">
                        <el-select
                          v-model="codeSettings.engine"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option label="E2B" value="e2b" ></el-option>
                          <el-option label="Sandbox Fusion" value="sandbox" ></el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="codeSettings.engine === 'e2b'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-code"></i>
                          </el-icon>
                          E2B
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://e2b.dev/" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="codeSettings.e2b_api_key"
                          :placeholder="t('e2bAPIKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="codeSettings.engine === 'sandbox'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-code"></i>
                          </el-icon>
                          Sandbox Fusion
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://github.com/bytedance/SandboxFusion" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoGithub') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('baseURL')" class="form-item-align">
                        <el-input
                          v-model="codeSettings.sandbox_url"
                          :placeholder="t('sandboxURLPlaceholder')"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>
                </el-form> 
              </div>
              <!-- 终端工具界面 -->
              <div v-show="subMenu === 'CLI'" class="page">
              <el-tabs v-model="activeCLITab">
                <el-tab-pane :label="t('CLItoolSettings')" name="config">
                  <el-form :model="CLISettings" class="settings-form"  label-position="top">
                    <div class="tool-item">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon>
                              <i class="fa-solid fa-terminal"></i>
                            </el-icon>
                            {{ t('CLItool') }}
                          </span>
                        </div>
                        <el-switch v-model="CLISettings.enabled" @click.stop @change="autoSaveSettings"/>
                      </div>
                      <div class="tool-content">
                        <el-form-item :label="t('CLIEngine')" class="form-item-align">
                          <el-select
                            v-model="CLISettings.engine"
                            @change="autoSaveSettings"
                            class="full-width-input"
                          >
                            <el-option :label="t('localEnvironment')" value="local" ></el-option>
                            <el-option :label="t('dockerSandbox')" value="ds" ></el-option> 
                            <el-option label="Claude Code" value="cc" ></el-option>
                            <el-option label="Qwen Code" value="qc" ></el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                    </div>

                    <!-- 本地环境配置 -->
                    <div class="tool-item" v-show="CLISettings.engine === 'local'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon><i class="fa-solid fa-laptop"></i></el-icon>
                            {{t('localEnvironment')}}
                          </span>
                        </div>
                      </div>
                      <div class="tool-content">
                        <!-- 工作空间选择 -->
                        <el-form-item required :label="t('workspace')" class="form-item-align">
                          <el-input v-model="CLISettings.cc_path" @input="autoSaveSettings" class="full-width-input">
                            <template #append>
                              <el-button @click="browseDirectory">
                                <i class="fa-solid fa-folder"></i>
                              </el-button>
                            </template>
                          </el-input>
                        </el-form-item>

                        <!-- 权限模式选择 -->
                        <el-form-item :label="t('permissionMode')" class="form-item-align">
                          <el-select v-model="localEnvSettings.permissionMode" @change="autoSaveSettings" class="full-width-input">
                            <el-option :label="t('defaultPermissionMode')" value="default" ></el-option>
                            <el-option :label="t('acceptEdits')" value="auto-approve" ></el-option>
                            <el-option :label="t('bypassPermissions')" value="yolo" ></el-option>
                            <el-option :label="t('planMode')" value="plan" ></el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('localEnvironmentNotice1') }}
                          </div>
                        </template>
                      </el-alert>
                    </div>

                    <!-- Docker Sandbox 配置 -->
                    <div class="tool-item" v-show="CLISettings.engine === 'ds'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon><i class="fa-brands fa-docker"></i></el-icon>
                            {{t('dockerSandbox')}}
                          </span>
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://www.docker.com/get-started" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-brands fa-docker"></i>
                            </el-icon>{{ t('downloadDocker') }}
                          </el-link>
                        </div>
                      </div>
                      <div class="tool-content">
                        <!-- 工作空间选择 -->
                        <el-form-item required :label="t('workspace')" class="form-item-align">
                          <el-input v-model="CLISettings.cc_path" @input="autoSaveSettings" class="full-width-input">
                            <template #append>
                              <el-button @click="browseDirectory">
                                <i class="fa-solid fa-folder"></i>
                              </el-button>
                            </template>
                          </el-input>
                        </el-form-item>

                        <!-- 权限模式选择 -->
                        <el-form-item :label="t('permissionMode')" class="form-item-align">
                          <el-select v-model="dsSettings.permissionMode" @change="autoSaveSettings" class="full-width-input">
                            <el-option :label="t('defaultPermissionMode')" value="default" ></el-option>
                            <el-option :label="t('acceptEdits')" value="auto-approve" ></el-option>
                            <el-option :label="t('bypassPermissions')" value="yolo" ></el-option>
                            <el-option :label="t('planMode')" value="plan" ></el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('DockerSandboxNotice1') }}
                          </div>
                        </template>
                      </el-alert>
                    </div>
                    
                    <div class="tool-item" v-show="CLISettings.engine === 'cc'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon>
                              <i class="fa-solid fa-terminal"></i>
                            </el-icon>
                            Claude Code
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://github.com/anthropics/claude-code" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('gotoGithub') }}
                            </el-link>
                          </span>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item required :label="t('workspace')" class="form-item-align">
                          <el-input
                            v-model="CLISettings.cc_path"
                            @input="autoSaveSettings"
                            class="full-width-input"
                          >
                            <template #append>
                              <el-button @click="browseDirectory">
                                  <i class="fa-solid fa-folder"></i>
                              </el-button>
                            </template>
                          </el-input>
                        </el-form-item>
                        <el-form-item :label="t('permissionMode')" class="form-item-align">
                          <el-select
                            v-model="ccSettings.permissionMode"
                            @change="autoSaveSettings"
                            class="full-width-input"
                          >
                            <el-option :label="t('defaultPermissionMode')" value="default" ></el-option>
                            <el-option :label="t('acceptEdits')" value="acceptEdits" ></el-option>
                            <el-option :label="t('bypassPermissions')" value="bypassPermissions" ></el-option>
                            <el-option :label="t('planMode')" value="plan" ></el-option>
                          </el-select>
                        </el-form-item>
                        <el-form-item required :label="t('enabledCCconfig')" class="form-item-align" label-position="left">
                          <el-switch
                            v-model="ccSettings.enabled"
                            @change="autoSaveSettings"
                            class="tool-switch"
                          ></el-switch>
                        </el-form-item>
                        <el-form-item :label="t('anthropicSupportedProviders')" class="form-item-align">
                          <el-select
                            v-model="ccSettings.selectedProvider"
                            :placeholder="t('selectProvider')"
                            filterable
                            @change="selectCCProvider"
                            @visible-change="handleCCProviderVisibleChange"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="provider in filteredClaudeModelProviders"
                              :key="provider.id"
                              :label="provider.vendor+' - '+provider.modelId"
                              :value="provider.id"
                            >
                              <div class="provider-option">
                                <img 
                                  :src="getVendorLogo(provider.vendor)" 
                                  class="mini-vendor-logo"
                                />
                                <span class="model-id">{{ provider.modelId }}</span>
                              </div>
                            </el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('ClaudeCodeNotice1') }}
                          </div>
                        </template>
                      </el-alert>
                    </div>
                    <div class="tool-item" v-show="CLISettings.engine === 'qc'">
                      <div class="tool-header">
                        <div class="header-left">
                          <span>
                            <el-icon>
                              <i class="fa-solid fa-terminal"></i>
                            </el-icon>
                            Qwen Code
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://github.com/QwenLM/qwen-code" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('gotoGithub') }}
                            </el-link>
                          </span>
                        </div>
                      </div>
                      <div class="tool-content">
                        <el-form-item required :label="t('workspace')" class="form-item-align">
                          <el-input
                            v-model="CLISettings.cc_path"
                            @input="autoSaveSettings"
                            class="full-width-input"
                          >
                            <template #append>
                              <el-button @click="browseDirectory">
                                  <i class="fa-solid fa-folder"></i>
                              </el-button>
                            </template>
                          </el-input>
                        </el-form-item>
                        <el-form-item :label="t('permissionMode')" class="form-item-align">
                          <el-select
                            v-model="qcSettings.permissionMode"
                            @change="autoSaveSettings"
                            class="full-width-input"
                          >
                            <el-option :label="t('defaultPermissionMode')" value="default" ></el-option>
                            <el-option :label="t('acceptEdits')" value="auto-edit" ></el-option>
                            <el-option :label="t('bypassPermissions')" value="yolo" ></el-option>
                            <el-option :label="t('planMode')" value="plan" ></el-option>
                          </el-select>
                        </el-form-item>
                        <el-form-item required :label="t('enabledCCconfig')" class="form-item-align" label-position="left">
                          <el-switch
                            v-model="qcSettings.enabled"
                            @change="autoSaveSettings"
                            class="tool-switch"
                          ></el-switch>
                        </el-form-item>
                        <el-form-item :label="t('provider')" class="form-item-align">
                          <el-select
                            v-model="qcSettings.selectedProvider"
                            :placeholder="t('selectProvider')"
                            filterable
                            @change="selectQCProvider"
                            @visible-change="handleQCProviderVisibleChange"
                            class="full-width-input"
                          >
                            <el-option
                              v-for="provider in modelProviders"
                              :key="provider.id"
                              :label="provider.vendor+' - '+provider.modelId"
                              :value="provider.id"
                            >
                              <div class="provider-option">
                                <img 
                                  :src="getVendorLogo(provider.vendor)" 
                                  class="mini-vendor-logo"
                                />
                                <span class="model-id">{{ provider.modelId }}</span>
                              </div>
                            </el-option>
                          </el-select>
                        </el-form-item>
                      </div>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('QwenCodeNotice1') }}
                          </div>
                        </template>
                      </el-alert>
                    </div>
                  </el-form> 
                </el-tab-pane>
                <el-tab-pane :label="t('agentSkills')" name="skills">
                  <!-- 官网技能市场跳转横幅 (Skills Version) -->
                  <div class="market-link-banner" @click="openRepository('https://www.agentparty.top/skills.html')">
                    <!-- 顶部装饰条文字改为 OFFICIAL SKILLS -->
                    <div class="banner-accent-bar">OFFICIAL SKILLS</div>
                    
                    <div class="banner-main">
                      <!-- 图标换成闪电 -->
                      <div class="banner-icon-box">
                        <i class="fa-solid fa-bolt-lightning"></i>
                      </div>
                      
                      <div class="banner-text">
                        <h3>{{ t('skillMarket') || 'Skills Market' }}</h3>
                        <p>{{ t('exploreMoreSkills') || 'Unlock more capabilities: RAG, Web Search, Tools...' }}</p>
                      </div>

                      <div class="banner-action">
                        <span>GO</span>
                        <i class="fa-solid fa-arrow-right-long"></i>
                      </div>
                    </div>
                  </div>
                  <div class="plugin-header">
                    <h3>{{ t('agentSkills') }}</h3>
                    <div class="plugin-button-group">
                      <el-button 
                        @click="showAddSkillDialog = true" 
                        type="primary">
                        {{ t('addSkill') }}
                      </el-button>
                      <el-button 
                        @click="openSkillsFolder" 
                        type="primary">
                        {{ t('openSkillsFolder') }}
                      </el-button>
                      <el-button 
                        @click="openRepository('https://github.com/super-agent-party/super-agent-party.github.io/blob/main/skills.json')" 
                        type="primary">
                        {{ t('addYourSkills') }}
                      </el-button>
                      <el-button 
                        @click="handleRefreshSkills" 
                        type="primary"
                        :loading="skillsLoading">
                        {{ t('refresh') }}
                      </el-button>
                    </div>
                  </div>
                  <div class="provider-grid">
                    <!-- 已安装的 Skills 卡片 -->
                    <div class="provider-card knowledge-card" v-for="skill in skillsList" :key="skill.id">
                      <div class="card-header">
                        <el-tooltip 
                          :content="!CLISettings.cc_path ? t('pleaseSelectWorkspaceFirst') : t('syncToProject')" 
                          placement="top"
                        >
                          <el-switch 
                            :model-value="isSkillInProject(skill.id)"
                            :disabled="!CLISettings.cc_path"
                            @change="(val) => toggleSkillInProject(skill.id, val)"
                          ></el-switch>
                        </el-tooltip>
                        <div class="card-actions">
                          <el-button @click="previewSkill(skill.id)" type="info" circle size="small">
                            <i class="fa-solid fa-eye"></i>
                          </el-button>
                          <el-button @click="removeSkill(skill.id)" type="danger" circle size="small">
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </div>
                      </div>
                      <div class="kb-content">
                        <div class="kb-header">
                          <h3 class="kb-title">{{ skill.name }}</h3>
                          <el-tag type="info" size="small">v{{ skill.version }}</el-tag>
                        </div>
                        <div class="kb-meta">
                          <p style="font-size: 12px; color: #666; margin-bottom: 5px;">
                            {{ skill.description && skill.description.length > 200 
                              ? skill.description.slice(0, 200) + '...' 
                              : skill.description }}
                          </p>
                          <div style="font-size: 11px; color: #909399;">
                            <i class="fa-regular fa-file"></i> {{ skill.files.length }} files
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 添加新 Skill 卡片 -->
                    <div class="provider-card add-tile" @click="showAddSkillDialog = true">
                      <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                      <div style="color: #606266; margin-top: 10px;">{{ t('addSkill') }}</div>
                    </div>

                  </div>
                </el-tab-pane>
              </el-tabs>
                <!-- 技能预览对话框 -->
                <el-dialog 
                  v-model="showSkillPreviewDialog" 
                  :title="t('skillPreview')" 
                  width="80%"
                  top="5vh"
                  custom-class="skill-preview-dialog"
                >
                  <div 
                    v-loading="skillPreviewLoading" 
                    class="markdown-body skill-preview-content"
                    v-html="renderedSkillContent"
                  ></div>
                  <template #footer>
                    <el-button @click="showSkillPreviewDialog = false">{{ t('close') }}</el-button>
                  </template>
                </el-dialog>
                <!-- === 新增: 添加 Skill 对话框 === -->
                <el-dialog v-model="showAddSkillDialog" :title="t('addSkill')" width="650px">
                  <el-tabs v-model="addSkillTab">
                    
                    <!-- GitHub 安装 -->
                    <el-tab-pane label="GitHub" name="github">
                      <el-alert type="info" :closable="false" class="mb-2">
                        {{ t('skillGithubNote') }}
                      </el-alert>
                      <el-form label-position="top">
                        <el-form-item :label="t('repoUrl')">
                          <el-input v-model="newSkillUrl" placeholder="https://github.com/owner/repo"></el-input>
                        </el-form-item>
                        <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                          <el-button 
                            type="primary" 
                            @click="installSkillFromGithub" 
                            :loading="isSkillInstalling" 
                            :disabled="!newSkillUrl"
                          >
                            {{ t('downloadAndInstall') }}
                          </el-button>
                        </div>
                      </el-form>
                    </el-tab-pane>

                    <el-tab-pane :label="t('localZip')" name="zip">
                      <el-alert type="info" :closable="false" class="mb-2">
                        {{ t('skillZipNote') }}
                      </el-alert>
                      
                      <!-- 这是一个普通的 div 容器，加上 loading 遮罩 -->
                      <div 
                        class="upload-container"
                        v-loading="isUploading"
                        :element-loading-text="t('uploading')"
                      >
                        <!-- 
                          1. @click: 点击触发 triggerSkillFileSelect
                          2. @dragover.prevent: 允许拖拽（必须阻止默认行为）
                          3. @drop.prevent: 获取拖拽的文件
                        -->
                        <div
                          class="drop-zone"
                          @dragover.prevent
                          @drop.prevent="handleSkillDrop"
                          @click="triggerSkillFileSelect"
                          style="cursor: pointer;"
                        >
                          <!-- 这里你可以换成 fa-solid fa-cloud-arrow-up 或者保持 upload 组件 -->
                          <el-icon :size="50"><i class="fa-solid fa-cloud-arrow-up"></i></el-icon>
                          <p>{{ t('clickOrDrop') }}</p>
                        </div>

                        <!-- 
                          隐藏的原生文件输入框 
                          ref="skillFileInput": 用于 JS 找到它
                          accept=".zip": 限制文件类型
                          @change: 选中文件后触发
                        -->
                        <input 
                          type="file" 
                          ref="skillFileInput" 
                          accept=".zip" 
                          style="display: none" 
                          @change="handleSkillFileChange"
                        >
                      </div>
                    </el-tab-pane>
                  </el-tabs>
                </el-dialog>
              </div>
              <!-- 联网搜索界面 -->
              <div v-show="subMenu === 'websearch'" class="page">
                <el-form :model="webSearchSettings" class="settings-form"  label-position="top">
                  <div class="tool-item">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          {{ t('webSearch') }}
                        </span>
                      </div>
                      <el-switch v-model="webSearchSettings.enabled" @click.stop @change="autoSaveSettings"/>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('searchEngine')" class="form-item-align">
                        <el-select
                          v-model="webSearchSettings.engine"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option label="DuckDuckGo" value="duckduckgo" ></el-option>
                          <el-option label="SearXNG" value="searxng" ></el-option>
                          <el-option label="Tavily" value="tavily" ></el-option>
                          <el-option label="Bing" value="bing" ></el-option>
                          <el-option label="Google" value="google" ></el-option>
                          <el-option label="Brave" value="brave" ></el-option>
                          <el-option label="Exa" value="exa" ></el-option>
                          <el-option label="Serper" value="serper" ></el-option>
                          <el-option label="Bochaai" value="bochaai" ></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('webCrawling')" class="form-item-align">
                        <el-select
                          v-model="webSearchSettings.crawler"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option label="Jina" value="jina" ></el-option>
                          <el-option label="Crawl4AI" value="crawl4ai" ></el-option>
                          <el-option label="Firecrawl" value="firecrawl"></el-option>
                        </el-select>
                      </el-form-item>
                      <el-form-item :label="t('webSearchTiming')" class="form-item-align">
                        <el-select
                          v-model="webSearchSettings.when"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option :label="t('beforeThinking')" value="before_thinking" ></el-option>
                          <el-option :label="t('afterThinking')" value="after_thinking" ></el-option>
                          <el-option :label="t('both')" value="both" ></el-option>
                        </el-select>
                      </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="webSearchSettings.engine === 'duckduckgo'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          DuckDuckGo{{t("noNet")}}
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('resultCount')" class="form-item-align">
                        <el-slider
                          v-model="webSearchSettings.duckduckgo_max_results"
                          :min="1"
                          :max="20"
                          :step="1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="webSearchSettings.engine === 'searxng'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          SearXNG
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://github.com/searxng/searxng" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoGithub') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('resultCount')" class="form-item-align">
                        <el-slider
                          v-model="webSearchSettings.searxng_max_results"
                          :min="1"
                          :max="20"
                          :step="1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('baseURL')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.searxng_url"
                          :placeholder="t('searxngURLPlaceholder')"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="webSearchSettings.engine === 'tavily'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          Tavily
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://app.tavily.com/home" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('resultCount')" class="form-item-align">
                        <el-slider
                          v-model="webSearchSettings.tavily_max_results"
                          :min="1"
                          :max="20"
                          :step="1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.tavily_api_key"
                          :placeholder="t('apiKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>
                  <!-- Bing 配置块 -->
                  <div class="tool-item" v-show="webSearchSettings.engine === 'bing'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          Bing
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://learn.microsoft.com/en-us/bing/search-apis/bing-web-search/create-bing-search-service-resource"
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('resultCount')" class="form-item-align">
                        <el-slider
                          v-model="webSearchSettings.bing_max_results"
                          :min="1"
                          :max="20"
                          :step="1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.bing_api_key"
                          :placeholder="t('apiKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                      <el-form-item :label="t('searchEndpoint')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.bing_search_url"
                          placeholder="https://api.bing.microsoft.com/v7.0/search"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>

                  <!-- Google 配置块 -->
                  <div class="tool-item" v-show="webSearchSettings.engine === 'google'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          Google
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://console.cloud.google.com/apis/credentials"
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('resultCount')" class="form-item-align">
                        <el-slider
                          v-model="webSearchSettings.google_max_results"
                          :min="1"
                          :max="20"
                          :step="1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.google_api_key"
                          :placeholder="t('apiKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                      <el-form-item label="CSE ID" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.google_cse_id"
                          :placeholder="t('googleCSEIdPlaceholder')"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>

                  <!-- Brave 配置块 -->
                  <div class="tool-item" v-show="webSearchSettings.engine === 'brave'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          Brave
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://brave.com/search/api/"
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('resultCount')" class="form-item-align">
                        <el-slider
                          v-model="webSearchSettings.brave_max_results"
                          :min="1"
                          :max="20"
                          :step="1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.brave_api_key"
                          :placeholder="t('apiKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>

                  <!-- Exa 配置块 -->
                  <div class="tool-item" v-show="webSearchSettings.engine === 'exa'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          Exa
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://docs.exa.ai/reference/welcome"
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('resultCount')" class="form-item-align">
                        <el-slider
                          v-model="webSearchSettings.exa_max_results"
                          :min="1"
                          :max="20"
                          :step="1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.exa_api_key"
                          :placeholder="t('apiKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>

                  <!-- Serper 配置块 -->
                  <div class="tool-item" v-show="webSearchSettings.engine === 'serper'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          Serper
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://serper.dev/dashboard"
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('resultCount')" class="form-item-align">
                        <el-slider
                          v-model="webSearchSettings.serper_max_results"
                          :min="1"
                          :max="20"
                          :step="1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.serper_api_key"
                          :placeholder="t('apiKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>
                  <!-- Bochaai 配置块 -->
                  <div class="tool-item" v-show="webSearchSettings.engine === 'bochaai'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          Bochaai
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://open.bochaai.com/overview"
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('resultCount')" class="form-item-align">
                        <el-slider
                          v-model="webSearchSettings.bochaai_max_results"
                          :min="1"
                          :max="20"
                          :step="1"
                          show-input
                          @input="autoSaveSettings"
                        />
                      </el-form-item>
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.bochaai_api_key"
                          :placeholder="t('apiKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="webSearchSettings.crawler === 'jina'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          jina
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://jina.ai/api-dashboard" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoAPI') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.jina_api_key"
                          :placeholder="t('jinaAPIKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>
                  <div class="tool-item" v-show="webSearchSettings.crawler === 'crawl4ai'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-globe"></i>
                          </el-icon>
                          Crawl4Ai
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://github.com/unclecode/crawl4ai" 
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-key"></i>
                            </el-icon>{{ t('gotoGithub') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('baseURL')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.Crawl4Ai_url"
                          :placeholder="t('crawl4AiURLPlaceholder')"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.Crawl4Ai_api_key"
                          :placeholder="t('crawl4AiAPIKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        />
                      </el-form-item>
                    </div>
                  </div>

                  <!-- Firecrawl 配置 -->
                  <div class="tool-item" v-show="webSearchSettings.crawler === 'firecrawl'">
                    <div class="tool-header">
                      <div class="header-left">
                        <span>
                          <el-icon>
                            <i class="fa-solid fa-fire"></i>
                          </el-icon>
                          Firecrawl
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://www.firecrawl.dev/"
                            target="_blank"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-globe"></i>
                            </el-icon>{{ t('officialWebsite') }}
                          </el-link>
                          <el-link
                            type="primary"
                            :underline="false"
                            href="https://docs.firecrawl.dev/api-reference/introduction"
                            target="_blank"
                            class="ml-2"
                          >
                            <el-icon class="mr-1">
                              <i class="fa-solid fa-book"></i>
                            </el-icon>{{ t('docs') }}
                          </el-link>
                        </span>
                      </div>
                    </div>
                    <div class="tool-content">
                      <el-form-item :label="t('baseURL')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.firecrawl_url"
                          :placeholder="t('firecrawlURLPlaceholder')"
                          @input="autoSaveSettings"
                          class="full-width-input"
                        >
                        </el-input>
                      </el-form-item>
                      
                      <el-form-item :label="t('apiKey')" class="form-item-align">
                        <el-input
                          v-model="webSearchSettings.firecrawl_api_key"
                          :placeholder="t('firecrawlAPIKeyPlaceholder')"
                          show-password
                          @input="autoSaveSettings"
                          class="full-width-input"
                        >
                        </el-input>
                        <div class="form-hint">{{ t('firecrawlKeyHint') }}</div>
                      </el-form-item>
                      
                      <el-form-item :label="t('operationMode')" class="form-item-align">
                        <el-select
                          v-model="webSearchSettings.firecrawl_mode"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option label="scrape" value="scrape">
                            <span style="display: flex; align-items: center; gap: 8px;">
                              <el-icon><i class="fa-solid fa-file-lines"></i></el-icon>
                              <span>{{ t('scrape') }}</span>
                            </span>
                          </el-option>
                          <el-option label="crawl" value="crawl">
                            <span style="display: flex; align-items: center; gap: 8px;">
                              <el-icon><i class="fa-solid fa-sitemap"></i></el-icon>
                              <span>{{ t('crawl') }}</span>
                            </span>
                          </el-option>
                          <el-option label="search" value="search">
                            <span style="display: flex; align-items: center; gap: 8px;">
                              <el-icon><i class="fa-solid fa-magnifying-glass"></i></el-icon>
                              <span>{{ t('search') }}</span>
                            </span>
                          </el-option>
                          <el-option label="map" value="map">
                            <span style="display: flex; align-items: center; gap: 8px;">
                              <el-icon><i class="fa-solid fa-map"></i></el-icon>
                              <span>{{ t('map') }}</span>
                            </span>
                          </el-option>
                        </el-select>
                        <div class="form-hint mode-hint">
                          {{ t(webSearchSettings.firecrawl_mode + 'ModeHint') }}
                        </div>
                      </el-form-item>
                    </div>
                  </div>
                </el-form>
              </div>
              <!-- 知识库界面 -->
              <div v-show="subMenu === 'document'" class="page">
                <el-tabs v-model="activeKbTab">
                  <el-tab-pane :label="t('kbSettings')" name="settings">
                    <el-form :model="KBSettings" class="settings-form"  label-position="top">
                      <div class="tool-item">
                        <div class="tool-header">
                          <div class="header-left">
                            <span>
                              <el-icon>
                                <i class="fa-solid fa-book"></i>
                              </el-icon>
                              {{ t('knowledgeBase') }}
                            </span>
                          </div>
                        </div>
                        <div class="tool-content">
                          <!-- 原有搜索时机设置 -->
                          <el-form-item :label="t('KBSearchTiming')" class="form-item-align">
                            <el-select
                              v-model="KBSettings.when"
                              @change="autoSaveSettings"
                              class="full-width-input"
                            >
                              <el-option :label="t('beforeThinking')" value="before_thinking"></el-option>
                              <el-option :label="t('afterThinking')" value="after_thinking"></el-option>
                              <el-option :label="t('both')" value="both"></el-option>
                            </el-select>
                          </el-form-item>
                          <el-form-item :label="t('returnChunks')" class="form-item-align">
                            <el-slider
                              v-model="KBSettings.top_n"
                              :min="1"
                              :max="20"
                              :step="1"
                              show-input
                              @input="autoSaveSettings"
                            />
                          </el-form-item>
                          <!-- 新增参数设置 -->
                          <el-form-item :label="t('rerankEnable')" class="form-item-align" label-position="left">
                            <el-switch
                              v-model="KBSettings.is_rerank"
                              @change="autoSaveSettings"
                            ></el-switch>
                          </el-form-item>
                          <!-- 模型参数 -->
                          <el-form-item :label="t('rerankProvider')" class="form-item-align" v-show="KBSettings.is_rerank">
                            <el-select
                              v-model="KBSettings.selectedProvider"
                              :placeholder="t('selectProvider')"
                              filterable
                              @change="selectRankProvider"
                              @visible-change="handleRankProviderVisibleChange"
                              class="full-width-input"
                            >
                              <el-option
                                v-for="provider in modelProviders"
                                :key="provider.id"
                                :label="provider.vendor+' - '+provider.modelId"
                                :value="provider.id"
                              >
                                <div class="provider-option">
                                  <img 
                                    :src="getVendorLogo(provider.vendor)" 
                                    class="mini-vendor-logo"
                                  />
                                  <span class="model-id">{{ provider.modelId }}</span>
                                </div>
                              </el-option>
                            </el-select>
                          </el-form-item>
                          <el-alert
                            type="info"
                            :closable="false"
                            class="mb-2"
                          >
                            <template #default>
                              <div class="alert-content" v-show="KBSettings.is_rerank">
                                {{ t('firstTimeUse') }}
                                <el-link
                                  type="primary"
                                  :underline="false"
                                  class="font-medium"
                                  @click="switchToApiBox"
                                >
                                  <el-icon class="mr-1">
                                    <i class="fa-solid fa-key"></i>
                                  </el-icon>{{ t('keyBoxInterface') }}
                                </el-link>
                                {{ t('addProviderReturnSelect') }}
                                {{ t('rerankmodelnotice') }}
                              </div>
                            </template>
                          </el-alert>
                        </div>
                      </div>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        <template #default>
                          <div class="alert-content">
                            {{ t('minilmNotice') }}
                          </div>
                        </template>
                      </el-alert>
                      <!-- Minilm ONNX 卡片 -->
                      <el-card
                        shadow="hover"
                        class="sherpa-card"
                      >
                        <!-- 卡片头部：标题 + 安装状态 -->
                        <div class="card-header d-flex justify-content-between align-items-center">
                          <!-- 左侧标题 -->
                          <span><strong>Paraphrase Multilingual MiniLM L12 v2</strong></span>

                          <!-- 右侧 tag 组 -->
                          <div class="d-flex gap-2">
                            <el-tag type="info" effect="dark">
                              224MB
                            </el-tag>

                            <el-tag
                              :type="minilmModelExists ? 'success' : 'info'"
                              effect="dark"
                            >
                              {{ minilmModelExists ? t('installed') : t('notInstalled') }}
                            </el-tag>
                          </div>
                        </div>


                        <!-- 操作按钮区 -->
                        <div class="card-actions">
                          <!-- 左侧：两个下载按钮 -->
                          <div class="left-actions">
                            <el-button
                              type="primary"
                              :disabled="minilmModelExists || minilmDownloading"
                              :loading="minilmDownloading && source==='modelscope'"
                              @click="minilmDownload('modelscope')"
                            >
                              {{ t('downloadFromModelScope') }}
                            </el-button>

                            <el-button
                              type="primary"
                              :style="{ margin: '0' }"
                              :disabled="minilmModelExists || minilmDownloading"
                              :loading="minilmDownloading && source==='huggingface'"
                              @click="minilmDownload('huggingface')"
                            >
                              {{ t('downloadFromHuggingFace') }}
                            </el-button>
                          </div>

                          <!-- 右侧：删除按钮 -->
                          <el-button
                            v-if="minilmModelExists"
                            type="danger"
                            @click="minilmRemove"
                          >
                            {{ t('deleteModel') }}
                          </el-button>
                        </div>


                        <!-- 进度条（固定在底部） -->
                        <el-progress
                          v-if="minilmDownloading"
                          :percentage="minilmPercent"
                          style="margin-top: 16px;"
                          :stroke-width="10"
                        ></el-progress>
                      </el-card>
                    </el-form>
                  </el-tab-pane>
                  <el-tab-pane :label="t('addKnowledgeBase')" name="add">
                    <!-- 磁贴网格 -->
                    <div class="provider-grid">
                      <!-- 知识库磁贴 -->
                      <div class="provider-card knowledge-card" v-for="kb in knowledgeBases" :key="kb.id">
                        <div class="card-header">
                          <!-- 加载状态指示 -->
                          <el-switch 
                            v-show="kb.processingStatus !== 'processing'" 
                            v-model="kb.enabled" 
                            @change="toggleKbEnabled(kb)">
                          </el-switch>

                          <div class="card-actions">
                            <el-button  type="info" v-if="kb.processingStatus === 'processing'"  circle size="small">
                              <i class="fa-solid fa-spinner"></i>
                            </el-button>
                            <el-button @click="removeKnowledgeBase(kb)" type="danger"  circle size="small">
                              <i class="fa-solid fa-trash"></i>
                            </el-button>
                          </div>
                        </div>

                        <!-- 内容区域根据状态显示 -->
                        <!-- 修改模板部分 -->
                        <template v-if="kb.processingStatus !== 'processing'">
                          <div class="kb-content">
                            <div class="kb-header">
                              <h3 class="kb-title">{{ kb.name }}</h3>
                              <el-tag v-if="kb.files?.length" type="info" size="small">
                                {{ kb.files.length }} {{ t('files') }}
                              </el-tag>
                            </div>
                            <p class="kb-description">{{ kb.introduction || t('noDescription') }}</p>
                            <div class="kb-meta">
                              <div class="kb-meta-item">
                                <el-icon class="kb-icon">
                                  <i class="fa-solid fa-file"></i>
                                </el-icon>
                                <span>{{ t('model') }}: {{ kb.model || t('default') }}</span>
                              </div>
                              <div class="kb-meta-item">
                                <el-icon class="kb-icon">
                                  <i class="fa-solid fa-database"></i>
                                </el-icon>
                                <span>{{ t('segment') }}: {{ kb.chunk_size }} / {{ kb.chunk_overlap }}</span>
                              </div>
                            </div>
                          </div>
                        </template>
                        <div v-else class="processing-message">
                          <p>{{ t('knowledgeBaseGenerating') }}</p>
                        </div>
                      </div>
                      <!-- 添加新知识库磁贴 -->
                      <div class="provider-card add-tile" @click="showAddKbDialog = true;currentUploadType = 'file'">
                        <el-icon :size="40" color="#909399">
                          <i class="fa-solid fa-plus"></i>
                        </el-icon>
                        <div style="color: #606266; margin-top: 10px;">{{ t('addNewKnowledgeBase') }}</div>
                      </div>
                    </div>

                    <!-- 添加知识库对话框 -->
                    <el-dialog
                      v-model="showAddKbDialog"
                      :title="t('addNewKnowledgeBase')"
                      width="80%"
                      @closed="() => {
                        newKb = {
                          name: '',
                          introduction: '',
                          providerId: null,
                          model: '',
                          base_url: '',
                          api_key: '',
                          chunk_size: 1024,
                          chunk_overlap: 256,
                          weight: 0.5,
                          chunk_k: 5
                        }
                      }"
                    >
                      <el-form label-position="top" label-width="120px">
                        <el-form-item :label="t('knowledgeBaseName')" required>
                          <el-input v-model="newKb.name" :placeholder="t('enterKnowledgeBaseName')" />
                        </el-form-item>

                        <el-form-item :label="t('knowledgeBaseIntro')">
                          <el-input v-model="newKb.introduction" type="textarea" :placeholder="t('enterKnowledgeBaseIntro')" />
                        </el-form-item>

                        <el-form-item :label="t('embeddingProvider')" required>
                          <el-select
                            v-model="newKb.providerId"
                            :placeholder="t('selectProvider')"
                            filterable
                            @change="selectKbProvider"
                            class="full-width-input"
                          >
                            <el-option
                              key='paraphrase-multilingual-MiniLM-L12-v2'
                              :label="t('localVendor') + ' - ' + 'paraphrase-multilingual-MiniLM-L12-v2'"
                              value='paraphrase-multilingual-MiniLM-L12-v2'
                            >
                              <div class="provider-option">
                                <img 
                                  :src="getVendorLogo('Local')" 
                                  class="mini-vendor-logo"
                                />
                                <span class="model-id">paraphrase-multilingual-MiniLM-L12-v2</span>
                              </div>
                            </el-option>
                            <el-option
                              v-for="provider in modelProviders"
                              :key="provider.id"
                              :label="provider.vendor+' - '+provider.modelId"
                              :value="provider.id"
                            >
                              <div class="provider-option">
                                <img 
                                  :src="getVendorLogo(provider.vendor)" 
                                  class="mini-vendor-logo"
                                />
                                <span class="model-id">{{ provider.modelId }}</span>
                              </div>
                            </el-option>
                          </el-select>
                        </el-form-item>
                        <el-alert type="info" :closable="false" class="mb-2">
                          <template #default>
                            <div class="alert-content">
                              {{ t('minilmNotice2') }}
                              <el-link
                                type="primary"
                                :underline="false"
                                class="font-medium"
                                @click="switchToKnowledgeConfig"
                              >
                                <el-icon class="mr-1">
                                  <i class="fa-solid fa-key"></i>
                                </el-icon>{{ t('goToKnowledgeBase') }}
                              </el-link><br>
                              {{ t('firstTimeUse') }}
                              <el-link
                                type="primary"
                                :underline="false"
                                class="font-medium"
                                @click="switchToApiBox"
                              >
                                <el-icon class="mr-1">
                                  <i class="fa-solid fa-key"></i>
                                </el-icon>{{ t('keyBoxInterface') }}
                              </el-link>
                              {{ t('addProviderReturnSelect') }}
                              {{ t('addemdNotice') }}
                            </div>
                          </template>
                        </el-alert>
                        <el-collapse v-model="activeCollapse" class="advanced-settings">
                          <el-collapse-item name="advanced">
                            <template #title>
                              <div class="collapse-title">
                                <span class="font-medium">{{ t('advancedSettingsClickExpand') }}</span>
                              </div>
                            </template>

                            <el-form-item :label="t('segmentSize')">
                              <el-slider
                                v-model="newKb.chunk_size"
                                :min="512"
                                :max="4096"
                                :step="512"
                                show-input
                                @input="autoSaveSettings"
                              />
                            </el-form-item>
                            <el-form-item :label="t('overlapSize')">
                              <el-slider
                                v-model="newKb.chunk_overlap"
                                :min="128"
                                :max="1024"
                                :step="128"
                                show-input
                                @input="autoSaveSettings"
                              />
                            </el-form-item>
                            <el-form-item :label="t('returnParagraphs')">
                              <el-slider
                                v-model="newKb.chunk_k"
                                :min="1"
                                :max="50"
                                :step="1"
                                show-input
                                @input="autoSaveSettings"
                              />
                            </el-form-item>
                            <el-form-item :label="t('keywordSemanticWeight')">
                              <span style="margin-right: 10px;">{{t('keyword')}}</span>
                              <el-slider
                                v-model="newKb.weight"
                                :min="0"
                                :max="1"
                                :step="0.1"
                                show-input
                                @input="autoSaveSettings"
                                style="flex: 1;"
                              ></el-slider>
                              <span style="margin-left: 10px;">{{t('semantic')}}</span>
                            </el-form-item>
                          </el-collapse-item>
                        </el-collapse>
                      </el-form>
                      <!-- 文件上传区域 -->
                      <el-form-item>
                        <el-button 
                          type="primary"
                          @click="browseKbFiles"
                          class="add-server-btn"
                        >
                          <i class="fa-solid fa-cloud-arrow-up"></i>
                          {{t('uploadFile')}}
                        </el-button>
                        <!-- 紧凑型文件列表 -->
                        <div class="compact-file-list" v-if="newKbFiles.length">
                          <div
                            v-for="(file, index) in newKbFiles"
                            :key="index"
                            class="compact-file-item"
                          >
                            <span class="file-name">@{{ file.name }}</span>
                            <el-button
                              @click.stop="removeKbFile(index)"
                              class="delete-icon"
                              circle
                            >
                            <i class="fa-solid fa-trash"></i>
                            </el-button>
                          </div>
                        </div>
                      </el-form-item>
                      <template #footer>
                        <el-button @click="showAddKbDialog = false">{{ t('cancel') }}</el-button>
                        <el-button
                          type="primary"
                          @click="createKnowledgeBase"
                          :disabled="!newKb.name || !newKb.providerId"
                        >
                          {{ t('createImmediately') }}
                        </el-button>
                      </template>
                    </el-dialog>
                  </el-tab-pane>
                </el-tabs>
              </div>

            <!-- 新增表情包界面 -->
              <div v-show="subMenu === 'sticker'" class="page">
                <div class="provider-grid">
                  <!-- 已有表情包库 -->
                  <div 
                    v-for="pack in stickerPacks" 
                    :key="pack.id"
                    class="provider-card knowledge-card">
                    <div class="card-header">
                      <el-switch v-model="pack.enabled"></el-switch>
                      <div class="card-actions">
                        <el-button @click="deleteStickerPack(pack)" type="danger" circle size="small">
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="kb-content">
                      <div class="kb-header">
                        <h3 class="kb-title">{{ pack.name }}</h3>
                        <el-tag v-if="pack.stickers?.length" type="info" size="small" effect="dark">
                          {{ pack.stickers.length }} {{ t('images') }}
                        </el-tag>
                      </div>
                      <div class="kb-meta">
                        <img :src="pack.cover" class="cover-image" />
                      </div>
                    </div>
                  </div>

                  <!-- 添加新表情包库 -->
                  <div class="provider-card add-tile" @click="showStickerDialog = true">
                    <el-icon :size="40" color="#909399">
                      <i class="fa-solid fa-plus"></i>
                    </el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addStickerPack') }}</div>
                  </div>
                </div>

                <!-- 表情包创建对话框 -->
                <el-dialog
                  v-model="showStickerDialog"
                  :title="t('createStickerPack')"
                  width="60%">
                  <el-form label-position="top">
                    <el-form-item :label="t('packName')" required>
                      <el-input v-model="newStickerPack.name" />
                    </el-form-item>

                    <el-form-item :label="t('uploadStickers')" required>
                      <div class="sticker-upload">
                        <el-upload
                          multiple
                          list-type="picture-card"
                          :file-list="uploadedStickers"
                          :before-upload="handleBeforeUpload"
                          :on-remove="handleStickerRemove"
                          :on-preview="handlePictureCardPreview"
                        >
                          <el-icon><i class="fa-solid fa-plus"></i></el-icon>
                        </el-upload>
                      </div>
                    </el-form-item>

                    <!-- 预览弹窗 -->
                    <el-dialog v-model="dialogVisible">
                      <img :src="imageUrl" style="width: 100%" alt="Preview">
                    </el-dialog>

                    <el-form-item :label="t('imageDescription')" required>
                      <div class="tag-editor">
                        <div class="tag-item" 
                            v-for="(sticker, index) in uploadedStickers" 
                            :key="index">
                          <img :src="sticker.url" class="sticker-thumb" />
                          <el-input
                            type="textarea"
                            :rows="2"
                            v-model="sticker.description"
                            :placeholder="t('enterDescriptionPlaceholder')"
                          />
                        </div>
                      </div>
                    </el-form-item>
                  </el-form>

                  <template #footer>
                    <el-button @click="cancelStickerUpload">{{ t('cancel') }}</el-button>
                    <el-button 
                      type="primary"
                      @click="createStickerPack"
                      :disabled="!newStickerPack.name || uploadedStickers.length === 0"
                      >
                      {{ t('createImmediately') }}
                    </el-button>
                  </template>
                </el-dialog>
              </div>

              <!-- 在agent_group的内容区添加ComfyUI配置 -->
              <div v-show="subMenu === 'comfyui'" class="page comfyui-container">
                <el-tabs>
                  <!-- 配置选项卡 -->
                  <el-tab-pane :label="t('comfyuiConfig')">
                    <el-form class="settings-form" label-position="top">
                      <div class="tool-item">
                        <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                          <span>
                            <el-icon><i class="fa-solid fa-server"></i></el-icon>
                            {{ t('comfyuiServers') }}
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://platform.comfy.org/profile/api-keys" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('gotoAPI') }}
                            </el-link>
                          </span>
                        </div>
                        <div class="tool-content">
                          <div class="server-item">
                            <el-input 
                              v-model="comfyuiAPIkey" 
                              :placeholder="t('comfyuiAPIKey')"
                              class="full-width-input"
                              show-password
                              @change="autoSaveSettings"
                            >
                            </el-input>
                          </div>
                          <div v-for="(server, index) in comfyuiServers" 
                              :key="index" 
                              class="server-item">
                            <el-input 
                              v-model="comfyuiServers[index]" 
                              placeholder="http://localhost:8188"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            >
                            </el-input>
                            <el-tooltip :content="t('connectComfyUIServer')" placement="top">
                              <el-button 
                                type="primary" 
                                @click="connectComfyUI(index)" 
                                :disabled="comfyuiServers.length === 0 || isConnecting"
                                circle
                              >
                                <template v-if="isConnecting">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-plug"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                            <el-tooltip :content="t('removeComfyUIServer')" placement="top">
                              <el-button 
                                v-if="index !== 0"
                                @click="removeComfyUIServer(index)"
                                type="danger" 
                                circle>
                                <i class="fa-solid fa-trash"></i>
                              </el-button>
                            </el-tooltip>
                          </div>
                          <el-button 
                            @click="addComfyUIServer"
                            type="primary" 
                            class="add-server-btn">
                            <i class="fa-solid fa-plus"></i> {{ t('addServer') }}
                          </el-button>
                        </div>
                      </div>
                      <el-alert
                          :title="t('comfyuiConfigInfo')"
                          type="info"
                          :closable="false"
                          class="mb-2"
                        >
                          1. {{ t('comfyuiConfigInfo1') }}<br>
                          2. {{ t('comfyuiConfigInfo2') }}<br>
                          3. {{ t('comfyuiConfigInfo3') }}<br>
                          4. {{ t('comfyuiConfigInfo4') }}<br>
                          5. {{ t('comfyuiConfigInfo5') }}<br>
                      </el-alert>
                    </el-form>
                  </el-tab-pane>

                  <!-- 展示选项卡 -->
                  <el-tab-pane :label="t('comfyuiDisplay')">
                    <div class="comfyui-iframe-container">
                      <iframe 
                        v-if="activeComfyUIUrl"
                        :src="activeComfyUIUrl" 
                        frameborder="0"
                        class="comfyui-iframe"></iframe>
                      <div v-else class="no-server-tip">
                        <el-empty :description="t('noServerTip')" />
                      </div>
                    </div>
                  </el-tab-pane>

                      <!-- 新增 ComfyUI 工作流转工具选项卡 -->
                  <el-tab-pane :label="t('comfyuiWorkflowTool')">
                  <!-- 磁贴列表 -->
                    <div class="provider-grid">
                      <div v-for="file in workflows" :key="file.unique_filename" class="provider-card knowledge-card">
                        <div class="card-header">
                          <el-switch v-model="file.enabled" @change="autoSaveSettings"></el-switch>
                          <div class="card-actions">
                            <!-- 下载按钮 -->
                            <a :href="`${partyURL}/uploaded_files/${file.unique_filename}`" download target="_blank">
                              <el-button circle size="small" class="file-actions-btn">
                                  <i class="fa-solid fa-download"></i>
                              </el-button>
                            </a>
                            <!-- 删除按钮 -->
                            <el-button
                              type="danger"
                              circle
                              size="small"
                              @click="deleteWorkflow(file.unique_filename)">
                              <i class="fa-solid fa-trash"></i>
                            </el-button>
                          </div>
                        </div>
                        <h3>{{ file.original_filename }}</h3>
                        <span>{{ (file.description?.substring(0, 50) + '...') || '' }}</span>
                      </div>
                      <!-- 添加上传按钮 -->
                      <div class="provider-card add-tile" @click="showWorkflowUploadDialog = true">
                        <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                        <div style="color: #606266; margin-top: 10px;">{{ t('uploadWorkflowJson') }}</div>
                      </div>
                    </div>
                  </el-tab-pane>
                </el-tabs>
                <!-- 工作流上传对话框 -->
                <el-dialog
                  v-model="showWorkflowUploadDialog"
                  :title="t('uploadWorkflowJson')"
                  width="600px"
                >
                  <div class="upload-container">
                    <div
                      class="drop-zone"
                      @dragover.prevent
                      @drop.prevent="handleWorkflowDrop"
                      @click="browseWorkflowFile"
                    >
                      <el-icon :size="50"><i class="fa-solid fa-cloud-arrow-up"></i></el-icon>
                      <p>{{ t('clickOrDrop') }}</p>
                    </div>
                    
                    <!-- 文件列表 -->
                    <div class="compact-file-list" v-if="workflowFile">
                      <div class="compact-file-item">
                        <span class="file-name">@{{ workflowFile.name }}</span>
                        <el-button
                          @click.stop="removeWorkflowFile"
                          class="delete-icon"
                          circle
                        >
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>

                    <div class="input-box" required>
                      <el-input
                        v-model="workflowDescription"
                        type="textarea"
                        :rows="3"
                        :placeholder="t('descriptionPlaceholder')"
                      />
                    </div>

                    <div class="input-box">
                      <!-- 文字输入位置选择 -->
                      <el-select v-model="selectedTextInput" value-key="id"  :placeholder="t('selectTextInput')" class="full-width-input">
                        <el-option
                          v-for="(node, index) in textInputOptions"
                          :key="index"
                          :label="node.label"
                          :value="node.value"
                        ></el-option>
                      </el-select>
                    </div>
                    <div class="input-box">
                      <!-- 文字输入位置选择 -->
                      <el-select v-model="selectedTextInput2" value-key="id"  :placeholder="t('selectTextInput')" class="full-width-input">
                        <el-option
                          v-for="(node, index) in textInputOptions"
                          :key="index"
                          :label="node.label"
                          :value="node.value"
                        ></el-option>
                      </el-select>
                    </div>
                    <div class="input-box">
                      <!-- 图片输入位置选择 -->
                      <el-select v-model="selectedImageInput" value-key="id" :placeholder="t('selectImageInput')" class="full-width-input">
                        <el-option
                          v-for="(node, index) in imageInputOptions"
                          :key="index"
                          :label="node.label"
                          :value="node.value"
                        ></el-option>
                      </el-select>
                    </div>
                    <div class="input-box">
                      <!-- 图片输入位置选择 -->
                      <el-select v-model="selectedImageInput2" value-key="id" :placeholder="t('selectImageInput')" class="full-width-input">
                        <el-option
                          v-for="(node, index) in imageInputOptions"
                          :key="index"
                          :label="node.label"
                          :value="node.value"
                        ></el-option>
                      </el-select>
                    </div>
                    <div class="input-box">
                      <!-- 种子位置选择 -->
                      <el-select v-model="selectedSeedInput" value-key="id" :placeholder="t('selectSeedInput')" class="full-width-input">
                        <el-option
                          v-for="(node, index) in seedInputOptions"
                          :key="index"
                          :label="node.label"
                          :value="node.value"
                        ></el-option>
                      </el-select>
                    </div>
                    <div class="input-box">
                      <!-- 种子位置选择 -->
                      <el-select v-model="selectedSeedInput2" value-key="id" :placeholder="t('selectSeedInput')" class="full-width-input">
                        <el-option
                          v-for="(node, index) in seedInputOptions"
                          :key="index"
                          :label="node.label"
                          :value="node.value"
                        ></el-option>
                      </el-select>
                    </div>
                    <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        {{ t('comfyuiWorkflowInfo') }}
                    </el-alert>
                  </div>
                  <template #footer>
                    <el-button @click="cancelWorkflowUpload">{{ t('cancel') }}</el-button>
                    <el-button type="primary" @click="uploadWorkflow" :disabled="!workflowFile">
                      {{ t('createImmediately') }}
                    </el-button>
                  </template>
                </el-dialog>
              </div>
              <!-- A2A页面 -->
              <div v-show="subMenu === 'a2a'" class="page a2a-container">
                <div class="provider-grid">
                  <div class="provider-card a2a-card" v-for="(server, url) in a2aServers" :key="url">
                    <div class="card-header">
                      <el-switch v-show="server.status !== 'initializing'" v-model="server.enabled" @change="autoSaveSettings"></el-switch>
                      <div class="card-actions">
                        <el-button  type="info" v-if="server.status === 'initializing'"  circle size="small">
                          <i class="fa-solid fa-spinner"></i>
                        </el-button>
                        <el-button @click="removeA2AServer(url)" type="danger" circle size="small">
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="a2a-content">
                      <h3 class="a2a-name">{{ server.name }}</h3>
                      <p class="a2a-description">{{ server.description }}</p>
                      <div class="a2a-skills">
                        <el-tag v-for="(skill, index) in server.skills" :key="index" type="info" size="small">
                          {{ skill }}
                        </el-tag>
                      </div>
                    </div>
                  </div>
                  <div class="provider-card add-tile" @click="showAddA2ADialog = true">
                    <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addA2AServer') }}</div>
                  </div>
                </div>
            
                <!-- 添加A2A服务器对话框 -->
                <el-dialog v-model="showAddA2ADialog" :title="t('addA2AServer')" width="500px" label-position="top">
                  <el-form label-position="top">
                    <el-form-item :label="t('A2AUrl')" required>
                      <el-input v-model="newA2AUrl" placeholder="http://127.0.0.1:5000"></el-input>
                    </el-form-item>
                  </el-form>
                  <template #footer>
                    <el-button @click="showAddA2ADialog = false">{{ t('cancel') }}</el-button>
                    <el-button 
                      type="primary" 
                      @click="addA2AServer"
                      :disabled="!isValidUrl(newA2AUrl)">
                      {{ t('confirmAdd') }}
                    </el-button>
                  </template>
                </el-dialog>
              </div>
              <!-- MCP页面 -->
              <div v-show="subMenu === 'mcp'" class="page mcp-container">
                  <!-- 官网 MCP 市场跳转横幅 -->
                  <div class="market-link-banner" @click="openRepository('https://www.agentparty.top/mcp.html')">
                    <div class="banner-accent-bar">OFFICIAL SERVERS</div>
                    <div class="banner-main">
                      <div class="banner-icon-box">
                        <i class="fa-solid fa-network-wired"></i>
                      </div>
                      <div class="banner-text">
                        <h3>{{ t('mcpMarket') || 'MCP Market' }}</h3>
                        <p>{{ t('exploreMoreMCP') || 'Connect to everything: GitHub, Databases, Local Files...' }}</p>
                      </div>
                      <div class="banner-action">
                        <span>GO</span>
                        <i class="fa-solid fa-arrow-right-long"></i>
                      </div>
                    </div>
                  </div>
                  <div class="plugin-header">
                    <h3>MCP</h3>
                    <div class="plugin-button-group">
                      <el-button 
                        @click="showAddMCPDialo = true" 
                        type="primary">
                        {{ t('addNewMCP') }}
                      </el-button>
                      <el-button 
                        @click="openRepository('https://github.com/super-agent-party/super-agent-party.github.io/blob/main/mcp.json')" 
                        type="primary">
                        {{ t('addYourMCP') }}
                      </el-button>
                    </div>
                  </div>
                  <!-- 磁贴网格 -->
                  <div class="provider-grid">
                    <div class="provider-card knowledge-card" v-for="(server, name) in mcpServers" :key="name">
                      <div class="card-header">
                        <el-switch
                          v-show="server.processingStatus !== 'initializing'"
                          :active-value="false"  
                          :inactive-value="true" 
                          v-model="server.disabled"
                          @change="autoSaveSettings"
                          class="kb-switch"
                          :disabled="server.processingStatus === 'server_error'"
                        ></el-switch>
                        <div class="card-actions">
                          <el-button
                            @click="restartMCPServer(name)"
                            type="info"
                            circle
                            size="small"
                          >
                            <i :class="server.processingStatus == 'initializing'?'fa-solid fa-spinner fa-spin':'fa-solid fa-rotate-right'"></i>
                          </el-button>
                          <!-- 编辑按钮现在是主要的查看工具入口 -->
                          <el-button
                            @click="editMCPServer(name)"
                            type="primary"
                            circle
                            size="small"
                          >
                            <i class="fa-solid fa-pen-to-square"></i>
                          </el-button>
                          <el-button
                            @click="removeMCPServer(name)"
                            type="danger"
                            circle
                            size="small"
                          >
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </div>
                      </div>
                      <div class="kb-content">
                        <div class="kb-header">
                          <h3 class="kb-title">{{ name }}</h3>
                          <!-- 状态标签 -->
                          <el-tag v-if="server.processingStatus === 'initializing'" type="warning" size="small">{{ t('initializing') }}</el-tag>
                          <el-tag v-else-if="server.processingStatus === 'server_error'" type="danger" size="small">{{ t('error') }}</el-tag>
                          <el-tag v-else-if="server?.tools?.length" type="success" size="small">
                            {{ server?.tools?.length }} {{ t('tools') }}
                          </el-tag>
                          <el-tag v-else type="info" size="small">0 {{ t('tools') }}</el-tag>
                        </div>
                        <div class="kb-meta">
                          <div class="kb-meta-item">
                            <!-- 仅保留提示信息，工具列表已移至弹窗 -->
                            <span style="font-size: 12px; color: #909399;">
                              {{ server.processingStatus === 'ready' ? t('clickEditToManageTools') : t('serverNotReady') }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 添加新磁贴 -->
                    <div class="provider-card add-tile" @click="openAddDialog()">
                      <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                      <div style="color: #606266; margin-top: 10px;">{{ t('addNewMCP') }}</div>
                    </div>
                  </div>

                  <!-- 添加/编辑 MCP 对话框 -->
                  <el-dialog
                    v-model="showAddMCPDialog"
                    :title="isEditMode ? t('editMCP') : t('addNewMCP')"
                    width="650px"
                    :close-on-click-modal="false"
                    :close-on-press-escape="false"
                    class="mcp-dialog"
                    @closed="resetDialogState">
                    
                    <!-- 加载遮罩 -->
                    <div v-loading="isSubmitting" element-loading-text="Initializing MCP Server...">
                      
                      <!-- 使用 Tabs 分离配置和工具 -->
                      <el-tabs v-model="activeDialogTab" class="mcp-dialog-tabs">
                        
                        <!-- Tab 1: 基础配置 -->
                        <el-tab-pane :label="t('settings')" name="config">
                          <el-form label-position="top" class="mt-2">
                            <!-- 基础配置 (添加模式或编辑模式都显示) -->
                            <div class="config-section">
                                <el-form-item :label="t('serverType')">
                                  <el-select 
                                    v-model="newMCPType" 
                                    @change="updateMCPExample"
                                    class="full-width-input"
                                    >
                                    <el-option :label="t('stdioServer')" value="stdio"></el-option>
                                    <el-option :label="t('sseServer')" value="sse"></el-option>
                                    <el-option :label="t('wsServer')" value="ws"></el-option>
                                    <el-option :label="t('streamableHttpServer')" value="streamablehttp"></el-option>
                                  </el-select>
                                </el-form-item>
                            
                                <el-form-item :label="t('inputMethod')">
                                  <el-select 
                                    v-model="mcpInputType" 
                                    @change="handleInputMethodChange" 
                                    class="full-width-input">
                                    <el-option :label="t('formInput')" value="form"></el-option>
                                    <el-option :label="t('jsonInput')" value="json"></el-option>
                                  </el-select>
                                </el-form-item>

                                <!-- JSON 输入模式 -->
                                <template v-if="mcpInputType === 'json'">
                                  <el-alert v-if="!isEditMode" type="info" :closable="false" class="mb-2">
                                      {{ t('mcpJsonFormat') }}
                                      <pre class="json-example">{{ currentMCPExample }}</pre>
                                    </el-alert>
                                    <el-form-item :label="t('mcpJsonInput')">
                                      <el-input v-model="newMCPJson" type="textarea" :rows="8" :placeholder="t('mcpJsonPlaceholder')"/>
                                    </el-form-item>
                                </template>

                                <!-- 表单输入模式 -->
                                <template v-if="mcpInputType === 'form'">
                                  <el-form-item :label="t('mcpName')">
                                    <el-input v-model="newMCPFormData.name" :disabled="isEditMode"/>
                                  </el-form-item>
                                  
                                  <template v-if="newMCPType !== 'stdio'">
                                    <el-form-item :label="t('mcpURL')">
                                        <el-input :placeholder="mcpURLDict[newMCPType]" v-model="newMCPFormData.url"/>
                                    </el-form-item>
                                    <el-form-item :label="t('mcpApiKey')">
                                        <el-input :placeholder="t('mcpApiKeyPlaceholder')" v-model="newMCPFormData.apiKey" show-password/>
                                    </el-form-item>
                                  </template>

                                  <template v-if="newMCPType === 'stdio'">
                                      <el-form-item :label="t('mcpCommand')">
                                        <el-input :placeholder="t('mcpCommandPlaceholder')" v-model="newMCPFormData.command"/>
                                      </el-form-item>
                                      <el-form-item :label="t('mcpArgs')">
                                        <el-input :placeholder="t('mcpArgsPlaceholder')" type="textarea" :rows="3" v-model="newMCPFormData.args"/>
                                      </el-form-item>
                                      <el-form-item :label="t('mcpEnv')">
                                        <el-input :placeholder="t('mcpEnvPlaceholder')" type="textarea" :rows="3" v-model="newMCPFormData.env"/>
                                      </el-form-item>
                                  </template>
                                </template>
                            </div>
                          </el-form>
                        </el-tab-pane>

                        <!-- Tab 2: 工具管理 (仅在编辑模式显示) -->
                        <!-- 动态显示工具数量 -->
                        <el-tab-pane 
                          v-if="isEditMode" 
                          :label="`${t('manageTools')} (${(mcpServers[currentEditingMCPId]?.tools?.length || 0)})`" 
                          name="tools"
                        >
                          <!-- 错误提示 -->
                          <el-alert v-if="mcpServers[currentEditingMCPId]?.processingStatus === 'server_error'" type="error" :closable="false" show-icon class="mb-2">
                              {{ t('mcpConnectionFailed') }}
                          </el-alert>

                          <!-- 工具列表容器 -->
                          <div v-if="mcpServers[currentEditingMCPId]?.tools && mcpServers[currentEditingMCPId].tools.length" class="tools-list-container">
                              <div v-for="tool in mcpServers[currentEditingMCPId].tools" :key="tool.name" class="tool-item-card">
                                  
                                  <div class="tool-info-left">
                                    <div class="tool-header-row">
                                      <span class="tool-name">{{ tool.name }}</span>
                                      <el-tooltip v-if="tool.description" :content="tool.description" placement="top" :show-after="500">
                                        <el-icon class="tool-info-icon"><i class="fa-solid fa-circle-info"></i></el-icon>
                                      </el-tooltip>
                                    </div>
                                    <div class="tool-desc">
                                      {{ tool.description || t('noDescription') }}
                                    </div>
                                  </div>

                                  <el-switch 
                                    v-model="tool.enabled" 
                                    @change="autoSaveSettings"
                                    size="small"
                                  />
                              </div>
                          </div>
                          
                          <!-- 空状态 -->
                          <div v-else-if="mcpServers[currentEditingMCPId]?.processingStatus === 'ready'" class="tools-empty-state">
                              {{ t('noToolsFound') }}
                          </div>
                          
                          <!-- 初始化中状态 -->
                          <div v-else-if="mcpServers[currentEditingMCPId]?.processingStatus === 'initializing'" class="tools-empty-state">
                              <i class="fa-solid fa-spinner fa-spin"></i> {{ t('initializing') }}...
                          </div>
                        </el-tab-pane>

                      </el-tabs>
                    </div>

                    <template #footer>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span></span>

                        <div>
                          <el-button @click="showAddMCPDialog = false" :disabled="isSubmitting">
                              {{ isEditMode ? t('close') : t('cancel') }}
                          </el-button>
                          
                          <!-- 添加模式 -->
                          <el-button 
                            v-if="!isEditMode"
                            type="primary" 
                            @click="addMCPServer"
                            :loading="isSubmitting"
                            :disabled="(!newMCPJson && !newMCPFormData.name)">
                            {{ t('confirmAdd') }}
                          </el-button>
                          
                          <!-- 编辑模式 -->
                          <el-button
                            v-if="isEditMode"
                            type="primary"
                            @click="updateMCPServerConfig"
                            :loading="isSubmitting">
                            {{ t('confirmSave') }}
                          </el-button>
                        </div>
                      </div>
                    </template>
                  </el-dialog>   
                  <el-dialog
                    v-model="showMCPConfirm"
                    :title="t('confirmDeleteTitle')"
                    width="400px"
                    @closed="deletingMCPName = null">
                    <div class="confirm-content">
                      <p>{{ t('confirmDeleteMCP', { name: deletingMCPName }) }}</p>
                      <div class="confirm-buttons">
                        <el-button @click="showMCPConfirm = false">{{ t('cancel') }}</el-button>
                        <el-button type="danger" @click="confirmDeleteMCP">{{ t('confirm') }}</el-button>
                      </div>
                    </div>
                  </el-dialog>
              </div>
              <!-- LLM工具页面 -->
              <div v-show="subMenu === 'llmTool'" class="page llm-tool-container">
                <!-- 磁贴网格 -->
                <div class="provider-grid">
                  <!-- 已有LLM工具配置 -->
                  <div class="provider-card llm-card" v-for="(tool, id) in llmTools" :key="id">
                    <div class="card-header">
                      <el-switch v-model="tool.enabled" @change="autoSaveSettings"></el-switch>
                      <div class="card-actions">
                        <el-button @click="removeLLMTool(id)" type="danger" circle size="small">
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="llm-content">
                      <h3 class="knowledge-info">{{ tool.name }}</h3>
                      <el-tag type="info" size="small">{{ toolTypeLabel(tool.type) }}</el-tag>
                      <p class="knowledge-desc">{{ tool.description || t('noDescription') }}</p>
                    </div>
                  </div>
                  
                  <!-- 添加新LLM工具 -->
                  <div class="provider-card add-tile" @click="showLLMForm = true">
                    <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addLLMTool') }}</div>
                  </div>
                </div>

                <!-- 添加/编辑LLM工具对话框 -->
                <el-dialog v-model="showLLMForm" :title="editingLLM ? t('editLLMTool') : t('addLLMTool')" width="600px">
                  <el-form label-position="top">
                    <el-form-item :label="t('toolName')" required>
                      <el-input v-model="newLLMTool.name" :placeholder="t('toolNamePlaceholder')"/>
                    </el-form-item>

                    <el-form-item :label="t('interfaceType')" required>
                      <el-select 
                        v-model="newLLMTool.type" 
                        @change="handleTypeChange"
                        filterable
                        allow-create
                        :placeholder="t('selectInterfaceType')">
                        <el-option
                          v-for="type in llmInterfaceTypes"
                          :key="type.value"
                          :label="type.label"
                          :value="type.value"
                        />
                      </el-select>
                    </el-form-item>

                    <el-form-item :label="t('description')" required>
                      <el-input
                        v-model="newLLMTool.description"
                        type="textarea"
                        :rows="3"
                        :placeholder="t('descriptionPlaceholder')"
                      />
                    </el-form-item>

                    <el-form-item :label="t('baseURL')" required>
                      <el-input
                        v-model="newLLMTool.base_url"
                        :placeholder="defaultBaseURL"
                      />
                    </el-form-item>

                    <el-form-item :label="t('apiKey')" required>
                      <el-input
                        v-model="newLLMTool.api_key"
                        show-password
                      />
                    </el-form-item>

                    <el-form-item :label="t('modelName')" required>
                      <el-input
                        v-model="newLLMTool.model"
                      >
                      </el-input>
                    </el-form-item>
                  </el-form>

                  <template #footer>
                    <el-button @click="cancelLLMTool">{{ t('cancel') }}</el-button>
                    <el-button 
                      type="primary" 
                      @click="saveLLMTool"
                      :disabled="!formValid">
                      {{ editingLLM ? t('save') : t('createImmediately') }}
                    </el-button>
                  </template>
                </el-dialog>
              </div>
              <!-- 自定义HTTP工具页面 -->
              <div v-show="subMenu === 'customHttpTool'" class="page custom-http-tool-container">
                <!-- 磁贴网格 -->
                <div class="provider-grid">
                  <div class="provider-card custom-http-tool-card" v-for="tool in customHttpTools" :key="tool.id">
                    <div class="card-header">
                      <el-switch v-model="tool.enabled" @change="autoSaveSettings"></el-switch>
                      <div class="card-actions">
                        <el-button @click="editCustomHttpTool(tool.id)" type="default" circle size="small">
                          <i class="fa-solid fa-pen-to-square"></i>
                        </el-button>
                        <el-button @click="removeCustomHttpTool(tool.id)" type="danger" circle size="small">
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>
                    <div class="custom-http-tool-content">
                      <h3 class="custom-http-tool-name">{{ tool.name }}</h3>
                      <p class="custom-http-tool-description">{{ tool.description }}</p>
                    </div>
                  </div>
                  <!-- 添加新自定义HTTP工具 -->
                  <div class="provider-card add-tile" @click="showCustomHttpToolForm = true">
                    <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addCustomHttpTool') }}</div>
                  </div>
                </div>

                <!-- 添加/编辑自定义HTTP工具对话框 -->
                <el-dialog v-model="showCustomHttpToolForm" :title="editingCustomHttpTool ? t('editCustomHttpTool') : t('addCustomHttpTool')" width="600px">
                  <el-form label-position="top">
                    <el-form-item :label="t('toolName')" required>
                      <el-input v-model="newCustomHttpTool.name" :placeholder="t('HTTPNamePlaceholder')"></el-input>
                    </el-form-item>
                    <el-form-item :label="t('description')" required>
                      <el-input v-model="newCustomHttpTool.description" type="textarea" :rows="3" :placeholder="t('descriptionPlaceholder')"></el-input>
                    </el-form-item>
                    <el-form-item :label="t('URL')" required>
                      <el-input v-model="newCustomHttpTool.url" :placeholder="t('urlPlaceholder')"></el-input>
                    </el-form-item>
                    <el-form-item :label="t('method')" required>
                      <el-select v-model="newCustomHttpTool.method" placeholder="Select method">
                        <el-option label="GET" value="GET"></el-option>
                        <el-option label="POST" value="POST"></el-option>
                        <el-option label="PUT" value="PUT"></el-option>
                        <el-option label="DELETE" value="DELETE"></el-option>
                      </el-select>
                    </el-form-item>
                    <el-form-item :label="t('headers')">
                      <el-input v-model="newCustomHttpTool.headers" type="textarea" :rows="4" :placeholder="t('headersPlaceholder')"></el-input>
                    </el-form-item>
                    <el-form-item :label="t('body')">
                      <el-input v-model="newCustomHttpTool.body" type="textarea" :rows="20" :placeholder="t('bodyPlaceholder')"></el-input>
                      <el-alert type="info" :closable="false">
                        {{ t('bodyJsonSchemaFormat') }}
                      </el-alert>
                    </el-form-item>
                  </el-form>
                  <template #footer>
                    <el-button @click="showCustomHttpToolForm = false">{{ t('cancel') }}</el-button>
                    <el-button type="primary" @click="saveCustomHttpTool" :disabled="!newCustomHttpTool.name || !newCustomHttpTool.url">
                      {{ editingCustomHttpTool ? t('save') : t('createImmediately') }}
                    </el-button>
                  </template>
                </el-dialog>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 系统设置页面 -->
        <div v-show="activeMenu === 'system'" class="page tools-container">
          <el-form :model="systemSettings" class="settings-form" label-position="top">
            <div class="tool-item">
              <div class="tool-header">
                <span>
                  <el-icon>
                    <i class="fa-solid fa-language"></i>
                  </el-icon>
                  {{ t('systemLanguage') }}
                </span>
              </div>
              <div class="tool-content">
                <el-form-item class="form-item-align">
                  <el-select
                    v-model="systemSettings.language"
                    @change="handleSystemLanguageChange"
                    class="full-width-input">
                    <el-option
                      v-for="option in systemlanguageOptions"
                      :key="option.value"
                      :label="t(option.label)"
                      :value="option.value">
                    </el-option>
                  </el-select>
                </el-form-item>
              </div>
            </div>

            <div class="tool-item">
              <div class="tool-header">
                <span>
                  <el-icon>
                    <i class="fa-solid fa-language"></i>
                  </el-icon>
                  {{ t('targetLang') }}
                </span>
              </div>
              <div class="tool-content">
                <el-form-item class="form-item-align">
                  <el-select
                    v-model="targetLangSelected"
                    filterable
                    allow-create
                    default-first-option
                    :placeholder="t('targetLangPlaceholder')"
                    @change="changeLanguage"
                  >
                    <el-option :label="t('systemLanguage')" value="system"></el-option>
                    <el-option label="简体中文" value="简体中文"></el-option>
                    <el-option label="繁體中文" value="繁體中文"></el-option>
                    <el-option label="English" value="English"></el-option>
                    <el-option label="Français" value="Français"></el-option>
                    <el-option label="Язык" value="Язык"></el-option>
                    <el-option label="Deutsch" value="Deutsch"></el-option>
                    <el-option label="Español" value="Español"></el-option>
                    <el-option label="Portuguese" value="Portuguese"></el-option>
                    <el-option label="日本語" value="日本語"></el-option>
                    <el-option label="한국어" value="한국어"></el-option>
                  </el-select>
                </el-form-item>
              </div>
            </div>

            <div class="tool-item">
              <div class="tool-header">
                <span>
                  <el-icon>
                    <i class="fa-solid fa-brush"></i>
                  </el-icon>
                  {{ t('themeSettings') }}
                </span>
              </div>
              <div class="tool-content">
                <el-form-item class="form-item-align">
                  <el-select
                    v-model="systemSettings.theme"
                    @change="handleThemeChange"
                    class="full-width-input">
                    <el-option
                      v-for="option in themeOptions"
                      :key="option.value"
                      :label="option.label"
                      :value="option.value">
                    </el-option>
                  </el-select>
                </el-form-item>
              </div>
            </div>
            
            <div class="tool-item" v-if="isElectron">
              <div class="tool-header">
                <span>
                  <el-icon>
                    <i class="fa-solid fa-network-wired"></i>
                  </el-icon>
                  {{ t('networkSettings') }}
                </span>
              </div>
              <div class="tool-content">
                <el-form-item class="form-item-align">
                  <el-select
                    v-model="systemSettings.network"
                    @change="handleNetworkChange"
                    class="full-width-input">
                    <el-option
                      v-for="option in networkOptions"
                      :key="option.value"
                      :label="t(option.label)"
                      :value="option.value">
                    </el-option>
                  </el-select>
                </el-form-item>
              </div>
            </div>

            <div class="tool-item">
              <div class="tool-header">
                <span>
                  <el-icon>
                    <i class="fa-solid fa-wifi"></i>
                  </el-icon>
                  {{ t('proxySettings') }}
                </span>
              </div>
              <div class="tool-content">
                <el-form-item class="form-item-align">
                  <el-select v-model="systemSettings.proxyMode" placeholder="Select method" @change="updateProxy">
                    <el-option :label="t('systemProxy')" value="system"></el-option>
                    <el-option :label="t('manualProxy')" value="manual"></el-option>
                    <el-option :label="t('noneProxy')" value="none"></el-option>
                  </el-select>
                </el-form-item>
                <el-form-item class="form-item-align">
                  <el-input
                    v-model="systemSettings.proxy"
                    v-show="systemSettings.proxyMode === 'manual'"
                    :placeholder="t('proxyPlaceholder')"
                    class="full-width-input"
                    @input="updateProxy"
                  ></el-input>
                </el-form-item>
              </div>
              <el-alert
                type="info"
                :closable="false"
                class="mb-2"
              >
                <template #default>
                  <div class="alert-content">
                    {{ t('proxyNotice') }}
                  </div>
                </template>
              </el-alert>
            </div>
            <div class="tool-item" v-show="isElectron">
              <div class="browser-mode-btn-container">
                <el-button
                  class="browser-mode-btn"
                  type="primary"
                  @click="openUserfile"
                  round
                  size="large">
                  <span class="ml-2">
                    {{ t('openUserfile') }}
                  </span>
                </el-button>
              </div>
              <el-alert
                type="info"
                :closable="false"
                class="mb-2"
              >
                <template #default>
                  <div class="alert-content">
                    {{ t('userfileNotice') }}
                  </div>
                </template>
              </el-alert>
            </div>
          </el-form>
        </div>
        <!--eldialog 询问用户是否立即重启-->
        <el-dialog
          :title="t('restartConfirm')"
          v-model="showRestartDialog"
          width="600px">
          <span>{{ t('restartConfirmText') }}</span>
          <template #footer>
            <span class="dialog-footer">
              <el-button @click="showRestartDialog = false">{{ t('cancel') }}</el-button>
              <el-button type="primary" @click="restartApp">{{ t('confirmRestart') }}</el-button>
            </span>
          </template>
        </el-dialog>
        <!-- 在内容区添加存储空间界面 -->
        <div v-show="activeMenu === 'storage'" class="page storage-container">
          <div class="suite-layout">
            <!-- 左侧二级导航 -->
            <div class="suite-sidebar">
              <div class="tile-nav">
                <div 
                  v-for="tile in storageTiles" 
                  :key="tile.id"
                  class="nav-item"
                  :class="{ active: subMenu === tile.id }"
                  @click="subMenu = tile.id">
                  <el-icon class="nav-icon"><i :class="tile.icon"></i></el-icon>
                  <span class="nav-text">{{ t(tile.title) }}</span>
                </div>
              </div>
            </div>
            
            <!-- 右侧内容区 -->
            <div class="suite-content">
              <!-- 文本存储 -->
              <div v-show="subMenu === 'text'" class="page text-container">
                <!-- 顶部工具条 -->
                <div class="toolbar">
                  <el-checkbox
                    v-model="allChecked"
                    :indeterminate="indeterminate"
                    @change="toggleAll">
                    {{ t('selectAll') }}
                  </el-checkbox>
                  <el-button
                    type="danger"
                    :disabled="selectedFiles.length === 0"
                    @click="batchDeleteFiles">
                    <i class="fa-solid fa-trash"></i>
                    {{ t('batchDelete') }}
                  </el-button>
                </div>
                <div class="text-list">
                  <!-- 文件列表 -->
                  <div class="file-item" v-for="(file, index) in textFiles" :key="index">
                    <!-- 复选框 -->
                    <el-checkbox
                      v-model="selectedFiles"
                      :label="file.unique_filename"
                      style="margin-right: 10px;"
                      class="checkbox-no-label">  
                    </el-checkbox>
                    <div class="file-info">
                      <span class="file-name">{{ file.original_filename }}</span>
                    </div>
                    <div class="file-actions">
                      <!-- 复制链接按钮 -->
                      <el-button circle size="small" class="file-actions-btn" @click="copyLink(file.unique_filename)">
                        <i class="fa-solid fa-link"></i>
                      </el-button>
                      <!-- 下载按钮 -->
                      <el-button 
                        circle 
                        size="small" 
                        class="file-actions-btn"
                        @click="handleDownload(file)">
                        <i class="fa-solid fa-download"></i>
                      </el-button>
                      <!-- 删除按钮 -->
                      <el-button type="danger" circle size="small" class="file-actions-btn" @click="deleteFile(file)">
                        <i class="fa-solid fa-trash"></i>
                      </el-button>
                    </div>
                  </div>
                </div>
                <!-- 如果文件列表长度为0 -->
                <div v-if="textFiles.length === 0" class="no-files">
                  <el-empty :description="t('noFiles')" />
                </div>
              </div>
              <!-- 图片存储 -->
              <div v-show="subMenu === 'image'" class="page image-container">
                <!-- 新增顶部工具栏 -->
                <div class="toolbar">
                  <el-checkbox
                    v-model="allImagesChecked"
                    :indeterminate="indeterminateImages"
                    @change="toggleAllImages">
                    {{ t('selectAll') }}
                  </el-checkbox>
                  <el-button
                    type="danger"
                    :disabled="selectedImages.length === 0"
                    @click="batchDeleteImages">
                    <i class="fa-solid fa-trash"></i>
                    {{ t('batchDelete') }}
                  </el-button>
                </div>
                <div class="image-grid">
                  <div class="image-item" v-for="(img, index) in imageFiles" :key="index">
                    <img :src="`${partyURL}/uploaded_files/${img.unique_filename}`" @click="previewImage(img)" class="thumbnail"/>
                    <div class="image-overlay">
                      <!-- 复选框 -->
                      <el-checkbox
                        v-model="selectedImages"
                        :label="img.unique_filename"
                        class="checkbox-no-label">
                      </el-checkbox>
                      <div class="image-actions">
                        <!-- 复制链接按钮 -->
                        <el-button circle size="small" class="image-actions-btn" @click="copyLink(img.unique_filename)">
                          <i class="fa-solid fa-link"></i>
                        </el-button>
                        
                        <!-- 下载按钮 -->
                      <el-button 
                        circle 
                        size="small" 
                        class="image-actions-btn"
                        @click="handleDownload(img)">
                        <i class="fa-solid fa-download"></i>
                      </el-button>
                        
                        <el-button type="danger" class="image-actions-btn" circle size="small" @click="deleteImage(img)">
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>
                  </div>
                </div>
                <div v-if="imageFiles.length === 0" class="no-Images">
                  <el-empty :description="t('noImages')" />
                </div>
                <el-dialog
                  v-model="previewVisible"
                  :title="t('preview')"
                  class="image-preview-dialog"
                  width="600px">
                  <div class="preview-container">
                    <img 
                      :src="previewImageUrl" 
                      class="preview-image"
                      alt="Preview"
                    />
                  </div>
                </el-dialog>
              </div>
              <!-- 视频存储 -->
              <div v-show="subMenu === 'video'" class="page video-container">
                <!-- 新增顶部工具栏 -->
                <div class="toolbar">
                  <el-checkbox
                    v-model="allVideosChecked"
                    :indeterminate="indeterminateVideos"
                    @change="toggleAllVideos">
                    {{ t('selectAll') }}
                  </el-checkbox>
                  <el-button
                    type="danger"
                    :disabled="selectedVideos.length === 0"
                    @click="batchDeleteVideos">
                    <i class="fa-solid fa-trash"></i>
                    {{ t('batchDelete') }}
                  </el-button>
                </div>
                <div class="video-list">
                  <div class="video-item" v-for="(video, index) in videoFiles" :key="index">
                    <div class="video-wrapper">
                      <!-- 视频播放器 -->
                      <video controls>
                        <source :src="`${partyURL}/uploaded_files/${video.unique_filename}`" type="video/mp4">
                        Your browser does not support the video tag.
                      </video>
                      <!-- 复选框 -->
                      <el-checkbox
                        v-model="selectedVideos"
                        :label="video.unique_filename"
                        class="checkbox-no-label">
                      </el-checkbox>
                      <!-- 删除按钮定位在视频右上角 -->
                      <el-button class="delete-overlay-btn" type="danger" circle @click="deleteVideo(video)">
                        <i class="fa-solid fa-trash"></i>
                      </el-button>
                    </div>
                  </div>
                </div>
                <div v-if="videoFiles.length === 0" class="no-Videos">
                  <el-empty :description="t('noVideos')" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- logo页面 -->
        <div v-show="activeMenu === 'logo'" class="page logo-container">
          <div class="license-notice">
            <h1>Super Agent Party v0.3.8</h1>
            <h3>开源协议声明 / Open Source License</h3>
            <div class="notice-section">
              <p>❗ 注意！本项目是基于AGPL协议开源的，请遵守AGPL协议，以避免不必要的法律问题！</p>
              <p>❗ Attention! This project is open source based on the AGPL agreement, please abide by the AGPL agreement to avoid unnecessary legal problems!</p>
            </div>

            <div class="contact-section">
              <h3>联系我们 / Contact</h3>
              <div class="contact-card">
                <p>商业授权咨询：
                  <a href="mailto:hst97@qq.com" class="contact-link">hst97@qq.com</a>
                </p>
                <p>Commercial License：
                  <a href="mailto:hst97@qq.com" class="contact-link">hst97@qq.com</a>
                </p>
              </div>
            </div>

            <div class="social-links">
              <div class="link-item">
                <span>Official Website：</span>
                <a href="https://www.agentparty.top/" 
                  target="_blank" 
                  class="social-link">
                  www.agentparty.top
                </a>
              </div>

              <div class="link-item">
                <span>GitHub：</span>
                <a href="https://github.com/heshengtao/super-agent-party" 
                  target="_blank" 
                  class="social-link">
                  heshengtao/super-agent-party
                </a>
              </div>
              
              <div class="link-item">
                <span>Gitee：</span>
                <a href="https://gitee.com/heshengtao/super-agent-party" 
                  target="_blank" 
                  class="social-link">
                  heshengtao/super-agent-party
                </a>
              </div>

              <div class="link-item">
                <span>Bilibili：</span>
                <a href="https://space.bilibili.com/26978344" 
                  target="_blank" 
                  class="social-link">
                  @派酱llm-party
                </a>
              </div>

              <div class="link-item">
                <span>Youtube：</span>
                <a href="https://www.youtube.com/@agentParty" 
                  target="_blank" 
                  class="social-link">
                  @agentParty
                </a>
              </div>

              <div class="link-item">
                <span>discord：</span>
                <a href="https://discord.com/invite/f2dsAKKr2V" 
                  target="_blank" 
                  class="social-link">
                  @llm-party
                </a>
              </div>

              <div class="link-item">
                <span>QQ交流群：</span>
                <span class="qq-group">931057213</span>
              </div>

              <div class="link-item">
                <span>中文使用指南：</span>
                <a href="https://gcnij7egmcww.feishu.cn/wiki/DPRKwdetCiYBhPkPpXWcugujnRc" 
                  target="_blank" 
                  class="social-link">
                  点击访问
                </a>
              </div>

              <div class="link-item">
                <span>English Usage Guide：</span>
                <a href="https://temporal-lantern-7e8.notion.site/super-agent-party-211b2b2cb6f180c899d1c27a98c4965d" 
                  target="_blank" 
                  class="social-link">
                  Click to access
                </a>
              </div>
            </div>

            <div class="agreement-section">
              <p>{{t('agplNotice')}}
                <a href="https://www.gnu.org/licenses/agpl-3.0.html" 
                  target="_blank" 
                  class="agreement-link">
                  GNU Affero General Public License v3.0
                </a>
              </p>
              <p>{{t('thirdPartyNotice')}}
                <a href="https://github.com/heshengtao/super-agent-party/tree/main/LICENSE-third-party" class="agreement-link">LICENSE-third-party</a>
              </p>
            </div>
          </div>
        </div>
        <div v-show="activeMenu === 'deploy-bot'" class="page deploy-container">
            <div class="suite-layout">
                <!-- 左侧导航 -->
                <div class="suite-sidebar">
                    <div class="tile-nav">
                        <div 
                            v-for="tile in deployTiles" 
                            class="nav-item"
                            :class="{ active: subMenu === tile.id }"
                            @click="subMenu = tile.id">
                            <el-icon class="nav-icon"><i :class="tile.icon"></i></el-icon>
                            <span class="nav-text">{{ t(tile.title) }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧内容 -->
                <div class="suite-content">
                  <!-- 通用配置页面 -->
                  <div v-show="subMenu === 'bot_config'">
                    <el-form class="settings-form" :model="BotConfig" label-position="top">
                      <div class="tool-item">
                        <!-- 通用配置头部 -->
                        <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                          <span>
                            <el-icon><i class="fa-solid fa-robot"></i></el-icon>
                            {{ t('bot_config') }} <!-- 本地化文本 -->
                          </span>
                        </div>
                        <div class="tool-item">
                          <div class="tool-header">
                            <div class="header-left">
                              <span>
                                {{t('imgHost')}}
                              </span>
                            </div>
                            <el-switch v-model="BotConfig.imgHost_enabled" @click.stop @change="autoSaveSettings"/>
                          </div>
                          <div class="tool-content">
                            <!-- 图床/文件床配置 -->
                            <el-form-item :label="t('imgHostType')">
                              <template #label>
                                  <span>
                                    {{ t('imgHostType') }}
                                    <el-link
                                      v-if="BotConfig.imgHost === 'smms'"
                                      type="primary"
                                      :underline="false"
                                      href="https://sm.ms/" 
                                      target="_blank"
                                    >
                                      <el-icon class="mr-1">
                                        <i class="fa-solid fa-key"></i>
                                      </el-icon>{{ t('gotoAPI') }}
                                    </el-link>
                                    <el-link
                                      v-if="BotConfig.imgHost === 'easyImage2'"
                                      type="primary"
                                      :underline="false"
                                      href="https://github.com/icret/EasyImages2.0" 
                                      target="_blank"
                                    >
                                      <el-icon class="mr-1">
                                        <i class="fa-solid fa-key"></i>
                                      </el-icon>{{ t('gotoEasyImage2Github') }}
                                    </el-link>
                                  </span>
                              </template>
                              <el-select 
                                v-model="BotConfig.imgHost"
                                @change="changeImgHost">
                                <el-option
                                  v-for="option in imgHostOptions"
                                  :key="option.value"
                                  :label="option.label"
                                  :value="option.value"
                                >
                                </el-option>
                              </el-select>
                            </el-form-item>
                            <!--sm.ms图床-->
                            <el-form-item v-if="BotConfig.imgHost === 'smms'" :label="t('apiKey')">
                              <el-input
                                v-model="BotConfig.SMMS_api_key"
                                :placeholder="t('apiKeyPlaceholder')"
                                class="full-width-input"
                                show-password
                                @change="autoSaveSettings"
                              />
                            </el-form-item>
                            <!--easyimage2图床-->
                            <el-form-item v-if="BotConfig.imgHost === 'easyImage2'" :label="t('baseURL')">
                              <el-input
                                v-model="BotConfig.EI2_base_url"
                                placeholder="https://png.cm/api/index.php"
                                class="full-width-input"
                                @change="autoSaveSettings"
                              />
                            </el-form-item>
                            <el-form-item v-if="BotConfig.imgHost === 'easyImage2'"  :label="t('apiKey')">
                              <el-input
                                v-model="BotConfig.EI2_api_key"
                                :placeholder="t('apiKeyPlaceholder')"
                                class="full-width-input"
                                show-password
                                @change="autoSaveSettings"
                              />
                            </el-form-item>
                          </div>
                        </div>
                      </div>
                    </el-form>
                  </div>
                  <!-- QQ机器人配置页面 -->
                  <div v-show="subMenu === 'qq_bot'">
                    <el-form class="settings-form" :model="qqBotConfig" label-position="top">
                      <div class="tool-item">
                        <!-- QQ机器人配置头部 -->
                        <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                          <span>
                            <el-icon><i class="fa-brands fa-qq"></i></el-icon>
                            {{ t('qq_bot_config') }}
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://q.qq.com/" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('gotoQQbot') }}
                            </el-link>
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://q.qq.com/#/news/detail?id=1376238e8e2fbbc036676bb09d2f37da" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-file"></i>
                              </el-icon>{{ t('QQbotNotice') }}
                            </el-link>
                          </span>
                          <div>
                            <!-- 启动按钮 -->
                            <el-tooltip :content="t('start_bot')" placement="top">
                              <el-button 
                                type="primary" 
                                @click="startQQBot" 
                                :disabled="!isQQBotConfigValid || isQQBotRunning || isStarting"
                                circle
                              >
                                <template v-if="isStarting">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-play"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                            
                            <!-- 停止按钮 -->
                            <el-tooltip :content="t('stop_bot')" placement="top">
                              <el-button 
                                type="danger" 
                                @click="stopQQBot" 
                                :disabled="!isQQBotRunning || isStopping"
                                circle
                              >
                                <template v-if="isStopping">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-stop"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                            
                            <!-- 重载按钮 -->
                            <el-tooltip :content="t('reload_bot')" placement="top">
                              <el-button 
                                @click="reloadQQBotConfig" 
                                :disabled="!isQQBotRunning || isReloading"
                                circle
                              >
                                <template v-if="isReloading">
                                  <i class="fa-solid fa-rotate fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-rotate"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                          </div>
                        </div>
                        <div class="tool-content">
                            <!-- 主智能体选择 -->
                            <el-form-item :label="t('mainAgent')" required>
                              <el-select 
                                v-model="qqBotConfig.QQAgent"
                                @change="changeQQAgent">
                                <el-option
                                  :label="t('defaultAgent')"
                                  value="super-model"
                                >
                                </el-option>
                                <el-option
                                  v-for="(agent, id) in agents"
                                  :key="id"
                                  :label="agent.name"
                                  :value="id"
                                >
                                </el-option>
                              </el-select>
                            </el-form-item>
                            <el-alert
                              type="info"
                              :closable="false"
                              class="mb-2"
                            >
                              <template #default>
                                <div class="alert-content">
                                  {{ t('goToMainAgentNotice1') }}
                                  <el-link
                                    type="primary"
                                    :underline="false"
                                    class="font-medium"
                                    @click="switchToMainAgent"
                                  >
                                    <el-icon class="mr-1">
                                      <i class="fa-solid fa-key"></i>
                                    </el-icon>{{ t('MainAgentInterface') }}
                                  </el-link>
                                </div>
                              </template>
                            </el-alert>
                            <!-- 角色卡选择 -->
                            <el-form-item :label="t('memoryEnable')" class="form-item-align" label-position="left">
                              <el-switch 
                              v-model="memorySettings.is_memory" 
                              @click.stop @change="changeMemory" 
                              ></el-switch>
                            </el-form-item>
                            <el-form-item :label="t('selectMemory')">
                              <el-select 
                                v-model="memorySettings.selectedMemory" 
                                :placeholder="t('selectMemoryPlaceholder')"
                                class="full-width-input"
                                @change ="changeMemory"
                                >
                                <el-option
                                  v-for="memory in memories"
                                  :key="memory.id"
                                  :label="memory.name"
                                  :value="memory.id"
                                />
                              </el-select>
                            </el-form-item>
                            <el-alert
                              type="info"
                              :closable="false"
                              class="mb-2"
                            >
                              <template #default>
                                <div class="alert-content">
                                  {{ t('goToMemoryNotice1') }}
                                  <el-link
                                    type="primary"
                                    :underline="false"
                                    class="font-medium"
                                    @click="switchToMemory"
                                  >
                                    <el-icon class="mr-1">
                                      <i class="fa-solid fa-key"></i>
                                    </el-icon>{{ t('memoryInterface') }}
                                  </el-link>
                                </div>
                              </template>
                            </el-alert>
                            <el-form-item :label="t('separators')">
                              <el-select
                                v-model="qqBotConfig.separators"
                                multiple
                                filterable
                                allow-create
                                @keyup.enter.native="handleEnter"
                                @create="handleCreateSeparator"
                                @change="autoSaveSettings"
                              >
                                <el-option
                                  v-for="sep in filteredSeparators"
                                  :key="sep.value"
                                  :label="sep.label"
                                  :value="sep.value"
                                />
                              </el-select>
                            </el-form-item>
                            <el-form-item :label="t('conversationRounds')" class="form-item-align">
                              <el-slider
                                v-model="qqBotConfig.memoryLimit"
                                :min="0"
                                :max="1000"
                                :step="2"
                                show-input
                                @input="autoSaveSettings"
                              />
                            </el-form-item>
                            <el-form-item :label="t('reasoningVisibleEnable')" class="form-item-align" label-position="left">
                              <el-switch
                                v-model="qqBotConfig.reasoningVisible"
                                @change="autoSaveSettings"
                              ></el-switch>
                            </el-form-item>
                            <el-form-item :label="t('is_sandbox')" class="form-item-align" label-position="left">
                              <el-switch
                                v-model="qqBotConfig.is_sandbox"
                                @change="autoSaveSettings"
                              ></el-switch>
                            </el-form-item>
                            <el-form-item :label="t('quickRestartEnable')" class="form-item-align" label-position="left">
                              <el-switch
                                v-model="qqBotConfig.quickRestart"
                                @change="autoSaveSettings"
                              ></el-switch>
                            </el-form-item>
                            <el-form-item label="APP ID" required>
                                <el-input @change="autoSaveSettings" v-model="qqBotConfig.appid" :placeholder="t('enter_qq_bot_app_id')" class="full-width-input"></el-input>
                            </el-form-item>
                            <el-form-item label="APP Secret" required>
                                <el-input @change="autoSaveSettings" v-model="qqBotConfig.secret" :placeholder="t('enter_qq_bot_secret')" show-password class="full-width-input"></el-input>
                            </el-form-item>
                        </div>
                      </div>
                    </el-form>
                  </div>

                  <!-- 飞书机器人配置页面 -->
                  <div v-show="subMenu === 'feishu_bot'">
                    <el-form class="settings-form" :model="feishuBotConfig" label-position="top">
                      <div class="tool-item">
                        <!-- 飞书机器人配置头部 -->
                        <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                          <span>
                            <el-icon><i class="fa-solid fa-paper-plane"></i></el-icon>
                            {{ t('feishu_bot_config') }}
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://open.feishu.cn/app"
                              target="_blank"
                            >
                              <el-icon class="mr-1"><i class="fa-solid fa-key"></i></el-icon>
                              {{ t('gotoFeishuBot') }}
                            </el-link>
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://open.feishu.cn/document/develop-an-echo-bot/introduction?from=op_develop_app"
                              target="_blank"
                            >
                              <el-icon class="mr-1"><i class="fa-solid fa-file"></i></el-icon>
                              {{ t('feishuBotNotice') }}
                            </el-link>
                          </span>

                          <!-- 按钮组 -->
                          <div>
                            <el-tooltip :content="t('start_bot')" placement="top">
                              <el-button
                                type="primary"
                                @click="startFeishuBot"
                                :disabled="!isfeishuBotConfigValid || isFeishuBotRunning || isFeishuStarting"
                                circle
                              >
                                <template v-if="isFeishuStarting">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-play"></i>
                                </template>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('stop_bot')" placement="top">
                              <el-button
                                type="danger"
                                @click="stopFeishuBot"
                                :disabled="!isFeishuBotRunning || isFeishuStopping"
                                circle
                              >
                                <template v-if="isFeishuStopping">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-stop"></i>
                                </template>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('reload_bot')" placement="top">
                              <el-button
                                @click="reloadfeishuBotConfig"
                                :disabled="!isFeishuBotRunning || isFeishuReloading"
                                circle
                              >
                                <template v-if="isFeishuReloading">
                                  <i class="fa-solid fa-rotate fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-rotate"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                          </div>
                        </div>

                        <!-- 表单内容 -->
                        <div class="tool-content">
                          <!-- 主智能体 -->
                          <el-form-item :label="t('mainAgent')" required>
                            <el-select v-model="feishuBotConfig.FeishuAgent" @change="autoSaveSettings">
                              <el-option :label="t('defaultAgent')" value="super-model" />
                              <el-option
                                v-for="(agent, id) in agents"
                                :key="id"
                                :label="agent.name"
                                :value="id"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 角色卡 / 记忆 -->
                          <el-form-item :label="t('memoryEnable')" class="form-item-align" label-position="left">
                            <el-switch
                              v-model="memorySettings.is_memory"
                              @change="changeMemory"
                            ></el-switch>
                          </el-form-item>
                          <el-form-item :label="t('selectMemory')">
                            <el-select
                              v-model="memorySettings.selectedMemory"
                              :placeholder="t('selectMemoryPlaceholder')"
                              class="full-width-input"
                              @change="changeMemory"
                            >
                              <el-option
                                v-for="mem in memories"
                                :key="mem.id"
                                :label="mem.name"
                                :value="mem.id"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 分隔符 -->
                          <el-form-item :label="t('separators')">
                            <el-select
                              v-model="feishuBotConfig.separators"
                              multiple
                              filterable
                              allow-create
                              @create="handleCreateFeishuSeparator"
                              @change="autoSaveSettings"
                            >
                              <el-option
                                v-for="sep in filteredFeishuSeparators"
                                :key="sep.value"
                                :label="sep.label"
                                :value="sep.value"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 记忆轮数 -->
                          <el-form-item :label="t('conversationRounds')" class="form-item-align">
                            <el-slider
                              v-model="feishuBotConfig.memoryLimit"
                              :min="0"
                              :max="1000"
                              :step="2"
                              show-input
                              @input="autoSaveSettings"
                            />
                          </el-form-item>

                          <!-- 推理显示 -->
                          <el-form-item :label="t('reasoningVisibleEnable')" class="form-item-align" label-position="left">
                            <el-switch
                              v-model="feishuBotConfig.reasoningVisible"
                              @change="autoSaveSettings"
                            ></el-switch>
                          </el-form-item>

                          <!-- 快速重启 -->
                          <el-form-item :label="t('quickRestartEnable')" class="form-item-align" label-position="left">
                            <el-switch
                              v-model="feishuBotConfig.quickRestart"
                              @change="autoSaveSettings"
                            ></el-switch>
                          </el-form-item>

                          <!-- 启用TTS -->
                          <el-form-item :label="t('enableTTS')" class="form-item-align" label-position="left">
                            <el-switch
                              v-model="feishuBotConfig.enableTTS"
                              @change="autoSaveSettings"
                            ></el-switch>
                          </el-form-item>

                          <el-form-item :label="t('wakeWord')">
                            <el-input
                              v-model="feishuBotConfig.wakeWord"
                              :placeholder="t('botWakeWordPlaceholder')"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>

                          <el-form-item :label="t('behaviorTargetChatIds')">
                            <template #label>
                              <div style="display: flex; align-items: center; gap: 5px;">
                                <span>{{ t('behaviorTargetChatIds') }}</span>
                              </div>
                            </template>
                            <el-select
                              v-model="feishuBotConfig.behaviorTargetChatIds"
                              multiple
                              filterable
                              allow-create
                              default-first-option
                              :placeholder="t('enterChatIdPlaceholder')"
                              class="full-width-input"
                              @change="autoSaveSettings();"
                            >
                              <!-- 这里通常为空，用户通过输入并回车来创建新的 ID -->
                            </el-select>
                          </el-form-item>

                          <!-- APP 凭证 -->
                          <el-form-item label="APP ID" required>
                            <el-input
                              v-model="feishuBotConfig.appid"
                              :placeholder="t('enter_feishu_bot_app_id')"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>
                          <el-form-item label="APP Secret" required>
                            <el-input
                              v-model="feishuBotConfig.secret"
                              :placeholder="t('enter_feishu_bot_secret')"
                              show-password
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>
                        </div>
                      </div>
                    </el-form>
                  </div>

                  <!-- 钉钉机器人配置页面 -->
                  <div v-show="subMenu === 'dingtalk_bot'">
                    <el-form class="settings-form" :model="dingtalkBotConfig" label-position="top">
                      <div class="tool-item">
                        <!-- 钉钉机器人配置头部 -->
                        <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                          <span>
                            <el-icon><i class="fa-solid fa-bolt"></i></el-icon>
                            {{ t('dingtalk_bot_config') }}
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://open-dev.dingtalk.com/fe/app"
                              target="_blank"
                            >
                              <el-icon class="mr-1"><i class="fa-solid fa-key"></i></el-icon>
                              {{ t('gotoDingtalkBot') }}
                            </el-link>
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://open.dingtalk.com/document/orgapp/stream-mode"
                              target="_blank"
                            >
                              <el-icon class="mr-1"><i class="fa-solid fa-file"></i></el-icon>
                              {{ t('dingtalkBotNotice') }}
                            </el-link>
                          </span>

                          <!-- 按钮组 (启动/停止/重载) -->
                          <div>
                            <el-tooltip :content="t('start_bot')" placement="top">
                              <el-button
                                type="primary"
                                @click="startDingtalkBot"
                                :disabled="!isdingtalkBotConfigValid || isDingtalkBotRunning || isDingtalkStarting"
                                circle
                              >
                                <i v-if="isDingtalkStarting" class="fa-solid fa-spinner fa-spin"></i>
                                <i v-else class="fa-solid fa-play"></i>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('stop_bot')" placement="top">
                              <el-button
                                type="danger"
                                @click="stopDingtalkBot"
                                :disabled="!isDingtalkBotRunning || isDingtalkStopping"
                                circle
                              >
                                <i v-if="isDingtalkStopping" class="fa-solid fa-spinner fa-spin"></i>
                                <i v-else class="fa-solid fa-stop"></i>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('reload_bot')" placement="top">
                              <el-button
                                @click="reloadDingtalkBot"
                                :disabled="!isDingtalkBotRunning || isDingtalkReloading"
                                circle
                              >
                                <i v-if="isDingtalkReloading" class="fa-solid fa-rotate fa-spin"></i>
                                <i v-else class="fa-solid fa-rotate"></i>
                              </el-button>
                            </el-tooltip>
                          </div>
                        </div>

                        <!-- 表单内容 -->
                        <div class="tool-content">
                          <!-- 主智能体选择 -->
                          <el-form-item :label="t('mainAgent')" required>
                            <el-select v-model="dingtalkBotConfig.DingtalkAgent" @change="autoSaveSettings">
                              <el-option :label="t('defaultAgent')" value="super-model" />
                              <el-option
                                v-for="(agent, id) in agents"
                                :key="id"
                                :label="agent.name"
                                :value="id"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 角色卡 / 记忆 -->
                          <el-form-item :label="t('memoryEnable')" class="form-item-align" label-position="left">
                            <el-switch v-model="memorySettings.is_memory" @change="changeMemory"></el-switch>
                          </el-form-item>
                          
                          <el-form-item :label="t('selectMemory')">
                            <el-select
                              v-model="memorySettings.selectedMemory"
                              :placeholder="t('selectMemoryPlaceholder')"
                              class="full-width-input"
                              @change="changeMemory"
                            >
                              <el-option v-for="mem in memories" :key="mem.id" :label="mem.name" :value="mem.id" />
                            </el-select>
                          </el-form-item>

                          <!-- 分隔符 (钉钉由于不支持流式原地更新，分隔符尤为重要) -->
                          <el-form-item :label="t('separators')">
                            <el-select
                              v-model="dingtalkBotConfig.separators"
                              multiple
                              filterable
                              allow-create
                              @create="handleCreateDingtalkSeparator"
                              @change="autoSaveSettings"
                            >
                              <el-option
                                v-for="sep in filteredDingtalkSeparators"
                                :key="sep.value"
                                :label="sep.label"
                                :value="sep.value"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 记忆轮数 -->
                          <el-form-item :label="t('conversationRounds')" class="form-item-align">
                            <el-slider
                              v-model="dingtalkBotConfig.memoryLimit"
                              :min="0" :max="1000" :step="2"
                              show-input
                              @input="autoSaveSettings"
                            />
                          </el-form-item>

                          <!-- 功能开关 -->
                          <el-form-item :label="t('reasoningVisibleEnable')" class="form-item-align" label-position="left">
                            <el-switch v-model="dingtalkBotConfig.reasoningVisible" @change="autoSaveSettings"></el-switch>
                          </el-form-item>

                          <el-form-item :label="t('quickRestartEnable')" class="form-item-align" label-position="left">
                            <el-switch v-model="dingtalkBotConfig.quickRestart" @change="autoSaveSettings"></el-switch>
                          </el-form-item>


                          <el-form-item :label="t('wakeWord')">
                            <el-input
                              v-model="dingtalkBotConfig.wakeWord"
                              :placeholder="t('botWakeWordPlaceholder')"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>

                          <el-form-item :label="t('behaviorTargetChatIds')">
                            <template #label>
                              <div style="display: flex; align-items: center; gap: 5px;">
                                <span>{{ t('behaviorTargetChatIds') }}</span>
                              </div>
                            </template>
                            <el-select
                              v-model="dingtalkBotConfig.behaviorTargetChatIds"
                              multiple
                              filterable
                              allow-create
                              default-first-option
                              :placeholder="t('enterChatIdPlaceholder')"
                              class="full-width-input"
                              @change="autoSaveSettings();"
                            >
                              <!-- 这里通常为空，用户通过输入并回车来创建新的 ID -->
                            </el-select>
                          </el-form-item>

                          <!-- 钉钉凭证 (对应飞书 appid/secret) -->
                          <el-form-item label="AppKey" required>
                            <el-input
                              v-model="dingtalkBotConfig.appKey"
                              :placeholder="t('enter_dingtalk_bot_app_key')"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>
                          
                          <el-form-item label="AppSecret" required>
                            <el-input
                              v-model="dingtalkBotConfig.appSecret"
                              :placeholder="t('enter_dingtalk_bot_app_secret')"
                              show-password
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>
                        </div>
                      </div>
                    </el-form>
                  </div>

                  <!-- Telegram 机器人配置页面 -->
                  <div v-show="subMenu === 'telegram_bot'">
                    <el-form class="settings-form" :model="telegramBotConfig" label-position="top">
                      <div class="tool-item">
                        <!-- 头部 -->
                        <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                          <span>
                            <el-icon><i class="fa-solid fa-paper-plane"></i></el-icon>
                            {{ t('telegram_bot_config') }}
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://t.me/BotFather"
                              target="_blank"
                            >
                              <el-icon class="mr-1"><i class="fa-solid fa-key"></i></el-icon>
                              {{ t('gotoTelegramBot') }}
                            </el-link>
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://core.telegram.org/bots/api"
                              target="_blank"
                            >
                              <el-icon class="mr-1"><i class="fa-solid fa-file"></i></el-icon>
                              {{ t('telegramBotNotice') }}
                            </el-link>
                          </span>

                          <!-- 按钮组 -->
                          <div>
                            <el-tooltip :content="t('start_bot')" placement="top">
                              <el-button
                                type="primary"
                                @click="startTelegramBot"
                                :disabled="!isTelegramBotConfigValid || isTelegramBotRunning || isTelegramStarting"
                                circle
                              >
                                <template v-if="isTelegramStarting">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-play"></i>
                                </template>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('stop_bot')" placement="top">
                              <el-button
                                type="danger"
                                @click="stopTelegramBot"
                                :disabled="!isTelegramBotRunning || isTelegramStopping"
                                circle
                              >
                                <template v-if="isTelegramStopping">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-stop"></i>
                                </template>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('reload_bot')" placement="top">
                              <el-button
                                @click="reloadTelegramBotConfig"
                                :disabled="!isTelegramBotRunning || isTelegramReloading"
                                circle
                              >
                                <template v-if="isTelegramReloading">
                                  <i class="fa-solid fa-rotate fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-rotate"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                          </div>
                        </div>

                        <!-- 表单 -->
                        <div class="tool-content">
                          <!-- 主智能体 -->
                          <el-form-item :label="t('mainAgent')" required>
                            <el-select v-model="telegramBotConfig.TelegramAgent" @change="autoSaveSettings">
                              <el-option :label="t('defaultAgent')" value="super-model" />
                              <el-option
                                v-for="(agent, id) in agents"
                                :key="id"
                                :label="agent.name"
                                :value="id"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 角色卡 / 记忆 -->
                          <el-form-item :label="t('memoryEnable')" class="form-item-align" label-position="left">
                            <el-switch
                              v-model="memorySettings.is_memory"
                              @change="changeMemory"
                            ></el-switch>
                          </el-form-item>
                          <el-form-item :label="t('selectMemory')">
                            <el-select
                              v-model="memorySettings.selectedMemory"
                              :placeholder="t('selectMemoryPlaceholder')"
                              class="full-width-input"
                              @change="changeMemory"
                            >
                              <el-option
                                v-for="mem in memories"
                                :key="mem.id"
                                :label="mem.name"
                                :value="mem.id"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 分隔符 -->
                          <el-form-item :label="t('separators')">
                            <el-select
                              v-model="telegramBotConfig.separators"
                              multiple
                              filterable
                              allow-create
                              @create="handleCreateTelegramSeparator"
                              @change="autoSaveSettings"
                            >
                              <el-option
                                v-for="sep in filteredTelegramSeparators"
                                :key="sep.value"
                                :label="sep.label"
                                :value="sep.value"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 记忆轮数 -->
                          <el-form-item :label="t('conversationRounds')" class="form-item-align">
                            <el-slider
                              v-model="telegramBotConfig.memoryLimit"
                              :min="0"
                              :max="1000"
                              :step="2"
                              show-input
                              @input="autoSaveSettings"
                            />
                          </el-form-item>

                          <!-- 推理显示 -->
                          <el-form-item :label="t('reasoningVisibleEnable')" class="form-item-align" label-position="left">
                            <el-switch
                              v-model="telegramBotConfig.reasoningVisible"
                              @change="autoSaveSettings"
                            ></el-switch>
                          </el-form-item>

                          <!-- 快速重启 -->
                          <el-form-item :label="t('quickRestartEnable')" class="form-item-align" label-position="left">
                            <el-switch
                              v-model="telegramBotConfig.quickRestart"
                              @change="autoSaveSettings"
                            ></el-switch>
                          </el-form-item>

                          <!-- 启用 TTS -->
                          <el-form-item :label="t('enableTTS')" class="form-item-align" label-position="left">
                            <el-switch
                              v-model="telegramBotConfig.enableTTS"
                              @change="autoSaveSettings"
                            ></el-switch>
                          </el-form-item>

                          <el-form-item :label="t('wakeWord')">
                            <el-input
                              v-model="telegramBotConfig.wakeWord"
                              :placeholder="t('botWakeWordPlaceholder')"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>

                          <!-- Bot Token -->
                          <el-form-item label="Bot Token" required>
                            <el-input
                              v-model="telegramBotConfig.bot_token"
                              :placeholder="t('enterTelegramBotToken')"
                              show-password
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>
                        </div>
                      </div>
                    </el-form>
                  </div>

                  <!-- Discord 机器人配置页面 -->
                  <div v-show="subMenu === 'discord_bot'">
                    <el-form class="settings-form" :model="discordBotConfig" label-position="top">
                      <div class="tool-item">
                        <!-- 头部 -->
                        <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                          <span>
                            <el-icon><i class="fa-brands fa-discord"></i></el-icon>
                            {{ t('discord_bot_config') }}
                            <el-link type="primary" :underline="false" href="https://discord.com/developers/applications" target="_blank">
                              <el-icon class="mr-1"><i class="fa-solid fa-key"></i></el-icon>
                              {{ t('gotoDiscordBot') }}
                            </el-link>
                            <el-link type="primary" :underline="false" href="https://discord.com/developers/docs/intro" target="_blank">
                              <el-icon class="mr-1"><i class="fa-solid fa-file"></i></el-icon>
                              {{ t('discordBotNotice') }}
                            </el-link>
                          </span>

                          <!-- 按钮组 -->
                          <div>
                            <el-tooltip :content="t('start_bot')" placement="top">
                              <el-button
                                type="primary"
                                @click="startDiscordBot"
                                :disabled="!isDiscordBotConfigValid || isDiscordBotRunning || isDiscordStarting"
                                circle
                              >
                                <template v-if="isDiscordStarting">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-play"></i>
                                </template>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('stop_bot')" placement="top">
                              <el-button
                                type="danger"
                                @click="stopDiscordBot"
                                :disabled="!isDiscordBotRunning || isDiscordStopping"
                                circle
                              >
                                <template v-if="isDiscordStopping">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-stop"></i>
                                </template>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('reload_bot')" placement="top">
                              <el-button
                                @click="reloadDiscordBot"
                                :disabled="!isDiscordBotRunning || isDiscordReloading"
                                circle
                              >
                                <template v-if="isDiscordReloading">
                                  <i class="fa-solid fa-rotate fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-rotate"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                          </div>
                        </div>

                        <!-- 表单 -->
                        <div class="tool-content">
                          <!-- 主智能体 -->
                          <el-form-item :label="t('mainAgent')" required>
                            <el-select v-model="discordBotConfig.llm_model" @change="autoSaveSettings">
                              <el-option :label="t('defaultAgent')" value="super-model" />
                              <el-option
                                v-for="(agent, id) in agents"
                                :key="id"
                                :label="agent.name"
                                :value="id"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 记忆 -->
                          <el-form-item :label="t('memoryEnable')" class="form-item-align" label-position="left">
                            <el-switch v-model="memorySettings.is_memory" @change="changeMemory"></el-switch>
                          </el-form-item>
                          <el-form-item :label="t('selectMemory')">
                            <el-select
                              v-model="memorySettings.selectedMemory"
                              :placeholder="t('selectMemoryPlaceholder')"
                              class="full-width-input"
                              @change="changeMemory"
                            >
                              <el-option
                                v-for="mem in memories"
                                :key="mem.id"
                                :label="mem.name"
                                :value="mem.id"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 分隔符 -->
                          <el-form-item :label="t('separators')">
                            <el-select
                              v-model="discordBotConfig.separators"
                              multiple
                              filterable
                              allow-create
                              @create="handleCreateDiscordSeparator"
                              @change="autoSaveSettings"
                            >
                              <el-option
                                v-for="sep in filteredDiscordSeparators"
                                :key="sep.value"
                                :label="sep.label"
                                :value="sep.value"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 记忆轮数 -->
                          <el-form-item :label="t('conversationRounds')" class="form-item-align">
                            <el-slider
                              v-model="discordBotConfig.memory_limit"
                              :min="0"
                              :max="1000"
                              :step="2"
                              show-input
                              @input="autoSaveSettings"
                            />
                          </el-form-item>

                          <!-- 推理显示 -->
                          <el-form-item :label="t('reasoningVisibleEnable')" class="form-item-align" label-position="left">
                            <el-switch v-model="discordBotConfig.reasoning_visible" @change="autoSaveSettings"></el-switch>
                          </el-form-item>

                          <!-- 快速重启 -->
                          <el-form-item :label="t('quickRestartEnable')" class="form-item-align" label-position="left">
                            <el-switch v-model="discordBotConfig.quick_restart" @change="autoSaveSettings"></el-switch>
                          </el-form-item>

                          <!-- 启用 TTS -->
                          <el-form-item :label="t('enableTTS')" class="form-item-align" label-position="left">
                            <el-switch v-model="discordBotConfig.enable_tts" @change="autoSaveSettings"></el-switch>
                          </el-form-item>

                          <el-form-item :label="t('wakeWord')">
                            <el-input
                              v-model="discordBotConfig.wakeWord"
                              :placeholder="t('botWakeWordPlaceholder')"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>

                          <!-- Bot Token -->
                          <el-form-item label="Bot Token" required>
                            <el-input
                              v-model="discordBotConfig.token"
                              show-password
                              :placeholder="t('enterDiscordBotToken')"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>
                        </div>
                      </div>
                    </el-form>
                  </div>


                  <!-- Slack 机器人配置页面 -->
                  <div v-show="subMenu === 'slack_bot'">
                    <el-form class="settings-form" :model="slackBotConfig" label-position="top">
                      <div class="tool-item">
                        <!-- 头部 -->
                        <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                          <span>
                            <el-icon><i class="fa-brands fa-slack"></i></el-icon>
                            {{ t('slack_bot_config') || 'Slack 机器人配置' }}
                            <el-link type="primary" :underline="false" href="https://api.slack.com/apps" target="_blank">
                              <el-icon class="mr-1"><i class="fa-solid fa-key"></i></el-icon>
                              {{ t('gotoSlackBot') || '前往 Slack App 控制台' }}
                            </el-link>
                          </span>

                          <!-- 按钮组 -->
                          <div>
                            <el-tooltip :content="t('start_bot')" placement="top">
                              <el-button
                                type="primary"
                                @click="startSlackBot"
                                :disabled="!isSlackBotConfigValid || isSlackBotRunning || isSlackStarting"
                                circle
                              >
                                <template v-if="isSlackStarting">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-play"></i>
                                </template>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('stop_bot')" placement="top">
                              <el-button
                                type="danger"
                                @click="stopSlackBot"
                                :disabled="!isSlackBotRunning || isSlackStopping"
                                circle
                              >
                                <template v-if="isSlackStopping">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-stop"></i>
                                </template>
                              </el-button>
                            </el-tooltip>

                            <el-tooltip :content="t('reload_bot')" placement="top">
                              <el-button
                                @click="reloadSlackBot"
                                :disabled="!isSlackBotRunning || isSlackReloading"
                                circle
                              >
                                <template v-if="isSlackReloading">
                                  <i class="fa-solid fa-rotate fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-rotate"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                          </div>
                        </div>

                        <!-- 表单 -->
                        <div class="tool-content">
                          <!-- 主智能体 -->
                          <el-form-item :label="t('mainAgent')" required>
                            <el-select v-model="slackBotConfig.llm_model" @change="autoSaveSettings">
                              <el-option :label="t('defaultAgent')" value="super-model" />
                              <el-option
                                v-for="(agent, id) in agents"
                                :key="id"
                                :label="agent.name"
                                :value="id"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 记忆 (这里和 Discord 一样，直接绑定 memorySettings) -->
                          <el-form-item :label="t('memoryEnable')" class="form-item-align" label-position="left">
                            <el-switch v-model="memorySettings.is_memory" @change="changeMemory"></el-switch>
                          </el-form-item>
                          <el-form-item :label="t('selectMemory')">
                            <el-select
                              v-model="memorySettings.selectedMemory"
                              :placeholder="t('selectMemoryPlaceholder')"
                              class="full-width-input"
                              @change="changeMemory"
                            >
                              <el-option
                                v-for="mem in memories"
                                :key="mem.id"
                                :label="mem.name"
                                :value="mem.id"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 分隔符 -->
                          <el-form-item :label="t('separators')">
                            <el-select
                              v-model="slackBotConfig.separators"
                              multiple
                              filterable
                              allow-create
                              @create="handleCreateSlackSeparator"
                              @change="autoSaveSettings"
                            >
                              <el-option
                                v-for="sep in filteredSlackSeparators"
                                :key="sep.value"
                                :label="sep.label"
                                :value="sep.value"
                              />
                            </el-select>
                          </el-form-item>

                          <!-- 记忆轮数 -->
                          <el-form-item :label="t('conversationRounds')" class="form-item-align">
                            <el-slider
                              v-model="slackBotConfig.memory_limit"
                              :min="0"
                              :max="1000"
                              :step="2"
                              show-input
                              @input="autoSaveSettings"
                            />
                          </el-form-item>

                          <!-- 推理显示 -->
                          <el-form-item :label="t('reasoningVisibleEnable')" class="form-item-align" label-position="left">
                            <el-switch v-model="slackBotConfig.reasoning_visible" @change="autoSaveSettings"></el-switch>
                          </el-form-item>

                          <!-- 快速重启 -->
                          <el-form-item :label="t('quickRestartEnable')" class="form-item-align" label-position="left">
                            <el-switch v-model="slackBotConfig.quick_restart" @change="autoSaveSettings"></el-switch>
                          </el-form-item>

                          <!-- 启用 TTS -->
                          <el-form-item :label="t('enableTTS')" class="form-item-align" label-position="left">
                            <el-switch v-model="slackBotConfig.enable_tts" @change="autoSaveSettings"></el-switch>
                          </el-form-item>

                          <el-form-item :label="t('wakeWord')">
                            <el-input
                              v-model="slackBotConfig.wakeWord"
                              :placeholder="t('botWakeWordPlaceholder')"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>

                          <!-- Bot Token (Slack 需要两个) -->
                          <el-form-item label="Bot User OAuth Token (xoxb-...)" required>
                            <el-input
                              v-model="slackBotConfig.bot_token"
                              show-password
                              placeholder="xoxb-xxxxxxxxxxxx"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>

                          <el-form-item label="App-Level Token (xapp-...)" required>
                            <el-input
                              v-model="slackBotConfig.app_token"
                              show-password
                              placeholder="xapp-1-xxxxxxxxxxxx"
                              class="full-width-input"
                              @change="autoSaveSettings"
                            />
                          </el-form-item>
                        </div>
                      </div>
                    </el-form>
                  </div>

                  <!-- 翻译机器人 -->
                  <div v-show="subMenu === 'translate_bot'" class="page translate-container">
                    <el-form class="settings-form" label-position="top">
                      <div class="tool-item">

                        <!-- 头部 -->
                        <div class="tool-header">
                          <span>
                            <el-icon><i class="fa-solid fa-language"></i></el-icon>
                            {{ t('translateBot') }}
                          </span>

                          <div class="header-buttons">
                            <!-- 复制 -->
                            <el-tooltip :content="t('copy')" placement="top">
                              <el-button circle @click="copyTranslated">
                                <i class="fa-solid fa-copy"></i>
                              </el-button>
                            </el-tooltip>

                            <!-- 翻译 -->
                            <el-tooltip :content="t('translate')" placement="top">
                              <el-button
                                type="primary"
                                circle
                                :disabled="!sourceText.trim() || isTranslating"
                                @click="handleTranslate"
                              >
                                <i v-if="isTranslating" class="fa-solid fa-spinner fa-spin"></i>
                                <i v-else class="fa-solid fa-play"></i>
                              </el-button>
                            </el-tooltip>

                            <!-- 停止 -->
                            <el-tooltip :content="t('stop')" placement="top">
                              <el-button
                                type="danger"
                                circle
                                :disabled="!isTranslating"
                                @click="abortTranslate"
                              >
                                <i class="fa-solid fa-stop"></i>
                              </el-button>
                            </el-tooltip>

                            <!-- 清空 -->
                            <el-tooltip :content="t('clear')" placement="top">
                              <el-button type="danger" circle @click="clearAll">
                                <i class="fa-solid fa-broom"></i>
                              </el-button>
                            </el-tooltip>
                          </div>
                        </div>

                        <!-- 目标语言 -->
                        <el-form-item :label="t('targetLang')" style="margin-bottom:12px;" label-position="left">
                          <el-select
                            v-model="targetLangSelected"
                            filterable
                            allow-create
                            default-first-option
                            :placeholder="t('targetLangPlaceholder')"
                            @change="changeLanguage"
                            style="width:220px"
                          >
                            <el-option :label="t('systemLanguage')" value="system"></el-option>
                            <el-option label="简体中文" value="简体中文"></el-option>
                            <el-option label="繁體中文" value="繁體中文"></el-option>
                            <el-option label="English" value="English"></el-option>
                            <el-option label="Français" value="Français"></el-option>
                            <el-option label="Язык" value="Язык"></el-option>
                            <el-option label="Deutsch" value="Deutsch"></el-option>
                            <el-option label="Español" value="Español"></el-option>
                            <el-option label="Portuguese" value="Portuguese"></el-option>
                            <el-option label="日本語" value="日本語"></el-option>
                            <el-option label="한국어" value="한국어"></el-option>
                          </el-select>
                        </el-form-item>

                        <!-- 经典并排 -->
                        <div class="classic-box">
                          <div class="classic-panel">
                            <el-input
                              v-model="sourceText"
                              type="textarea"
                              :rows="24"
                              :placeholder="t('sourceTextPlaceholder')"
                              resize="none"
                            ></el-input>
                          </div>

                          <div class="classic-panel">
                            <el-input
                              v-model="translatedText"
                              :placeholder="t('translatedTextPlaceholder')"
                              type="textarea"
                              :rows="24"
                              readonly
                              resize="none"
                            ></el-input>
                          </div>
                        </div>

                      </div>
                    </el-form>
                  </div>

                  <!-- 桌宠配置页面 -->
                  <div v-show="subMenu === 'table_pet'">
                    <el-form class="settings-form" :model="VRMConfig" label-position="top">
                      <div class="tool-item">
                        <!-- 桌宠机器人配置头部 -->
                        <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                          <span>
                            <el-icon><i class="fa-solid fa-user-ninja"></i></el-icon>
                            {{ t('table_pet_config') }}
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://www.agentparty.top/article.html?lang=zh&slug=0yuan" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-book-open-reader"></i>
                              </el-icon>{{ t('detailedTutorial') }}
                            </el-link>
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://vroid.com/en/studio" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-key"></i>
                              </el-icon>{{ t('gotoVroid') }}
                            </el-link>
                            <span>{{ '  ' }}</span>
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://hub.vroid.com/en" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-cube"></i>
                              </el-icon>{{ t('gotoVroidHub') }}
                            </el-link>
                            <span>{{ '  ' }}</span>
                            <el-link
                              type="primary"
                              :underline="false"
                              href="https://www.aplaybox.com/search?value=VRM" 
                              target="_blank"
                            >
                              <el-icon class="mr-1">
                                <i class="fa-solid fa-cube"></i>
                              </el-icon>{{ t('gotoAplaybox') }}
                            </el-link>
                          </span>
                          <div>
                            <!-- 启动按钮 -->
                            <el-tooltip :content="t('start_table_pet')" placement="top">
                              <el-button 
                                v-if="isElectron"
                                type="primary" 
                                @click="startVRM" 
                                circle
                              >
                                <template v-if="isVRMStarting">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-play"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                            <!-- 在浏览器启动按钮 -->
                            <el-tooltip :content="t('start_table_pet_web')" placement="top">
                              <el-button 
                                type="primary" 
                                @click="startVRMweb" 
                                circle
                              >
                                <template v-if="isVRMStarting">
                                  <i class="fa-solid fa-spinner fa-spin"></i>
                                </template>
                                <template v-else>
                                  <i class="fa-solid fa-window-maximize"></i>
                                </template>
                              </el-button>
                            </el-tooltip>
                          </div>
                        </div>
                        <div class="tool-content">
                            <!-- 主智能体选择 -->
                            <el-form-item :label="t('mainAgent')" required>
                              <el-select 
                                v-model="mainAgent"
                                @change="autoSaveSettings">
                                <el-option
                                  :label="t('defaultAgent')"
                                  value="super-model"
                                >
                                </el-option>
                                <el-option
                                  v-for="(agent, id) in agents"
                                  :key="id"
                                  :label="agent.name"
                                  :value="id"
                                >
                                </el-option>
                              </el-select>
                            </el-form-item>
                            <el-alert
                              type="info"
                              :closable="false"
                              class="mb-2"
                            >
                              <template #default>
                                <div class="alert-content">
                                  {{ t('goToMainAgentNotice1') }}
                                  <el-link
                                    type="primary"
                                    :underline="false"
                                    class="font-medium"
                                    @click="switchToMainAgent"
                                  >
                                    <el-icon class="mr-1">
                                      <i class="fa-solid fa-key"></i>
                                    </el-icon>{{ t('MainAgentInterface') }}
                                  </el-link>
                                </div>
                              </template>
                            </el-alert>
                            <!-- 角色卡选择 -->
                            <el-form-item :label="t('memoryEnable')" class="form-item-align" label-position="left">
                              <el-switch 
                              v-model="memorySettings.is_memory" 
                              @click.stop @change="changeMemory" 
                              />
                            </el-form-item>
                            <el-form-item :label="t('selectMemory')">
                              <el-select 
                                v-model="memorySettings.selectedMemory" 
                                :placeholder="t('selectMemoryPlaceholder')"
                                class="full-width-input"
                                @change ="changeMemory"
                                >
                                <el-option
                                  v-for="memory in memories"
                                  :key="memory.id"
                                  :label="memory.name"
                                  :value="memory.id"
                                />
                              </el-select>
                            </el-form-item>
                            <el-alert
                              type="info"
                              :closable="false"
                              class="mb-2"
                            >
                              <template #default>
                                <div class="alert-content">
                                  {{ t('goToMemoryNotice1') }}
                                  <el-link
                                    type="primary"
                                    :underline="false"
                                    class="font-medium"
                                    @click="switchToMemory"
                                  >
                                    <el-icon class="mr-1">
                                      <i class="fa-solid fa-key"></i>
                                    </el-icon>{{ t('memoryInterface') }}
                                  </el-link>
                                </div>
                              </template>
                            </el-alert>
                            <el-form-item :label="t('windowWidth')" class="form-item-align">
                              <el-slider
                                v-model="VRMConfig.windowWidth"
                                :min="300"
                                :max="2560"
                                :step="10"
                                show-input
                                @change="autoSaveSettings"
                              />
                            </el-form-item>
                            <el-form-item :label="t('windowHeight')" class="form-item-align">
                              <el-slider
                                v-model="VRMConfig.windowHeight"
                                :min="450"
                                :max="2560"
                                :step="10"
                                show-input
                                @change="autoSaveSettings"
                              />
                            </el-form-item>

                            <el-form-item :label="t('enabledExpressions')" class="form-item-align" label-position="left">
                              <el-switch 
                                v-model="VRMConfig.enabledExpressions" 
                                @change="autoSaveSettings"
                              ></el-switch>
                            </el-form-item>
                            
                            <el-form-item :label="t('enabledMotions')" class="form-item-align" label-position="left">
                              <el-switch 
                                v-model="VRMConfig.enabledMotions" 
                                @change="autoSaveSettings"
                              ></el-switch>
                            </el-form-item>

                            <el-form-item :label="t('asyncTools')" class="form-item-align" label-position="left">
                              <el-switch 
                                v-model="toolsSettings.asyncTools.enabled" 
                                @change="autoSaveSettings"
                              ></el-switch>
                            </el-form-item>

                            <!-- VRM模型选择框 -->
                            <el-form-item :label="t('selectVrmModel')">
                              <el-select
                                v-model="VRMConfig.selectedModelId"
                                @change="handleModelChange"
                                class="full-width-input"
                              >
                                <!-- 默认模型分组 -->
                                <el-option-group :label="t('defaultModels')">
                                  <el-option
                                    v-for="model in VRMConfig.defaultModels"
                                    :key="model.id"
                                    :label="model.name"
                                    :value="model.id"
                                  >
                                    <div class="model-option-item">
                                      <!-- 图标在最前 -->
                                      <i class="fa-solid fa-star" style="color: #f39c12; margin-right: 6px;"></i>
                                      <span>{{ model.name }}</span>
                                    </div>
                                  </el-option>
                                </el-option-group>

                                <!-- 用户上传模型分组 -->
                                <el-option-group :label="t('userModels')" v-if="VRMConfig.userModels.length > 0">
                                  <el-option
                                    v-for="model in VRMConfig.userModels"
                                    :key="model.id"
                                    :label="model.name"
                                    :value="model.id"
                                  >
                                    <div class="model-option-item">
                                      <!-- 图标在最前 -->
                                      <i
                                        class="fa-solid fa-trash-can"
                                        style="color: #ff0000; margin-right: 6px;"
                                        @click.stop="deleteModelOption(model.id)"
                                      ></i>
                                      <span>{{ model.name }}</span>
                                    </div>
                                  </el-option>
                                </el-option-group>
                              </el-select>

                              <!-- 模型上传按钮 -->
                              <el-button
                                @click="showVrmModelDialog = true"
                                type="primary"
                                class="add-server-btn"
                              >
                                <i class="fa-solid fa-plus"></i> {{ t('addVrmModel') }}
                              </el-button>
                            </el-form-item>

                            <!-- VRMA动作选择框（已统一） -->
                            <el-form-item :label="t('selectVrmaMotions')">
                              <el-select
                                v-model="VRMConfig.selectedMotionIds"
                                @change="handleMotionChange"
                                class="full-width-input"
                                multiple
                              >
                                <!-- 默认动作分组 -->
                                <el-option-group :label="t('defaultMotions')">
                                  <el-option
                                    v-for="motion in VRMConfig.defaultMotions"
                                    :key="motion.id"
                                    :label="motion.name"
                                    :value="motion.id"
                                  >
                                    <div class="motion-option-item">
                                      <i class="fa-solid fa-star" style="color: #f39c12; margin-right: 6px;"></i>
                                      <span>{{ motion.name }}</span>
                                    </div>
                                  </el-option>
                                </el-option-group>

                                <!-- 用户上传动作分组 -->
                                <el-option-group :label="t('userMotions')" v-if="VRMConfig.userMotions.length > 0">
                                  <el-option
                                    v-for="motion in VRMConfig.userMotions"
                                    :key="motion.id"
                                    :label="motion.name"
                                    :value="motion.id"
                                  >
                                    <div class="motion-option-item">
                                      <i
                                        class="fa-solid fa-trash-can"
                                        style="color: #ff0000; margin-right: 6px;"
                                        @click.stop="deleteMotionOption(motion.id)"
                                      ></i>
                                      <span>{{ motion.name }}</span>
                                    </div>
                                  </el-option>
                                </el-option-group>
                              </el-select>

                              <!-- 动作上传按钮 -->
                              <el-button
                                @click="showVrmaMotionDialog = true"
                                type="success"
                                class="add-server-btn"
                              >
                                <i class="fa-solid fa-plus"></i> {{ t('addVrmaMotion') }}
                              </el-button>
                            </el-form-item>
                            
                            <!-- 高斯场景选择框  GAUSS -->
                            <el-form-item :label="t('selectGaussScene')">
                              <el-select
                                v-model="VRMConfig.selectedGaussSceneId"
                                @change="handleGaussSceneChange"
                                class="full-width-input"
                              >
                                <el-option
                                  key="transparent"
                                  value="transparent"
                                  :label="t('transparentBackground')"
                                >
                                  <div class="scene-option-item">
                                    <i class="fa-solid fa-check-circle" style="color:#28a745;margin-right:6px;"></i>
                                    <span>{{ t('transparentBackground') }}</span>
                                  </div>
                                </el-option>
                                <!-- 默认场景分组 -->
                                <el-option-group :label="t('defaultScenes')">
                                  <el-option
                                    v-for="scene in VRMConfig.gaussDefaultScenes"
                                    :key="scene.id"
                                    :label="scene.name"
                                    :value="scene.id"
                                  >
                                    <div class="scene-option-item">
                                      <i class="fa-solid fa-star" style="color: #f39c12; margin-right: 6px;"></i>
                                      <span>{{ scene.name }}</span>
                                    </div>
                                  </el-option>
                                </el-option-group>

                                <!-- 用户上传场景分组 -->
                                <el-option-group :label="t('userScenes')" v-if="VRMConfig.gaussUserScenes.length > 0">
                                  <el-option
                                    v-for="scene in VRMConfig.gaussUserScenes"
                                    :key="scene.id"
                                    :label="scene.name"
                                    :value="scene.id"
                                  >
                                    <div class="scene-option-item">
                                      <i
                                        class="fa-solid fa-trash-can"
                                        style="color: #ff0000; margin-right: 6px;"
                                        @click.stop="deleteGaussSceneOption(scene.id)"
                                      ></i>
                                      <span>{{ scene.name }}</span>
                                    </div>
                                  </el-option>
                                </el-option-group>
                              </el-select>

                              <!-- 场景上传按钮 -->
                              <el-button
                                @click="showGaussSceneDialog = true"
                                type="warning"
                                class="add-server-btn"
                              >
                                <i class="fa-solid fa-plus"></i> {{ t('addGaussScene') }}
                              </el-button>
                            </el-form-item>
                            
                            <el-alert
                              type="info"
                              :closable="false"
                              class="mb-2"
                            >
                              <template #default>
                                <div class="alert-content">
                                  {{ t('vrmNotice1') }}<br>
                                  {{ t('vrmNotice2') }}<br>
                                  {{ t('vrmNotice3') }}
                                </div>
                              </template>
                            </el-alert>
                        </div>
                      </div>
                    </el-form>
                  </div>

                  <!-- VRM模型上传对话框 -->
                  <el-dialog
                    v-model="showVrmModelDialog"
                    :title="t('uploadVrmModel')"
                    width="600px"
                  >
                    <div class="upload-container">
                      <div
                        class="drop-zone"
                        @dragover.prevent
                        @drop.prevent="handleVrmModelDrop"
                        @click="browseVrmModelFile"
                      >
                        <el-icon :size="50"><i class="fa-solid fa-cloud-arrow-up"></i></el-icon>
                        <p>{{ t('clickOrDropVrm') }}</p>
                      </div>
                      
                      <!-- 文件列表 -->
                      <div class="compact-file-list" v-if="newVrmModel.name">
                        <div class="compact-file-item">
                          <span class="file-name">{{ newVrmModel.name }}</span>
                          <el-button
                            @click.stop="removeNewVrmModel"
                            class="delete-icon"
                            circle
                          >
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </div>
                      </div>

                      <el-input
                        v-model="newVrmModel.displayName"
                        :label="t('modelDisplayName')"
                        :placeholder="t('modelDisplayNamePlaceholder')"
                        required
                      />
                    </div>
                    <template #footer>
                      <el-button @click="cancelVrmModelUpload">{{ t('cancel') }}</el-button>
                      <el-button type="primary" @click="uploadVrmModel" :disabled="!newVrmModel.name">
                        {{ t('createImmediately') }}
                      </el-button>
                    </template>
                  </el-dialog>

                  <!-- VRMA动作上传对话框 -->
                  <el-dialog
                    v-model="showVrmaMotionDialog"
                    :title="t('uploadVrmaMotion')"
                    width="600px"
                  >
                    <div class="upload-container">
                      <div
                        class="drop-zone"
                        @dragover.prevent
                        @drop.prevent="handleVrmaMotionDrop"
                        @click="browseVrmaMotionFile"
                      >
                        <el-icon :size="50"><i class="fa-solid fa-cloud-arrow-up"></i></el-icon>
                        <p>{{ t('clickOrDropVrma') }}</p>
                      </div>
                      
                      <!-- 文件列表 -->
                      <div class="compact-file-list" v-if="newVrmaMotion.name">
                        <div class="compact-file-item">
                          <span class="file-name">{{ newVrmaMotion.name }}</span>
                          <el-button
                            @click.stop="removeNewVrmaMotion"
                            class="delete-icon"
                            circle
                          >
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </div>
                      </div>

                      <el-input
                        v-model="newVrmaMotion.displayName"
                        :label="t('motionDisplayName')"
                        :placeholder="t('motionDisplayNamePlaceholder')"
                        required
                      />
                    </div>
                    <template #footer>
                      <el-button @click="cancelVrmaMotionUpload">{{ t('cancel') }}</el-button>
                      <el-button type="primary" @click="uploadVrmaMotion" :disabled="!newVrmaMotion.name">
                        {{ t('createImmediately') }}
                      </el-button>
                    </template>
                  </el-dialog>

                  <!-- 高斯场景上传对话框  GAUSS -->
                  <el-dialog
                    v-model="showGaussSceneDialog"
                    :title="t('uploadGaussScene')"
                    width="600px"
                  >
                    <div class="upload-container">
                      <div
                        class="drop-zone"
                        @dragover.prevent
                        @drop.prevent="handleGaussSceneDrop"
                        @click="browseGaussSceneFile"
                      >
                        <el-icon :size="50"><i class="fa-solid fa-cloud-arrow-up"></i></el-icon>
                        <p>{{ t('clickOrDropGaussScene') }}</p>
                      </div>
                      
                      <!-- 文件列表 -->
                      <div class="compact-file-list" v-if="newGaussScene.name">
                        <div class="compact-file-item">
                          <span class="file-name">{{ newGaussScene.name }}</span>
                          <el-button
                            @click.stop="removeNewGaussScene"
                            class="delete-icon"
                            circle
                          >
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </div>
                      </div>

                      <el-input
                        v-model="newGaussScene.displayName"
                        :label="t('GaussSceneDisplayName')"
                        :placeholder="t('GaussSceneDisplayNamePlaceholder')"
                        required
                      />
                    </div>
                    <template #footer>
                      <el-button @click="cancelGaussSceneUpload">{{ t('cancel') }}</el-button>
                      <el-button type="primary" @click="uploadGaussScene" :disabled="!newGaussScene.name">
                        {{ t('createImmediately') }}
                      </el-button>
                    </template>
                  </el-dialog>

                  <!-- 朗读页面 -->
                  <div v-show="subMenu === 'read_bot'">
                    <el-tabs v-model="activeReadTab">
                      <!-- 配置标签页 -->
                      <el-tab-pane :label="t('FullTextReading')" name="full" key="full">
                        <el-form class="settings-form" :model="readConfig" label-position="top">
                          <div class="tool-item">
                            <!-- 配置头部 -->
                            <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                              <span>
                                <el-icon><i class="fa-solid fa-book-open-reader"></i></el-icon>
                                {{ t('readBot') }}
                              </span>
                              <div>
                                
                                <!-- 启动按钮 -->
                                <el-tooltip :content="t(isReadRunning ? (isReadPaused ? 'resume_read' : 'pause_read') : 'start_read')" placement="top">
                                  <el-button 
                                    type="primary" 
                                    @click="toggleRead" 
                                    :disabled="!readConfig.longText || isReadStarting"
                                    circle
                                  >
                                    <template v-if="isReadStarting">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else-if="isReadRunning && !isReadPaused">
                                      <i class="fa-solid fa-pause"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-play"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                                <!-- 转换音频按钮 -->
                                <el-tooltip :content="t('convertAudioOnly')" placement="top">
                                  <el-button 
                                    type="success" 
                                    @click="convertAudioOnly" 
                                    circle
                                    :disabled="!readConfig.longText || isConvertingAudio"
                                  >
                                    <i v-if="isConvertingAudio" class="fa-solid fa-spinner fa-spin"></i>
                                    <i v-else class="fa-solid fa-wand-magic-sparkles"></i>
                                  </el-button>
                                </el-tooltip>
                                <!-- 下载音频按钮 -->
                                <el-tooltip :content="t('downloadAudio')" placement="top">
                                  <el-button 
                                    type="default" 
                                    @click="downloadAudio" 
                                    circle
                                    :disabled="(isAudioSynthesizing && isConvertingAudio) || audioChunksCount === 0"
                                  >
                                    <i v-if="isAudioSynthesizing && isConvertingAudio" class="fa-solid fa-spinner fa-spin"></i>
                                    <i v-else class="fa-solid fa-download"></i>
                                  </el-button>
                                </el-tooltip>

                                <!-- 停止按钮（更新为通用停止功能） -->
                                <el-tooltip :content="t('stop_all_tts')" placement="top">
                                  <el-button 
                                    type="danger" 
                                    @click="stopTTSActivities" 
                                    :disabled="(!isReadRunning && !isConvertingAudio) || isReadStopping || isConvertStopping"
                                    circle
                                  >
                                    <template v-if="isReadStopping || isConvertStopping">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-stop"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                              </div>
                            </div>
                            <div class="tool-content">
                              <!-- 新增：进度条区域 -->
                              <div class="progress-container" style="margin-top: 15px;">
                                <div class="progress-info" style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                  <span>{{ t('processingProgress') }}</span>
                                  <span>{{ processingProgressText }}</span>
                                </div>
                                <el-progress 
                                  :percentage="processingPercentage" 
                                  :status="progressStatus"
                                  :stroke-width="20"
                                  :text-inside="true"
                                ></el-progress>
                              </div>
                              <!-- 文件选择区域 -->
                              <el-form-item>
                                <!-- 选择textFiles中的文件 -->
                                <el-select class="full-width-input" v-model="selectedFile" @change="parseSelectedFile" :placeholder="t('selectFile')">
                                  <el-option
                                    v-for="file in textFiles"
                                    :key="file.unique_filename"
                                    :label="file.original_filename"
                                    :value="file.unique_filename"
                                  ></el-option>
                                </el-select>
                              </el-form-item>
                              <el-alert
                                type="info"
                                :closable="false"
                                class="mb-2"
                              >
                                <template #default>
                                  <div class="alert-content">
                                    {{ t('SeparatorNotice') }}<br>
                                    {{ t('SeparatorNotice1') }}
                                    <el-link
                                      type="primary"
                                      :underline="false"
                                      class="font-medium"
                                      @click="switchToTTS"
                                    >
                                      <el-icon class="mr-1">
                                        <i class="fa-solid fa-key"></i>
                                      </el-icon>{{ t('TTSInterface') }}
                                    </el-link>
                                  </div>
                                </template>
                              </el-alert>
                              <div style="display: flex; justify-content: flex-end;margin-bottom: 16px;">
                                <el-tooltip :content="t('prevChapter')" placement="top">
                                  <el-button 
                                    v-show="this.readConfig.longTextList?.length > 0"
                                    type="default" 
                                    @click="PrevPage" 
                                    circle
                                  >
                                    <i class="fa-solid fa-arrow-left"></i>
                                  </el-button>
                                </el-tooltip>
                                <el-tooltip :content="t('nextChapter')" placement="top">
                                  <el-button 
                                    v-show="this.readConfig.longTextList?.length > 0"
                                    type="default" 
                                    @click="NextPage" 
                                    circle
                                  >
                                    <i class="fa-solid fa-arrow-right"></i>
                                  </el-button>
                                </el-tooltip>
                                <!-- 新增上传文件按钮 -->
                                <el-tooltip :content="t('uploadFile')" placement="top">
                                  <el-button 
                                    type="success" 
                                    @click="showFileDialog = true" 
                                    circle
                                  >
                                    <i class="fa-solid fa-file-arrow-up"></i>
                                  </el-button>
                                </el-tooltip>
                                <el-tooltip :content="t('clearText')" placement="top">
                                  <el-button 
                                    type="danger" 
                                    @click="clearLongText" 
                                    circle
                                  >
                                    <i class="fa-solid fa-broom"></i>
                                  </el-button>
                                </el-tooltip>
                              </div>
                              <el-form-item>
                                <el-input
                                    v-model="readConfig.longText"
                                    type="textarea"
                                    :rows=32
                                    :placeholder="t('longTextPlaceholder')"
                                    class="input-box">
                                </el-input>
                              </el-form-item>
                            </div>
                          </div>
                        </el-form>
                      </el-tab-pane>  
                      <el-tab-pane :label="t('SegmentedReading')" name="segment" key="segment">
                        <el-form class="settings-form" label-position="top">
                          <div class="tool-item">
                            <!-- 顶部工具栏 -->
                            <div class="tool-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                              <span><el-icon><i class="fa-solid fa-list-ol"></i></el-icon> {{ t('segmentRead') }}</span>
                              <div>
                                <el-tooltip :content="t('playNextSegment')" placement="top">
                                  <el-button
                                    type="primary"
                                    circle
                                    :disabled="readState.ttsChunks.length===0 || readState.isPlaying"
                                    @click="playNextSegmentOnce"
                                  >
                                    <i class="fa-solid fa-step-forward"></i>
                                  </el-button>
                                </el-tooltip>
                                <!-- 连续播放 / 暂停 -->
                                <el-tooltip :content="t('continuousPlay')" placement="top">
                                  <el-button
                                    type="primary"
                                    circle
                                    :disabled="readState.ttsChunks.length===0 || isReadRunning"
                                    @click="toggleContinuousPlay"
                                  >
                                    <i :class="readState.isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play'"></i>
                                  </el-button>
                                </el-tooltip>
                                <!-- 停止 -->
                                <el-tooltip :content="t('stopSegmentTTS')" placement="top">
                                  <el-button
                                    type="danger"
                                    circle
                                    :disabled="!readState.isPlaying && !isReadRunning"
                                    @click="stopSegmentTTS"
                                  >
                                    <i class="fa-solid fa-stop"></i>
                                  </el-button>
                                </el-tooltip>
                              </div>
                            </div>

                            <!-- 分段列表 -->
                            <!-- 外层只控制列表显隐，不控制行 -->
                            <div v-if="readState.ttsChunks.length"
                                key="seg-list-box"
                                class="segment-list"
                                style="max-height:420px;overflow:auto">

                              <!-- 直接对行做 v-for，避免 template 带来的 diff 问题 -->
                              <div v-for="(chunk, idx) in readState.ttsChunks"
                                  :key="idx"
                                  class="segment-item"
                                  :style="{ background: idx === readState.currentChunk ? '#ecf5ff' : '' }"
                                  style="display:flex;align-items:center;margin-bottom:8px;padding:8px;border:1px solid #dcdfe6;border-radius:4px">

                                <span style="min-width:30px;text-align:center">{{ idx + 1 }}</span>

                                <!-- 音色标签 / 选择框：同场过渡，防止闪帧 -->
                                <Transition name="el-fade-in-linear" mode="out-in">
                                  <!-- 关键：mode="out-in" 保证旧元素完全退场后再进新元素 -->
                                  <el-tag v-if="activeSegmentIdx !== idx"
                                          size="default"
                                          style="margin-right:8px;width:80px">
                                    {{ readState.chunks_voice[idx] }}
                                  </el-tag>

                                  <el-select v-else
                                            v-model="segmentVoiceEditBuffer[idx]"
                                            size="small"
                                            style="margin-right:8px;width:80px">
                                    <el-option key="default" label="default" value="default"></el-option>
                                    <el-option v-for="(cfg,name) in ttsSettings.newtts"
                                              :key="name"
                                              :label="name"
                                              :value="name" >
                                    </el-option>
                                  </el-select>
                                </Transition>

                                <div style="flex:1;margin-right:8px">
                                  <div v-if="activeSegmentIdx !== idx" class="segment-text">{{ chunk }}</div>
                                  <el-input v-else v-model="segmentEditBuffer" type="textarea" ></el-input>
                                </div>

                                <div>
                                  <el-button v-if="activeSegmentIdx !== idx"
                                            type="text" size="small"
                                            :disabled="isReadRunning||isReadingOnetext"
                                            @click="playSingleSegment(idx)" >
                                            <i class="fa-solid fa-play"></i>
                                  </el-button>
                                  <el-button type="text" size="small"
                                            :disabled="isReadRunning||isReadingOnetext"
                                            @click="toggleEditSegment(idx)" >
                                            <i :class="activeSegmentIdx === idx ? 'fa-solid fa-check' : 'fa-solid fa-pen'"></i>
                                  </el-button>
                                </div>
                              </div>
                            </div>



                            <!-- 空态 -->
                            <el-empty v-else :description="t('noSegmentList')" />
                          </div>
                        </el-form>
                      </el-tab-pane>
                    </el-tabs>

                    <!-- 文件上传对话框 -->
                    <el-dialog 
                      :title="t('uploadFile')" 
                      v-model="showFileDialog" 
                      width="600px"
                    >
                      <div class="upload-container">
                        <!-- 可点击的拖拽区域 -->
                        <div
                          class="drop-zone"
                          @dragover.prevent
                          @drop.prevent="handleReadDrop"
                          @click="browseReadFiles"
                        >
                          <el-icon :size="50"><upload /></el-icon>
                          <p>{{ t('clickOrDrop') }}</p>
                        </div>
                      </div>
                    </el-dialog>
                  </div>
                  <!-- 直播页面 -->
                  <div v-show="subMenu === 'live_stream'">
                    <el-tabs v-model="activeLiveTab">
                      <!-- 配置标签页 -->
                      <el-tab-pane :label="t('liveConfig')" name="live" key="live">
                        <el-form class="settings-form" :model="liveConfig" label-position="top">
                          <div class="tool-item">
                            <!-- 直播配置头部 -->
                            <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                              <span>
                                <el-icon><i class="fa-solid fa-video"></i></el-icon>
                                {{ t('live_stream_bot') }}
                              </span>
                              <div>
                                <!-- 启动按钮 -->
                                <el-tooltip :content="t('start_live')" placement="top">
                                  <el-button 
                                    type="primary" 
                                    @click="startLive" 
                                    :disabled="!isLiveConfigValid || isLiveRunning || isLiveStarting"
                                    circle
                                  >
                                    <template v-if="isLiveStarting">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-play"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                                
                                <!-- 停止按钮 -->
                                <el-tooltip :content="t('stop_live')" placement="top">
                                  <el-button 
                                    type="danger" 
                                    @click="stopLive" 
                                    :disabled="!isLiveRunning || isLiveStopping"
                                    circle
                                  >
                                    <template v-if="isLiveStopping">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-stop"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                                
                                <!-- 重载按钮 -->
                                <el-tooltip :content="t('reload_live')" placement="top">
                                  <el-button 
                                    @click="reloadLiveConfig" 
                                    :disabled="!isLiveRunning || isLiveReloading"
                                    circle
                                  >
                                    <template v-if="isLiveReloading">
                                      <i class="fa-solid fa-rotate fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-rotate"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                              </div>
                            </div>
                            <div class="tool-header">
                              <div class="header-left">
                                <span>
                                  {{t('liveSetting')}}
                                </span>
                              </div>
                            </div>
                            <div class="tool-content">
                              <el-form-item :label="t('onlyDanmaku')" class="form-item-align" label-position="left">
                                <el-switch 
                                  v-model="liveConfig.onlyDanmaku" 
                                  @change="autoSaveSettings"
                                ></el-switch>
                              </el-form-item>   
                              <el-form-item :label="t('danmakuQueueLimit')" class="form-item-align" label-position="left">
                                <el-slider
                                  v-model="liveConfig.danmakuQueueLimit"
                                  :min="1"
                                  :max="30"
                                  :step="1"
                                  show-input
                                  @change="autoSaveSettings"
                                />
                              </el-form-item> 
                                <el-form-item :label="t('danmakuWakeWord')">
                                  <el-input
                                    v-model="liveConfig.wakeWord"
                                    :placeholder="t('botWakeWordPlaceholder')"
                                    class="full-width-input"
                                    @change="autoSaveSettings"
                                    type="textarea" 
                                    :rows="3"
                                  />
                                </el-form-item>
                            </div>
                          </div>
                        </el-form>
                      </el-tab-pane>
                      <el-tab-pane :label="t('bilibiliLive')" name="bilibili" key="bilibili">
                        <el-form class="settings-form" :model="liveConfig" label-position="top">
                          <div class="tool-item">
                            <!-- 直播配置头部 -->
                            <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                              <span>
                                <el-icon><i class="fa-brands fa-bilibili"></i></el-icon>
                                {{ t('live_stream_bot') }}
                              </span>
                              <div>
                                <!-- 启动按钮 -->
                                <el-tooltip :content="t('start_live')" placement="top">
                                  <el-button 
                                    type="primary" 
                                    @click="startLive" 
                                    :disabled="!isLiveConfigValid || isLiveRunning || isLiveStarting"
                                    circle
                                  >
                                    <template v-if="isLiveStarting">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-play"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                                
                                <!-- 停止按钮 -->
                                <el-tooltip :content="t('stop_live')" placement="top">
                                  <el-button 
                                    type="danger" 
                                    @click="stopLive" 
                                    :disabled="!isLiveRunning || isLiveStopping"
                                    circle
                                  >
                                    <template v-if="isLiveStopping">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-stop"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                                
                                <!-- 重载按钮 -->
                                <el-tooltip :content="t('reload_live')" placement="top">
                                  <el-button 
                                    @click="reloadLiveConfig" 
                                    :disabled="!isLiveRunning || isLiveReloading"
                                    circle
                                  >
                                    <template v-if="isLiveReloading">
                                      <i class="fa-solid fa-rotate fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-rotate"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                              </div>
                            </div>

                            <div class="tool-header">
                              <div class="header-left">
                                <span>
                                  {{t('bilibili')}}
                                  <el-link
                                    type="primary"
                                    :underline="false"
                                    href="https://open-live.bilibili.com/" 
                                    target="_blank"
                                  >
                                    <el-icon class="mr-1">
                                      <i class="fa-solid fa-key"></i>
                                    </el-icon>{{ t('gotoBilibiliOpenLive') }}
                                  </el-link>
                                </span>
                              </div>
                              <el-switch v-model="liveConfig.bilibili_enabled" @click.stop @change="autoSaveSettings"/>
                            </div>
                            <div class="tool-content">
                              <el-form-item :label="t('liveType')">
                                <el-select
                                  v-model="liveConfig.bilibili_type"
                                  :placeholder="t('liveTypePlaceholder')"
                                  class="full-width-input"
                                  @change="autoSaveSettings"
                                >
                                  <el-option :label="t('web')" value="web"></el-option>
                                  <el-option :label="t('bilibili_open_live')" value="open_live"></el-option>
                                </el-select>
                              </el-form-item>      
                              <el-form-item :label="t('roomID')" v-if="liveConfig.bilibili_type === 'web'">
                                <el-input
                                  v-model="liveConfig.bilibili_room_id"
                                  :placeholder="t('roomIDPlaceholder')"
                                  class="full-width-input"
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>
                              <el-form-item :label="t('sessdata')" v-if="liveConfig.bilibili_type === 'web'">
                                <el-input
                                  v-model="liveConfig.bilibili_sessdata"
                                  :placeholder="t('sessdataPlaceholder')"
                                  class="full-width-input"
                                  show-password
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>
                              <el-alert
                                type="info"
                                :closable="false"
                                class="mb-2"
                                v-if="liveConfig.bilibili_type === 'web'"
                              >
                                <template #default>
                                  <div class="alert-content">
                                    {{ t('webBilibiliInfo') }}
                                  </div>
                                </template>
                              </el-alert>
                              <el-form-item label="ACCESS KEY ID" v-if="liveConfig.bilibili_type === 'open_live'">
                                <el-input
                                  v-model="liveConfig.bilibili_ACCESS_KEY_ID"
                                  :placeholder="t('ACCESS_KEY_ID_Placeholder')"
                                  class="full-width-input"
                                  show-password
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>
                              <el-form-item label="ACCESS KEY SECRET" v-if="liveConfig.bilibili_type === 'open_live'">
                                <el-input
                                  v-model="liveConfig.bilibili_ACCESS_KEY_SECRET"
                                  :placeholder="t('ACCESS_KEY_SECRET_Placeholder')"
                                  class="full-width-input"
                                  show-password
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>
                              <el-form-item label="APP ID" v-if="liveConfig.bilibili_type === 'open_live'">
                                <el-input
                                  v-model="liveConfig.bilibili_APP_ID"
                                  :placeholder="t('APP_ID_Placeholder')"
                                  class="full-width-input"
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>
                              <el-form-item label="ROOM OWNER AUTH CODE" v-if="liveConfig.bilibili_type === 'open_live'">
                                <el-input
                                  v-model="liveConfig.bilibili_ROOM_OWNER_AUTH_CODE"
                                  :placeholder="t('ROOM_OWNER_AUTH_CODE_Placeholder')"
                                  class="full-width-input"
                                  show-password
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>
                            </div>

                          </div>
                        </el-form>
                      </el-tab-pane>
                      <el-tab-pane :label="t('youtubeLive')" name="youtube" key="youtube">
                        <el-form class="settings-form" :model="liveConfig" label-position="top">
                          <div class="tool-item">
                            <!-- 直播配置头部 -->
                            <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                              <span>
                                <el-icon><i class="fa-brands fa-youtube"></i></el-icon>
                                {{ t('live_stream_bot') }}
                              </span>
                              <div>
                                <!-- 启动按钮 -->
                                <el-tooltip :content="t('start_live')" placement="top">
                                  <el-button 
                                    type="primary" 
                                    @click="startLive" 
                                    :disabled="!isLiveConfigValid || isLiveRunning || isLiveStarting"
                                    circle
                                  >
                                    <template v-if="isLiveStarting">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-play"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                                
                                <!-- 停止按钮 -->
                                <el-tooltip :content="t('stop_live')" placement="top">
                                  <el-button 
                                    type="danger" 
                                    @click="stopLive" 
                                    :disabled="!isLiveRunning || isLiveStopping"
                                    circle
                                  >
                                    <template v-if="isLiveStopping">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-stop"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                                
                                <!-- 重载按钮 -->
                                <el-tooltip :content="t('reload_live')" placement="top">
                                  <el-button 
                                    @click="reloadLiveConfig" 
                                    :disabled="!isLiveRunning || isLiveReloading"
                                    circle
                                  >
                                    <template v-if="isLiveReloading">
                                      <i class="fa-solid fa-rotate fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-rotate"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                              </div>
                            </div>

                            <!-- YouTube 配置 -->
                            <div class="tool-header">
                              <div class="header-left">
                                <span>
                                  YouTube
                                  <el-link
                                    type="primary"
                                    :underline="false"
                                    href="https://console.cloud.google.com/apis/credentials"
                                    target="_blank"
                                  >
                                    <el-icon class="mr-1"><i class="fa-solid fa-key"></i></el-icon>
                                    {{ t('getYouTubeAPIKey') }}
                                  </el-link>
                                </span>
                              </div>
                              <el-switch
                                v-model="liveConfig.youtube_enabled"
                                @change="autoSaveSettings"
                              />
                            </div>

                            <div class="tool-content">
                              <el-form-item :label="t('youtubeVideoId')">
                                <el-input
                                  v-model="liveConfig.youtube_video_id"
                                  :placeholder="t('youtubeVideoIdPlaceholder')"
                                  class="full-width-input"
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>

                              <el-form-item :label="t('youtubeApiKey')">
                                <el-input
                                  v-model="liveConfig.youtube_api_key"
                                  :placeholder="t('youtubeApiKeyPlaceholder')"
                                  class="full-width-input"
                                  show-password
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>

                              <el-alert type="info" :closable="false" class="mb-2">
                                <template #default>
                                  <div class="alert-content">
                                    {{ t('youtubeHelp') }}
                                  </div>
                                </template>
                              </el-alert>
                            </div>
                          </div>
                        </el-form>
                      </el-tab-pane>
                      <el-tab-pane :label="t('twitchLive')" name="twitch" key="twitch">
                        <el-form class="settings-form" :model="liveConfig" label-position="top">
                          <div class="tool-item">
                            <!-- 直播配置头部 -->
                            <div class="tool-header" style="display: flex; justify-content: space-between; align-items: center;">
                              <span>
                                <el-icon><i class="fa-brands fa-twitch"></i></el-icon>
                                {{ t('live_stream_bot') }}
                              </span>
                              <div>
                                <!-- 启动按钮 -->
                                <el-tooltip :content="t('start_live')" placement="top">
                                  <el-button 
                                    type="primary" 
                                    @click="startLive" 
                                    :disabled="!isLiveConfigValid || isLiveRunning || isLiveStarting"
                                    circle
                                  >
                                    <template v-if="isLiveStarting">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-play"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                                
                                <!-- 停止按钮 -->
                                <el-tooltip :content="t('stop_live')" placement="top">
                                  <el-button 
                                    type="danger" 
                                    @click="stopLive" 
                                    :disabled="!isLiveRunning || isLiveStopping"
                                    circle
                                  >
                                    <template v-if="isLiveStopping">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-stop"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                                
                                <!-- 重载按钮 -->
                                <el-tooltip :content="t('reload_live')" placement="top">
                                  <el-button 
                                    @click="reloadLiveConfig" 
                                    :disabled="!isLiveRunning || isLiveReloading"
                                    circle
                                  >
                                    <template v-if="isLiveReloading">
                                      <i class="fa-solid fa-rotate fa-spin"></i>
                                    </template>
                                    <template v-else>
                                      <i class="fa-solid fa-rotate"></i>
                                    </template>
                                  </el-button>
                                </el-tooltip>
                              </div>
                            </div>

                            <!-- Twitch 配置 -->
                            <div class="tool-header">
                              <div class="header-left">
                                <span>
                                  Twitch
                                  <el-link
                                    type="primary"
                                    :underline="false"
                                    href="https://twitchtokengenerator.com"
                                    target="_blank"
                                  >
                                    <el-icon class="mr-1"><i class="fa-solid fa-key"></i></el-icon>
                                    {{ t('getTwitchAccessToken') }}
                                  </el-link>
                                </span>
                              </div>
                              <el-switch
                                v-model="liveConfig.twitch_enabled"
                                @change="autoSaveSettings"
                              />
                            </div>

                            <div class="tool-content">
                              <el-form-item :label="t('twitchChannel')">
                                <el-input
                                  v-model="liveConfig.twitch_channel"
                                  :placeholder="t('twitchChannelPlaceholder')"
                                  class="full-width-input"
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>

                              <el-form-item :label="t('twitchAccessToken')">
                                <el-input
                                  v-model="liveConfig.twitch_access_token"
                                  :placeholder="t('twitchAccessTokenPlaceholder')"
                                  class="full-width-input"
                                  show-password
                                  @change="autoSaveSettings"
                                />
                              </el-form-item>

                              <el-alert type="info" :closable="false" class="mb-2">
                                <template #default>
                                  <div class="alert-content">
                                    {{ t('twitchHelp') }}
                                  </div>
                                </template>
                              </el-alert>
                            </div>
                          </div>
                        </el-form>
                      </el-tab-pane>
                    </el-tabs>
                  </div>
                </div>
            </div>
        </div>
        <div v-show="activeMenu === 'api-group'" class="page agent-suite-container">
          <div class="suite-layout">
            <!-- 左侧导航 -->
            <div class="suite-sidebar">
              <div class="tile-nav">
                <div 
                  v-for="tile in apiTiles" 
                  :key="tile.id"
                  class="nav-item"
                  :class="{ active: subMenu === tile.id }"
                  @click="subMenu = tile.id">
                  <el-icon class="nav-icon"><i :class="tile.icon"></i></el-icon>
                  <span class="nav-text">{{ t(tile.title) }}</span>
                </div>
              </div>
            </div>
            <!-- 右侧内容 -->
            <div class="suite-content">
              <!-- 开发工具页面 -->
              <div v-show="subMenu === 'develop'" class="page agents-container">
                <!-- Node.js 卡片：已安装 & 未安装 双状态 -->
                <el-card shadow="hover" class="sherpa-card">
                  <!-- 头部：标题 + 状态标签 -->
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span><strong>Node.js</strong></span>

                    <div class="d-flex gap-2">
                      <el-button
                        v-if="!nodeInstalled"
                        type="primary"
                        :loading="nodeInstalling"
                        @click="installNode"
                      >
                        <i class="fa-solid fa-download"></i>
                        {{ t('installNode') }}
                      </el-button>
                      <el-tag v-else type="success" effect="dark" size="large">  
                        <i class="fa-solid fa-circle-check"></i>
                        {{ t('installed') }}
                      </el-tag>
                    </div>
                  </div>

                  <!-- 进度条 -->
                  <el-progress
                    v-if="nodeInstalling && nodeProgress > 0"
                    :percentage="nodeProgress"
                    :status="nodeProgress === 100 ? 'success' : null"
                    style="margin-top: 16px;"
                    :stroke-width="10"
                  />
                </el-card>
                <!-- uv 卡片：已安装 & 未安装 双状态 -->
                <el-card shadow="hover" class="sherpa-card">
                  <!-- 头部：标题 + 状态标签 -->
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span><strong>UV</strong></span>

                    <div class="d-flex gap-2">
                      <el-button
                        v-if="!uvInstalled"
                        type="primary"
                        :loading="uvInstalling"
                        @click="installUv"
                      >
                        <i class="fa-solid fa-download"></i>
                        {{ t('installUv') }}
                      </el-button>
                      <el-tag v-else type="success" effect="dark" size="large">
                        <i class="fa-solid fa-circle-check"></i>
                        {{ t('installed') }}
                      </el-tag>
                    </div>
                  </div>

                  <!-- 进度条 -->
                  <el-progress
                    v-if="uvInstalling && uvProgress > 0"
                    :percentage="uvProgress"
                    :status="uvProgress === 100 ? 'success' : null"
                    style="margin-top: 16px;"
                    :stroke-width="10"
                  />
                </el-card>
                <!-- Git 卡片：已安装 & 未安装 双状态 -->
                <el-card
                  shadow="hover"
                  class="sherpa-card"
                >
                  <!-- 头部：标题 + 状态标签 -->
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span><strong>Git</strong></span>

                    <div class="d-flex gap-2">
                      <!-- 未安装 -->
                      <el-button
                        v-if="!gitInstalled"
                        type="primary"
                        :loading="gitInstalling"
                        @click="installGit"
                      >
                        <i class="fa-solid fa-download"></i>
                        {{ t('installGit') }}
                      </el-button>

                      <!-- 已安装 -->
                      <el-tag
                        v-else
                        type="success"
                        effect="dark"
                        size="large"
                      >
                      <i class="fa-solid fa-circle-check"></i>
                        {{ t('installed') }}
                      </el-tag>
                    </div>
                  </div>

                  <!-- 进度条：只在安装过程中出现 -->
                  <el-progress
                    v-if="gitInstalling && gitProgress > 0"
                    :percentage="gitProgress"
                    :status="gitProgress === 100 ? 'success' : null"
                    style="margin-top: 16px;"
                    :stroke-width="10"
                  />
                </el-card>
              </div>
              <!-- 智能体页面 -->
              <div v-show="subMenu === 'agents'" class="page agents-container">
                <!-- 磁贴网格 -->
                <div class="provider-grid">
                  <!-- 已有智能体 -->
                  <div class="provider-card agent-card" v-for="agent in agents" :key="agent.id">
                    <div class="card-header">
                      <el-switch v-model="agent.enabled" @change="autoSaveSettings"></el-switch>
                      <div class="card-actions">
                        <!-- 更新删除按钮样式 -->
                        <el-button @click="removeAgent(agent.id)" type="danger" circle size="small">
                          <i class="fa-solid fa-trash"></i>
                        </el-button>
                      </div>
                    </div>
                    
                    <div class="agent-content">
                      <div class="agent-header">
                        <span class="agent-name">{{ agent.name }}</span>
                        <!-- 添加复制功能 -->
                        <el-button
                          size="small"
                          type="info"
                          @click="copyAgentName(agent.name)"
                        >
                          <i class="fa-regular fa-copy"></i>
                        </el-button>
                      </div>
                      <!-- 带复制功能的ID展示 -->
                      <el-tag 
                        type="info" 
                        size="small" 
                        class="agent-id clickable"
                        @click="copyAgentId(agent.id)"
                      >
                        {{ agent.id }}
                        <i class="fa-regular fa-copy"></i>
                      </el-tag>
                      <p class="agent-prompt">{{ agent.system_prompt }}</p>
                    </div>
                  </div>
                  <!-- 添加新智能体 -->
                  <div class="provider-card add-tile" @click="showAgentForm = true;newAgent.system_prompt = this.system_prompt">
                    <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addNewAgent') }}</div>
                  </div>
                </div>
                <!-- 智能体编辑对话框 -->
                <el-dialog v-model="showAgentForm" :title="editingAgent ? t('editAgent') : t('addAgent')" width="600px">
                  <el-form label-position="top">
                    <el-form-item :label="t('agentName')" required>
                      <el-input v-model="newAgent.name" :placeholder="t('agentNamePlaceholder')"/>
                    </el-form-item>
                    <el-form-item :label="t('systemPrompt')" required>
                      <el-input 
                        v-model="newAgent.system_prompt" 
                        type="textarea" 
                        :rows="6"
                        :placeholder="t('systemPromptPlaceholder')"/>
                    </el-form-item>
                  </el-form>
                  <el-alert
                    type="info"
                    :closable="false"
                    class="mb-2"
                  >
                    <template #default>
                      <div class="alert-content">
                        {{ t('agentInfo') }}
                      </div>
                    </template>
                  </el-alert>
                  <template #footer>
                    <el-button @click="showAgentForm = false">{{ t('cancel') }}</el-button>
                    <el-button 
                      type="primary" 
                      @click="saveAgent"
                      :disabled="!newAgent.name || !newAgent.system_prompt">
                      {{ t('createAgent') }}
                    </el-button>
                  </template>
                </el-dialog>
              </div>
              <!-- 扩展页面 -->
              <div v-show="subMenu === 'extension'" class="page extension-container">
                <!-- 官网插件市场跳转卡片 -->
                <div class="market-link-banner" @click="openRepository('https://www.agentparty.top/plugins.html')">
                  <div class="banner-accent-bar">OFFICIAL</div>
                  
                  <div class="banner-main">
                    <div class="banner-icon-box">
                      <i class="fa-solid fa-store"></i>
                    </div>
                    
                    <div class="banner-text">
                      <h3>{{t('pluginMarket') || 'Extension Market'}}</h3>
                      <p>{{t('exploreMorePlugins') || 'Discover and download more community extensions'}}</p>
                    </div>

                    <div class="banner-action">
                      <span>GO</span>
                      <i class="fa-solid fa-arrow-right-long"></i>
                    </div>
                  </div>
                </div>
                <div class="plugin-header">
                  <h3>{{t('availableExtensions')}}</h3>
                  <div class="plugin-button-group">
                    <el-button 
                      @click="openAddExtensionDialog" 
                      type="primary">
                      {{t('addNewExtension')}}
                    </el-button>
                    <el-button 
                      @click="openExtfile" 
                      type="primary">
                      {{t('openExtfile')}}
                    </el-button>
                    <el-button 
                      @click="openRepository('https://github.com/super-agent-party/super-agent-party.github.io')" 
                      type="primary">
                      {{t('addYourExtensions')}}
                    </el-button>
                    <el-button 
                      @click="handleRefreshClick" 
                      type="primary"
                      :loading="refreshing">
                      {{refreshButtonText}}
                    </el-button>
                  </div>
                </div>

                <!-- 磁贴网格 -->
                <div class="provider-grid">
                  <!-- 已有智能体 -->
                  <div class="provider-card" v-for="extension in extensions" :key="extension.id">
                    <div class="card-header">
                      <el-tooltip :content="t('useExtension')" placement="top">
                        <el-button 
                          type="primary" 
                          @click="switchExtension(extension);this.activeMenu = 'home';"
                          circle
                        >
                          <i class="fa-solid fa-play"></i>
                        </el-button>
                      </el-tooltip>
                      <div class="card-actions">
                        <el-tooltip :content="t('openExtensionInBrowser')" placement="top">
                          <!-- 浏览器打开按钮 -->
                          <el-button
                            type="default"
                            circle
                            size="small"
                            @click.stop="openExtension(extension)">
                            <i class="fa-solid fa-external-link"></i>
                          </el-button>
                        </el-tooltip>
                        <el-tooltip :content="t('openExtensionInWindow')" placement="top">
                          <!-- 独立窗口打开按钮（仅在Electron环境下显示） -->
                          <el-button
                            v-if="isElectron"
                            type="primary"
                            circle
                            size="small"
                            @click.stop="openExtensionInWindow(extension)"
                            style="margin-left: 8px;">
                            <i class="fa-solid fa-window-restore"></i>
                          </el-button>
                        </el-tooltip>
                        <el-tooltip :content="t('deleteExtension')" placement="top">
                          <!-- 更新删除按钮样式 -->
                          <el-button @click="removeExtension(extension)" type="danger" circle size="small">
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </el-tooltip>
                      </div>
                    </div>
                    <div class="kb-content">
                      <div class="kb-header"> 
                        <h3>{{ extension.name }}</h3>
                        <el-tag 
                          type="info" 
                          size="small" 
                        >
                          v{{ extension.version }}
                        </el-tag>                      
                      </div>
                      <p class="kb-description">{{ extension.author }}</p>
                      <div class="kb-meta">
                        <p>{{ extension.description }}</p>
                      </div>
                    </div>
                  </div>
                  <!-- 添加新扩展 -->
                  <div class="provider-card add-tile" @click="openAddExtensionDialog">
                    <el-icon :size="40" color="#909399"><i class="fa-solid fa-plus"></i></el-icon>
                    <div style="color: #606266; margin-top: 10px;">{{ t('addNewExtension') }}</div>
                  </div>
                </div>
                <!-- 添加扩展对话框 -->
                <el-dialog
                  v-model="showExtensionForm"
                  :title="t('addNewExtension')"
                  width="80%"
                >
                  <!-- GitHub 地址输入 -->
                  <div class="line-box">
                    <el-input
                      v-model="newExtensionUrl"
                      placeholder="https://github.com/owner/repo"
                      class="fill-input"
                    ></el-input>
                    <el-button
                      type="primary"
                      :loading="installLoading"
                      :disabled="!newExtensionUrl.trim()"
                      @click="addExtension"
                    >
                      {{ t('add') }}
                    </el-button>
                  </div>

                  <!-- Electron 额外功能 -->
                  <div v-if="isElectron" style="margin-top: 12px;">
                    <el-divider>{{t('or')}}</el-divider>
                    <el-button 
                      @click="selectLocalZip" 
                      :loading="installLoading"  
                      type="primary" 
                      class="add-server-btn">
                      {{t('localZipInstallation')}}
                    </el-button>
                    <input
                      ref="zipInput"
                      type="file"
                      accept=".zip"
                      style="display: none"
                      @change="onZipSelected"
                    ></input>
                  </div>
                  <el-divider>{{t('or')}}</el-divider>
                  
                  <!-- 远程插件列表 - 卡片形式 -->
                  <div class="plugin-header">
                    <h3>{{t('availableExtensions')}}</h3>
                    <div class="plugin-button-group">
                      <el-button 
                        @click="openExtfile" 
                        type="primary">
                        {{t('openExtfile')}}
                      </el-button>
                      <el-button 
                        @click="openRepository('https://github.com/super-agent-party/super-agent-party.github.io')" 
                        type="primary">
                        {{t('addYourExtensions')}}
                      </el-button>
                      <el-button 
                        @click="handleRefreshClick" 
                        type="primary"
                        :loading="refreshing">
                        {{refreshButtonText}}
                      </el-button>
                    </div>
                  </div>
                  
                  <div class="plugins-container">
                    <div v-if="remotePlugins.length === 0" class="empty-plugins">
                      <el-empty :description="t('noExtensionsFound')"></el-empty>
                    </div>
                    <div v-else class="plugins-grid">
                      <div v-for="plugin in remotePlugins" :key="plugin.name" class="plugin-card">
                        <div class="plugin-content">
                          <h4 class="plugin-name">{{ plugin.name }}</h4>
                          <p class="plugin-description">{{ plugin.description }}</p>
                        </div>
                        <div class="plugin-action">
                          <el-button
                            v-if="plugin.repository"
                            type="primary"
                            @click="openRepository(plugin.repository)"
                            class="repo-button"
                          >
                            <i class="fa-brands fa-github"></i>
                            {{ t('viewRepository') }}
                          </el-button>
                          <!-- 紧挨着原来的 uninstall / install 按钮 -->
                          <el-button
                            v-if="plugin.installed"
                            type="warning"
                            :loading="plugin._updating"
                            @click="updatePlugin(plugin)"
                          >
                            {{ t('update') }}
                          </el-button>
                          <el-button
                            :loading="installLoading&&!plugin.installed"
                            :type="plugin.installed ? 'danger' : 'primary'"
                            @click="togglePlugin(plugin)"
                          >
                            {{ plugin.installed ? t('uninstall'): t('install') }}
                          </el-button>
                        </div>
                      </div>
                    </div>
                  </div>
                </el-dialog>
              </div>
              <!-- OpenAI风格API -->
              <div v-show="subMenu === 'openai'" class="page">
                <el-form class="settings-form">
                  <div class="tool-item">
                    <!-- 原有SuperAPI内容 -->
                    <div class="tool-header">
                      <span>
                        <el-icon><i class="fa-solid fa-link"></i></el-icon>
                        {{ t('openaiStyleAPI') }}
                      </span>
                    </div>
                    <div class="tool-content">
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        {{ t('superAPIInstructions') }}
                      </el-alert>
                      <!-- 模型名称 -->
                      <el-form-item :label="t('modelName')" class="form-item-align" label-position="top">
                        <el-input
                          :value="'super-model'"
                          readonly
                          class="full-width-input"
                        >
                          <template #append>
                            <el-button
                              @click="copyModel"
                              class="copy-btn"
                            >
                            <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </template>
                        </el-input>
                      </el-form-item>

                      <!-- API端点 -->
                      <el-form-item :label="t('apiEndpoint')" class="form-item-align" label-position="top">
                        <el-input
                          :value="partyURL+'/v1'"
                          readonly
                          class="full-width-input"
                        >
                          <template #append>
                            <el-button
                              @click="copyEndpoint"
                              class="copy-btn"
                            >
                            <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </template>
                        </el-input>
                      </el-form-item>

                      <!-- API key -->
                      <div class="browser-mode-btn-container" v-if="isdocker">
                        <el-button
                          class="browser-mode-btn"
                          type="primary"
                          @click="launchAPIKeyManager"
                          round
                          size="large">
                          <span class="ml-2">
                            {{ t('APIKeyManager') }}
                          </span>
                        </el-button>
                      </div>
                      <el-form-item v-else :label="t('openaiStyleAPIKey')" class="form-item-align" label-position="top">
                        <el-input
                          value="super-secret-key"
                          readonly
                          class="full-width-input"
                        >
                          <template #append>
                            <el-button
                              @click="copyEndpoint"
                              class="copy-btn"
                            >
                            <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </template>
                        </el-input>
                      </el-form-item>
                      <!-- 在index.html的API配置区块内添加 -->
                      <el-form-item :label="t('exampleLanguage')" class="form-item-align" label-position="top">
                        <el-select
                          v-model="selectedCodeLang"
                          @change="autoSaveSettings"
                          class="full-width-input"
                        >
                          <el-option label="Python" value="python"></el-option>
                          <el-option label="JavaScript" value="javascript"></el-option>
                          <el-option label="cURL" value="curl"></el-option>
                        </el-select>
                      </el-form-item>

                      <!-- 修改index.html中的代码块结构 -->
                      <div class="code-block">
                        <div class="code-header">
                          <span class="code-lang">{{ selectedCodeLang }}</span>
                          <button class="copy-button" @click.prevent="handleCopy"><i class="fa-solid fa-copy"></i></button>
                        </div>
                        <pre><code class="hljs" :class="'language-' + selectedCodeLang">{{ codeExamples[selectedCodeLang] }}</code></pre>
                      </div>
                    </div>
                  </div>
                </el-form>
              </div>
              <!-- FastAPI文档 -->
              <div v-show="subMenu === 'fastapi'" class="page">
                <iframe 
                  :src="partyURL + '/docs'" 
                  frameborder="0" 
                  width="100%" 
                  allow="fullscreen"
                  class="fastapi-iframe"
                ></iframe>
              </div>
              <!-- MCP风格API -->
              <div v-show="subMenu === 'mcp'" class="page">
                <el-form class="settings-form">
                  <div class="tool-item">
                    <!-- 原有SuperAPI内容 -->
                    <div class="tool-header">
                      <span>
                        <el-icon><i class='fa-solid fa-server'></i></el-icon>
                        {{ t('MCPStyleAPI') }}
                      </span>
                    </div>
                    <div class="tool-content">
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        {{ t('MCPAPIInstructions') }}
                      </el-alert>
                      <!-- API端点 -->
                      <el-form-item :label="t('apiEndpoint')" class="form-item-align" label-position="top">
                        <el-input
                          :value="partyURL+'/mcp'"
                          readonly
                          class="full-width-input"
                        >
                          <template #append>
                            <el-button
                              @click="copyMCPEndpoint"
                              class="copy-btn"
                            >
                            <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </template>
                        </el-input>
                      </el-form-item>
                    </div>
                  </div>
                </el-form>
              </div>
              <!-- VRM桌宠API -->
              <div v-show="subMenu === 'vrm'" class="page">
                <el-form class="settings-form">
                  <div class="tool-item">
                    <!-- 原有SuperAPI内容 -->
                    <div class="tool-header">
                      <span>
                        <el-icon><i class='fa-solid fa-server'></i></el-icon>
                        {{ t('vrmAPI') }}
                      </span>
                    </div>
                    <div class="tool-content">
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        {{ t('vrmAPIInstructions') }}
                      </el-alert>
                      <!-- API端点 -->
                      <el-form-item :label="t('apiEndpoint')" class="form-item-align" label-position="top">
                        <el-input
                          :value="partyURL+'/vrm.html'"
                          readonly
                          class="full-width-input"
                        >
                          <template #append>
                            <el-button
                              @click="copyVrmEndpoint"
                              class="copy-btn"
                            >
                            <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </template>
                        </el-input>
                      </el-form-item>
                      <!-- API端点 -->
                      <el-form-item :label="t('vmcpReceive')" class="form-item-align" label-position="top">
                        <el-input
                          value="http://127.0.0.1:39539"
                          readonly
                          class="full-width-input"
                        >
                          <template #append>
                            <el-button
                              @click="copyURL('http://127.0.0.1:39539')"
                              class="copy-btn"
                            >
                            <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </template>
                        </el-input>
                      </el-form-item>
                      <el-form-item :label="t('vmcpSend')" class="form-item-align" label-position="top">
                        <el-input
                          value="http://127.0.0.1:39540"
                          readonly
                          class="full-width-input"
                        >
                          <template #append>
                            <el-button
                              @click="copyURL('http://127.0.0.1:39540')"
                              class="copy-btn"
                            >
                            <i class="fa-solid fa-copy"></i>
                            </el-button>
                          </template>
                        </el-input>
                      </el-form-item>
                        <el-alert
                          type="info"
                          :closable="false"
                          class="mb-2"
                        >
                          {{ t('vmcpInstructions') }}
                        </el-alert>
                    </div>
                  </div>
                </el-form>
              </div>
              <!-- docker -->
              <div v-show="subMenu === 'docker'" class="page">
                <el-form class="settings-form">
                  <div class="tool-item">
                    <div class="tool-header">
                      <span>
                        <el-icon><i class='fa-brands fa-docker'></i></el-icon>
                        {{ t('docker') }}
                      </span>
                    </div>
                    <div class="tool-content">
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        {{ t('dockerInstructions') }}
                      </el-alert>
                      <!-- 修改index.html中的代码块结构 -->
                      <div class="code-block">
                        <div class="code-header">
                          <span class="code-lang">shell</span>
                          <button class="copy-button" @click.prevent="handleCopy"><i class="fa-solid fa-copy"></i></button>
                        </div>
                        <pre><code class="hljs language-shell">{{ dockerExamples }}</code></pre>
                      </div>
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        {{ t('dockerInstructions2') }}
                      </el-alert>                      <!-- 修改index.html中的代码块结构 -->
                      <div class="code-block">
                        <div class="code-header">
                          <span class="code-lang">shell</span>
                          <button class="copy-button" @click.prevent="handleCopy"><i class="fa-solid fa-copy"></i></button>
                        </div>
                        <pre><code class="hljs language-shell">{{ dockerExamples2 }}</code></pre>
                      </div>
                    </div>
                  </div>
                </el-form>
              </div>
              <!-- 浏览器模式 -->
              <div v-show="subMenu === 'browser'" class="page">
                <el-form class="settings-form">
                  <div class="tool-item">
                    <span>
                      <el-icon>
                        <i class="fa-solid fa-globe"></i>
                      </el-icon>
                      {{ t('useWebmode') }}
                    </span>
                    <div class="browser-mode-btn-container">
                      <el-button
                        class="browser-mode-btn"
                        type="primary"
                        @click="launchBrowserMode"
                        round
                        size="large">
                        <i class="fa-solid fa-globe" v-if="!isBrowserOpening"></i>
                        <transition name="bounce">
                          <span v-if="isBrowserOpening" class="ml-2">
                            <el-icon class="is-loading"><loading /></el-icon>
                            {{ t('launching') }}
                          </span>
                          <span v-else class="ml-2">
                            {{ t('launchBrowserMode') }}
                          </span>
                        </transition>
                      </el-button>
                    </div>
                    <canvas id="qrcode" style="display: block; margin: 20px auto;"></canvas>
                    <el-alert
                      type="info"
                      :closable="false"
                      class="mb-2"
                    >
                      <template #default>
                        <div class="alert-content">
                          {{ t('clickToUse') }}<br>
                          {{ t('scanToUse') }}
                        </div>
                      </template>
                    </el-alert>
                    <div class="tool-content">
                      <el-alert
                        type="info"
                        :closable="false"
                        class="mb-2"
                      >
                        {{ t('browserEmbedCodeInstructions') }}
                      </el-alert>
                      <!-- 修改index.html中的代码块结构 -->
                      <div class="code-block">
                        <div class="code-header">
                          <span class="code-lang">html</span>
                          <button class="copy-button" @click.prevent="handleCopy"><i class="fa-solid fa-copy"></i></button>
                        </div>
                        <pre><code class="hljs language-html">{{ browserEmbedCodeExamples }}</code></pre>
                      </div>
                    </div>
                  </div>
                </el-form>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Browser Container -->
        <div v-show="activeMenu === 'ai-browser'" class="page ai-browser-container" v-if="isElectron" style="display: flex; flex-direction: row; height: 100%; overflow: hidden; position: relative;">
            
          <!-- 2. 左侧：浏览器主体 (flex: 1 自动占满剩余空间) -->
          <div class="browser-body" style="flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; height: 100%;">
              
              <div 
                  class="browser-toggle-handle"
                  @click="showBrowserChat = !showBrowserChat;autoSaveSettings();"
              >
                  <!-- 图标逻辑：面板打开时显示向右箭头(收起)，关闭时显示向左箭头(展开) -->
                  <i :class="showBrowserChat ? 'fa-solid fa-chevron-right' : 'fa-solid fa-chevron-left'"></i>
              </div>

              <!-- Webview 容器 -->
              <div 
                  v-for="tab in browserTabs" 
                  :key="tab.id" 
                  class="webview-wrapper"
                  v-show="currentTabId === tab.id && tab.url"
                  style="flex: 1; display: flex; flex-direction: column; height: 100%;"
              >
                <webview 
                    :src="tab.url" 
                    :id="'webview-' + tab.id"
                    class="webview-element"
                    :useragent="dynamicUserAgent" 
                    allowpopups
                    plugins
                    :preload="webviewPreloadPath"
                    @ipc-message="handleWebviewIpcMessage"
                    partition="persist:party-browser-session"
                    @did-start-loading="onDidStartLoading(tab.id)"
                    @did-stop-loading="onDidStopLoading(tab.id)"
                    @page-title-updated="onPageTitleUpdated(tab.id, $event)"
                    @page-favicon-updated="onPageFaviconUpdated(tab.id, $event)"
                    @new-window="onNewWindow(tab.id, $event)"
                    @dom-ready="onDomReady(tab.id)"
                    style="flex: 1; width: 100%; height: 100%;"
                    webpreferences="contextIsolation=true, nodeIntegration=false, sandbox=true, webSecurity=true, enableRemoteModule=false" 
                ></webview>
              </div>

              <!-- 3. 极简 IOS 风格欢迎页 -->
              <div class="browser-welcome-page" v-if="currentTab && !currentTab.url">
                  <div class="ios-welcome-container">
                      
                      <h1 class="ios-title" @click="showFavorites = !showFavorites;autoSaveSettings();" title="Click to toggle favorites">
                          Welcome to Party
                      </h1>
                      
                      <!-- 居中大搜索框 -->
                      <div class="ios-search-wrapper" :class="{ 'focused': isSearchFocused }">
                          <!-- 引擎切换器 -->
                          <div class="engine-selector" 
                              @mouseenter="handleSelectorEnter" 
                              @mouseleave="handleSelectorLeave">
                              
                              <div class="current-engine">
                                  <!-- 动态显示当前引擎的高清 Logo 图片 -->
                                  <img 
                                      v-if="searchEngine === 'party'" 
                                      src="./source/icon_shadow.png" 
                                      class="engine-logo-img" 
                                      alt="Party"
                                  >
                                  <img 
                                      v-if="searchEngine === 'bing'" 
                                      src="./source/providers/bing.png" 
                                      class="engine-logo-img" 
                                      alt="Bing"
                                  >
                                  <img 
                                      v-if="searchEngine === 'google'" 
                                      src="./source/providers/google.png" 
                                      class="engine-logo-img" 
                                      alt="Google"
                                  >
                                  <!-- 下拉小箭头保留 -->
                                  <i class="fa-solid fa-caret-down"></i>
                              </div>
                              
                              <!-- 下拉菜单：根据 showEngineDropdown 显示 -->
                              <div class="engine-dropdown" v-show="showEngineDropdown">
                                  <div class="engine-item" 
                                      @click="setSearchEngine('party')" 
                                      :class="{active: searchEngine === 'party'}">
                                  <img 
                                      src="./source/icon_shadow.png" 
                                      class="engine-logo-img" 
                                      alt="party"
                                  > Party
                                  </div>
                                  <div class="engine-item" 
                                      @click="setSearchEngine('bing')" 
                                      :class="{active: searchEngine === 'bing'}">
                                  <img 
                                      src="./source/providers/bing.png" 
                                      class="engine-logo-img" 
                                      alt="Bing"
                                  > Bing
                                  </div>
                                  <div class="engine-item" 
                                      @click="setSearchEngine('google')" 
                                      :class="{active: searchEngine === 'google'}">
                                  <img 
                                      src="./source/providers/google.png" 
                                      class="engine-logo-img" 
                                      alt="Google"
                                  > Google
                                  </div>
                              </div>
                          </div>

                          <!-- 输入框 -->
                          <input 
                              type="text" 
                              v-model="welcomeSearchQuery" 
                              class="ios-search-input"
                              :placeholder="searchEngineplaceholder"
                              @focus="isSearchFocused = true"
                              @blur="isSearchFocused = false"
                              @keyup.enter="handleWelcomeSearch"
                          >
                          
                          <!-- 搜索按钮 -->
                          <button class="ios-search-btn" @click="handleWelcomeSearch">
                              <i class="fa-solid fa-arrow-right"></i>
                          </button>
                      </div>

                      <div class="ios-favorites-wrapper" :class="{ 'hidden': !showFavorites }">
                          <div class="ios-favorites-grid">
                              <!-- 循环渲染收藏项 -->
                              <div 
                                  v-for="fav in favorites" 
                                  :key="fav.url" 
                                  class="fav-item"
                                  @click="loadUrlInCurrentTab(fav.url)"
                              >
                                  <div class="fav-icon-box">
                                      <!-- 如果有 favicon 显示图片，否则显示默认图标 -->
                                      <img v-if="fav.favicon" :src="fav.favicon" :alt="fav.title" />
                                      <i v-else class="fa-regular fa-compass"></i>
                                      
                                      <!-- 删除按钮 (阻止冒泡以免触发跳转) -->
                                      <span 
                                          class="fav-remove-btn" 
                                          @click.stop="removeFavorite(fav.url)"
                                          :title="t('remove')"
                                      >
                                          <i class="fa-solid fa-xmark"></i>
                                      </span>
                                  </div>
                                  <span class="fav-title">{{ fav.title || 'No Title' }}</span>
                              </div>

                              <!-- 这是一个空的占位，如果收藏夹为空时显示提示 -->
                              <div v-if="favorites.length === 0" class="empty-favorites-tip" style="grid-column: 1 / -1; text-align: center; color: var(--el-text-color-secondary); padding: 20px;">
                                  <i class="fa-regular fa-star" style="margin-bottom: 8px;"></i>
                                  <p style="font-size: 12px;">{{t('addFavoritesToSeeThemHere')}}</p>
                              </div>
                          </div>
                      </div>

                  </div>
              </div>

          </div>

          <!-- 3. 右侧：Copilot 侧边栏 (复用 Chat 逻辑) -->
          <div 
            class="browser-copilot-sidebar" 
            :class="{ 'sidebar-collapsed': !showBrowserChat }"
          >
            <!-- 聊天区域复用 -->
            <div class="chat-area" style="min-width: 450px;flex: 1; display: flex; flex-direction: column; overflow: hidden; height: 100%; width: 100%;">
                
                <!-- 消息列表 (flex: 1) -->
              <div class="messages-container" ref="browserMessagesContainer" v-if="!isCapsuleMode" @click.capture="handleMessageLinkClick">
                <!-- 添加 is-group-mode 类 -->
                <div v-for="(message, index) in messages" :key="index" class="message" :class="[message.role, { 'is-group-mode': isGroupMode }]">
                  
                  <!-- 群聊模式 - AI 头像 (左侧) -->
                  <div v-if="isGroupMode && message.role === 'assistant' && message.agentName" class="im-avatar left">
                    <img :src="getRoleAvatar(message.agentName)" draggable="false" />
                  </div>

                  <!-- 内容包裹层：负责纵向排列 名字、气泡、按钮 -->
                  <div class="im-content-wrapper">
                    
                    <!-- AI 名字 (仅群聊显示) -->
                    <div v-if="(isGroupMode && message.agentName) && message.role === 'assistant'" class="im-name-tag">
                        {{ message.agentName }}
                    </div>

                    <!-- TTS 控制区 -->
                    <div v-if="(ttsSettings.enabled || settings.enableOmniTTS) && message.role === 'assistant'" class="tts-controls">
                      <el-tooltip :content="message.isPlaying ? t('pause') : t('play')">
                        <el-button @click="toggleTTS(message)" circle size="small">
                          <i :class="message.isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play'"></i>
                        </el-button>
                      </el-tooltip>
                      <template v-if="!message.isOmni">
                        <el-button @click="backwardTTS(message)" circle size="small"><i class="fa-solid fa-backward"></i></el-button>
                        <el-button @click="forwardTTS(message)" circle size="small"><i class="fa-solid fa-forward"></i></el-button>
                        <span class="tts-status" v-if="message.ttsChunks">
                          {{ (message.currentChunk || 0) + 1 }}/{{ message.ttsChunks.length }}
                        </span>
                      </template>
                      <template v-else>
                        <div class="omni-progress-wrapper" style="margin-left: 20px;">
                          <el-slider 
                            v-model="message.omniCurrentTime" 
                            :max="message.omniDuration > 0 ? message.omniDuration : 0.1" 
                            :step="0.01"
                            :show-tooltip="false"
                            @change="(val) => seekOmniTTS(message, val)"
                          />
                          <span class="tts-status-time">
                            {{ (message.omniCurrentTime || 0).toFixed(1) }}s / {{ (message.omniDuration || 0).toFixed(1) }}s
                          </span>
                        </div>
                      </template>
                      <span class="tts-status" v-if="message.role === 'assistant' && !isMobile && !message.isOmni">
                        {{ t('first_sentence_latency')+': '+(message?.first_sentence_latency ?? 0) +'ms' }}
                      </span>
                    </div>

                    <!-- 消息气泡主体 -->
                    <div class="message-content" v-if="!allBriefly||message.role !== 'system'||index === 0" :class="{ typing: message.role === 'assistant' && isTyping && index === messages.length - 1 }">
                      
                      <!-- User -->
                      <div v-if="message.role === 'user'" class="user-content" data-mjx-disabled="true">
                        <div v-html="message.content" class = "user-msg"></div>
                        <div v-if="message.fileLinks?.length" class="file-links">
                          <a v-for="(link, linkIndex) in message.fileLinks" :key="linkIndex" :href="formatFileUrl(link.path)" target="_blank" class="file-link">@{{ link.name }}</a>
                        </div>
                        <div v-if="message.imageLinks?.length" class="image-links">
                          <img v-for="(link, linkIndex) in message.imageLinks" :key="linkIndex" :src="formatFileUrl(link.path)" class="image-link"/>
                        </div>
                      </div>
                      
                      <!-- Assistant -->
                      <div v-else-if="message.role === 'assistant'" class="markdown-body">
                          <div v-if="message.briefly" v-html="formatMessage(message.pure_content??message.content, index)"></div>
                          <div v-else>
                              <template v-for="(segment, segIndex) in splitMessageContent(message.content)" :key="segIndex">
                                  <div v-if="segment.type === 'text'" class="stream-content" :class="{ 'streaming': isTyping && index === messages.length - 1 && segIndex === splitMessageContent(message.content).length - 1 }" v-morph:format="segment.content" style="display: inline-block; width: 100%;"></div>
                                  <a2-u-i-renderer v-else-if="segment.type === 'ui'" :config="segment.content" @action="handleA2UIAction"></a2-u-i-renderer>
                              </template>
                              <div v-if="isTyping && index === messages.length - 1 && !message.content"><i class="fa-solid fa-spinner fa-spin"></i></div>
                          </div>
                      </div>
                      
                      <!-- System -->
                      <div v-else class="system-content" data-mjx-disabled="true">
                        <div v-html="index===0 ? (t('system_prompt') + message.content):message.content" class="scroll-on-hover" @click="openEditDialog(message.role, message.content,index)" :style="{ 'max-height': index===0 ? '200px' : 'none', 'overflow-y': index===0 ? 'auto' : 'hidden' }"></div>
                      </div>

                    </div>

                    <!-- 操作按钮区 -->
                    <div class="message-actions" v-if="!allBriefly||message.role !== 'system'||index === 0">
                      <el-tooltip v-if="mainAgent === 'super-model' || message.role !== 'system'" :content="t('edit')" placement="bottom">
                        <el-button @click="openEditDialog(message.role, message.content,index)" circle size="small"><i class="fa-solid fa-pen-to-square"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="message.role === 'assistant'" :content="t('briefly')" placement="bottom">
                        <el-button class="briefly-btn" @click="toggleBriefly(index)" circle size="small"><i class="fa-solid fa-asterisk"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="message.role === 'assistant'" :content="t('rewrite')" placement="bottom">
                        <el-button class="rewrite-btn" @click="rewrite(index)" circle size="small"><i class="fa-solid fa-rotate"></i></el-button>
                      </el-tooltip>
                      <el-tooltip :content="t('copy')" placement="bottom">
                        <el-button class="copy-btn" @click="copyMessageContent(message)" circle size="small"><i class="fa-solid fa-copy"></i></el-button>
                      </el-tooltip>
                      <el-tooltip :content="t('translateAndMark')" placement="bottom">
                        <el-button @click="translateMessage(index)" circle size="small"><i class="fa-solid fa-language"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="index !== 0" :content="t('delete')" placement="bottom">
                        <el-button @click="deleteMessage(index)" circle size="small"><i class="fa-solid fa-trash-can"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="index == 0" :content="t('reset')" placement="bottom">
                        <el-button @click="resetMessage(index)" circle size="small"><i class="fa-solid fa-rotate"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="message.role === 'system'&&index == 0" :content="t('oneClickExpand')" placement="bottom">
                        <el-button class="Gen-btn" @click="toggleQuickGen(index)" :disabled="isQuickGenerating" circle size="small"><i class="fa-solid fa-wand-magic-sparkles"></i></el-button>
                      </el-tooltip>
                      <el-tooltip v-if="message.role === 'system'&&index == 0" :content="t('save')" placement="bottom">
                        <el-button class="Gen-btn" @click="saveSystemPrompt(index)" :disabled="isQuickGenerating" circle size="small"><i class="fa-solid fa-floppy-disk"></i></el-button>
                      </el-tooltip>
                    </div>

                  </div>

                  <!-- 群聊模式 - 用户头像 (右侧) -->
                  <div v-if="isGroupMode && message.role === 'user'" class="im-avatar right">
                    <img src="source/providers/logo.png" draggable="false" />
                  </div>

                </div>
              </div>

                <!-- 底部工具栏与输入框 -->
                <div style="border-top: 1px solid var(--el-border-color); padding: 10px; background: var(--el-bg-color);">
                    <!-- 按钮组 -->
                    <div class="button-group" style="margin-bottom: 5px; display: flex; flex-wrap: wrap; gap: 4px;">
                        
                        <!-- 常用功能按钮复用 -->
                        <el-tooltip :content="t('clearChat')" placement="top">
                          <el-button
                            v-if="!isCapsuleMode"
                            @click="clearMessages"
                            class="icon-btn clear-btn"
                            type="danger"
                            circle>
                            <i class="fa-solid fa-trash"></i>
                          </el-button>
                        </el-tooltip>

                        <el-tooltip :content="t('chatHistory')" placement="top">
                          <el-button
                            v-if="!isCapsuleMode"
                            @click="showHistoryDialog = true"
                            class="icon-btn history-btn"
                            :type="conversations.length === 0 ? 'default' : 'primary'"
                            circle>
                            <i class="fa-solid fa-clock-rotate-left"></i>
                          </el-button>
                        </el-tooltip>

                        <el-tooltip :content="t('desktopVisionButton')" placement="top">
                          <el-button
                            @click="visionSettings.desktopVision = !visionSettings.desktopVision; autoSaveSettings()"
                            class="icon-btn vision-btn"
                            :type="visionSettings.desktopVision ? 'primary' : 'default'"
                            :disabled="!isElectron"
                            circle>
                            <i class="fa-solid fa-eye"></i>
                          </el-button>
                        </el-tooltip>

                        <el-tooltip :content="t('screenshot')" placement="top">
                          <el-button
                            @click="toggleScreenshot(false)"
                            class="icon-btn vision-btn"
                            type="default"
                            circle>
                            <i class="fa-solid fa-scissors"></i>
                          </el-button>
                        </el-tooltip>

                        <el-tooltip :content="t('asr')" placement="top">
                          <el-button
                            @click="toggleASR"
                            class="icon-btn asr-btn"
                            :type="asrSettings.enabled ? 'primary' : 'default'"
                            circle>
                            <i class="fa-solid fa-microphone"></i>
                          </el-button>
                        </el-tooltip>

                        <el-tooltip :content="t('tts')" placement="top">
                          <el-button
                            @click="ttsSettings.enabled=!ttsSettings.enabled;changeTTSstatus();"
                            class="icon-btn asr-btn"
                            :type="ttsSettings.enabled ? 'primary' : 'default'"
                            circle>
                            <i v-if="ttsSettings.enabled" class="fa-solid fa-volume-high"></i>
                            <i v-else class="fa-solid fa-volume-xmark"></i>
                          </el-button>
                        </el-tooltip>

                        <el-tooltip :content="t('browserControl')" placement="top">
                          <el-button
                            @click="chromeMCPSettings.enabled = !chromeMCPSettings.enabled; changeChromeMCPEnabled();"
                            class="icon-btn browserControl-btn"
                            :type="chromeMCPSettings.enabled ? 'primary' : 'default'"
                            circle>
                            <i class="fa-solid fa-compass"></i>
                          </el-button>
                        </el-tooltip>

                        <el-tooltip :content="t('tablePet')" placement="top">
                          <el-button
                            @click="startVRM"
                            class="icon-btn vrm-btn"
                            :type="'default'"
                            circle>
                            <i :class='isVRMStarting? "fa-solid fa-spinner fa-spin" : "fa-solid fa-user-ninja"'></i>
                          </el-button>
                        </el-tooltip>

                        <el-tooltip :content="isSending ? t('stopGenerating') : t('sendMessage')" placement="top">
                          <el-button
                            @click="isSending ? stopGenerate() : sendMessage()"
                            :type="isSending ? 'danger' : 'primary'"
                            class="icon-btn send-btn"
                            circle>
                            <i :class="isSending ? 'fa-solid fa-stop' : 'fa-solid fa-paper-plane'" aria-hidden="true"></i>
                          </el-button>
                        </el-tooltip>
                    </div>

                    <!-- 输入框区域 -->
                    <div class="input-container" v-if="!isCapsuleMode">
                      
                      <!-- ✨✨✨ 新增：统一的外层包裹器 ✨✨✨ -->
                      <!-- tabindex="-1" 是为了让 focus-within 生效更稳定 -->
                      <div class="unified-input-wrapper">
                        
                        <!-- 1. 附件预览区域 -->
                        <div class="attachment-preview-list" v-show="allItems.length > 0">
                          <div v-for="(item, index) in allItems" :key="index" class="attachment-item">
                            
                            <!-- 图片类型 -->
                            <div v-if="item.type === 'image'" class="preview-image-box">
                              <img :src="item.path" alt="preview" />
                              <div class="overlay">
                                <el-button 
                                  type="danger" 
                                  circle 
                                  size="small" 
                                  @click.stop="removeItem(index, item.type)"
                                >
                                  <i class="fa-solid fa-trash"></i>
                                </el-button>
                              </div>
                            </div>

                            <!-- 文件类型 -->
                            <div v-else class="file-card-box">
                              <div class="file-icon">
                                <i class="fa-solid fa-file-lines"></i>
                              </div>
                              <div class="file-info">
                                <span class="file-name" :title="item.name">{{ item.name }}</span>
                              </div>
                              <div class="remove-btn" @click.stop="removeItem(index, item.type)">
                                <i class="fa-solid fa-xmark"></i>
                              </div>
                            </div>

                          </div>
                        </div>

                        <!-- 2. 输入框 -->
                        <!-- 注意：这里的 class 是 input-box-transparent -->
                        <el-input
                          v-model="userInput"
                          type="textarea"
                          :rows="isMobile?(isInputExpanded ? 8 : 3):(isInputExpanded ? 16 : 4)"
                          :placeholder="t('inputMessage')"
                          resize="none"
                          @keydown="isInputting=true;handleKeyDown($event)" 
                          @keyup="isInputting=false"
                          @paste.native="handleInputPaste"
                          class="input-box-transparent">
                        </el-input>
                        
                      </div> <!-- 结束 unified-input-wrapper -->
                    </div>
                </div>
            </div>
          </div>
        </div>
      </el-main>
    </el-container>
  </div>
  <!-- 引入Vue和Element Plus -->
  <script src="libs/vue.global.prod.js"></script>
  <script src="libs/element-plus.js"></script>
  <script src="libs/element-plus-icons.js"></script>
  <script src="js/vue_data.js"></script>
  <script src="js/vue_methods.js"></script>
  <script src="js/renderer.js"></script>
</body>
</html>
